{% extends 'layout_django.html' %}
{% load static %}

{% block title %}{{ car.make }} {{ car.model }} - كاررنتال{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/car-detail-animations.css' %}"
<style>
    /* Car Hero Section */
    .car-hero-section {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .car-hero-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        display: block;
    }
    
    .car-hero-overlay {
        position: absolute;
        bottom: 0;
        right: 0;
        left: 0;
        background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        padding: 2rem;
        color: white;
    }
    
    .car-hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .car-hero-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 1rem;
    }
    
    .car-hero-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .car-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
    }
    
    .car-badge i {
        margin-left: 0.5rem;
    }
    
    .badge-category {
        background-color: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .badge-transmission {
        background-color: rgba(139, 92, 246, 0.2);
        color: #8b5cf6;
    }
    
    .badge-fuel {
        background-color: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    .badge-available {
        background-color: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    .badge-unavailable {
        background-color: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    /* Car Information Panels */
    .car-detail-panel {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
    }
    
    .car-detail-panel:hover {
        transform: translateY(-5px);
    }
    
    .detail-panel-header {
        background: linear-gradient(45deg, #0f766e, #0d9488);
        color: white;
        padding: 1rem 1.5rem;
    }
    
    .detail-panel-header h3 {
        margin: 0;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
    }
    
    .detail-panel-header h3 i {
        margin-left: 0.5rem;
    }
    
    .detail-panel-body {
        padding: 1.5rem;
    }
    
    /* Specifications Grid */
    .specs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
    }
    
    .spec-item {
        display: flex;
        align-items: flex-start;
    }
    
    .spec-icon {
        background-color: #e6f7f5;
        color: #0f766e;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 1rem;
        font-size: 1.2rem;
    }
    
    .spec-content {
        flex: 1;
    }
    
    .spec-label {
        color: #64748b;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .spec-value {
        color: #0f172a;
        font-weight: 600;
    }
    
    /* Features List */
    .features-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .feature-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
    }
    
    .feature-icon {
        color: #0f766e;
        margin-left: 0.5rem;
        display: flex;
    }
    
    /* Reservation Card */
    .reservation-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .reservation-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .reservation-card-header {
        background: linear-gradient(45deg, #0f766e, #0d9488);
        color: white;
        padding: 1.5rem;
    }
    
    .reservation-card-header h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.25rem;
    }
    
    .reservation-price {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .price-period {
        font-size: 0.875rem;
        opacity: 0.8;
    }
    
    .reservation-card-body {
        padding: 1.5rem;
    }
    
    .action-button {
        display: block;
        background: linear-gradient(45deg, #0f766e, #0d9488);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .action-button:hover {
        background: linear-gradient(45deg, #115e59, #0f766e);
        transform: translateY(-2px);
        color: white;
    }
    
    /* Unavailable dates panel */
    .unavailable-dates-panel {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-top: 1.5rem;
    }
    
    .date-range-item {
        display: flex;
        align-items: center;
        padding: 0.8rem 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .date-range-item:last-child {
        border-bottom: none;
    }
    
    .date-range-icon {
        color: #ef4444;
        font-size: 1.2rem;
        margin-left: 0.8rem;
    }
    
    .date-range-text {
        color: #334155;
        font-weight: 500;
    }
    
    /* Direct booking form */
    .direct-booking-form {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-top: 1.5rem;
    }
    
    .direct-booking-header {
        background: linear-gradient(45deg, #0f766e, #0d9488);
        color: white;
        padding: 1.2rem;
        font-weight: 600;
    }
    
    .direct-booking-body {
        padding: 1.5rem;
    }
    
    .booking-summary {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 1.2rem;
        margin-top: 1.5rem;
    }
    
    .booking-summary-title {
        color: #0f766e;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.8rem;
        border-bottom: 1px dashed #cbd5e1;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.6rem;
        color: #475569;
    }
    
    .summary-total {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px dashed #cbd5e1;
        font-weight: 700;
        color: #0f766e;
    }
    
    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease forwards;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Car Hero Section -->
    <div class="car-hero-section">
        {% if car.image %}
        <img src="{{ car.image.url }}" class="car-hero-image animate-fade-in-up" alt="{{ car.make }} {{ car.model }}">
        {% elif car.image_url %}
        <img src="{{ car.image_url }}" class="car-hero-image animate-fade-in-up" alt="{{ car.make }} {{ car.model }}">
        {% else %}
        <img src="{% static 'images/car-placeholder.svg' %}" class="car-hero-image animate-fade-in-up" alt="{{ car.make }} {{ car.model }}">
        {% endif %}
        
        <div class="car-hero-overlay">
            <h1 class="car-hero-title">{{ car.make }} {{ car.model }}</h1>
            <p class="car-hero-subtitle">{{ car.year }} • {{ car.color }}</p>
            
            <div class="car-hero-badges">
                <div class="car-badge badge-category">
                    <i class="fas fa-car ms-2"></i> {{ car.category }}
                </div>
                <div class="car-badge badge-transmission">
                    <i class="fas fa-cog ms-2"></i> {{ car.transmission }}
                </div>
                <div class="car-badge badge-fuel">
                    <i class="fas fa-gas-pump ms-2"></i> {{ car.fuel_type }}
                </div>
                
                {% if car.is_available %}
                <div class="car-badge badge-available">
                    <i class="fas fa-check-circle ms-2"></i> متاحة
                </div>
                {% else %}
                <div class="car-badge badge-unavailable">
                    <i class="fas fa-times-circle ms-2"></i> غير متاحة
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Car Information Panels -->
            <!-- Car Specifications -->
            <div class="car-detail-panel animate-fade-in-up" style="animation-delay: 0.1s;">
                <div class="detail-panel-header">
                    <h3><i class="fas fa-info-circle ms-2"></i> مواصفات السيارة</h3>
                </div>
                <div class="detail-panel-body">
                    <div class="specs-grid">
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-palette"></i></div>
                            <div class="spec-content">
                                <div class="spec-label">اللون</div>
                                <div class="spec-value">{{ car.color }}</div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-users"></i></div>
                            <div class="spec-content">
                                <div class="spec-label">عدد المقاعد</div>
                                <div class="spec-value">{{ car.seats }}</div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-calendar-alt"></i></div>
                            <div class="spec-content">
                                <div class="spec-label">سنة الصنع</div>
                                <div class="spec-value">{{ car.year }}</div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-cog ms-2"></i></div>
                            <div class="spec-content">
                                <div class="spec-label">ناقل الحركة</div>
                                <div class="spec-value">{{ car.transmission }}</div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-gas-pump ms-2"></i></div>
                            <div class="spec-content">
                                <div class="spec-label">نوع الوقود</div>
                                <div class="spec-value">{{ car.fuel_type }}</div>
                            </div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-tag"></i></div>
                            <div class="spec-content">
                                <div class="spec-label">الفئة</div>
                                <div class="spec-value">{{ car.category }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Car Features -->
            {% if car.feature_list %}
            <div class="car-detail-panel animate-fade-in-up" style="animation-delay: 0.2s;">
                <div class="detail-panel-header">
                    <h3><i class="fas fa-list ms-2"></i> المميزات</h3>
                </div>
                <div class="detail-panel-body">
                    <div class="features-list">
                        {% for feature in car.feature_list %}
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-check-circle ms-2"></i></div>
                            <div>{{ feature }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Unavailable Dates -->
            <div class="car-detail-panel animate-fade-in-up" style="animation-delay: 0.3s;">
                <div class="detail-panel-header">
                    <h3><i class="fas fa-calendar-times ms-2"></i> التواريخ المحجوزة</h3>
                </div>
                <div class="detail-panel-body">
                    <div id="unavailableDates" class="py-3">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-2 text-muted">جاري تحميل التواريخ المحجوزة...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Reservation Card -->
            <div class="reservation-card animate-fade-in-up">
                <div class="reservation-card-header">
                    <h3>حجز هذه السيارة</h3>
                    <div class="d-flex align-items-baseline">
                        <div class="reservation-price">{{ car.daily_rate }}</div>
                        <div class="price-period ms-2">دينار/يوم</div>
                    </div>
                </div>
                
                <div class="reservation-card-body">
                    {% if car.is_available %}
                    <a href="{% url 'book_car' car_id=car.id %}" class="action-button d-block text-center text-decoration-none">
                        <i class="fas fa-calendar-check ms-2"></i> طلب الحجز
                    </a>
                    {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle ms-2"></i> عذراً، هذه السيارة غير متاحة للحجز حالياً.
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Direct Booking Form -->
            {% if car.is_available and user.is_authenticated %}
            <div class="direct-booking-form animate-fade-in-up" style="animation-delay: 0.2s;">
                <div class="direct-booking-header">
                    <i class="fas fa-bolt ms-2"></i> الحجز السريع
                </div>
                <div class="direct-booking-body">
                    <form id="directBookingForm" method="post" action="{% url 'book_car' car_id=car.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="start_date" class="form-label">تاريخ الاستلام</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label">تاريخ التسليم</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>
                        
                        <div class="booking-summary">
                            <div class="booking-summary-title">
                                <i class="fas fa-receipt ms-2"></i> ملخص الحجز
                            </div>
                            <div class="summary-item">
                                <span>المدة</span>
                                <span id="direct-booking-days">-- يوم</span>
                            </div>
                            <div class="summary-item">
                                <span>سعر اليوم الواحد</span>
                                <span>{{ car.daily_rate }} د.ك</span>
                            </div>
                            <div class="summary-total">
                                <span>المجموع</span>
                                <span id="direct-booking-total">-- د.ك</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="action-button d-block text-center text-decoration-none mt-3">
                            <i class="fas fa-shopping-cart ms-2"></i> إضافة إلى سلة التسوق
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/car-detail-animations.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch unavailable dates
        const carId = {{ car.id |escapejs }};
        const dailyRate = {{ car.daily_rate |escapejs }};
        const unavailableDatesContainer = document.getElementById('unavailableDates');
        
        try {
            fetch(`/api/car/${carId}/unavailable-dates/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.dates || data.dates.length === 0) {
                        unavailableDatesContainer.innerHTML = '<p class="text-success mb-0 text-center py-4"><i class="fas fa-check-circle ms-2"></i> لا توجد تواريخ محجوزة حالياً!</p>';
                    } else {
                        let html = '';
                        
                        data.dates.forEach(dateRange => {
                            const startDate = new Date(dateRange[0]);
                            const endDate = new Date(dateRange[1]);
                            
                            const formattedStartDate = startDate.toLocaleDateString('ar-SA', { 
                                year: 'numeric', month: 'long', day: 'numeric' 
                            });
                            const formattedEndDate = endDate.toLocaleDateString('ar-SA', { 
                                year: 'numeric', month: 'long', day: 'numeric' 
                            });
                            
                            html += `
                            <div class="date-range-item">
                                <i class="fas fa-calendar-times date-range-icon"></i>  <div class="date-range-text">${formattedStartDate} - ${formattedEndDate}</div>
                            </div>`;
                        });
                        
                        unavailableDatesContainer.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error("Error fetching unavailable dates:", error);
                    const unavailableDatesContainer = document.getElementById("unavailableDates");
                    unavailableDatesContainer.innerHTML = '<p class="text-danger mb-0 text-center py-4"><i class="fas fa-exclamation-circle ms-2"></i> حدث خطأ أثناء تحميل التواريخ المحجوزة</p>';
                });
        } catch (err) {
            console.error("Error in fetch operation:", err);
            const unavailableDatesContainer = document.getElementById("unavailableDates");
            unavailableDatesContainer.innerHTML = '<p class="text-danger mb-0 text-center py-4"><i class="fas fa-exclamation-circle ms-2"></i> حدث خطأ أثناء تحميل التواريخ المحجوزة</p>';
        }
        
        // Direct booking form functionality
        const directBookingForm = document.getElementById("directBookingForm");
        if (directBookingForm) {
            const directStartDate = directBookingForm.querySelector('input[name="start_date"]');
            const directEndDate = directBookingForm.querySelector('input[name="end_date"]');
            const directBookingDays = document.getElementById("direct-booking-days");
            const directBookingTotal = document.getElementById("direct-booking-total");
            
            function updateDirectBookingSummary() {
                if (directStartDate.value && directEndDate.value) {
                    const startDate = new Date(directStartDate.value);
                    const endDate = new Date(directEndDate.value);
                    
                    if (endDate >= startDate) {
                        // Calculate days difference
                        const diffTime = Math.abs(endDate - startDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        
                        // Update UI
                        directBookingDays.textContent = diffDays + " أيام";
                        directBookingTotal.textContent = (diffDays * dailyRate).toFixed(2) + " د.ك";
                    } else {
                        directBookingDays.textContent = "-- أيام";
                        directBookingTotal.textContent = "-- د.ك";
                    }
                } else {
                    directBookingDays.textContent = "-- أيام";
                    directBookingTotal.textContent = "-- د.ك";
                }
            }
            
            directStartDate.addEventListener('change', updateDirectBookingSummary);
            directEndDate.addEventListener('change', updateDirectBookingSummary);
            
            // Card image preview
            const cardImageInput = directBookingForm.querySelector('input[name="card_image"]');
            if (cardImageInput) {
                cardImageInput.addEventListener('change', function(e) {
                    if (this.files && this.files[0]) {
                        // Create preview if doesn't exist
                        let previewContainer = directBookingForm.querySelector('.card-image-preview');
                        
                        if (!previewContainer) {
                            previewContainer = document.createElement('div');
                            previewContainer.className = 'card-image-preview mt-2 text-center';
                            previewContainer.innerHTML = '<p class="mb-1 text-success"><i class="fas fa-check-circle ms-2"></i> تم تحميل الصورة بنجاح</p>';
                            
                            const imagePreview = document.createElement('img');
                            imagePreview.className = 'img-thumbnail';
                            imagePreview.style.maxHeight = '150px';
                            previewContainer.appendChild(imagePreview);
                            
                            cardImageInput.parentNode.appendChild(previewContainer);
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewContainer.querySelector('img').src = e.target.result;
                        }
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
            
            // Form validation
            directBookingForm.addEventListener('submit', function(e) {
                if (!directStartDate.value || !directEndDate.value) {
                    e.preventDefault();
                    alert("يرجى تحديد تاريخ الاستلام وتاريخ التسليم");
                    return false;
                }
                
                const startDate = new Date(directStartDate.value);
                const endDate = new Date(directEndDate.value);
                
                if (endDate < startDate) {
                    e.preventDefault();
                    alert("يجب أن يكون تاريخ التسليم بعد تاريخ الاستلام");
                    return false;
                }
                
                const cardNumber = directBookingForm.querySelector('input[name="card_number"]')?.value;
                const cardName = directBookingForm.querySelector('input[name="card_name"]')?.value;
                const expiryMonth = directBookingForm.querySelector('select[name="expiry_month"]')?.value;
                const expiryYear = directBookingForm.querySelector('select[name="expiry_year"]')?.value;
                const cvv = directBookingForm.querySelector('input[name="cvv"]')?.value;
                
                if (cardNumber && cardName && expiryMonth && expiryYear && cvv) {
                    if (!/^\d{16}$/.test(cardNumber.replace(/\s/g, ''))) {
                        e.preventDefault();
                        alert("يرجى إدخال رقم بطاقة صحيح (16 رقم)");
                        return false;
                    }
                    
                    if (!/^\d{3,4}$/.test(cvv)) {
                        e.preventDefault();
                        alert("يرجى إدخال رمز أمان صحيح (3-4 أرقام)");
                        return false;
                    }
                }
                
                return true;
            });
        }
    });
</script>
{% endblock %}
