{% extends "admin_layout.html" %}
{% load i18n %}
{% load static %}

{% block title %}إدارة الحجوزات{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0">إدارة الحجوزات</h2>
        <div class="admin-filters">
            <form method="get" class="d-flex gap-2">
                <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="" {% if not status %}selected{% endif %}>كل الحالات</option>
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>قيد المراجعة</option>
                    <option value="confirmed" {% if status == 'confirmed' %}selected{% endif %}>تمت الموافقة</option>
                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>مكتمل</option>
                    <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>ملغي</option>
                </select>
                <select name="payment_status" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="" {% if not payment_status %}selected{% endif %}>كل حالات الدفع</option>
                    <option value="pending" {% if payment_status == 'pending' %}selected{% endif %}>في انتظار الدفع</option>
                    <option value="paid" {% if payment_status == 'paid' %}selected{% endif %}>مدفوع</option>
                    <option value="refunded" {% if payment_status == 'refunded' %}selected{% endif %}>مسترجع</option>
                </select>
                <input type="text" name="search" placeholder="بحث..." class="form-control form-control-sm" value="{{ search|default:'' }}">
                <button type="submit" class="btn btn-sm btn-primary">بحث</button>
            </form>
        </div>
    </div>
    
    <!-- رابط للتقارير التحليلية الموحدة -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4 text-center">
            <h3 class="h5 mb-3">البيانات التحليلية</h3>
            <p class="mb-3">لعرض جميع التقارير التحليلية والرسوم البيانية الخاصة بالحجوزات، يرجى الانتقال إلى قسم التقارير التحليلية الموحد</p>
            <a href="{% url 'admin_payment_analytics' %}" class="btn btn-primary">
                <i class="fas fa-chart-line ms-2"></i>
                عرض التقارير التحليلية للحجوزات
            </a>
        </div>
    </div>
    
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">العميل</th>
                            <th scope="col">السيارة</th>
                            <th scope="col">التواريخ</th>
                            <th scope="col">المبلغ</th>
                            <th scope="col">حالة الحجز</th>
                            <th scope="col">حالة الدفع</th>
                            <th scope="col">تاريخ الإنشاء</th>
                            <th scope="col" class="text-center">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reservation in reservations %}
                        <tr>
                            <td><strong>{{ reservation.id }}</strong></td>
                            <td>
                                <div>{{ reservation.user.get_full_name }}</div>
                                <small class="text-muted">{{ reservation.user.email }}</small>
                            </td>
                            <td>
                                <div>{{ reservation.car.make }} {{ reservation.car.model }}</div>
                                <small class="text-muted">{{ reservation.car.year }}</small>
                            </td>
                            <td>
                                <div>{{ reservation.start_date|date:"Y/m/d" }} - {{ reservation.end_date|date:"Y/m/d" }}</div>
                                <small class="text-muted">{{ reservation.start_date|timesince:reservation.end_date|slice:":-1" }} يوم</small>
                            </td>
                            <td>{{ reservation.total_price }} دينار</td>
                            <td>
                                {% if reservation.status == 'pending' %}
                                <span class="badge bg-warning">قيد المراجعة</span>
                                {% elif reservation.status == 'confirmed' %}
                                <span class="badge bg-success">تمت الموافقة</span>
                                {% elif reservation.status == 'completed' %}
                                <span class="badge bg-info">مكتمل</span>
                                {% elif reservation.status == 'cancelled' %}
                                <span class="badge bg-danger">ملغي</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if reservation.payment_status == 'pending' %}
                                <span class="badge bg-secondary">في انتظار الدفع</span>
                                {% elif reservation.payment_status == 'paid' %}
                                <span class="badge bg-success">مدفوع</span>
                                {% elif reservation.payment_status == 'refunded' %}
                                <span class="badge bg-danger">مسترجع</span>
                                {% endif %}
                            </td>
                            <td>{{ reservation.created_at|date:"Y/m/d H:i" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- View details button -->
                                    <a href="{% url 'admin_reservation_detail' reservation_id=reservation.id %}" class="btn btn-outline-primary">
                                        <i class="fas fa-eye ms-1"></i> عرض</a>
                                    
                                    <!-- If reservation is pending, show approve button -->
                                    {% if reservation.status == 'pending' %}
                                    <a href="{% url 'update_reservation_status' reservation_id=reservation.id status='confirmed' %}" class="btn btn-outline-success">
                                        <i class="fas fa-check ms-1"></i> قبول</a>
                                    {% endif %}
                                    
                                    <!-- If reservation is not cancelled, show cancel button -->
                                    {% if reservation.status != 'cancelled' %}
                                    <a href="{% url 'update_reservation_status' reservation_id=reservation.id status='cancelled' %}" class="btn btn-outline-danger">
                                        <i class="fas fa-times ms-1"></i> إلغاء</a>
                                    {% endif %}
                                    
                                    <!-- If reservation is confirmed and not paid, show mark as paid button -->
                                    {% if reservation.status == 'confirmed' and reservation.payment_status == 'pending' %}
                                    <a href="{% url 'mark_as_paid' payment_id=reservation.id %}" class="btn btn-outline-warning">
                                        <i class="fas fa-money-bill ms-1"></i> دفع</a>
                                    {% endif %}
                                    
                                    <!-- If reservation is confirmed and paid, show complete button -->
                                    {% if reservation.status == 'confirmed' and reservation.payment_status == 'paid' %}
                                    <a href="{% url 'update_reservation_status' reservation_id=reservation.id status="completed" %}" class="btn btn-outline-info">
                                        <i class="fas fa-flag-checkered ms-1"></i>  </a>
                                    {% endif %}
                                    
                                    <!-- Delete permanently button (always shown) -->
                                    <a href="{% url 'delete_reservation' reservation_id=reservation.id %}" class="btn btn-outline-danger" onclick="return confirm('هل أنت متأكد من رغبتك في حذف هذا الحجز بشكل نهائي؟');">
                                        <i class="fas fa-trash-alt ms-1"></i> حذف</a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-calendar-times fa-3x text-muted mb-3 ms-1"></i>  <h5>لا توجد حجوزات</h5>
                                    <p class="text-muted">لم يتم العثور على أي حجوزات تطابق معايير البحث.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Status Summary Cards -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">قيد المراجعة</h6>
                            <h2 class="my-2">{{ pending_count }}</h2>
                            <p class="card-text mb-0">
                                <small class="text-muted">بانتظار الموافقة</small>
                            </p>
                        </div>
                        <div class="text-warning">
                            <i class="fas fa-clock fa-2x ms-1"></i>  </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">تمت الموافقة</h6>
                            <h2 class="my-2">{{ confirmed_count }}</h2>
                            <p class="card-text mb-0">
                                <small class="text-muted">بانتظار الدفع</small>
                            </p>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-check-circle fa-2x ms-1"></i>  </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">مكتمل</h6>
                            <h2 class="my-2">{{ completed_count }}</h2>
                            <p class="card-text mb-0">
                                <small class="text-muted">حجوزات مكتملة</small>
                            </p>
                        </div>
                        <div class="text-info">
                            <i class="fas fa-flag-checkered fa-2x ms-1"></i>  </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">ملغاة</h6>
                            <h2 class="my-2">{{ cancelled_count }}</h2>
                            <p class="card-text mb-0">
                                <small class="text-muted">حجوزات ملغاة</small>
                            </p>
                        </div>
                        <div class="text-danger">
                            <i class="fas fa-ban fa-2x ms-1"></i>  </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if reservations.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if reservations.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if status %}&status={{ status }}{% endif %}{% if payment_status %}&payment_status={{ payment_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ reservations.previous_page_number }}{% if status %}&status={{ status }}{% endif %}{% if payment_status %}&payment_status={{ payment_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}
            
            {% for i in reservations.paginator.page_range %}
                {% if reservations.number == i %}
                <li class="page-item active">
                    <a class="page-link" href="#">{{ i }}</a>
                </li>
                {% elif i > reservations.number|add:'-3' and i < reservations.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ i }}{% if status %}&status={{ status }}{% endif %}{% if payment_status %}&payment_status={{ payment_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}">{{ i }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if reservations.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ reservations.next_page_number }}{% if status %}&status={{ status }}{% endif %}{% if payment_status %}&payment_status={{ payment_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ reservations.paginator.num_pages }}{% if status %}&status={{ status }}{% endif %}{% if payment_status %}&payment_status={{ payment_status }}{% endif %}{% if search %}&search={{ search }}{% endif %}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<style>
    .empty-state {
        text-align: center;
        padding: 20px;
    }
</style>
{% endblock %}
