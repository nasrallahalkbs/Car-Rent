<!-- CACHE_BUSTER 1747528990 -->{% extends "admin/enhanced/admin_layout.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {% if is_add %}
        {% trans "إضافة عهدة جديدة" %}
    {% else %}
        {% trans "تعديل العهدة" %}
    {% endif %} - {% trans "كاررنتال" %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* أنماط خاصة بصفحة نموذج العهدة */
    .custody-form-card {
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        background: #fff;
        margin-bottom: 1.5rem;
    }
    
    .custody-form-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .custody-form-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
        color: #1f2937;
    }
    
    .custody-form-body {
        padding: 1.5rem;
    }
    
    .custody-form-footer {
        padding: 1.25rem 1.5rem;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }
    
    /* تخصيص نموذج Crispy */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .asteriskField {
        color: #ef4444;
        margin-right: 0.25rem;
    }
    
    /* تنسيق الحقول */
    .form-control:focus,
    .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }
    
    /* مساعدة للحقول */
    .help-block {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    /* Flatpickr custom styles */
    .flatpickr-day.selected, 
    .flatpickr-day.startRange, 
    .flatpickr-day.endRange, 
    .flatpickr-day.selected.inRange, 
    .flatpickr-day.startRange.inRange, 
    .flatpickr-day.endRange.inRange, 
    .flatpickr-day.selected:focus, 
    .flatpickr-day.startRange:focus, 
    .flatpickr-day.endRange:focus, 
    .flatpickr-day.selected:hover, 
    .flatpickr-day.startRange:hover, 
    .flatpickr-day.endRange:hover, 
    .flatpickr-day.selected.prevMonthDay, 
    .flatpickr-day.startRange.prevMonthDay, 
    .flatpickr-day.endRange.prevMonthDay, 
    .flatpickr-day.selected.nextMonthDay, 
    .flatpickr-day.startRange.nextMonthDay, 
    .flatpickr-day.endRange.nextMonthDay {
        background: #3b82f6;
        border-color: #3b82f6;
    }
    
    /* تم إزالة تعريفات CSS لحقول غير موجودة */
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <form method="post" id="custodyForm">
                {% csrf_token %}
                {% if next %}
                    <input type="hidden" name="next" value="{{ next }}">
                {% endif %}
                
                <div class="custody-form-card">
                    <div class="custody-form-header">
                        <h5 class="custody-form-title">{% trans "معلومات العهدة الأساسية" %}</h5>
                    </div>
                    <div class="custody-form-body">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.name|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.guarantee_type|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.category|as_crispy_field }}
                            </div>
                            <div class="col-md-6 custody-field-cash">
                                {{ form.value|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- حقول مخصصة حسب نوع العهدة -->
                        <div class="row custody-field-credit_card">
                            <div class="col-md-12">
                                {{ form.credit_card_info|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row custody-field-property">
                            <div class="col-md-12">
                                {{ form.property_description|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row custody-field-insurance">
                            <div class="col-md-12">
                                {{ form.insurance_policy_number|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.identifier|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.reservation|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.handover_date|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- وصف العهدة -->
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.description|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- الملاحظات -->
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.notes|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    <div class="custody-form-footer">
                        <a href="{% if next %}{{ next }}{% else %}{% url 'custody_list' %}{% endif %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>{% trans "إلغاء" %}
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if is_add %}
                                {% trans "إضافة العهدة" %}
                            {% else %}
                                {% trans "حفظ التغييرات" %}
                            {% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// تهيئة منتقي التاريخ
document.addEventListener('DOMContentLoaded', function() {
    flatpickr("#id_handover_date", {
        dateFormat: "Y-m-d",
        locale: {
            firstDayOfWeek: 6, // السبت كأول يوم في الأسبوع
            weekdays: {
                shorthand: ["أحد", "اثنين", "ثلاثاء", "أربعاء", "خميس", "جمعة", "سبت"],
                longhand: ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"]
            },
            months: {
                shorthand: ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"],
                longhand: ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"]
            }
        },
        defaultDate: "{% if form.handover_date.value %}{{ form.handover_date.value|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}"
    });
});
</script>

<script>
// سكريبت محسن لإدارة حقول نموذج العهدة
document.addEventListener('DOMContentLoaded', function() {
    // حقل اختيار نوع العهدة
    var guaranteeTypeSelect = document.getElementById('id_guarantee_type');
    if (!guaranteeTypeSelect) return;

    console.log("تم تهيئة سكريبت إخفاء وإظهار حقول العهدة");

    // جميع حقول العهدة
    var cashFields = document.querySelectorAll('.custody-field-cash');
    var creditCardFields = document.querySelectorAll('.custody-field-credit_card');
    var propertyFields = document.querySelectorAll('.custody-field-property');
    var insuranceFields = document.querySelectorAll('.custody-field-insurance');

    console.log("عدد حقول النقد: " + cashFields.length);
    console.log("عدد حقول بطاقة الائتمان: " + creditCardFields.length);
    console.log("عدد حقول الممتلكات: " + propertyFields.length);
    console.log("عدد حقول التأمين: " + insuranceFields.length);

    // إخفاء جميع الحقول في البداية بشكل مباشر
    var allFields = [].concat(
        Array.from(cashFields),
        Array.from(creditCardFields),
        Array.from(propertyFields),
        Array.from(insuranceFields)
    );
    
    allFields.forEach(function(field) {
        field.style.display = 'none';
    });

    // دالة لتحديث الحقول المرئية
    function updateVisibleFields() {
        var selectedType = guaranteeTypeSelect.value;
        console.log("تم اختيار نوع العهدة: " + selectedType);

        // إخفاء جميع الحقول أولاً
        allFields.forEach(function(field) {
            field.style.display = 'none';
        });

        // إظهار الحقول المناسبة فقط حسب النوع المحدد
        if (selectedType === 'cash' || selectedType === 'bank_deposit' || selectedType === 'other') {
            cashFields.forEach(function(field) {
                field.style.display = 'block';
            });
            console.log("تم إظهار حقول النقد");
        } else if (selectedType === 'credit_card') {
            creditCardFields.forEach(function(field) {
                field.style.display = 'block';
            });
            console.log("تم إظهار حقول بطاقة الائتمان");
        } else if (selectedType === 'property') {
            propertyFields.forEach(function(field) {
                field.style.display = 'block';
            });
            console.log("تم إظهار حقول الممتلكات");
        } else if (selectedType === 'insurance') {
            insuranceFields.forEach(function(field) {
                field.style.display = 'block';
            });
            console.log("تم إظهار حقول التأمين");
        }
    }

    // إضافة معالج حدث لتغيير نوع العهدة
    guaranteeTypeSelect.addEventListener('change', updateVisibleFields);
    
    // تنفيذ الدالة عند تحميل الصفحة لتطبيق التخصيص الأولي
    // استخدام setTimeout لضمان تنفيذ الكود بعد اكتمال تحميل الصفحة
    setTimeout(function() {
        updateVisibleFields();
        console.log("تم تطبيق إخفاء/إظهار الحقول عند التحميل");
    }, 100);
});
</script>
{% endblock %}