<!-- CACHE_BUSTER 1747528990 -->{% extends "admin/enhanced/admin_layout.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {% if is_add %}
        {% trans "إضافة عهدة جديدة" %}
    {% else %}
        {% trans "تعديل العهدة" %}
    {% endif %} - {% trans "كاررنتال" %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* أنماط خاصة بصفحة نموذج العهدة */
    .custody-form-card {
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        background: #fff;
        margin-bottom: 1.5rem;
    }
    
    .custody-form-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .custody-form-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
        color: #1f2937;
    }
    
    .custody-form-body {
        padding: 1.5rem;
    }
    
    .custody-form-footer {
        padding: 1.25rem 1.5rem;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }
    
    /* تخصيص نموذج Crispy */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .asteriskField {
        color: #ef4444;
        margin-right: 0.25rem;
    }
    
    /* تنسيق الحقول */
    .form-control:focus,
    .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }
    
    /* مساعدة للحقول */
    .help-block {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    /* Flatpickr custom styles */
    .flatpickr-day.selected, 
    .flatpickr-day.startRange, 
    .flatpickr-day.endRange, 
    .flatpickr-day.selected.inRange, 
    .flatpickr-day.startRange.inRange, 
    .flatpickr-day.endRange.inRange, 
    .flatpickr-day.selected:focus, 
    .flatpickr-day.startRange:focus, 
    .flatpickr-day.endRange:focus, 
    .flatpickr-day.selected:hover, 
    .flatpickr-day.startRange:hover, 
    .flatpickr-day.endRange:hover, 
    .flatpickr-day.selected.prevMonthDay, 
    .flatpickr-day.startRange.prevMonthDay, 
    .flatpickr-day.endRange.prevMonthDay, 
    .flatpickr-day.selected.nextMonthDay, 
    .flatpickr-day.startRange.nextMonthDay, 
    .flatpickr-day.endRange.nextMonthDay {
        background: #3b82f6;
        border-color: #3b82f6;
    }
    
    /* تم إزالة تعريفات CSS لحقول غير موجودة */
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <form method="post" id="custodyForm">
                {% csrf_token %}
                {% if next %}
                    <input type="hidden" name="next" value="{{ next }}">
                {% endif %}
                
                <div class="custody-form-card">
                    <div class="custody-form-header">
                        <h5 class="custody-form-title">{% trans "معلومات العهدة الأساسية" %}</h5>
                    </div>
                    <div class="custody-form-body">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.name|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.guarantee_type|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.category|as_crispy_field }}
                            </div>
                            <div class="col-md-6" id="value_field">
                                {{ form.value|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- حقول مخصصة حسب نوع العهدة -->
                        <div class="row" id="credit_card_fields" style="display: none;">
                            <div class="col-md-12">
                                {{ form.credit_card_info|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row" id="property_fields" style="display: none;">
                            <div class="col-md-12">
                                {{ form.property_description|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row" id="insurance_fields" style="display: none;">
                            <div class="col-md-12">
                                {{ form.insurance_policy_number|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.identifier|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.reservation|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.handover_date|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- وصف العهدة -->
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.description|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- الملاحظات -->
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.notes|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    <div class="custody-form-footer">
                        <a href="{% if next %}{{ next }}{% else %}{% url 'custody_list' %}{% endif %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>{% trans "إلغاء" %}
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if is_add %}
                                {% trans "إضافة العهدة" %}
                            {% else %}
                                {% trans "حفظ التغييرات" %}
                            {% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تهيئة منتقي التاريخ
        flatpickr("#id_handover_date", {
            dateFormat: "Y-m-d",
            locale: {
                firstDayOfWeek: 6, // السبت كأول يوم في الأسبوع
                weekdays: {
                    shorthand: ["أحد", "اثنين", "ثلاثاء", "أربعاء", "خميس", "جمعة", "سبت"],
                    longhand: ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"]
                },
                months: {
                    shorthand: ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"],
                    longhand: ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"]
                }
            },
            defaultDate: "{% if form.handover_date.value %}{{ form.handover_date.value|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}"
        });
        
        // حذفنا تهيئة حقل تاريخ انتهاء الصلاحية حيث أنه غير موجود في النموذج
    });
</script>

<!-- إضافة سكريبت التحكم في نموذج العهدة -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // البحث عن جميع حقول النموذج
        var guaranteeTypeField = document.getElementById('id_guarantee_type');
        var valueField = document.getElementById('id_value');
        var creditCardField = document.getElementById('id_credit_card_info');
        var propertyField = document.getElementById('id_property_description');
        var insuranceField = document.getElementById('id_insurance_policy_number');
        
        // البحث عن مجموعات النموذج (form-group) للحقول
        var valueFormGroup = valueField ? valueField.closest('.form-group') : null;
        var creditCardFormGroup = creditCardField ? creditCardField.closest('.form-group') : null;
        var propertyFormGroup = propertyField ? propertyField.closest('.form-group') : null;
        var insuranceFormGroup = insuranceField ? insuranceField.closest('.form-group') : null;
        
        console.log("تم تحميل سكريبت نموذج العهدة");
        console.log("حقل القيمة موجود:", valueFormGroup !== null);
        console.log("حقل البطاقة الائتمانية موجود:", creditCardFormGroup !== null);
        console.log("حقل وصف الممتلكات موجود:", propertyFormGroup !== null);
        console.log("حقل رقم التأمين موجود:", insuranceFormGroup !== null);
        
        // طريقة بديلة للعثور على الحقول إذا لم يتم العثور عليها عن طريق معرفات الحقول
        if (!valueFormGroup || !creditCardFormGroup || !propertyFormGroup || !insuranceFormGroup) {
            console.log("استخدام طريقة بديلة للعثور على حقول النموذج");
            
            var allFormGroups = document.querySelectorAll('.form-group');
            allFormGroups.forEach(function(group) {
                var label = group.querySelector('label');
                if (label) {
                    var labelText = label.textContent;
                    
                    if (labelText.includes('قيمة العهدة') && !valueFormGroup) {
                        valueFormGroup = group;
                        console.log("تم العثور على حقل القيمة");
                    }
                    else if (labelText.includes('معلومات البطاقة الائتمانية') && !creditCardFormGroup) {
                        creditCardFormGroup = group;
                        console.log("تم العثور على حقل البطاقة الائتمانية");
                    }
                    else if (labelText.includes('وصف الممتلكات العقارية') && !propertyFormGroup) {
                        propertyFormGroup = group;
                        console.log("تم العثور على حقل وصف الممتلكات");
                    }
                    else if (labelText.includes('رقم بوليصة التأمين') && !insuranceFormGroup) {
                        insuranceFormGroup = group;
                        console.log("تم العثور على حقل رقم التأمين");
                    }
                }
            });
        }
        
        // تحديث عرض الحقول بناءً على نوع العهدة
        function updateFieldsVisibility() {
            if (!guaranteeTypeField) {
                console.log("لم يتم العثور على حقل نوع العهدة!");
                return;
            }
            
            var guaranteeType = guaranteeTypeField.value;
            console.log("نوع العهدة المختار:", guaranteeType);
            
            // إخفاء جميع الحقول المخصصة أولاً
            if (creditCardFormGroup) creditCardFormGroup.style.display = 'none';
            if (propertyFormGroup) propertyFormGroup.style.display = 'none';
            if (insuranceFormGroup) insuranceFormGroup.style.display = 'none';
            
            // أنواع العهدات التي تتطلب حقل القيمة
            var typesRequiringValue = ['cash', 'bank_deposit', 'other'];
            
            // إظهار/إخفاء حقل القيمة
            if (valueFormGroup) {
                valueFormGroup.style.display = typesRequiringValue.includes(guaranteeType) ? '' : 'none';
                console.log("حالة عرض حقل القيمة:", typesRequiringValue.includes(guaranteeType));
                
                // إعادة تعيين قيمة الحقل إلى 0 عند إخفائه
                if (!typesRequiringValue.includes(guaranteeType) && valueField) {
                    valueField.value = '0';
                }
            }
            
            // إظهار الحقل المناسب حسب نوع العهدة
            switch (guaranteeType) {
                case 'credit_card':
                    if (creditCardFormGroup) {
                        creditCardFormGroup.style.display = '';
                        console.log("تم إظهار حقل معلومات البطاقة الائتمانية");
                    }
                    break;
                case 'property':
                    if (propertyFormGroup) {
                        propertyFormGroup.style.display = '';
                        console.log("تم إظهار حقل وصف الممتلكات العقارية");
                    }
                    break;
                case 'insurance':
                    if (insuranceFormGroup) {
                        insuranceFormGroup.style.display = '';
                        console.log("تم إظهار حقل رقم بوليصة التأمين");
                    }
                    break;
            }
        }
        
        // إضافة مستمع أحداث لحقل نوع العهدة
        if (guaranteeTypeField) {
            guaranteeTypeField.addEventListener('change', updateFieldsVisibility);
            // تنفيذ الدالة عند تحميل الصفحة
            updateFieldsVisibility();
        }
    });
</script>
{% endblock %}