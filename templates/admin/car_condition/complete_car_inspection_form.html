{% extends "admin/admin_layout.html" %}
{% load i18n %}
{% load car_extras %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ title }}</h5>
                        <a href="{% url 'car_condition_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-right ms-1"></i> {% trans "العودة للقائمة" %}
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" class="car-inspection-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- بيانات السيارة والحجز -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="section-card mb-4">
                                    <div class="section-header">
                                        <i class="fas fa-car-side me-2"></i> {% trans "معلومات أساسية" %}
                                    </div>
                                    <div class="section-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                {{ form.reservation|as_crispy_field }}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.car|as_crispy_field }}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.report_type|as_crispy_field }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                {{ form.date|as_crispy_field }}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.mileage|as_crispy_field }}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.fuel_level|as_crispy_field }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                {{ form.car_condition|as_crispy_field }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- تفاصيل الفحص -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="section-card mb-4">
                                    <div class="section-header">
                                        <i class="fas fa-clipboard-check me-2"></i> {% trans "قائمة الفحص" %}
                                    </div>
                                    <div class="section-body">
                                        <div class="accordion" id="inspectionAccordion">
                                            {% comment %} 
                                            هنا سيتم إنشاء عناصر الفحص ديناميكياً من النموذج حسب الفئات
                                            يتم استخراجها من الحقول الديناميكية التي تم إنشاؤها في النموذج
                                            {% endcomment %}
                                            
                                            {% regroup form.fields.items by key.0.split.item_|first as inspection_fields %}
                                            
                                            {% for group in inspection_fields %}
                                                {% if 'item_' in group.grouper %}
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="true" aria-controls="collapse{{ forloop.counter }}">
                                                                {% trans "فئة الفحص" %} #{{ forloop.counter }}
                                                            </button>
                                                        </h2>
                                                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse show" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#inspectionAccordion">
                                                            <div class="accordion-body">
                                                                <div class="table-responsive">
                                                                    <table class="table table-bordered inspection-table">
                                                                        <thead class="table-light">
                                                                            <tr>
                                                                                <th width="30%">{% trans "عنصر الفحص" %}</th>
                                                                                <th width="20%">{% trans "الحالة" %}</th>
                                                                                <th width="50%">{% trans "ملاحظات" %}</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {% for field_name, field in form.fields.items %}
                                                                                {% if field_name.startswith 'item_' and not field_name.endswith '_notes' %}
                                                                                    <tr>
                                                                                        <td>{{ field.label }}</td>
                                                                                        <td>{{ form|get_field:field_name }}</td>
                                                                                        <td>{{ form|get_field:field_name|add:'_notes' }}</td>
                                                                                    </tr>
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- الأضرار والملاحظات -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="section-card mb-4">
                                    <div class="section-header">
                                        <i class="fas fa-exclamation-triangle me-2"></i> {% trans "الأضرار والملاحظات" %}
                                    </div>
                                    <div class="section-body">
                                        <div class="row">
                                            <div class="col-md-12">
                                                {{ form.notes|as_crispy_field }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                {{ form.defects|as_crispy_field }}
                                            </div>
                                            <div class="col-md-6">
                                                {{ form.defect_cause|as_crispy_field }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                {{ form.repair_cost|as_crispy_field }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- أزرار التحكم -->
                        <div class="row">
                            <div class="col-md-12 text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> {% trans "حفظ التقرير" %}
                                </button>
                                <a href="{% url 'car_condition_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> {% trans "إلغاء" %}
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .section-card {
        border: 1px solid rgba(0,0,0,.125);
        border-radius: 0.25rem;
    }
    
    .section-header {
        padding: 1rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
        font-weight: 600;
    }
    
    .section-body {
        padding: 1.5rem;
    }
    
    .inspection-table {
        margin-bottom: 0;
    }
    
    .inspection-table textarea {
        min-height: 80px;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: #f0f7ff;
        color: #0d6efd;
    }
    
    .condition-excellent, .select-excellent {
        background-color: #d4edda !important;
        color: #155724 !important;
    }
    
    .condition-good, .select-good {
        background-color: #d1ecf1 !important;
        color: #0c5460 !important;
    }
    
    .condition-fair, .select-fair {
        background-color: #fff3cd !important;
        color: #856404 !important;
    }
    
    .condition-poor, .select-poor {
        background-color: #f8d7da !important;
        color: #721c24 !important;
    }
    
    .condition-damaged, .select-damaged {
        background-color: #f1aeb5 !important;
        color: #58151c !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // نص JavaScript للتفاعل مع النموذج
    $(document).ready(function() {
        // إضافة تأثيرات CSS لاختيارات الحالة
        $('select[name^="item_"]').change(function() {
            var selectedValue = $(this).val();
            $(this).removeClass('select-excellent select-good select-fair select-poor select-damaged');
            if (selectedValue) {
                $(this).addClass('select-' + selectedValue);
            }
        });
        
        // تحديث السيارة عند تغيير الحجز
        $('#id_reservation').change(function() {
            var reservationId = $(this).val();
            if (reservationId) {
                // استدعاء وظيفة AJAX لجلب بيانات السيارة
                $.ajax({
                    url: '{% url "get_car_by_reservation" %}',
                    data: { 'reservation_id': reservationId },
                    dataType: 'json',
                    success: function(data) {
                        $('#id_car').val(data.car_id);
                    },
                    error: function(error) {
                        console.log('Error fetching car data:', error);
                    }
                });
            }
        });
        
        // تطبيق التأثيرات على القائمة عند التحميل
        $('select[name^="item_"]').each(function() {
            var selectedValue = $(this).val();
            if (selectedValue) {
                $(this).addClass('select-' + selectedValue);
            }
        });
    });
</script>
{% endblock %}