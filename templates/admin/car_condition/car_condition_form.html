<!-- CACHE_BUSTER 1746751077 --><!-- CACHE_BUSTER 1746750932 -->{% extends "admin/enhanced/admin_layout.html" %}
{% load static %}
{% load i18n %}
{% load rental_extras %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    /* سيتم التحكم بإظهار وإخفاء أقسام الفحص من خلال جافاسكريبت */
    .fuel-level-selector {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
    }
    
    .fuel-level-option {
        text-align: center;
        cursor: pointer;
    }
    
    .fuel-level-option.selected {
        font-weight: bold;
    }
    
    .fuel-gauge {
        width: 100%;
        background-color: #f5f5f5;
        border-radius: 5px;
        overflow: hidden;
        height: 20px;
    }
    
    .fuel-gauge-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.3s;
    }
    
    /* أنماط الهيكل الخارجي */
    .image-input-container {
        width: 100%;
        height: 150px;
        border: 2px dashed #ced4da;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        background-color: #f8f9fa;
        position: relative;
        transition: all 0.3s;
    }
    
    .image-input-container:hover {
        border-color: #6c757d;
        background-color: #f2f2f2;
    }
    
    .upload-placeholder {
        text-align: center;
    }
    
    .preview-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    /* أنماط قسم الصور الجديدة */
    .car-image-section {
        margin-bottom: 10px;
    }
    
    .car-image-container {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px;
        height: 100%;
        background-color: #f8f9fa;
        transition: all 0.2s;
    }
    
    .car-image-container:hover {
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    
    .car-image-box {
        width: 40px; /* عرض ثابت - 4 سم */
        height: 60px; /* ارتفاع ثابت - 6 سم */
        margin: 0 auto; /* توسيط العنصر */
        border: 1px solid #ddd;
        border-radius: 3px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        position: relative;
        background-color: #fff;
        overflow: hidden; /* منع تجاوز المحتوى للحدود */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .car-image-box:hover {
        border-color: #6c757d;
        box-shadow: 0 0 3px rgba(0,0,0,0.1);
    }
    
    .car-image-box i {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1rem; /* تصغير أيقونة الكاميرا للتناسب مع الحجم الجديد */
        color: #adb5bd;
        z-index: 1;
    }
    
    .car-image-preview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; /* تغطية المساحة بشكل كامل */
        display: none; /* سيتم تغييره إلى block عبر JavaScript عند تحديد صورة */
        z-index: 2; /* ضمان أن الصورة فوق أيقونة الكاميرا */
        padding: 0; /* إزالة الهامش الداخلي تماماً */
        border-radius: 2px; /* حواف مستديرة للصورة */
    }
    
    /* أنماط النافذة المنبثقة لعرض الصورة بالحجم الكامل */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        overflow: auto;
    }
    
    .image-modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        object-fit: contain;
        padding: 10px;
        animation: zoom 0.3s;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    
    @keyframes zoom {
        from {transform: scale(0.1)} 
        to {transform: scale(1)}
    }
    
    .image-modal-close {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
    }
    
    .image-modal-close:hover {
        color: #bbb;
    }
    
    .image-preview-container {
        position: relative;
    }
    
    .fullscreen-hint {
        position: absolute;
        bottom: 1px;
        right: 1px;
        background-color: rgba(0,0,0,0.5);
        color: white;
        border-radius: 50%;
        width: 8px;
        height: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        opacity: 0.7;
        transition: opacity 0.2s;
        font-size: 0.4rem;
        cursor: pointer;
    }
    
    .car-image-box:hover .fullscreen-hint {
        opacity: 1;
    }
    
    /* عند تحميل الصورة سيظهر كود المعاينة */
    .car-image-preview.show {
        display: block !important;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
    
    /* عند تحميل صورة، إخفاء أيقونة الكاميرا */
    .car-image-box.has-image i.fa-camera {
        display: none;
    }
    
    .car-image-notes {
        font-size: 0.8rem;
        color: #495057;
        margin-top: 2px;
        padding: 2px 5px;
        height: 22px;
        min-height: 22px;
    }
    
    /* تأثير النبض على قسم الفحص الإلكتروني النشط */
    @keyframes pulse-animation {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.5); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .pulse-animation {
        animation: pulse-animation 2s infinite;
    }
    
    /* تحسين أسلوب زر الحفظ */
    button[type="submit"] {
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    button[type="submit"]:active {
        transform: translateY(0);
        box-shadow: none;
    }
</style>
{% endblock %}

{% block content %}
<script>
// سكريبت إضافي للتأكد من تفعيل وظيفة إظهار/إخفاء أقسام الفحص
function setupInspectionToggle() {
    // تحديد المقاطع الرئيسية
    var electronicSection = document.getElementById('electronic-inspection-section');
    var manualSection = document.getElementById('manual-inspection-section');
    
    if (!electronicSection || !manualSection) {
        console.error("لم يتم العثور على عناصر الفحص");
        return;
    }
    
    // إخفاء كلا القسمين ابتداءً
    electronicSection.style.display = 'none';
    manualSection.style.display = 'none';
    
    // الحصول على قيمة الاختيار الحالية
    var select = document.getElementById('{{ form.inspection_type.id_for_label }}');
    if (!select) {
        console.error("لم يتم العثور على حقل نوع الفحص");
        return;
    }
    
    // وظيفة لتحديث العرض بناءً على قيمة الاختيار
    function updateSections() {
        var selectedValue = select.value;
        
        if (selectedValue === 'electronic') {
            electronicSection.style.display = 'block';
            manualSection.style.display = 'none';
        } else {
            electronicSection.style.display = 'none';
            manualSection.style.display = 'block';
        }
    }
    
    // تحديث العرض عند بدء التشغيل
    updateSections();
    
    // إضافة مستمع للتغييرات
    select.addEventListener('change', updateSections);
}

// تنفيذ عند تحميل الصفحة مباشرة
window.addEventListener('DOMContentLoaded', setupInspectionToggle);
// تنفيذ مرة إضافية بعد جاهزية المستند للتأكد
window.addEventListener('load', setupInspectionToggle);
// استخدام جيكويري أيضاً للتأكد
$(document).ready(setupInspectionToggle);
</script>

<div class="container-fluid mt-3">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">{{ title }}</h5>
                <a href="{% url 'car_condition_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i> {% trans "العودة للقائمة" %}
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="post" action="" class="needs-validation" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "معلومات أساسية" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.reservation.id_for_label }}" class="form-label">{{ form.reservation.label }}</label>
                                        {{ form.reservation }}
                                        {% if form.reservation.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.reservation.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.car.id_for_label }}" class="form-label">{{ form.car.label }}</label>
                                        {{ form.car }}
                                        {% if form.car.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.car.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.report_type.id_for_label }}" class="form-label">{{ form.report_type.label }}</label>
                                        {{ form.report_type }}
                                        {% if form.report_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.report_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.inspection_type.id_for_label }}" class="form-label">{{ form.inspection_type.label }}</label>
                                        {{ form.inspection_type }}
                                        {% if form.inspection_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.inspection_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
                                        {{ form.date }}
                                        {% if form.date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "حالة السيارة (العناصر الرئيسية فقط)" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.mileage.id_for_label }}" class="form-label">{{ form.mileage.label }}</label>
                                        {{ form.mileage }}
                                        {% if form.mileage.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.mileage.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="{{ form.car_condition.id_for_label }}" class="form-label">{{ form.car_condition.label }}</label>
                                        {{ form.car_condition }}
                                        {% if form.car_condition.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.car_condition.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                        
                                    <div class="col-md-6">
                                        <label for="{{ form.fuel_level.id_for_label }}" class="form-label">{{ form.fuel_level.label }}</label>
                                        {{ form.fuel_level }}
                                        {% if form.fuel_level.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.fuel_level.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        
                                    </div>
                                    
                                    <!-- تم إزالة حقل "نوع الفحص" من هنا لمنع التكرار، حيث أنه موجود بالفعل في قسم "معلومات أساسية" -->
                                    <!-- بدلاً من ذلك، نضيف حقل غير مرئي يحتوي على تعليمات -->
                                    <div class="col-md-4">
                                        <div class="alert alert-info p-2 mb-0 text-center info-message">
                                            <small>
                                                <i class="fas fa-info-circle me-1"></i>
                                                {% if form.inspection_type.value == 'electronic' %}
                                                    {% trans "الفحص الإلكتروني: قم برفع ملف PDF" %}
                                                {% else %}
                                                    {% trans "الفحص اليدوي: قم بتحديد العناصر المهمة" %}
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تم إزالة قسم الصيانة والإصلاح غير المهم -->
                </div>
                
                <!-- حذف قسم الملاحظات الإضافية للتبسيط -->
                
                <!-- قسم الهيكل الخارجي -->
                <div class="row mb-2">
                    <div class="col-md-12">
                        <div class="card card-compact">
                            <div class="card-header bg-primary text-white py-1">
                                <h6 class="mb-0 small">
                                    <i class="fas fa-car-alt me-2"></i>{% trans "الهيكل الخارجي" %}
                                </h6>
                            </div>
                            <div class="card-body p-2">
                                <!-- إضافة تعليمات مختصرة للمستخدم في نفس صف الصور -->
                                <div class="small text-muted mb-1 text-center">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% trans "انقر لتحميل الصور، ثم انقر على الصورة لتكبيرها." %}
                                </div>
                                
                                <div class="row g-2 justify-content-center car-image-section">
                                    <!-- صورة أمامية -->
                                    <div class="col-6 col-sm-3 mb-1">
                                        <div class="car-image-container">
                                            <h6 class="text-primary small mb-0" style="font-size: 0.7rem;">
                                                <i class="fas fa-car-side me-1"></i> {% trans "صورة أمامية" %}
                                            </h6>
                                            <div class="car-image-box" id="frontImageBox" onclick="document.getElementById('frontImage').click()">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="frontImagePreview" class="car-image-preview" onclick="openImageModal(this); event.stopPropagation();">
                                                <div class="fullscreen-hint" title="{% trans 'انقر لعرض الصورة بالحجم الكامل' %}" onclick="openImageModal(document.getElementById('frontImagePreview')); event.stopPropagation();">
                                                    <i class="fas fa-search-plus"></i>
                                                </div>
                                                <input type="file" name="front_image" id="frontImage" class="d-none" accept="image/*" onchange="previewImage(this, 'frontImagePreview')">
                                            </div>
                                            <input type="text" name="front_image_notes" class="form-control car-image-notes mt-1 py-1" placeholder="{% trans 'ملاحظات' %}">
                                        </div>
                                    </div>
                                    
                                    <!-- صورة خلفية -->
                                    <div class="col-6 col-sm-3 mb-1">
                                        <div class="car-image-container">
                                            <h6 class="text-primary small mb-0" style="font-size: 0.7rem;">
                                                <i class="fas fa-car-side fa-flip-horizontal me-1"></i> {% trans "صورة خلفية" %}
                                            </h6>
                                            <div class="car-image-box" id="rearImageBox" onclick="document.getElementById('rearImage').click()">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="rearImagePreview" class="car-image-preview" onclick="openImageModal(this); event.stopPropagation();">
                                                <div class="fullscreen-hint" title="{% trans 'انقر لعرض الصورة بالحجم الكامل' %}" onclick="openImageModal(document.getElementById('rearImagePreview')); event.stopPropagation();">
                                                    <i class="fas fa-search-plus"></i>
                                                </div>
                                                <input type="file" name="rear_image" id="rearImage" class="d-none" accept="image/*" onchange="previewImage(this, 'rearImagePreview')">
                                            </div>
                                            <input type="text" name="rear_image_notes" class="form-control car-image-notes mt-1 py-1" placeholder="{% trans 'ملاحظات' %}">
                                        </div>
                                    </div>
                                    
                                    <!-- صورة جانبية -->
                                    <div class="col-6 col-sm-3 mb-1">
                                        <div class="car-image-container">
                                            <h6 class="text-primary small mb-0" style="font-size: 0.7rem;">
                                                <i class="fas fa-car me-1"></i> {% trans "صورة جانبية" %}
                                            </h6>
                                            <div class="car-image-box" id="sideImageBox" onclick="document.getElementById('sideImage').click()">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="sideImagePreview" class="car-image-preview" onclick="openImageModal(this); event.stopPropagation();">
                                                <div class="fullscreen-hint" title="{% trans 'انقر لعرض الصورة بالحجم الكامل' %}" onclick="openImageModal(document.getElementById('sideImagePreview')); event.stopPropagation();">
                                                    <i class="fas fa-search-plus"></i>
                                                </div>
                                                <input type="file" name="side_image" id="sideImage" class="d-none" accept="image/*" onchange="previewImage(this, 'sideImagePreview')">
                                            </div>
                                            <input type="text" name="side_image_notes" class="form-control car-image-notes mt-1 py-1" placeholder="{% trans 'ملاحظات' %}">
                                        </div>
                                    </div>
                                    
                                    <!-- صورة داخلية -->
                                    <div class="col-6 col-sm-3 mb-1">
                                        <div class="car-image-container">
                                            <h6 class="text-primary small mb-0" style="font-size: 0.7rem;">
                                                <i class="fas fa-car-alt me-1"></i> {% trans "صورة داخلية" %}
                                            </h6>
                                            <div class="car-image-box" id="interiorImageBox" onclick="document.getElementById('interiorImage').click()">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="interiorImagePreview" class="car-image-preview" onclick="openImageModal(this); event.stopPropagation();">
                                                <div class="fullscreen-hint" title="{% trans 'انقر لعرض الصورة بالحجم الكامل' %}" onclick="openImageModal(document.getElementById('interiorImagePreview')); event.stopPropagation();">
                                                    <i class="fas fa-search-plus"></i>
                                                </div>
                                                <input type="file" name="interior_image" id="interiorImage" class="d-none" accept="image/*" onchange="previewImage(this, 'interiorImagePreview')">
                                            </div>
                                            <input type="text" name="interior_image_notes" class="form-control car-image-notes mt-1 py-1" placeholder="{% trans 'ملاحظات' %}">
                                        </div>
                                    </div>
                                    
                                    <!-- النافذة المنبثقة لعرض الصور بالحجم الكامل -->
                                    <div id="imageModal" class="image-modal">
                                        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
                                        <img class="image-modal-content" id="modalImage">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- قسم رفع ملف الفحص الإلكتروني - سيظهر فقط عند اختيار "فحص إلكتروني" -->
                <div class="row mb-3" id="electronic-inspection-section">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-file-pdf me-2"></i>{% trans "رفع ملف الفحص الإلكتروني" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "يرجى رفع ملف PDF يحتوي على نتائج الفحص الإلكتروني للسيارة" %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="inspection_pdf_file" class="form-label fw-bold">{% trans "ملف الفحص الإلكتروني" %}</label>
                                    {% if report and report.electronic_report_pdf %}
                                        <div class="mb-2">
                                            <a href="{{ report.electronic_report_pdf.url }}" class="btn btn-sm btn-outline-success" target="_blank">
                                                <i class="fas fa-file-pdf me-1"></i> {% trans "عرض الملف الحالي" %}
                                            </a>
                                            <div class="form-text text-success">{% trans "ملف موجود بالفعل، رفع ملف جديد سيستبدل القديم" %}</div>
                                        </div>
                                    {% endif %}
                                    <input type="file" class="form-control" id="inspection_pdf_file" name="inspection_pdf_file" accept="application/pdf" {% if not report.electronic_report_pdf %}required{% endif %}>
                                    <div class="form-text">{% trans "يجب أن يكون الملف بصيغة PDF، وحجمه أقل من 10 ميجابايت" %}</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="inspection_summary" class="form-label fw-bold">{% trans "ملخص نتائج الفحص" %}</label>
                                    <textarea class="form-control" id="inspection_summary" name="inspection_summary" rows="3" placeholder="{% trans 'أدخل ملخصاً لنتائج الفحص الإلكتروني' %}">{% if report.is_electronic_inspection and report.notes %}{{ report.notes }}{% endif %}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- قسم عناصر الفحص المهمة والمكلفة فقط (يظهر عند اختيار فحص يدوي) -->
                <div class="row mb-3" id="manual-inspection-section">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-clipboard-check me-2"></i>{% trans "العناصر المهمة والمكلفة" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% for category in inspection_categories %}
                                {% if category.name == "الهيكل الخارجي" %}
                                <!-- تم نقل قسم الهيكل الخارجي إلى قسم منفصل في أعلى الصفحة -->
                                {% elif category.name == "المحرك ومكونات أسفل غطاء المحرك" or category.name == "أنظمة السلامة والتشغيل" %}
                                <!-- عرض فقط الفئات المهمة والمكلفة -->
                                <div class="inspection-category mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="fas fa-check-circle me-2 text-primary"></i>{{ category.name }}
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="col-5">{% trans "العنصر" %}</th>
                                                    <th class="col-5">{% trans "الحالة" %}</th>
                                                    <th class="col-2 text-center">{% trans "إصلاح" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in category.inspection_items.all %}
                                                <!-- عرض فقط العناصر المهمة والسوائل الأهم -->
                                                {% if category.name == "المحرك ومكونات أسفل غطاء المحرك" %}
                                                    <!-- بالنسبة لقسم المحرك، عرض العناصر المهمة والمكلفة فقط -->
                                                    {% if item.id in important_items or item.id in expensive_items %}
                                                        <tr>
                                                            <td>
                                                                <strong>{{ item.name }}</strong>
                                                                <span class="badge bg-danger ms-1">{% trans "إلزامي" %}</span>
                                                            </td>
                                                            <td>
                                                                <select name="inspection_item_{{ item.id }}" class="form-select form-select-sm">
                                                                    <option value="">{% trans "-- اختر --" %}</option>
                                                                    {% for value, text in item.CONDITION_CHOICES %}
                                                                    <option value="{{ value }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.condition == value %}selected{% endif %}>{{ text }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </td>
                                                            <td class="text-center">
                                                                <div class="form-check d-flex justify-content-center">
                                                                    <input class="form-check-input needs-repair-checkbox" type="checkbox" name="needs_repair_{{ item.id }}" id="needs_repair_{{ item.id }}" data-item-id="{{ item.id }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.needs_repair %}checked{% endif %}>
                                                                </div>
                                                                
                                                                <!-- حقول الإصلاح الإضافية -->
                                                                <div class="repair-fields-container mt-2 repair-fields-{{ item.id }}" style="display: {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.needs_repair %}block{% else %}none{% endif %};">
                                                                    <div class="row g-2">
                                                                        <div class="col-12">
                                                                            <input type="text" class="form-control form-control-sm" name="repair_description_{{ item.id }}" placeholder="{% trans 'وصف الإصلاح المطلوب' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_description|default:'' }}{% endif %}">
                                                                        </div>
                                                                        <div class="col-12">
                                                                            <input type="text" class="form-control form-control-sm" name="repair_parts_{{ item.id }}" placeholder="{% trans 'قطع الغيار المطلوبة' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_parts|default:'' }}{% endif %}">
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <input type="number" step="0.01" class="form-control form-control-sm" name="repair_cost_{{ item.id }}" placeholder="{% trans 'تكلفة الإصلاح' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_cost|default:'' }}{% endif %}">
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <input type="number" step="0.01" class="form-control form-control-sm" name="labor_cost_{{ item.id }}" placeholder="{% trans 'تكلفة اليد العاملة' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.labor_cost|default:'' }}{% endif %}">
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <select class="form-select form-select-sm" name="repair_status_{{ item.id }}">
                                                                                <option value="not_needed" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'not_needed' %}selected{% endif %}>{% trans 'لا يحتاج إصلاح' %}</option>
                                                                                <option value="needed" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'needed' %}selected{% endif %}>{% trans 'يحتاج إصلاح' %}</option>
                                                                                <option value="in_progress" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'in_progress' %}selected{% endif %}>{% trans 'قيد الإصلاح' %}</option>
                                                                                <option value="completed" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'completed' %}selected{% endif %}>{% trans 'تم الإصلاح' %}</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="col-6">
                                                                            <input type="date" class="form-control form-control-sm" name="repair_date_{{ item.id }}" value="{% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_date %}{{ inspection_details|get_item:item.id.repair_date|date:'Y-m-d' }}{% endif %}">
                                                                        </div>
                                                                        <div class="col-12">
                                                                            <input type="text" class="form-control form-control-sm" name="repair_workshop_{{ item.id }}" placeholder="{% trans 'الورشة المسؤولة عن الإصلاح' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_workshop|default:'' }}{% endif %}">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                {% elif item.is_required or item.id in important_items or item.id in expensive_items or item.id in critical_items %}
                                                    <!-- بالنسبة للأقسام الأخرى، عرض العناصر الإلزامية والمهمة والمكلفة والحرجة فقط -->
                                                    <tr>
                                                        <td>
                                                            <strong>{{ item.name }}</strong>
                                                            <span class="badge bg-danger ms-1">{% trans "إلزامي" %}</span>
                                                        </td>
                                                        <td>
                                                            <select name="inspection_item_{{ item.id }}" class="form-select form-select-sm">
                                                                <option value="">{% trans "-- اختر --" %}</option>
                                                                {% for value, text in item.CONDITION_CHOICES %}
                                                                <option value="{{ value }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.condition == value %}selected{% endif %}>{{ text }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td class="text-center">
                                                            <div class="form-check d-flex justify-content-center">
                                                                <input class="form-check-input needs-repair-checkbox" type="checkbox" name="needs_repair_{{ item.id }}" id="needs_repair_{{ item.id }}" data-item-id="{{ item.id }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.needs_repair %}checked{% endif %}>
                                                            </div>
                                                            
                                                            <!-- حقول الإصلاح الإضافية -->
                                                            <div class="repair-fields-container mt-2 repair-fields-{{ item.id }}" style="display: {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.needs_repair %}block{% else %}none{% endif %};">
                                                                <div class="row g-2">
                                                                    <div class="col-12">
                                                                        <input type="text" class="form-control form-control-sm" name="repair_description_{{ item.id }}" placeholder="{% trans 'وصف الإصلاح المطلوب' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_description|default:'' }}{% endif %}">
                                                                    </div>
                                                                    <div class="col-12">
                                                                        <input type="text" class="form-control form-control-sm" name="repair_parts_{{ item.id }}" placeholder="{% trans 'قطع الغيار المطلوبة' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_parts|default:'' }}{% endif %}">
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <input type="number" step="0.01" class="form-control form-control-sm" name="repair_cost_{{ item.id }}" placeholder="{% trans 'تكلفة الإصلاح' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_cost|default:'' }}{% endif %}">
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <input type="number" step="0.01" class="form-control form-control-sm" name="labor_cost_{{ item.id }}" placeholder="{% trans 'تكلفة اليد العاملة' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.labor_cost|default:'' }}{% endif %}">
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <select class="form-select form-select-sm" name="repair_status_{{ item.id }}">
                                                                            <option value="not_needed" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'not_needed' %}selected{% endif %}>{% trans 'لا يحتاج إصلاح' %}</option>
                                                                            <option value="needed" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'needed' %}selected{% endif %}>{% trans 'يحتاج إصلاح' %}</option>
                                                                            <option value="in_progress" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'in_progress' %}selected{% endif %}>{% trans 'قيد الإصلاح' %}</option>
                                                                            <option value="completed" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_status == 'completed' %}selected{% endif %}>{% trans 'تم الإصلاح' %}</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <input type="date" class="form-control form-control-sm" name="repair_date_{{ item.id }}" value="{% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.repair_date %}{{ inspection_details|get_item:item.id.repair_date|date:'Y-m-d' }}{% endif %}">
                                                                    </div>
                                                                    <div class="col-12">
                                                                        <input type="text" class="form-control form-control-sm" name="repair_workshop_{{ item.id }}" placeholder="{% trans 'الورشة المسؤولة عن الإصلاح' %}" value="{% if inspection_details and inspection_details|get_item:item.id %}{{ inspection_details|get_item:item.id.repair_workshop|default:'' }}{% endif %}">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                                {% empty %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "لا توجد فئات فحص مضافة حتى الآن. يرجى إضافة فئات وعناصر الفحص أولاً." %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- زر الإرسال -->
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'car_condition_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i> {% trans "إلغاء" %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> {% trans "حفظ التقرير" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // إضافة معالج الأحداث لخانات الاختيار "يحتاج إصلاح"
    document.addEventListener('DOMContentLoaded', function() {
        // الحصول على جميع خانات اختيار "يحتاج إصلاح"
        const needsRepairCheckboxes = document.querySelectorAll('.needs-repair-checkbox');
        
        // إضافة معالج حدث النقر لكل خانة اختيار
        needsRepairCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const itemId = this.getAttribute('data-item-id');
                const repairFields = document.querySelector('.repair-fields-' + itemId);
                
                if (this.checked) {
                    repairFields.style.display = 'block';
                } else {
                    repairFields.style.display = 'none';
                }
            });
        });
    });
    
    // دالة عامة لمعاينة الصور
    // دالة فتح النافذة المنبثقة لعرض الصورة بحجمها الكامل
    function openImageModal(img) {
        // فحص ما إذا كانت الصورة تحتوي على src حقيقي وليست فارغة
        if (img.src && img.src !== "" && img.classList.contains('show')) {
            var modal = document.getElementById("imageModal");
            var modalImg = document.getElementById("modalImage");
            
            // عرض النافذة المنبثقة
            modal.style.display = "flex";
            
            // نسخ الصورة إلى النافذة المنبثقة
            modalImg.src = img.src;
            
            // وقف النقرة من الوصول إلى عناصر أخرى (مثل input file)
            event.stopPropagation();
        } else {
            // إذا لم تكن هناك صورة، نسمح بالنقر للتحميل
            var input = img.closest('.car-image-box').querySelector('input[type="file"]');
            if (input) {
                input.click();
            }
        }
    }
    
    // دالة إغلاق النافذة المنبثقة
    function closeImageModal() {
        var modal = document.getElementById("imageModal");
        modal.style.display = "none";
    }
    
    // إغلاق النافذة المنبثقة عند النقر خارج الصورة
    window.onclick = function(event) {
        var modal = document.getElementById("imageModal");
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    
    // دالة معاينة الصورة المحسنة للأبعاد 40×60 بكسل
    function previewImage(input, previewId) {
        if (input.files && input.files[0]) {
            var file = input.files[0];
            var reader = new FileReader();
            
            reader.onload = function(e) {
                console.log("معالجة الصورة:", previewId);
                
                // ضغط الصورة قبل المعاينة
                var img = new Image();
                img.onload = function() {
                    // قياسات الصورة بالضبط - 40×60 بكسل (4×6 سم)
                    var targetWidth = 40;   // عرض 4 سم
                    var targetHeight = 60;  // ارتفاع 6 سم
                    
                    // حساب نسبة الأبعاد للصورة الأصلية والمستهدفة
                    var origRatio = img.width / img.height;
                    var targetRatio = targetWidth / targetHeight;
                    
                    // متغيرات لعملية القطع
                    var cropWidth, cropHeight, cropX, cropY;
                    
                    // تحديد مناطق القطع بناءً على نسبة الأبعاد
                    if (origRatio > targetRatio) {
                        // الصورة الأصلية أعرض نسبياً، نقطع من العرض
                        cropHeight = img.height;
                        cropWidth = img.height * targetRatio;
                        cropX = (img.width - cropWidth) / 2;
                        cropY = 0;
                    } else {
                        // الصورة الأصلية أطول نسبياً، نقطع من الارتفاع
                        cropWidth = img.width;
                        cropHeight = img.width / targetRatio;
                        cropX = 0;
                        cropY = (img.height - cropHeight) / 2;
                    }
                    
                    // إنشاء كانفس بأبعاد الصورة المستهدفة
                    var canvas = document.createElement('canvas');
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    var ctx = canvas.getContext('2d');
                    
                    // تطبيق تقنية التنعيم لتحسين جودة الصورة
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // رسم الصورة على الكانفس مع تطبيق القياسات المحسوبة
                    ctx.drawImage(
                        img,                // الصورة المصدر
                        cropX, cropY,       // نقطة البداية في الصورة الأصلية (المركز)
                        cropWidth, cropHeight, // الأبعاد للقطع من الصورة الأصلية
                        0, 0,               // نقطة البداية في الكانفاس
                        targetWidth, targetHeight // الأبعاد النهائية في الكانفاس
                    );
                    
                    // تحويل الكانفس إلى صورة jpg مضغوطة
                    var compressedImageSrc = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // عرض الصورة المضغوطة
                    var preview = document.getElementById(previewId);
                    preview.src = compressedImageSrc;
                    preview.style.display = 'block';
                    preview.classList.add('show');
                    
                    // إضافة فئة has-image إلى العنصر الأساسي
                    var imageBox = preview.closest('.car-image-box');
                    imageBox.classList.add('has-image');
                    
                    // إظهار أيقونة التكبير
                    var fullscreenHint = imageBox.querySelector('.fullscreen-hint');
                    if (fullscreenHint) {
                        fullscreenHint.style.display = 'flex';
                    }
                    
                    // إخفاء أيقونة الكاميرا
                    var cameraIcon = imageBox.querySelector('i.fa-camera');
                    if (cameraIcon) {
                        cameraIcon.style.display = 'none';
                    }
                    
                    console.log("تم معالجة الصورة بنجاح، الأبعاد النهائية:", targetWidth, "×", targetHeight);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
    }

    // دالة للتبديل بين أقسام الفحص بناءً على نوع الفحص
    function toggleInspectionSections(inspectionType) {
        // إخفاء كلا القسمين بداية بإزالة أي أنماط inline مضافة من قبل
        $("#electronic-inspection-section, #manual-inspection-section").css('display', 'none');
        
        // ثم إظهار القسم المناسب حسب نوع الفحص
        if (inspectionType === 'electronic') {
            $("#electronic-inspection-section").css('display', 'block');
            $("#inspection_pdf_file").prop('required', true);
            $(".info-message").html('<i class="fas fa-info-circle me-1"></i>{% trans "تم اختيار الفحص الإلكتروني - قم برفع ملف PDF" %}');
        } else {
            $("#manual-inspection-section").css('display', 'block');
            $("#inspection_pdf_file").prop('required', false);
            $(".info-message").html('<i class="fas fa-info-circle me-1"></i>{% trans "تم اختيار الفحص اليدوي - قم بتحديد العناصر المهمة" %}');
        }
    }

    // الدالة الرئيسية - سيتم تنفيذها عند تحميل الصفحة
$(document).ready(function() {
        // تأخير بسيط لضمان تحميل الصفحة بالكامل قبل تطبيق تبديل العرض
        setTimeout(function() {
            // إعداد نوع الفحص الأولي عند تحميل الصفحة
            var currentType = $("#{{ form.inspection_type.id_for_label }}").val() || 'manual';
            
            // تطبيق التغييرات للنوع الأولي
            toggleInspectionSections(currentType);
        }, 100);
        // إخفاء قسم الإصلاحات في البداية
        $(".card.border-warning").hide();
        
        // إظهار قسم الإصلاحات فقط عندما تكون حالة السيارة "سيئة" أو "تالفة"
        $("#{{ form.car_condition.id_for_label }}").change(function() {
            var condition = $(this).val();
            if (condition === 'poor' || condition === 'damaged') {
                $(".card.border-warning").slideDown();
            } else {
                $(".card.border-warning").slideUp();
            }
        });
        
        // حذف أي معالجات سابقة وإضافة معالج جديد لحدث تغيير نوع الفحص
        // ملاحظة مهمة: نستخدم off('change') أولاً لتجنب تسجيل المعالج أكثر من مرة
        $("#{{ form.inspection_type.id_for_label }}").off('change').on('change', function() {
            // الحصول على القيمة الجديدة المختارة
            var selectedType = $(this).val();
            // تطبيق التغييرات المناسبة على واجهة المستخدم
            toggleInspectionSections(selectedType);
        });
        
        {% if report and report.is_electronic_inspection %}
        // إذا كان التقرير الحالي هو فحص إلكتروني، تأكد من عرض قسم الفحص الإلكتروني
        $("#{{ form.inspection_type.id_for_label }}").val('electronic');
        toggleInspectionSections('electronic');
        {% endif %}
        
        // استخدام وظيفة previewImage المحددة في بداية الصفحة بدلاً من تكرار الكود
        // تم تحديث كل عناصر الصور بمعالجات onclick مباشرة ولن نحتاج للكثير من كود التوصيل هنا
        
        // تفعيل النقر على مربعات الصور
        $(".image-input-container").click(function() {
            $(this).find('input[type="file"]').click();
        });
        
        // إنشاء عناصر عرض معلومات العميل والسيارة
        var customerInfoDiv = $('<div class="customer-info mt-3 card bg-light mb-3" style="display:none">')
            .append('<div class="card-header bg-info text-white"><h6 class="mb-0"><i class="fas fa-user me-2"></i>{% trans "معلومات العميل والحجز" %}</h6></div>')
            .append('<div class="card-body customer-details"></div>');
        
        var carDetailsDiv = $('<div class="car-details-info mt-3 card bg-light" style="display:none">')
            .append('<div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="fas fa-car me-2"></i>{% trans "معلومات السيارة" %}</h6></div>')
            .append('<div class="card-body car-details-content"></div>');
        
        // إضافة العناصر بعد القسم الأول
        $("#reservation-select").closest('.card-body').append(customerInfoDiv).append(carDetailsDiv);

        // العلاقة بين الحجز والسيارة وعرض البيانات
        $("#reservation-select").change(function() {
            const reservationId = $(this).val();
            if (reservationId) {
                $.ajax({
                    url: "{% url 'get_car_by_reservation' %}",
                    data: {
                        'reservation_id': reservationId
                    },
                    dataType: 'json',
                    success: function(data) {
                        // تعيين السيارة المتعلقة بالحجز
                        $("#car-select").val(data.car_id);
                        
                        // عرض معلومات العميل والحجز
                        var customerDetails = `
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans "اسم العميل" %}:</strong> ${data.customer_name}</p>
                                    <p><strong>{% trans "رقم الحجز" %}:</strong> ${data.reservation_number}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans "تاريخ البداية" %}:</strong> ${data.reservation_start_date}</p>
                                    <p><strong>{% trans "تاريخ النهاية" %}:</strong> ${data.reservation_end_date}</p>
                                </div>
                            </div>
                        `;
                        $(".customer-details").html(customerDetails);
                        $(".customer-info").slideDown();
                        
                        // عرض تفاصيل السيارة
                        var carDetails = `
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans "الماركة" %}:</strong> ${data.car_details.make}</p>
                                    <p><strong>{% trans "الموديل" %}:</strong> ${data.car_details.model}</p>
                                    <p><strong>{% trans "سنة الصنع" %}:</strong> ${data.car_details.year}</p>
                                    <p><strong>{% trans "اللون" %}:</strong> ${data.car_details.color}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans "لوحة الترخيص" %}:</strong> ${data.car_details.license_plate}</p>
                                    <p><strong>{% trans "الفئة" %}:</strong> ${data.car_details.category}</p>
                                    <p><strong>{% trans "ناقل الحركة" %}:</strong> ${data.car_details.transmission}</p>
                                    <p><strong>{% trans "نوع الوقود" %}:</strong> ${data.car_details.fuel_type}</p>
                                </div>
                            </div>
                        `;
                        $(".car-details-content").html(carDetails);
                        $(".car-details-info").slideDown();
                    },
                    error: function(error) {
                        console.error("Error fetching car data:", error);
                        $(".customer-info, .car-details-info").slideUp();
                        alert("{% trans 'حدث خطأ أثناء جلب بيانات الحجز' %}");
                    }
                });
            } else {
                // إخفاء معلومات العميل والسيارة إذا لم يتم اختيار حجز
                $(".customer-info, .car-details-info").slideUp();
            }
        });
        
        // تم إزالة وظيفة عرض الوقود البصرية
        
        // إضافة تأثيرات مرئية عند تغيير نوع التقرير
        $("#{{ form.report_type.id_for_label }}").change(function() {
            const reportType = $(this).val();
            
            // إذا كان التقرير من نوع صيانة، أظهر حقول الصيانة
            if (reportType === 'maintenance' || reportType === 'periodic') {
                $("#{{ form.maintenance_type.id_for_label }}").closest('.col-12').show();
            } else {
                $("#{{ form.maintenance_type.id_for_label }}").closest('.col-12').hide();
            }
        }).trigger('change');
        
        // تحقق مما إذا كان هناك حجز مختار بالفعل عند تحميل الصفحة
        if ($("#reservation-select").val()) {
            $("#reservation-select").trigger("change");
        }
        
        // تم إعداد معاينة الصور في الكود أعلاه
        console.log('تم إعداد معاينة الصور بالفعل في الكود السابق');
    });
</script>
{% endblock %}