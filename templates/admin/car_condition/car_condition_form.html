{% extends "admin_layout.html" %}
{% load static %}
{% load i18n %}
{% load rental_extras %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .fuel-level-selector {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
    }
    
    .fuel-level-option {
        text-align: center;
        cursor: pointer;
    }
    
    .fuel-level-option.selected {
        font-weight: bold;
    }
    
    .fuel-gauge {
        width: 100%;
        background-color: #f5f5f5;
        border-radius: 5px;
        overflow: hidden;
        height: 20px;
    }
    
    .fuel-gauge-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.3s;
    }
    
    /* أنماط الهيكل الخارجي */
    .image-input-container {
        width: 100%;
        height: 150px;
        border: 2px dashed #ced4da;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        background-color: #f8f9fa;
        position: relative;
        transition: all 0.3s;
    }
    
    .image-input-container:hover {
        border-color: #6c757d;
        background-color: #f2f2f2;
    }
    
    .upload-placeholder {
        text-align: center;
    }
    
    .preview-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    /* أنماط قسم الصور الجديدة */
    .car-image-section {
        margin-bottom: 20px;
    }
    
    .car-image-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        height: 100%;
        background-color: #f8f9fa;
        transition: transform 0.2s;
    }
    
    .car-image-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .car-image-box {
        width: 100%;
        height: 150px; /* ارتفاع ثابت بدلاً من نسبة العرض إلى الارتفاع */
        border: 2px dashed #ced4da;
        border-radius: 8px;
        position: relative;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        cursor: pointer;
        overflow: hidden;
    }
    
    .car-image-box i {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: #adb5bd;
        z-index: 1;
    }
    
    .car-image-preview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* استخدام contain بدلاً من cover للحفاظ على نسبة العرض إلى الارتفاع */
        display: none; /* سيتم تغييره إلى block عبر JavaScript عند تحديد صورة */
        z-index: 2; /* ضمان أن الصورة فوق أيقونة الكاميرا */
    }
    
    /* عند تحميل الصورة سيظهر كود المعاينة */
    .car-image-preview.show {
        display: block;
    }
    
    /* عند تحميل صورة، إخفاء أيقونة الكاميرا */
    .car-image-box.has-image i.fa-camera {
        display: none;
    }
    
    .car-image-notes {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">{{ title }}</h5>
                <a href="{% url 'car_condition_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i> {% trans "العودة للقائمة" %}
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="post" action="" class="needs-validation" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "معلومات أساسية" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.reservation.id_for_label }}" class="form-label">{{ form.reservation.label }}</label>
                                        {{ form.reservation }}
                                        {% if form.reservation.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.reservation.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.car.id_for_label }}" class="form-label">{{ form.car.label }}</label>
                                        {{ form.car }}
                                        {% if form.car.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.car.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.report_type.id_for_label }}" class="form-label">{{ form.report_type.label }}</label>
                                        {{ form.report_type }}
                                        {% if form.report_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.report_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.inspection_type.id_for_label }}" class="form-label">{{ form.inspection_type.label }}</label>
                                        {{ form.inspection_type }}
                                        {% if form.inspection_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.inspection_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
                                        {{ form.date }}
                                        {% if form.date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light h-100">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "حالة السيارة" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.mileage.id_for_label }}" class="form-label">{{ form.mileage.label }}</label>
                                        {{ form.mileage }}
                                        {% if form.mileage.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.mileage.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.car_condition.id_for_label }}" class="form-label">{{ form.car_condition.label }}</label>
                                        {{ form.car_condition }}
                                        {% if form.car_condition.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.car_condition.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="{{ form.fuel_level.id_for_label }}" class="form-label">{{ form.fuel_level.label }}</label>
                                        {{ form.fuel_level }}
                                        
                                        <div class="fuel-gauge mt-2">
                                            <div class="fuel-gauge-fill" id="fuel-gauge-visual"></div>
                                        </div>
                                        
                                        <div class="fuel-level-selector mt-2">
                                            <div class="fuel-level-option" data-value="empty" data-percentage="0">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "فارغ" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="quarter" data-percentage="25">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "ربع" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="half" data-percentage="50">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "نصف" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="three_quarters" data-percentage="75">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "ثلاثة أرباع" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="full" data-percentage="100">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "ممتلئ" %}</div>
                                            </div>
                                        </div>
                                        
                                        {% if form.fuel_level.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.fuel_level.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light h-100">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "معلومات الصيانة والإصلاح" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="{{ form.maintenance_type.id_for_label }}" class="form-label">{{ form.maintenance_type.label }}</label>
                                        {{ form.maintenance_type }}
                                        {% if form.maintenance_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.maintenance_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="{{ form.defects.id_for_label }}" class="form-label">{{ form.defects.label }}</label>
                                        {{ form.defects }}
                                        {% if form.defects.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.defects.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.defect_cause.id_for_label }}" class="form-label">{{ form.defect_cause.label }}</label>
                                        {{ form.defect_cause }}
                                        {% if form.defect_cause.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.defect_cause.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.repair_cost.id_for_label }}" class="form-label">{{ form.repair_cost.label }}</label>
                                        {{ form.repair_cost }}
                                        {% if form.repair_cost.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.repair_cost.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- حقول قطع الغيار والإصلاحات المطلوبة -->
                                    <div class="col-12 mt-3">
                                        <div class="card border border-warning">
                                            <div class="card-header bg-warning bg-opacity-10">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-tools me-2"></i>
                                                    {% trans "قطع الغيار والإصلاحات المطلوبة" %}
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <label class="form-label">{% trans "وصف الإصلاحات المطلوبة" %}</label>
                                                        <textarea name="repair_description" class="form-control" rows="3" placeholder="{% trans 'اكتب وصفاً تفصيلياً للإصلاحات المطلوبة' %}"></textarea>
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label">{% trans "قطع الغيار المطلوبة" %}</label>
                                                        <textarea name="repair_parts" class="form-control" rows="3" placeholder="{% trans 'اكتب قائمة بقطع الغيار المطلوبة، كل قطعة في سطر منفصل' %}"></textarea>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">{% trans "تكلفة قطع الغيار المقدرة" %}</label>
                                                        <input type="number" name="parts_cost" class="form-control" min="0" step="0.01" placeholder="{% trans 'تكلفة قطع الغيار' %}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">{% trans "تكلفة اليد العاملة المقدرة" %}</label>
                                                        <input type="number" name="labor_cost" class="form-control" min="0" step="0.01" placeholder="{% trans 'تكلفة اليد العاملة' %}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "ملاحظات إضافية" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                                        {{ form.notes }}
                                        {% if form.notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.notes.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- قسم الهيكل الخارجي -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-car-alt me-2"></i>{% trans "الهيكل الخارجي" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row car-image-section">
                                    <!-- صورة أمامية -->
                                    <div class="col-md-3 mb-3">
                                        <div class="car-image-container">
                                            <h6>{% trans "صورة أمامية" %}</h6>
                                            <div class="car-image-box" id="frontImageBox" onclick="document.getElementById('frontImage').click();">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="frontImagePreview" class="car-image-preview">
                                                <input type="file" name="front_image" id="frontImage" class="d-none" accept="image/*" onchange="previewImage(this, 'frontImagePreview')">
                                            </div>
                                            <textarea name="front_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الأمامية' %}"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- صورة خلفية -->
                                    <div class="col-md-3 mb-3">
                                        <div class="car-image-container">
                                            <h6>{% trans "صورة خلفية" %}</h6>
                                            <div class="car-image-box" id="rearImageBox" onclick="document.getElementById('rearImage').click();">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="rearImagePreview" class="car-image-preview">
                                                <input type="file" name="rear_image" id="rearImage" class="d-none" accept="image/*" onchange="previewImage(this, 'rearImagePreview')">
                                            </div>
                                            <textarea name="rear_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الخلفية' %}"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- صورة جانبية -->
                                    <div class="col-md-3 mb-3">
                                        <div class="car-image-container">
                                            <h6>{% trans "صورة جانبية" %}</h6>
                                            <div class="car-image-box" id="sideImageBox" onclick="document.getElementById('sideImage').click();">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="sideImagePreview" class="car-image-preview">
                                                <input type="file" name="side_image" id="sideImage" class="d-none" accept="image/*" onchange="previewImage(this, 'sideImagePreview')">
                                            </div>
                                            <textarea name="side_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الجانبية' %}"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- صورة داخلية -->
                                    <div class="col-md-3 mb-3">
                                        <div class="car-image-container">
                                            <h6>{% trans "صورة داخلية" %}</h6>
                                            <div class="car-image-box" id="interiorImageBox" onclick="document.getElementById('interiorImage').click();">
                                                <i class="fas fa-camera"></i>
                                                <img src="" id="interiorImagePreview" class="car-image-preview">
                                                <input type="file" name="interior_image" id="interiorImage" class="d-none" accept="image/*" onchange="previewImage(this, 'interiorImagePreview')">
                                            </div>
                                            <textarea name="interior_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الداخلية' %}"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- قسم تفاصيل الفحص -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-clipboard-check me-2"></i>{% trans "تفاصيل الفحص" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% for category in inspection_categories %}
                                {% if category.name == "الهيكل الخارجي" %}
                                <!-- تم نقل قسم الهيكل الخارجي إلى قسم منفصل في أعلى الصفحة -->
                                {% else %}
                                <div class="inspection-category mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="fas fa-check-circle me-2 text-primary"></i>{{ category.name }}
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="col-4">{% trans "العنصر" %}</th>
                                                    <th class="col-3">{% trans "الحالة" %}</th>
                                                    <th class="col-1 text-center">{% trans "إصلاح" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in category.inspection_items.all %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ item.name }}</strong>
                                                        {% if item.is_required %}
                                                        <span class="badge bg-danger ms-1">{% trans "إلزامي" %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <select name="inspection_item_{{ item.id }}" class="form-select form-select-sm">
                                                            <option value="">{% trans "-- اختر --" %}</option>
                                                            {% for value, text in item.CONDITION_CHOICES %}
                                                            <option value="{{ value }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.condition == value %}selected{% endif %}>{{ text }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="form-check d-flex justify-content-center align-items-center">
                                                            <input class="form-check-input" type="checkbox" name="needs_repair_{{ item.id }}" id="needs_repair_{{ item.id }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.needs_repair %}checked{% endif %}>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                                {% empty %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "لا توجد فئات فحص مضافة حتى الآن. يرجى إضافة فئات وعناصر الفحص أولاً." %}
                                </div>
                                {% endfor %}

                                <!-- حقل ملاحظات عامة للفحص -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">{% trans "ملاحظات عامة حول الفحص" %}</label>
                                            <textarea name="inspection_notes" class="form-control" rows="2" placeholder="{% trans 'أي ملاحظات إضافية عن الفحص بشكل عام' %}"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- زر الإرسال -->
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'car_condition_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i> {% trans "إلغاء" %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> {% trans "حفظ التقرير" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // دالة عامة لمعاينة الصور
    function previewImage(input, previewId) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function(e) {
                console.log("معاينة الصورة:", previewId);
                var preview = document.getElementById(previewId);
                preview.src = e.target.result;
                preview.style.display = 'block';
                preview.classList.add('show');
                
                // إضافة فئة has-image إلى العنصر الأساسي
                preview.closest('.car-image-box').classList.add('has-image');
                
                // إخفاء أيقونة الكاميرا
                var cameraIcon = preview.parentNode.querySelector('i.fa-camera');
                if (cameraIcon) {
                    cameraIcon.style.display = 'none';
                }
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    $(document).ready(function() {
        // إخفاء قسم الإصلاحات في البداية
        $(".card.border-warning").hide();
        
        // إظهار قسم الإصلاحات فقط عندما تكون حالة السيارة "سيئة" أو "تالفة"
        $("#{{ form.car_condition.id_for_label }}").change(function() {
            var condition = $(this).val();
            if (condition === 'poor' || condition === 'damaged') {
                $(".card.border-warning").slideDown();
            } else {
                $(".card.border-warning").slideUp();
            }
        });
        
        // استخدام وظيفة previewImage المحددة في بداية الصفحة بدلاً من تكرار الكود
        // تم تحديث كل عناصر الصور بمعالجات onclick مباشرة ولن نحتاج للكثير من كود التوصيل هنا
        
        // تفعيل النقر على مربعات الصور
        $(".image-input-container").click(function() {
            $(this).find('input[type="file"]').click();
        });
        
        // إنشاء عناصر عرض معلومات العميل والسيارة
        var customerInfoDiv = $('<div class="customer-info mt-3 card bg-light mb-3" style="display:none">')
            .append('<div class="card-header bg-info text-white"><h6 class="mb-0"><i class="fas fa-user me-2"></i>{% trans "معلومات العميل والحجز" %}</h6></div>')
            .append('<div class="card-body customer-details"></div>');
        
        var carDetailsDiv = $('<div class="car-details-info mt-3 card bg-light" style="display:none">')
            .append('<div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="fas fa-car me-2"></i>{% trans "معلومات السيارة" %}</h6></div>')
            .append('<div class="card-body car-details-content"></div>');
        
        // إضافة العناصر بعد القسم الأول
        $("#reservation-select").closest('.card-body').append(customerInfoDiv).append(carDetailsDiv);

        // العلاقة بين الحجز والسيارة وعرض البيانات
        $("#reservation-select").change(function() {
            const reservationId = $(this).val();
            if (reservationId) {
                $.ajax({
                    url: "{% url 'get_car_by_reservation' %}",
                    data: {
                        'reservation_id': reservationId
                    },
                    dataType: 'json',
                    success: function(data) {
                        // تعيين السيارة المتعلقة بالحجز
                        $("#car-select").val(data.car_id);
                        
                        // عرض معلومات العميل والحجز
                        var customerDetails = `
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans "اسم العميل" %}:</strong> ${data.customer_name}</p>
                                    <p><strong>{% trans "رقم الحجز" %}:</strong> ${data.reservation_number}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans "تاريخ البداية" %}:</strong> ${data.reservation_start_date}</p>
                                    <p><strong>{% trans "تاريخ النهاية" %}:</strong> ${data.reservation_end_date}</p>
                                </div>
                            </div>
                        `;
                        $(".customer-details").html(customerDetails);
                        $(".customer-info").slideDown();
                        
                        // عرض تفاصيل السيارة
                        var carDetails = `
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans "الماركة" %}:</strong> ${data.car_details.make}</p>
                                    <p><strong>{% trans "الموديل" %}:</strong> ${data.car_details.model}</p>
                                    <p><strong>{% trans "سنة الصنع" %}:</strong> ${data.car_details.year}</p>
                                    <p><strong>{% trans "اللون" %}:</strong> ${data.car_details.color}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans "لوحة الترخيص" %}:</strong> ${data.car_details.license_plate}</p>
                                    <p><strong>{% trans "الفئة" %}:</strong> ${data.car_details.category}</p>
                                    <p><strong>{% trans "ناقل الحركة" %}:</strong> ${data.car_details.transmission}</p>
                                    <p><strong>{% trans "نوع الوقود" %}:</strong> ${data.car_details.fuel_type}</p>
                                </div>
                            </div>
                        `;
                        $(".car-details-content").html(carDetails);
                        $(".car-details-info").slideDown();
                    },
                    error: function(error) {
                        console.error("Error fetching car data:", error);
                        $(".customer-info, .car-details-info").slideUp();
                        alert("{% trans 'حدث خطأ أثناء جلب بيانات الحجز' %}");
                    }
                });
            } else {
                // إخفاء معلومات العميل والسيارة إذا لم يتم اختيار حجز
                $(".customer-info, .car-details-info").slideUp();
            }
        });
        
        // الرسم التفاعلي لمستوى الوقود
        function updateFuelGauge() {
            const selectedValue = $("#{{ form.fuel_level.id_for_label }}").val();
            let percentage = 0;
            
            switch (selectedValue) {
                case 'empty':
                    percentage = 0;
                    break;
                case 'quarter':
                    percentage = 25;
                    break;
                case 'half':
                    percentage = 50;
                    break;
                case 'three_quarters':
                    percentage = 75;
                    break;
                case 'full':
                    percentage = 100;
                    break;
            }
            
            $("#fuel-gauge-visual").css('width', percentage + '%');
            
            // تحديث الخيارات المرئية
            $(".fuel-level-option").removeClass('selected');
            $(`.fuel-level-option[data-value="${selectedValue}"]`).addClass('selected');
        }
        
        // تحديث الرسم عند تغيير القيمة
        $("#{{ form.fuel_level.id_for_label }}").change(updateFuelGauge);
        
        // النقر على خيارات مستوى الوقود
        $(".fuel-level-option").click(function() {
            const value = $(this).data('value');
            $("#{{ form.fuel_level.id_for_label }}").val(value).trigger('change');
        });
        
        // تحديث الرسم عند تحميل الصفحة
        updateFuelGauge();
        
        // إضافة تأثيرات مرئية عند تغيير نوع التقرير
        $("#{{ form.report_type.id_for_label }}").change(function() {
            const reportType = $(this).val();
            
            // إذا كان التقرير من نوع صيانة، أظهر حقول الصيانة
            if (reportType === 'maintenance' || reportType === 'periodic') {
                $("#{{ form.maintenance_type.id_for_label }}").closest('.col-12').show();
            } else {
                $("#{{ form.maintenance_type.id_for_label }}").closest('.col-12').hide();
            }
        }).trigger('change');
        
        // تحقق مما إذا كان هناك حجز مختار بالفعل عند تحميل الصفحة
        if ($("#reservation-select").val()) {
            $("#reservation-select").trigger("change");
        }
        
        // تم إعداد معاينة الصور في الكود أعلاه
        console.log('تم إعداد معاينة الصور بالفعل في الكود السابق');
    });
</script>
{% endblock %}