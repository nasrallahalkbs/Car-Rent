{% extends "admin_layout.html" %}
{% load static %}
{% load i18n %}
{% load rental_extras %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .fuel-level-selector {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
    }
    
    .fuel-level-option {
        text-align: center;
        cursor: pointer;
    }
    
    .fuel-level-option.selected {
        font-weight: bold;
    }
    
    .fuel-gauge {
        width: 100%;
        background-color: #f5f5f5;
        border-radius: 5px;
        overflow: hidden;
        height: 20px;
    }
    
    .fuel-gauge-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.3s;
    }
    
    /* أنماط الهيكل الخارجي */
    .image-input-container {
        width: 100%;
        height: 150px;
        border: 2px dashed #ced4da;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        background-color: #f8f9fa;
        position: relative;
        transition: all 0.3s;
    }
    
    .image-input-container:hover {
        border-color: #6c757d;
        background-color: #f2f2f2;
    }
    
    .upload-placeholder {
        text-align: center;
    }
    
    .preview-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">{{ title }}</h5>
                <a href="{% url 'car_condition_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i> {% trans "العودة للقائمة" %}
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="post" action="" class="needs-validation" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "معلومات أساسية" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.reservation.id_for_label }}" class="form-label">{{ form.reservation.label }}</label>
                                        {{ form.reservation }}
                                        {% if form.reservation.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.reservation.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.car.id_for_label }}" class="form-label">{{ form.car.label }}</label>
                                        {{ form.car }}
                                        {% if form.car.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.car.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.report_type.id_for_label }}" class="form-label">{{ form.report_type.label }}</label>
                                        {{ form.report_type }}
                                        {% if form.report_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.report_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.inspection_type.id_for_label }}" class="form-label">{{ form.inspection_type.label }}</label>
                                        {{ form.inspection_type }}
                                        {% if form.inspection_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.inspection_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
                                        {{ form.date }}
                                        {% if form.date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light h-100">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "حالة السيارة" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.mileage.id_for_label }}" class="form-label">{{ form.mileage.label }}</label>
                                        {{ form.mileage }}
                                        {% if form.mileage.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.mileage.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.car_condition.id_for_label }}" class="form-label">{{ form.car_condition.label }}</label>
                                        {{ form.car_condition }}
                                        {% if form.car_condition.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.car_condition.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="{{ form.fuel_level.id_for_label }}" class="form-label">{{ form.fuel_level.label }}</label>
                                        {{ form.fuel_level }}
                                        
                                        <div class="fuel-gauge mt-2">
                                            <div class="fuel-gauge-fill" id="fuel-gauge-visual"></div>
                                        </div>
                                        
                                        <div class="fuel-level-selector mt-2">
                                            <div class="fuel-level-option" data-value="empty" data-percentage="0">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "فارغ" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="quarter" data-percentage="25">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "ربع" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="half" data-percentage="50">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "نصف" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="three_quarters" data-percentage="75">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "ثلاثة أرباع" %}</div>
                                            </div>
                                            <div class="fuel-level-option" data-value="full" data-percentage="100">
                                                <i class="fas fa-gas-pump"></i>
                                                <div>{% trans "ممتلئ" %}</div>
                                            </div>
                                        </div>
                                        
                                        {% if form.fuel_level.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.fuel_level.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light h-100">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "معلومات الصيانة والإصلاح" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="{{ form.maintenance_type.id_for_label }}" class="form-label">{{ form.maintenance_type.label }}</label>
                                        {{ form.maintenance_type }}
                                        {% if form.maintenance_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.maintenance_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12">
                                        <label for="{{ form.defects.id_for_label }}" class="form-label">{{ form.defects.label }}</label>
                                        {{ form.defects }}
                                        {% if form.defects.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.defects.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.defect_cause.id_for_label }}" class="form-label">{{ form.defect_cause.label }}</label>
                                        {{ form.defect_cause }}
                                        {% if form.defect_cause.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.defect_cause.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="{{ form.repair_cost.id_for_label }}" class="form-label">{{ form.repair_cost.label }}</label>
                                        {{ form.repair_cost }}
                                        {% if form.repair_cost.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.repair_cost.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- حقول قطع الغيار والإصلاحات المطلوبة -->
                                    <div class="col-12 mt-3">
                                        <div class="card border border-warning">
                                            <div class="card-header bg-warning bg-opacity-10">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-tools me-2"></i>
                                                    {% trans "قطع الغيار والإصلاحات المطلوبة" %}
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <label class="form-label">{% trans "وصف الإصلاحات المطلوبة" %}</label>
                                                        <textarea name="repair_description" class="form-control" rows="3" placeholder="{% trans 'اكتب وصفاً تفصيلياً للإصلاحات المطلوبة' %}"></textarea>
                                                    </div>
                                                    <div class="col-12">
                                                        <label class="form-label">{% trans "قطع الغيار المطلوبة" %}</label>
                                                        <textarea name="repair_parts" class="form-control" rows="3" placeholder="{% trans 'اكتب قائمة بقطع الغيار المطلوبة، كل قطعة في سطر منفصل' %}"></textarea>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">{% trans "تكلفة قطع الغيار المقدرة" %}</label>
                                                        <input type="number" name="parts_cost" class="form-control" min="0" step="0.01" placeholder="{% trans 'تكلفة قطع الغيار' %}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">{% trans "تكلفة اليد العاملة المقدرة" %}</label>
                                                        <input type="number" name="labor_cost" class="form-control" min="0" step="0.01" placeholder="{% trans 'تكلفة اليد العاملة' %}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">{% trans "ملاحظات إضافية" %}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                                        {{ form.notes }}
                                        {% if form.notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.notes.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- قسم تفاصيل الفحص -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-clipboard-check me-2"></i>{% trans "تفاصيل الفحص" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% for category in inspection_categories %}
                                {% if category.name == "الهيكل الخارجي" %}
                                <div class="inspection-category mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="fas fa-car-alt me-2 text-primary"></i>{{ category.name }}
                                    </h6>
                                    <div class="row car-image-section">
                                        <!-- صورة أمامية -->
                                        <div class="col-md-3 mb-3">
                                            <div class="car-image-container">
                                                <h6>{% trans "صورة أمامية" %}</h6>
                                                <div class="car-image-box" id="frontImageBox">
                                                    <i class="fas fa-camera"></i>
                                                    <img src="" id="frontImagePreview" class="car-image-preview">
                                                    <input type="file" name="front_image" id="frontImage" class="d-none" accept="image/*">
                                                </div>
                                                <textarea name="front_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الأمامية' %}"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- صورة خلفية -->
                                        <div class="col-md-3 mb-3">
                                            <div class="car-image-container">
                                                <h6>{% trans "صورة خلفية" %}</h6>
                                                <div class="car-image-box" id="rearImageBox">
                                                    <i class="fas fa-camera"></i>
                                                    <img src="" id="rearImagePreview" class="car-image-preview">
                                                    <input type="file" name="rear_image" id="rearImage" class="d-none" accept="image/*">
                                                </div>
                                                <textarea name="rear_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الخلفية' %}"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- صورة جانبية -->
                                        <div class="col-md-3 mb-3">
                                            <div class="car-image-container">
                                                <h6>{% trans "صورة جانبية" %}</h6>
                                                <div class="car-image-box" id="sideImageBox">
                                                    <i class="fas fa-camera"></i>
                                                    <img src="" id="sideImagePreview" class="car-image-preview">
                                                    <input type="file" name="side_image" id="sideImage" class="d-none" accept="image/*">
                                                </div>
                                                <textarea name="side_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الجانبية' %}"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- صورة داخلية -->
                                        <div class="col-md-3 mb-3">
                                            <div class="car-image-container">
                                                <h6>{% trans "صورة داخلية" %}</h6>
                                                <div class="car-image-box" id="interiorImageBox">
                                                    <i class="fas fa-camera"></i>
                                                    <img src="" id="interiorImagePreview" class="car-image-preview">
                                                    <input type="file" name="interior_image" id="interiorImage" class="d-none" accept="image/*">
                                                </div>
                                                <textarea name="interior_image_notes" class="form-control car-image-notes" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الداخلية' %}"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="inspection-category mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="fas fa-check-circle me-2 text-primary"></i>{{ category.name }}
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="col-4">{% trans "العنصر" %}</th>
                                                    <th class="col-3">{% trans "الحالة" %}</th>
                                                    <th class="col-1 text-center">{% trans "إصلاح" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in category.inspection_items.all %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ item.name }}</strong>
                                                        {% if item.is_required %}
                                                        <span class="badge bg-danger ms-1">{% trans "إلزامي" %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <select name="inspection_item_{{ item.id }}" class="form-select form-select-sm">
                                                            <option value="">{% trans "-- اختر --" %}</option>
                                                            {% for value, text in item.CONDITION_CHOICES %}
                                                            <option value="{{ value }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.condition == value %}selected{% endif %}>{{ text }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="form-check d-flex justify-content-center align-items-center">
                                                            <input class="form-check-input" type="checkbox" name="needs_repair_{{ item.id }}" id="needs_repair_{{ item.id }}" {% if inspection_details and inspection_details|get_item:item.id and inspection_details|get_item:item.id.needs_repair %}checked{% endif %}>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}
                                {% empty %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "لا توجد فئات فحص مضافة حتى الآن. يرجى إضافة فئات وعناصر الفحص أولاً." %}
                                </div>
                                {% endfor %}

                                <!-- حقل ملاحظات عامة للفحص -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">{% trans "ملاحظات عامة حول الفحص" %}</label>
                                            <textarea name="inspection_notes" class="form-control" rows="2" placeholder="{% trans 'أي ملاحظات إضافية عن الفحص بشكل عام' %}"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- قسم الهيكل الخارجي -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-car-alt me-2"></i>{% trans "الهيكل الخارجي" %}
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- صورة أمامية -->
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">{% trans "صورة أمامية" %}</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <label for="front_image" class="image-input-container">
                                            {% with front_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة أمامية"|first %}
                                            {% if front_image %}
                                                <img id="front_image_preview" class="preview-image" src="{{ front_image.image.url }}" alt="صورة أمامية">
                                                <div class="upload-placeholder d-none">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                            {% else %}
                                                <div class="upload-placeholder">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                                <img id="front_image_preview" class="preview-image d-none" src="#" alt="معاينة الصورة">
                                            {% endif %}
                                            {% endwith %}
                                            <input type="file" id="front_image" name="front_image" class="d-none" accept="image/*">
                                        </label>
                                        {% with front_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة أمامية"|first %}
                                        {% if front_image and front_image.description and "-" in front_image.description %}
                                            <textarea name="front_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الأمامية' %}">{{ front_image.description|split:"-"|last|trim }}</textarea>
                                        {% else %}
                                            <textarea name="front_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الأمامية' %}"></textarea>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- صورة خلفية -->
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">{% trans "صورة خلفية" %}</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <label for="rear_image" class="image-input-container">
                                            {% with rear_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة خلفية"|first %}
                                            {% if rear_image %}
                                                <img id="rear_image_preview" class="preview-image" src="{{ rear_image.image.url }}" alt="صورة خلفية">
                                                <div class="upload-placeholder d-none">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                            {% else %}
                                                <div class="upload-placeholder">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                                <img id="rear_image_preview" class="preview-image d-none" src="#" alt="معاينة الصورة">
                                            {% endif %}
                                            {% endwith %}
                                            <input type="file" id="rear_image" name="rear_image" class="d-none" accept="image/*">
                                        </label>
                                        {% with rear_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة خلفية"|first %}
                                        {% if rear_image and rear_image.description and "-" in rear_image.description %}
                                            <textarea name="rear_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الخلفية' %}">{{ rear_image.description|split:"-"|last|trim }}</textarea>
                                        {% else %}
                                            <textarea name="rear_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الخلفية' %}"></textarea>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- صورة جانبية -->
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">{% trans "صورة جانبية" %}</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <label for="side_image" class="image-input-container">
                                            {% with side_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة جانبية"|first %}
                                            {% if side_image %}
                                                <img id="side_image_preview" class="preview-image" src="{{ side_image.image.url }}" alt="صورة جانبية">
                                                <div class="upload-placeholder d-none">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                            {% else %}
                                                <div class="upload-placeholder">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                                <img id="side_image_preview" class="preview-image d-none" src="#" alt="معاينة الصورة">
                                            {% endif %}
                                            {% endwith %}
                                            <input type="file" id="side_image" name="side_image" class="d-none" accept="image/*">
                                        </label>
                                        {% with side_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة جانبية"|first %}
                                        {% if side_image and side_image.description and "-" in side_image.description %}
                                            <textarea name="side_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الجانبية' %}">{{ side_image.description|split:"-"|last|trim }}</textarea>
                                        {% else %}
                                            <textarea name="side_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الجانبية' %}"></textarea>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- صورة داخلية -->
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">{% trans "صورة داخلية" %}</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <label for="interior_image" class="image-input-container">
                                            {% with interior_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة داخلية"|first %}
                                            {% if interior_image %}
                                                <img id="interior_image_preview" class="preview-image" src="{{ interior_image.image.url }}" alt="صورة داخلية">
                                                <div class="upload-placeholder d-none">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                            {% else %}
                                                <div class="upload-placeholder">
                                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                                    <p>{% trans "انقر لإضافة صورة" %}</p>
                                                </div>
                                                <img id="interior_image_preview" class="preview-image d-none" src="#" alt="معاينة الصورة">
                                            {% endif %}
                                            {% endwith %}
                                            <input type="file" id="interior_image" name="interior_image" class="d-none" accept="image/*">
                                        </label>
                                        {% with interior_image=exterior_images|dictsortreversed:"upload_date"|selectattr:"description"|selectattr:"صورة داخلية"|first %}
                                        {% if interior_image and interior_image.description and "-" in interior_image.description %}
                                            <textarea name="interior_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الداخلية' %}">{{ interior_image.description|split:"-"|last|trim }}</textarea>
                                        {% else %}
                                            <textarea name="interior_image_notes" class="form-control mt-2" rows="2" placeholder="{% trans 'ملاحظات عن الصورة الداخلية' %}"></textarea>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'car_condition_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i> {% trans "إلغاء" %}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> {% trans "حفظ التقرير" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        // إخفاء قسم الإصلاحات في البداية
        $(".card.border-warning").hide();
        
        // إظهار قسم الإصلاحات فقط عندما تكون حالة السيارة "سيئة" أو "تالفة"
        $("#{{ form.car_condition.id_for_label }}").change(function() {
            var condition = $(this).val();
            if (condition === 'poor' || condition === 'damaged') {
                $(".card.border-warning").slideDown();
            } else {
                $(".card.border-warning").slideUp();
            }
        });
        
        // معالجة تحميل ومعاينة صور الهيكل الخارجي للسيارة
        // صورة أمامية
        $("#front_image").change(function() {
            readURL(this, "#front_image_preview");
        });
        
        // صورة خلفية
        $("#rear_image").change(function() {
            readURL(this, "#rear_image_preview");
        });
        
        // صورة جانبية
        $("#side_image").change(function() {
            readURL(this, "#side_image_preview");
        });
        
        // صورة داخلية
        $("#interior_image").change(function() {
            readURL(this, "#interior_image_preview");
        });
        
        // وظيفة معالجة تحميل الصور ومعاينتها
        function readURL(input, previewId) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    $(previewId).attr('src', e.target.result);
                    $(previewId).removeClass('d-none');
                    $(previewId).siblings('.upload-placeholder').addClass('d-none');
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // تفعيل النقر على مربعات الصور
        $(".image-input-container").click(function() {
            $(this).find('input[type="file"]').click();
        });
        
        // إنشاء عناصر عرض معلومات العميل والسيارة
        var customerInfoDiv = $('<div class="customer-info mt-3 card bg-light mb-3" style="display:none">')
            .append('<div class="card-header bg-info text-white"><h6 class="mb-0"><i class="fas fa-user me-2"></i>{% trans "معلومات العميل والحجز" %}</h6></div>')
            .append('<div class="card-body customer-details"></div>');
        
        var carDetailsDiv = $('<div class="car-details-info mt-3 card bg-light" style="display:none">')
            .append('<div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="fas fa-car me-2"></i>{% trans "معلومات السيارة" %}</h6></div>')
            .append('<div class="card-body car-details-content"></div>');
        
        // إضافة العناصر بعد القسم الأول
        $("#reservation-select").closest('.card-body').append(customerInfoDiv).append(carDetailsDiv);

        // العلاقة بين الحجز والسيارة وعرض البيانات
        $("#reservation-select").change(function() {
            const reservationId = $(this).val();
            if (reservationId) {
                $.ajax({
                    url: "{% url 'get_car_by_reservation' %}",
                    data: {
                        'reservation_id': reservationId
                    },
                    dataType: 'json',
                    success: function(data) {
                        // تعيين السيارة المتعلقة بالحجز
                        $("#car-select").val(data.car_id);
                        
                        // عرض معلومات العميل والحجز
                        var customerDetails = `
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans "اسم العميل" %}:</strong> ${data.customer_name}</p>
                                    <p><strong>{% trans "رقم الحجز" %}:</strong> ${data.reservation_number}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans "تاريخ البداية" %}:</strong> ${data.reservation_start_date}</p>
                                    <p><strong>{% trans "تاريخ النهاية" %}:</strong> ${data.reservation_end_date}</p>
                                </div>
                            </div>
                        `;
                        $(".customer-details").html(customerDetails);
                        $(".customer-info").slideDown();
                        
                        // عرض تفاصيل السيارة
                        var carDetails = `
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>{% trans "الماركة" %}:</strong> ${data.car_details.make}</p>
                                    <p><strong>{% trans "الموديل" %}:</strong> ${data.car_details.model}</p>
                                    <p><strong>{% trans "سنة الصنع" %}:</strong> ${data.car_details.year}</p>
                                    <p><strong>{% trans "اللون" %}:</strong> ${data.car_details.color}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>{% trans "لوحة الترخيص" %}:</strong> ${data.car_details.license_plate}</p>
                                    <p><strong>{% trans "الفئة" %}:</strong> ${data.car_details.category}</p>
                                    <p><strong>{% trans "ناقل الحركة" %}:</strong> ${data.car_details.transmission}</p>
                                    <p><strong>{% trans "نوع الوقود" %}:</strong> ${data.car_details.fuel_type}</p>
                                </div>
                            </div>
                        `;
                        $(".car-details-content").html(carDetails);
                        $(".car-details-info").slideDown();
                    },
                    error: function(error) {
                        console.error("Error fetching car data:", error);
                        $(".customer-info, .car-details-info").slideUp();
                        alert("{% trans 'حدث خطأ أثناء جلب بيانات الحجز' %}");
                    }
                });
            } else {
                // إخفاء معلومات العميل والسيارة إذا لم يتم اختيار حجز
                $(".customer-info, .car-details-info").slideUp();
            }
        });
        
        // الرسم التفاعلي لمستوى الوقود
        function updateFuelGauge() {
            const selectedValue = $("#{{ form.fuel_level.id_for_label }}").val();
            let percentage = 0;
            
            switch (selectedValue) {
                case 'empty':
                    percentage = 0;
                    break;
                case 'quarter':
                    percentage = 25;
                    break;
                case 'half':
                    percentage = 50;
                    break;
                case 'three_quarters':
                    percentage = 75;
                    break;
                case 'full':
                    percentage = 100;
                    break;
            }
            
            $("#fuel-gauge-visual").css('width', percentage + '%');
            
            // تحديث الخيارات المرئية
            $(".fuel-level-option").removeClass('selected');
            $(`.fuel-level-option[data-value="${selectedValue}"]`).addClass('selected');
        }
        
        // تحديث الرسم عند تغيير القيمة
        $("#{{ form.fuel_level.id_for_label }}").change(updateFuelGauge);
        
        // النقر على خيارات مستوى الوقود
        $(".fuel-level-option").click(function() {
            const value = $(this).data('value');
            $("#{{ form.fuel_level.id_for_label }}").val(value).trigger('change');
        });
        
        // تحديث الرسم عند تحميل الصفحة
        updateFuelGauge();
        
        // إضافة تأثيرات مرئية عند تغيير نوع التقرير
        $("#{{ form.report_type.id_for_label }}").change(function() {
            const reportType = $(this).val();
            
            // إذا كان التقرير من نوع صيانة، أظهر حقول الصيانة
            if (reportType === 'maintenance' || reportType === 'periodic') {
                $("#{{ form.maintenance_type.id_for_label }}").closest('.col-12').show();
            } else {
                $("#{{ form.maintenance_type.id_for_label }}").closest('.col-12').hide();
            }
        }).trigger('change');
        
        // تحقق مما إذا كان هناك حجز مختار بالفعل عند تحميل الصفحة
        if ($("#reservation-select").val()) {
            $("#reservation-select").trigger("change");
        }
    });
</script>
{% endblock %}