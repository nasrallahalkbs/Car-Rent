{% extends "admin/base_site_print.html" %}
{% load i18n static %}

{% block title %}{% trans "نموذج تسليم سيارة" %} - {{ report.car.model_name }} {{ report.car.year }}{% endblock %}

{% block extrahead %}
<style>
    @media print {
        @page {
            size: A4 portrait;
            margin: 0.5cm;
        }
        
        body {
            font-family: 'Tajawal', 'Cairo', sans-serif;
            line-height: 1.3;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 0;
            font-size: 11px;
        }
        
        .print-container {
            width: 100%;
            max-width: 21cm;
            margin: 0 auto;
            background: #fff;
            padding: 0;
        }
        
        .header-section {
            text-align: right;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        
        .header-section h2 {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
        }
        
        .header-section p {
            margin: 5px 0;
            font-size: 10px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 60% 40%;
            gap: 10px;
        }
        
        .left-column {
            border-left: 1px solid #ccc;
            padding-left: 10px;
        }
        
        .search-box {
            border: 1px solid #ddd;
            padding: 5px;
            margin-bottom: 10px;
            display: flex;
            border-radius: 2px;
        }
        
        .search-box input {
            border: none;
            width: 100%;
            padding: 2px 5px;
            font-size: 11px;
        }
        
        .customer-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .info-box {
            border: 1px solid #ddd;
            border-radius: 2px;
            padding: 3px;
            font-size: 9px;
        }
        
        .info-box .label {
            color: #777;
            display: block;
            margin-bottom: 2px;
        }
        
        .info-box .value {
            font-weight: bold;
        }
        
        .car-specs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
            font-size: 9px;
        }
        
        table.inspection-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-bottom: 10px;
        }
        
        table.inspection-table th, 
        table.inspection-table td {
            border: 1px solid #ddd;
            padding: 2px 3px;
            text-align: right;
        }
        
        table.inspection-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            width: 40%;
        }
        
        .car-views {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .car-view {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .car-view img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            max-height: 180px; /* تحديد ارتفاع موحد للصور */
            object-fit: contain; /* للحفاظ على نسبة العرض إلى الارتفاع */
            border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .car-image-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .terms-section {
            border: 1px solid #ddd;
            padding: 8px;
            margin: 10px 0;
            font-size: 9px;
            background-color: #f9f9f9;
        }
        
        .signatures {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-box {
            border-top: 1px solid #ddd;
            padding-top: 5px;
            text-align: center;
            font-size: 9px;
        }
        
        .inspection-item-normal {
            color: #28a745;
        }
        
        .inspection-item-damaged {
            color: #dc3545;
        }
        
        .inspection-item-warning {
            color: #ffc107;
        }
        
        .btn, .navbar, footer, .no-print {
            display: none !important;
        }
    }

    /* Non-print styles */
    body {
        background-color: #f4f6f9;
        font-family: 'Tajawal', 'Cairo', sans-serif;
    }
    
    .print-container {
        width: 100%;
        max-width: 21cm;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        border-radius: 5px;
    }
    
    .header-section {
        text-align: right;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ccc;
    }
    
    .header-section h2 {
        margin: 0;
        font-size: 22px;
        font-weight: bold;
    }
    
    .header-section p {
        margin: 10px 0;
        font-size: 14px;
    }
    
    .main-grid {
        display: grid;
        grid-template-columns: 60% 40%;
        gap: 20px;
    }
    
    .left-column {
        border-left: 1px solid #ccc;
        padding-left: 20px;
    }
    
    .search-box {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 15px;
        display: flex;
        border-radius: 4px;
    }
    
    .search-box input {
        border: none;
        width: 100%;
        padding: 5px 10px;
        font-size: 14px;
    }
    
    .customer-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .info-box {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        font-size: 14px;
    }
    
    .info-box .label {
        color: #777;
        display: block;
        margin-bottom: 5px;
    }
    
    .info-box .value {
        font-weight: bold;
    }
    
    .car-specs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    table.inspection-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    table.inspection-table th, 
    table.inspection-table td {
        border: 1px solid #ddd;
        padding: 8px 10px;
        text-align: right;
    }
    
    table.inspection-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        width: 40%;
    }
    
    .car-views {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .car-view {
        text-align: center;
        margin-bottom: 15px;
    }
    
    .car-view img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
        max-height: 180px; /* تحديد ارتفاع موحد للصور */
        object-fit: contain; /* للحفاظ على نسبة العرض إلى الارتفاع */
        border: 1px solid #ddd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .car-image-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .terms-section {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 15px 0;
        font-size: 13px;
        background-color: #f9f9f9;
    }
    
    .signatures {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }
    
    .signature-box {
        border-top: 1px solid #ddd;
        padding-top: 10px;
        text-align: center;
        font-size: 13px;
    }
    
    .inspection-item-normal {
        color: #28a745;
    }
    
    .inspection-item-damaged {
        color: #dc3545;
    }
    
    .inspection-item-warning {
        color: #ffc107;
    }
    
    /* إضافة أنماط جديدة لتناسب التصميم المرجعي */
    .status-good {
        color: #28a745;
        font-weight: bold;
    }
    
    .status-warning {
        color: #ffc107;
        font-weight: bold;
    }
    
    .status-damaged {
        color: #dc3545;
        font-weight: bold;
    }
    
    .additional-notes h3,
    .inspection-section h3 {
        font-size: 12px;
        margin-bottom: 5px;
        color: #0056b3;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 3px;
    }
    
    .notes-box {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 5px;
        margin-bottom: 8px;
        font-size: 9px;
        min-height: 30px;
    }
    
    .inspection-box {
        margin-bottom: 10px;
    }
    
    .detail-section {
        background-color: #0056b3;
        color: white;
        padding: 5px 8px;
        margin-bottom: 8px;
        font-size: 11px;
        font-weight: bold;
        border-radius: 3px;
    }

    .print-button {
        display: block;
        margin: 20px auto;
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
    }
    
    /* أنماط إضافية جديدة تم إضافتها */
    .car-view-header {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 3px 5px;
        margin-top: 10px;
        margin-bottom: 3px;
        font-size: 10px;
        font-weight: bold;
        text-align: center;
        border-radius: 3px;
    }
    
    .car-view {
        border: 1px solid #dee2e6;
        padding: 5px;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .signature-placeholder {
        border-bottom: 1px solid #999;
        height: 20px;
        margin-top: 5px;
        font-size: 10px;
        color: #777;
        text-align: center;
    }
    
    .stamp-placeholder {
        border: 1px dashed #999;
        border-radius: 5px;
        height: 40px;
        margin-top: 5px;
    }
    
    .date-value {
        font-weight: bold;
        color: #495057;
    }
    
    /* تأكيد الألوان في وضع الطباعة */
    @media print {
        .status-good {
            color: #28a745 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .status-warning {
            color: #ffc107 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .status-damaged {
            color: #dc3545 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* ضمان طباعة القسم الأزرق باللون */
        .detail-section {
            background-color: #0056b3 !important;
            color: white !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* ضمان طباعة عناوين صور السيارة */
        .car-view-header {
            background-color: #f8f9fa !important;
            border: 1px solid #e9ecef !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* ضمان طباعة عناوين فئات الفحص */
        .inspection-table th[colspan="2"] {
            background-color: #f0f0f0 !important;
            color: #333 !important;
            font-weight: bold !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* تحسين تنسيق جدول الفحص للطباعة */
        .inspection-table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-bottom: 10px !important;
        }
        
        .inspection-table th, 
        .inspection-table td {
            border: 1px solid #ddd !important;
            padding: 2px 4px !important;
            font-size: 9px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="print-container">
    <div class="header-section">
        <h2>نموذج تسليم سيارة</h2>
        <p>
            يحتوي هذا النموذج على معلومات حالة السيارة عند تسليمها للعميل، ويتضمن تفاصيل السيارة والعميل وحالة أجزاء السيارة.
        </p>
    </div>

    <div class="main-grid">
        <div class="left-column">
            <!-- معلومات العميل والسيارة -->
            <div class="search-box">
                <input type="text" placeholder="بحث عن حالة السيارة" disabled>
            </div>
            
            <div class="customer-info">
                <div class="info-box">
                    <span class="label">رقم عقد الإيجار</span>
                    <span class="value">{{ report.reservation.id }}</span>
                </div>
                <div class="info-box">
                    <span class="label">رقم التقرير</span>
                    <span class="value">{{ report.id }}</span>
                </div>
                <div class="info-box">
                    <span class="label">نوع التقرير</span>
                    <span class="value"><strong>{{ report.get_report_type_display }}</strong></span>
                </div>
                <div class="info-box">
                    <span class="label">اسم العميل</span>
                    <span class="value">{{ report.customer.full_name }}</span>
                </div>
                <div class="info-box">
                    <span class="label">مستوى الوقود</span>
                    <span class="value">{{ report.get_fuel_level_display }}</span>
                </div>
                <div class="info-box">
                    <span class="label">تاريخ التقرير</span>
                    <span class="value">{{ report.date|date:"Y-m-d H:i" }}</span>
                </div>
                <div class="info-box">
                    <span class="label">تاريخ الاستلام</span>
                    <span class="value">{{ report.delivery_date|date:"Y-m-d" }}</span>
                </div>
                <div class="info-box">
                    <span class="label">رقم الهوية</span>
                    <span class="value">{{ report.customer.id_number }}</span>
                </div>
                <div class="info-box">
                    <span class="label">تاريخ التسليم</span>
                    <span class="value">{{ report.return_date|date:"Y-m-d" }}</span>
                </div>
            </div>
            
            <div class="car-specs">
                <div class="info-box">
                    <span class="label">السيارة</span>
                    <span class="value">{{ report.car.make }} {{ report.car.model }}</span>
                </div>
                <div class="info-box">
                    <span class="label">سنة الصنع</span>
                    <span class="value">{{ report.car.year }}</span>
                </div>
                <div class="info-box">
                    <span class="label">رقم اللوحة</span>
                    <span class="value">{{ report.car.license_plate }}</span>
                </div>
                <div class="info-box">
                    <span class="label">رقم الهيكل</span>
                    <span class="value">{{ report.car.vin }}</span>
                </div>
                <div class="info-box">
                    <span class="label">قراءة العداد</span>
                    <span class="value">{{ report.mileage }} كم</span>
                </div>
                <div class="info-box">
                    <span class="label">المسافة المقطوعة</span>
                    <span class="value">{{ report.distance_traveled }} كم</span>
                </div>
                <div class="info-box">
                    <span class="label">لون السيارة</span>
                    <span class="value">{{ report.car.color }}</span>
                </div>
                <div class="info-box">
                    <span class="label">ناقل الحركة</span>
                    <span class="value">{{ report.car.get_transmission_display }}</span>
                </div>
                <div class="info-box">
                    <span class="label">فئة السيارة</span>
                    <span class="value">{{ report.car.get_category_display }}</span>
                </div>
                <div class="info-box">
                    <span class="label">حالة السيارة</span>
                    <span class="value">
                        <strong class="{% if report.car_condition == 'excellent' or report.car_condition == 'good' %}status-good{% elif report.car_condition == 'fair' %}status-warning{% else %}status-damaged{% endif %}">
                            {{ report.get_car_condition_display }}
                        </strong>
                    </span>
                </div>
            </div>
            
            <!-- شريط أزرق للملاحظات الإضافية -->
            <div class="detail-section">
                <i class="fas fa-sticky-note"></i> ملاحظات إضافية
            </div>
            
            <div class="additional-notes">
                <div class="notes-box">
                    <p>{{ report.notes|default:"لا توجد ملاحظات إضافية" }}</p>
                </div>
            </div>
            
            <!-- تفاصيل فحص السيارة -->
            <!-- شريط أزرق للتفاصيل -->
            <div class="detail-section">
                <i class="fas fa-clipboard-check"></i> تفاصيل الفحص
            </div>
            
            <div class="inspection-section">
                <div class="inspection-box">
                    <table class="inspection-table">
                        <tr>
                            <th>العنصر</th>
                            <th>الحالة</th>
                        </tr>
                        
                        {% for category_id, category in categories.items %}
                            <!-- عنوان فئة الفحص -->
                            <tr>
                                <th colspan="2" style="background-color: #f0f0f0;">{{ category.name }}</th>
                            </tr>
                            
                            {% if category.items %}
                                <!-- عناصر الفحص للفئة -->
                                {% for detail in category.items %}
                                    <tr>
                                        <td>{{ detail.inspection_item.name }}</td>
                                        <td class="{% if detail.condition == 'poor' or detail.condition == 'damaged' %}status-damaged{% elif detail.condition == 'fair' %}status-warning{% else %}status-good{% endif %}">
                                            {{ detail.get_condition_display }}
                                            {% if detail.needs_repair %}
                                                <span style="color: #dc3545; font-weight: bold;">*</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <!-- لا توجد عناصر في هذه الفئة -->
                                <tr>
                                    <td colspan="2" class="text-center" style="font-style: italic; color: #6c757d;">
                                        لا توجد عناصر مسجلة في هذه الفئة
                                    </td>
                                </tr>
                            {% endif %}
                        {% empty %}
                            <!-- لا توجد فئات فحص -->
                            <tr>
                                <td colspan="2" class="text-center" style="font-style: italic; color: #6c757d;">
                                    لا توجد تفاصيل فحص مسجلة لهذا التقرير
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                    
                    <!-- مفتاح توضيحي للألوان ومؤشرات الحالة -->
                    <div style="margin-top: 5px; font-size: 8px; color: #555;">
                        <span class="status-good" style="font-weight: bold;">■</span> حالة جيدة / ممتازة  
                        <span class="status-warning" style="font-weight: bold; margin-right: 10px;">■</span> حالة متوسطة  
                        <span class="status-damaged" style="font-weight: bold; margin-right: 10px;">■</span> حالة سيئة / تالفة
                        <span style="color: #dc3545; font-weight: bold; margin-right: 10px;">*</span> يحتاج إلى إصلاح
                    </div>
                </div>
            </div>
            
            <!-- شروط التسليم -->
            <div class="terms-section">
                <p>أقر أنا الموقع أدناه بأنني استلمت السيارة المذكورة أعلاه بالحالة الموضحة في هذا النموذج وأتعهد بإعادتها بنفس الحالة. وفي حال وجود أي تلف او ضرر جديد سيتم احتساب تكلفة الإصلاح حسب سياسة الشركة.</p>
            </div>
            
            <!-- شريط أزرق للتوقيعات -->
            <div class="detail-section">
                <i class="fas fa-signature"></i> التوقيعات
            </div>
            
            <!-- التوقيعات -->
            <div class="signatures">
                <div class="signature-box">
                    <p>توقيع المستلم</p>
                    {% if customer_signature %}
                        <img src="{{ customer_signature.signature.url }}" alt="توقيع العميل" style="max-height: 40px;">
                    {% else %}
                        <div class="signature-placeholder">_________________</div>
                    {% endif %}
                </div>
                <div class="signature-box">
                    <p>ختم الشركة</p>
                    <div class="stamp-placeholder"></div>
                </div>
                <div class="signature-box">
                    <p>توقيع الموظف</p>
                    {% if staff_signature %}
                        <img src="{{ staff_signature.signature.url }}" alt="توقيع الموظف" style="max-height: 40px;">
                    {% else %}
                        <div class="signature-placeholder">_________________</div>
                    {% endif %}
                </div>
                <div class="signature-box">
                    <p>تاريخ الاستلام</p>
                    <p class="date-value">{{ report.date|date:"Y-m-d" }}</p>
                </div>
            </div>
        </div>
        
        <div class="right-column">
            <!-- شريط أزرق للضمان البصري -->
            <div class="detail-section">
                <i class="fas fa-car"></i> الضمان البصري
            </div>
            
            <!-- صور السيارة -->
            <div class="car-views">
                <div class="car-view-header">صورة front</div>
                <div class="car-view">
                    {% if report.front_image %}
                        <img src="{{ report.front_image.url }}" alt="الواجهة الأمامية">
                    {% else %}
                        <img src="{% static 'car_images/front.png' %}" alt="الواجهة الأمامية">
                    {% endif %}
                </div>
                
                <div class="car-view-header">صورة rear</div>
                <div class="car-view">
                    {% if report.rear_image %}
                        <img src="{{ report.rear_image.url }}" alt="الواجهة الخلفية">
                    {% else %}
                        <img src="{% static 'car_images/rear.png' %}" alt="الواجهة الخلفية">
                    {% endif %}
                </div>
                
                <div class="car-view-header">صورة side</div>
                <div class="car-view">
                    {% if report.side_image %}
                        <img src="{{ report.side_image.url }}" alt="المنظر الجانبي">
                    {% else %}
                        <img src="{% static 'car_images/side.png' %}" alt="المنظر الجانبي">
                    {% endif %}
                </div>
                
                <div class="car-view-header">صورة interior</div>
                <div class="car-view">
                    {% if report.interior_image %}
                        <img src="{{ report.interior_image.url }}" alt="المنظر الداخلي">
                    {% else %}
                        <img src="{% static 'car_images/side2.png' %}" alt="المنظر الداخلي">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <button onclick="window.print()" class="print-button no-print">
        <i class="fas fa-print"></i> طباعة النموذج
    </button>
</div>
{% endblock %}