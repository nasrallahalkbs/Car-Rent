{% extends "admin/enhanced/admin_layout.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "الحجوزات" %} | {% trans "لوحة المسؤول" %}{% endblock %}

{% block extra_css %}
<style>
  /* تصميم صفحة الحجوزات الجديد (مطابق للصورة المرجعية) */
  .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e3e6f0;
  }
  
  /* نمط الجدول */
  .reservations-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .reservations-table th {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e3e6f0;
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .reservations-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e3e6f0;
    text-align: center;
    vertical-align: middle;
  }
  
  /* نمط أيقونات العميل والسيارة */
  .user-avatar, .car-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
  }
  
  /* نمط شارات الحالة */
  .badge-status {
    display: inline-block;
    padding: 0.3rem 0.6rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .badge-confirmed {
    background-color: #e8f5e9 !important;
    color: #4caf50 !important;
    border: 1px solid rgba(76, 175, 80, 0.2);
  }
  
  .badge-pending {
    background-color: #fff8e1 !important;
    color: #ffc107 !important;
    border: 1px solid rgba(255, 193, 7, 0.2);
  }
  
  .badge-paid {
    background-color: #e8f5e9 !important;
    color: #4caf50 !important;
    border: 1px solid rgba(76, 175, 80, 0.2);
  }
  
  .badge-waiting {
    background-color: #fff8e1 !important;
    color: #ffc107 !important;
    border: 1px solid rgba(255, 193, 7, 0.2);
  }
  
  /* قائمة الإجراءات (مطابقة للصورة المرجعية) */
  .actions-list {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }
  
  .actions-list a {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    color: white;
    font-size: 12px;
  }
  
  .actions-list .delete-action {
    background-color: #f44336;
  }
  
  .actions-list .view-action {
    background-color: #2196f3;
  }
  
  .actions-list .print-action {
    background-color: #4caf50;
  }
  
  .actions-list .export-action {
    background-color: #ff9800;
  }
  
  .actions-list .message-action {
    background-color: #9c27b0;
  }
  
  .actions-list i {
    font-size: 12px;
  }
  
  /* تنسيق البحث والفلتر */
  .filter-options {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .filter-options .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  
  .pagination-container {
    margin-top: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- عنوان الصفحة -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="h3 mb-0 text-gray-800">{% trans "الحجوزات" %}</h1>
      <p class="mb-0 text-muted">{% trans "إدارة جميع حجوزات العملاء" %}</p>
    </div>
  </div>
  
  <!-- خيارات البحث والفلتر -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">{% trans "خيارات البحث والتصفية" %}</h5>
          <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filterOptions">
            <i class="fas fa-filter"></i> {% trans "عرض/إخفاء" %}
          </button>
        </div>
        <div id="filterOptions" class="collapse show">
          <div class="card-body">
            <form method="get" class="row">
              <div class="col-md-3 mb-3">
                <label for="status-filter" class="form-label">{% trans "حالة الحجز" %}</label>
                <select name="status" id="status-filter" class="form-select">
                  <option value="">{% trans "جميع الحالات" %}</option>
                  <option value="pending" {% if status == 'pending' %}selected{% endif %}>{% trans "قيد المراجعة" %}</option>
                  <option value="confirmed" {% if status == 'confirmed' %}selected{% endif %}>{% trans "تمت الموافقة" %}</option>
                  <option value="completed" {% if status == 'completed' %}selected{% endif %}>{% trans "مكتمل" %}</option>
                  <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>{% trans "ملغي" %}</option>
                </select>
              </div>
              <div class="col-md-3 mb-3">
                <label for="payment-filter" class="form-label">{% trans "حالة الدفع" %}</label>
                <select name="payment_status" id="payment-filter" class="form-select">
                  <option value="">{% trans "جميع الحالات" %}</option>
                  <option value="pending" {% if payment_status == 'pending' %}selected{% endif %}>{% trans "انتظار الدفع" %}</option>
                  <option value="paid" {% if payment_status == 'paid' %}selected{% endif %}>{% trans "مدفوع" %}</option>
                  <option value="refunded" {% if payment_status == 'refunded' %}selected{% endif %}>{% trans "مسترجع" %}</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="search" class="form-label">{% trans "بحث" %}</label>
                <input type="text" class="form-control" id="search" name="search" placeholder="{% trans 'البحث حسب الاسم، رقم الحجز...' %}" value="{{ search }}">
              </div>
              <div class="col-md-2 mb-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-search"></i> {% trans "بحث" %}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- قائمة الحجوزات -->
  <div class="row">
    <div class="col-12">
      <!-- عنوان قائمة الحجوزات والأزرار -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 fw-bold">
          <i class="fas fa-list-ul me-2"></i>
          {% trans "قائمة الحجوزات" %}
        </h6>
        <div>
          <button class="btn btn-sm" style="border: 1px solid #ddd; background-color: #f8f9fa;">
            <i class="fas fa-download me-1"></i> {% trans "طباعة" %}
          </button>
          <button class="btn btn-sm ms-2" style="border: 1px solid #ddd; background-color: #f8f9fa;">
            <i class="fas fa-sort me-1"></i> {% trans "ترتيب حسب" %}
          </button>
        </div>
      </div>
      
      <!-- جدول الحجوزات -->
      <div class="card border-0 shadow-sm mb-4" style="border-radius: 4px; overflow: hidden; border: 1px solid #e9ecef !important; box-shadow: 0 2px 4px rgba(0,0,0,0.03) !important;">
        <div class="table-responsive">
          <table class="reservations-table">
            <thead>
              <tr>
                <th>{% trans "رقم الحجز" %}</th>
                <th>{% trans "العميل" %}</th>
                <th>{% trans "السيارة" %}</th>
                <th>{% trans "التواريخ" %}</th>
                <th>{% trans "المبلغ" %}</th>
                <th>{% trans "حالة الحجز" %}</th>
                <th>{% trans "حالة الدفع" %}</th>
                <th>{% trans "تاريخ الإنشاء" %}</th>
                <th>{% trans "إجراءات" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for reservation in reservations %}
              <tr>
                <td>#{{ reservation.id }}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="user-avatar">
                      <i class="fas fa-user-alt"></i>
                    </div>
                    <div class="ms-2 text-start">
                      <div style="font-size: 0.9rem;">{{ reservation.user.get_full_name }}</div>
                      <small class="text-muted" style="font-size: 0.75rem;">{{ reservation.user.email }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="car-avatar">
                      <i class="fas fa-car-alt"></i>
                    </div>
                    <div class="ms-2 text-start">
                      <div style="font-size: 0.9rem;">{{ reservation.car.make }} {{ reservation.car.model }}</div>
                      <small class="text-muted" style="font-size: 0.75rem;">{{ reservation.car.year }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <div style="font-size: 0.85rem;">{{ reservation.start_date|date:"Y-m-d" }} - {{ reservation.end_date|date:"Y-m-d" }}</div>
                  <div><small class="text-muted" style="font-size: 0.75rem;">{{ reservation.start_date|timesince:reservation.end_date }} أيام</small></div>
                </td>
                <td>
                  <strong>{{ reservation.total_price }} د.ك</strong>
                </td>
                <td>
                  {% if reservation.status == 'pending' %}
                  <span class="badge-status badge-pending">
                    <i class="fas fa-clock me-1"></i> قيد المراجعة
                  </span>
                  {% elif reservation.status == 'confirmed' %}
                  <span class="badge-status badge-confirmed">
                    <i class="fas fa-check-circle me-1"></i> تمت الموافقة
                  </span>
                  {% elif reservation.status == 'completed' %}
                  <span class="badge-status" style="background-color: #e1f5fe !important; color: #03a9f4 !important; border: 1px solid rgba(3, 169, 244, 0.2);">
                    <i class="fas fa-flag-checkered me-1"></i> مكتمل
                  </span>
                  {% elif reservation.status == 'cancelled' %}
                  <span class="badge-status" style="background-color: #ffebee !important; color: #f44336 !important; border: 1px solid rgba(244, 67, 54, 0.2);">
                    <i class="fas fa-ban me-1"></i> ملغي
                  </span>
                  {% endif %}
                </td>
                <td>
                  {% if reservation.payment_status == 'paid' %}
                  <span class="badge-status badge-paid">
                    <i class="fas fa-check-circle me-1"></i> مدفوع
                  </span>
                  {% elif reservation.payment_status == 'pending' %}
                  <span class="badge-status badge-waiting">
                    <i class="fas fa-clock me-1"></i> انتظار الدفع
                  </span>
                  {% elif reservation.payment_status == 'refunded' %}
                  <span class="badge-status" style="background-color: #e1f5fe !important; color: #03a9f4 !important; border: 1px solid rgba(3, 169, 244, 0.2);">
                    <i class="fas fa-undo me-1"></i> مسترجع
                  </span>
                  {% endif %}
                </td>
                <td>
                  {{ reservation.created_at|date:"Y-m-d" }}
                </td>
                <td>
                  <div class="actions-list">
                    <a href="{% url 'delete_reservation' reservation.id %}" class="delete-action" onclick="return confirm('هل أنت متأكد من رغبتك في حذف هذا الحجز بشكل نهائي؟');">
                      <i class="fas fa-trash-alt"></i>
                    </a>
                    <a href="{% url 'admin_reservation_detail' reservation.id %}" class="view-action">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a href="#" class="print-action">
                      <i class="fas fa-print"></i>
                    </a>
                    <a href="#" class="export-action">
                      <i class="fas fa-file-export"></i>
                    </a>
                    <a href="#" class="message-action">
                      <i class="fas fa-comment-alt"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center py-4">
                  <div class="empty-state">
                    <i class="fas fa-calendar-times fa-3x mb-3 text-muted"></i>
                    <h5>{% trans "لا توجد حجوزات" %}</h5>
                    <p class="text-muted">{% trans "لم يتم العثور على حجوزات مطابقة لمعايير البحث" %}</p>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- ترقيم الصفحات -->
      {% if reservations.has_other_pages %}
      <div class="pagination-container">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            {% if reservations.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ reservations.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link"><i class="fas fa-chevron-right"></i></span>
            </li>
            {% endif %}
            
            {% for i in reservations.paginator.page_range %}
              {% if reservations.number == i %}
              <li class="page-item active">
                <span class="page-link">{{ i }}</span>
              </li>
              {% elif i > reservations.number|add:'-3' and i < reservations.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                  {{ i }}
                </a>
              </li>
              {% endif %}
            {% endfor %}
            
            {% if reservations.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ reservations.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link"><i class="fas fa-chevron-left"></i></span>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // تفعيل tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // طباعة جدول الحجوزات
    document.querySelector('.btn-print').addEventListener('click', function() {
      window.print();
    });
  });
</script>
{% endblock %}