{% extends 'admin/index.html' %}
{% load static %}
{% load crispy_forms_tags %}

<!-- Debug information: Total users: {{ all_users|length }} -->
<!-- Users available: {% for u in all_users %}[{{ u.id }}. {{ u.first_name }} {{ u.last_name }}]{% endfor %} -->
{% load admin_extras %}
<div class="alert alert-info mb-4" style="font-family: monospace; font-size: 0.9em;">
    <h5>Debug Information:</h5>
    <div>Total users in database: {{ all_users|length }}</div>
    <div>Users:
    {% for u in all_users %}
        <pre>[{{ u.id }}] {{ u.username }} - {{ u.first_name }} {{ u.last_name }} - {{ u.email }}</pre>
    {% empty %}
        <strong>No users found!</strong>
    {% endfor %}
    </div>
</div>

{% block title %}إضافة دفعة يدوية - كاررنتال{% endblock %}

{% block admin_content %}
<div class="container py-4">
    <!-- فتات الخبز -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_index' %}">لوحة المعلومات</a></li>
            <li class="breadcrumb-item"><a href="{% url 'admin_payments' %}">المدفوعات</a></li>
            <li class="breadcrumb-item active">إضافة دفعة يدوية</li>
        </ol>
    </nav>

    <!-- عنوان الصفحة -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="section-heading mb-0">إضافة دفعة يدوية</h2>
        <a href="{% url 'admin_payments' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-right me-2"></i>العودة للمدفوعات
        </a>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="dashboard-card p-4">
                <form method="post" id="paymentForm">
                    {% csrf_token %}
                    
                    <!-- اختيار المستخدم -->
                    <div class="mb-4">
                        <h5 class="mb-3 fw-bold">1. اختر المستخدم</h5>
                        <div class="mb-3">
                            <label for="user_id" class="form-label required">المستخدم</label>
                            <select name="user_id" id="user_id" class="form-select" required>
                                <option value="">-- اختر المستخدم --</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" title="ID: {{ user.id }}">
                                    {{ user.username }} - {{ user.first_name }} {{ user.last_name }} ({{ user.email }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="small text-muted mt-1">
                                عدد المستخدمين المتاحين: {{ users|length }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- اختيار الحجز أو دفعة بدون حجز -->
                    <div class="mb-4">
                        <h5 class="mb-3 fw-bold">2. اختر نوع المدفوعات</h5>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="payment_type" id="type_reservation" value="reservation" checked>
                            <label class="form-check-label" for="type_reservation">
                                دفع قيمة حجز موجود
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="payment_type" id="type_manual" value="manual">
                            <label class="form-check-label" for="type_manual">
                                دفعة يدوية (بدون حجز)
                            </label>
                            <input type="hidden" name="no_reservation" id="no_reservation">
                        </div>
                    </div>
                    
                    <!-- اختيار الحجز (يظهر فقط مع النوع الأول) -->
                    <div class="mb-4" id="reservation_section">
                        <h5 class="mb-3 fw-bold">3. اختر الحجز</h5>
                        <div class="mb-3">
                            <label for="reservation_id" class="form-label required">حجز العميل</label>
                            <select name="reservation_id" id="reservation_id" class="form-select" required>
                                <option value="">-- اختر الحجز --</option>
                                {% for res in incomplete_reservations %}
                                <option value="{{ res.id }}" data-price="{{ res.total_price }}" data-user="{{ res.user.id }}">
                                    حجز #{{ res.id }} - {{ res.car.make }} {{ res.car.model }} ({{ res.total_price }} د.ك)
                                </option>
                                {% endfor %}
                            </select>
                            <div class="text-muted mt-2" id="reservation_info"></div>
                        </div>
                    </div>
                    
                    <!-- معلومات الدفعة اليدوية (يظهر فقط مع النوع الثاني) -->
                    <div class="mb-4" id="manual_payment_section" style="display: none;">
                        <h5 class="mb-3 fw-bold">3. معلومات الدفعة اليدوية</h5>
                        <div class="mb-3">
                            <label for="payment_reason" class="form-label required">سبب الدفع</label>
                            <select name="payment_reason" id="payment_reason" class="form-select">
                                <option value="deposit">وديعة</option>
                                <option value="prepayment">دفعة مقدمة</option>
                                <option value="credit">رصيد حساب</option>
                                <option value="other">سبب آخر</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- تفاصيل الدفع -->
                    <div class="mb-4">
                        <h5 class="mb-3 fw-bold">4. تفاصيل الدفع</h5>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.amount|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.payment_method|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.reference_number|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.notes|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- أزرار الإجراءات -->
                    <div class="mt-4 text-end">
                        <a href="{% url 'admin_payments' %}" class="btn btn-outline-secondary me-2">إلغاء</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>تسجيل الدفعة
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userSelect = document.getElementById('user_id');
        const paymentTypeReservation = document.getElementById('type_reservation');
        const paymentTypeManual = document.getElementById('type_manual');
        const noReservationInput = document.getElementById('no_reservation');
        const reservationSection = document.getElementById('reservation_section');
        const manualPaymentSection = document.getElementById('manual_payment_section');
        const reservationSelect = document.getElementById('reservation_id');
        const reservationInfo = document.getElementById('reservation_info');
        
        // مراقبة تغييرات اختيار المستخدم
        userSelect.addEventListener('change', function() {
            if (paymentTypeReservation.checked) {
                // تحديث قائمة الحجوزات بناءً على المستخدم المختار
                updateReservationOptions();
            }
        });
        
        // مراقبة تغييرات نوع الدفع
        paymentTypeReservation.addEventListener('change', function() {
            if (this.checked) {
                reservationSection.style.display = 'block';
                manualPaymentSection.style.display = 'none';
                noReservationInput.value = '';
                // تحديث قائمة الحجوزات
                updateReservationOptions();
            }
        });
        
        paymentTypeManual.addEventListener('change', function() {
            if (this.checked) {
                reservationSection.style.display = 'none';
                manualPaymentSection.style.display = 'block';
                noReservationInput.value = 'on';
                reservationSelect.value = '';
            }
        });
        
        // مراقبة تغييرات اختيار الحجز
        reservationSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const price = selectedOption.getAttribute('data-price');
                document.getElementById('id_amount').value = price;
            } else {
                document.getElementById('id_amount').value = '';
            }
        });
        
        // وظيفة لتحديث خيارات الحجز بناءً على المستخدم المختار
        function updateReservationOptions() {
            const userId = userSelect.value;
            if (!userId) {
                return;
            }
            
            reservationInfo.textContent = 'جاري تحميل الحجوزات...';
            
            // تحديث قائمة الحجوزات
            reservationSelect.innerHTML = '<option value="">-- اختر الحجز --</option>';
            
            {% for res in incomplete_reservations %}
            if ("{{ res.user.id }}" == userId) {
                const option = document.createElement('option');
                option.value = "{{ res.id }}";
                option.setAttribute('data-price', "{{ res.total_price }}");
                option.setAttribute('data-user', "{{ res.user.id }}");
                option.textContent = "حجز #{{ res.id }} - {{ res.car.make }} {{ res.car.model }} ({{ res.total_price }} د.ك)";
                reservationSelect.appendChild(option);
            }
            {% endfor %}
            
            if (reservationSelect.options.length <= 1) {
                reservationInfo.textContent = 'لا توجد حجوزات معلقة لهذا المستخدم';
            } else {
                reservationInfo.textContent = `${reservationSelect.options.length - 1} حجوزات متاحة`;
            }
        }
    });
</script>
{% endblock %}
