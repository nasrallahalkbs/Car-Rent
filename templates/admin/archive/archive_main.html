{% extends "admin_layout.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "الأرشيف الإلكتروني" %} | {% trans "لوحة التحكم" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css">
<style>
    /* لوحة التحكم - الأسلوب المخصص */
    :root {
        --primary-color: #3b82f6;
        --primary-dark: #1e40af;
        --primary-light: #93c5fd;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-color: #1e293b;
        --light-color: #f1f5f9;
        --border-radius: 0.5rem;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* تنسيق عام */
    body.admin {
        background-color: #f8fafc;
    }
    
    /* القائمة الجانبية */
    .admin-sidebar {
        background-color: var(--dark-color);
        color: #fff;
        min-height: 100vh;
    }
    
    .admin-sidebar .nav-link {
        padding: 0.75rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        transition: all 0.2s;
    }
    
    .admin-sidebar .nav-link i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }
    
    .admin-sidebar.rtl .nav-link i {
        margin-right: 0;
        margin-left: 0.75rem;
        text-align: right;
    }
    
    .admin-sidebar .nav-link:hover {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .admin-sidebar .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: 500;
    }
    
    .admin-sidebar .sidebar-heading {
        text-transform: uppercase;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 600;
        padding: 1rem 1.5rem 0.5rem;
    }
    
    /* تنسيقات صفحة الأرشيف الإلكتروني - مطابقة للصورة المرجعية */
    .archive-main-section {
        margin-top: 20px;
    }
    
    /* تنسيق القسم الرئيسي */
    .simple-archive-container {
        width: 100%;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* تنسيق عنوان الشجرة */
    .tree-title {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    /* تنسيقات شجرة المجلدات - مطابقة للصورة المرجعية */
    .simple-tree-view {
        padding: 10px;
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 500px;
        overflow-y: auto;
    }
    
    /* ألوان أيقونات شجرة المجلدات */
    .jstree-default .jstree-icon {
        color: #333; /* لون افتراضي للأيقونات */
    }
    
    .jstree-default .jstree-themeicon-custom,
    .jstree-default .fa-folder {
        color: #ffc837 !important; /* لون أصفر ذهبي للمجلدات */
    }
    
    .jstree-default .fa-hdd {
        color: #0078d7 !important; /* لون أزرق لأيقونة الكمبيوتر */
    }
    
    /* تنسيق عناصر الشجرة - مشابه لتصميم ويندوز */
    .jstree-default .jstree-anchor {
        white-space: normal;
        height: auto;
        color: #000; /* لون أسود للنص */
        padding: 2px 5px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* خط مشابه لويندوز */
        font-size: 14px;
        line-height: 24px;
    }
    
    /* تنسيق عند تحديد عنصر في الشجرة */
    .jstree-default .jstree-wholerow-clicked {
        background-color: #cce8ff !important; /* لون أزرق فاتح مشابه للصورة عند التحديد */
    }
    
    /* تنسيق لتمرير المؤشر فوق عنصر */
    .jstree-default .jstree-wholerow-hovered {
        background-color: #f0f0f0 !important; /* لون رمادي فاتح عند تمرير المؤشر */
    }
    
    /* تنسيق العنصر المحدد في الشجرة */
    .jstree-default .jstree-clicked {
        background-color: transparent !important; /* إزالة الخلفية الافتراضية */
        color: #000;
        font-weight: 500;
    }
    
    /* تباعد العناصر في الشجرة ونمط مشابه لويندوز */
    .jstree-default .jstree-node {
        min-height: 28px;
        line-height: 28px;
        margin-left: 0;
        background-image: none;
    }
    
    /* تعديل حجم أيقونة المجلد */
    .jstree-default .jstree-icon.fa-folder {
        font-size: 16px;
        color: #ffd04c !important; /* لون المجلد الذهبي مشابه للصورة */
    }
    
    /* تصميم أيقونات التوسيع/الانكماش بشكل مشابه لويندوز */
    .jstree-default .jstree-ocl {
        background-size: 16px auto;
        background-position: center;
        width: 20px;
    }
    
    /* تنسيق محاذاة شجرة المجلدات للغة العربية */
    .jstree-rtl .jstree-node {
        direction: rtl;
        text-align: right;
    }
    
    .jstree-rtl .jstree-icon {
        margin-left: 5px;
        margin-right: 0;
    }
    
    .jstree-rtl .jstree-anchor {
        padding: 3px 5px 3px 0;
    }
    
    /* تنسيق عرض معاينة المجلد */
    .folder-preview {
        min-height: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    /* تنسيق شاشة المحتوى الفارغة */
    .empty-folder-message {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .archive-main-section .row {
            flex-direction: column;
        }
        
        .simple-tree-view {
            min-height: 300px;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- القائمة الجانبية على اليمين في العربية -->
        <div class="col-lg-10 order-1">
            <div class="admin-content p-4">
                <!-- ترويسة الصفحة -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">{% trans "الأرشيف الإلكتروني" %}</h3>
                    <div>
                        <a href="#" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> {% trans "العودة للوحة التحكم" %}
                        </a>
                        <a href="#" class="btn btn-secondary">
                            <i class="fas fa-folder me-2"></i> {% trans "إدارة المجلدات" %}
                        </a>
                    </div>
                </div>
                
                <!-- قسم عرض شجرة المجلدات البسيطة (كما في الصورة المرجعية) -->
                <div class="archive-main-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-folder-open me-2 text-warning"></i> {% trans "مستكشف الأرشيف" %}</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                    <i class="fas fa-file-upload me-1"></i> {% trans "إضافة مستند" %}
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                                    <i class="fas fa-folder-plus me-1"></i> {% trans "إضافة مجلد" %}
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- هيكل بسيط للعرض كما في الصورة المرجعية -->
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- عنوان الشجرة -->
                                    <div class="tree-title">
                                        {% trans "تصميم (شجرة)" %}
                                    </div>
                                    
                                    <!-- مربع البحث في المجلدات -->
                                    <div class="search-box mb-3">
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="folder-search" class="form-control" placeholder="{% trans 'البحث في المجلدات...' %}">
                                            <button class="btn btn-outline-secondary" type="button">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- عرض المجلدات في شكل شجري بسيط مشابه لمستكشف ويندوز -->
                                    <div class="windows-explorer-container border bg-white" style="height: 480px; overflow: hidden; display: flex; flex-direction: column;">
                                        <div id="folder-tree" class="simple-tree-view flex-grow-1" dir="{% if is_rtl %}rtl{% else %}ltr{% endif %}" style="overflow-y: auto; padding: 5px;"></div>
                                        <div class="folder-status-bar d-flex justify-content-start align-items-center p-2 border-top bg-light" style="font-size: 12px; height: 24px;">
                                            <span id="items-count">4 items</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- عرض تفاصيل المجلد المختار - كما في الصورة المرجعية -->
                                <div class="col-md-8">
                                    <div class="folder-preview h-100">
                                        <!-- الحالة الأولية - لم يتم تحديد مجلد بعد -->
                                        <div id="no-folder-selected" class="d-flex justify-content-center align-items-center h-100">
                                            <div class="text-center">
                                                <i class="fas fa-folder-open text-warning" style="font-size: 72px;"></i>
                                                <p class="mt-3">{% trans "اختر مجلد من الشجرة لعرض محتوياته" %}</p>
                                            </div>
                                        </div>
                                        
                                        <!-- عرض محتويات المجلد المحدد (يظهر عند تحديد مجلد) -->
                                        <div id="folder-contents" class="d-none">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="folder-title mb-0">
                                                    <i class="fas fa-folder-open text-warning me-2"></i>
                                                    <span id="selected-folder-name"></span>
                                                </h5>
                                                
                                                <div class="folder-actions">
                                                    <a href="#" id="view-folder-btn" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye me-1"></i> {% trans "عرض المجلد" %}
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                                                        <i class="fas fa-folder-plus me-1"></i> {% trans "إضافة مجلد هنا" %}
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                                        <i class="fas fa-file-upload me-1"></i> {% trans "إضافة ملف" %}
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="folder-info bg-light p-3 rounded mb-3">
                                                <div id="folder-path" class="mb-2">
                                                    <small class="text-muted">
                                                        <i class="fas fa-sitemap me-1"></i> {% trans "المسار:" %} 
                                                        <span id="folder-full-path"></span>
                                                    </small>
                                                </div>
                                                <div id="folder-stats" class="d-flex">
                                                    <div class="me-3">
                                                        <small>
                                                            <i class="fas fa-folder me-1"></i> 
                                                            <span id="subfolder-count">0</span> {% trans "مجلد فرعي" %}
                                                        </small>
                                                    </div>
                                                    <div>
                                                        <small>
                                                            <i class="fas fa-file me-1"></i> 
                                                            <span id="file-count">0</span> {% trans "ملف" %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="folder-content-placeholder" class="text-center py-5">
                                                <p class="text-muted">{% trans "سيتم عرض محتوى المجلد هنا عند التنفيذ الكامل للميزة" %}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- إحصائيات الأرشيف -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{% trans "إجمالي المجلدات" %}</h6>
                                        <h3 class="mt-2 mb-0">{{ total_folders }}</h3>
                                    </div>
                                    <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                        <i class="fas fa-folder fs-4 text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{% trans "إجمالي الملفات" %}</h6>
                                        <h3 class="mt-2 mb-0">{{ total_files }}</h3>
                                    </div>
                                    <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                        <i class="fas fa-file fs-4 text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{% trans "تاريخ اليوم" %}</h6>
                                        <h3 class="mt-2 mb-0">{{ today }}</h3>
                                    </div>
                                    <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                        <i class="fas fa-calendar-day fs-4 text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- القائمة الجانبية للوحة التحكم - تم تبسيطها -->
        <div class="col-lg-2 admin-sidebar order-2 {% if is_rtl %}rtl{% endif %}">
            <div class="py-4 px-3">
                <div class="admin-logo-container mb-4 text-center">
                    <img src="{% static 'images/car-rental-logo-white.svg' %}" alt="كاررنتال" height="40">
                </div>
                
                <!-- القائمة الرئيسية المبسطة -->
                <div class="sidebar-heading">{% trans "لوحة التحكم" %}</div>
                <ul class="nav flex-column mb-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-tachometer-alt"></i>
                            {% trans "الرئيسية" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-calendar-check"></i>
                            {% trans "الحجوزات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-car"></i>
                            {% trans "السيارات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-users"></i>
                            {% trans "المستخدمون" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-credit-card"></i>
                            {% trans "المدفوعات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-archive"></i>
                            {% trans "الأرشيف" %}
                        </a>
                    </li>
                </ul>
                
                <!-- قائمة الإعدادات المبسطة -->
                <div class="sidebar-heading mt-4">{% trans "الإعدادات" %}</div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-cog"></i>
                            {% trans "إعدادات النظام" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-user-cog"></i>
                            {% trans "الملف الشخصي" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-sign-out-alt"></i>
                            {% trans "تسجيل الخروج" %}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- المودالز -->
<!-- مودال إنشاء مجلد جديد -->
<div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFolderModalLabel">{% trans "إنشاء مجلد جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="{% url 'admin_archive_folder_add' %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="parent_id" id="parent_folder_id" value="">
                    
                    <div class="mb-3">
                        <label for="folderName" class="form-label">{% trans "اسم المجلد" %}</label>
                        <input type="text" class="form-control" id="folderName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="folderDescription" class="form-label">{% trans "وصف المجلد" %}</label>
                        <textarea class="form-control" id="folderDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="folderType" class="form-label">{% trans "نوع المجلد" %}</label>
                        <select class="form-select" id="folderType" name="folder_type">
                            <option value="general">{% trans "عام" %}</option>
                            <option value="reservations">{% trans "حجوزات" %}</option>
                            <option value="cars">{% trans "سيارات" %}</option>
                            <option value="customers">{% trans "عملاء" %}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "إنشاء المجلد" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- مودال رفع ملف جديد -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFileModalLabel">{% trans "رفع ملف جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="{% url 'admin_archive_add' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="folder_id" id="upload_folder_id" value="">
                    
                    <div class="file-upload-zone mb-3">
                        <div class="file-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <p>{% trans "اسحب الملف هنا أو انقر للرفع" %}</p>
                        <input type="file" id="fileUpload" name="file" class="d-none" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fileDescription" class="form-label">{% trans "وصف الملف" %}</label>
                        <textarea class="form-control" id="fileDescription" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="fileType" class="form-label">{% trans "نوع الملف" %}</label>
                        <select class="form-select" id="fileType" name="file_type">
                            <option value="document">{% trans "مستند" %}</option>
                            <option value="image">{% trans "صورة" %}</option>
                            <option value="contract">{% trans "عقد" %}</option>
                            <option value="invoice">{% trans "فاتورة" %}</option>
                            <option value="other">{% trans "أخرى" %}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "رفع الملف" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // بيانات تخصيص الشجرة لتتطابق تماماً مع الصورة المرجعية (مستكشف ويندوز)
        const customFolderData = [
            { 
              'id': 'recycle-bin', 
              'text': '{% trans "سلة المحذوفات" %}', 
              'icon': 'fas fa-trash-alt',
              'type': 'system',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-design', 
              'text': '{% trans "CarRental-master" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': true }
            },
            { 
              'id': 'folder-6', 
              'text': '{% trans "CarRental-master" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-7', 
              'text': '{% trans "venv" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-8', 
              'text': '{% trans "developer" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-9', 
              'text': '{% trans "Digital-Persona-SDK-master" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-10', 
              'text': '{% trans "html" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-1', 
              'text': '{% trans "New folder" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false },
              'li_attr': { 'class': 'highlight-new' }
            },
            { 
              'id': 'folder-2', 
              'text': '{% trans "New folder (2)" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-3', 
              'text': '{% trans "New folder (3)" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-4', 
              'text': '{% trans "New folder (4)" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-5', 
              'text': '{% trans "New folder (5)" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-11', 
              'text': '{% trans "New folder (6)" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-12', 
              'text': '{% trans "New folder (7)" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            },
            { 
              'id': 'folder-13', 
              'text': '{% trans "nsr" %}', 
              'icon': 'fas fa-folder',
              'type': 'folder',
              'state': { 'opened': false }
            }
        ];
        
        // استخدام البيانات المخصصة إذا لم تكن هناك بيانات من الخادم
        let treeData = (!{{ folder_tree|safe }} || {{ folder_tree|safe }}.length === 0) ? customFolderData : {{ folder_tree|safe }};
        
        // تحويل معرفات المجلدات لتكون متوافقة مع التطبيق
        function processTreeData(data) {
            if (Array.isArray(data)) {
                return data.map(node => processTreeData(node));
            } else if (typeof data === 'object') {
                // التأكد من أن معرف المجلد يحتوي على بادئة "folder-" إذا كان ليس معرفًا خاصًا
                if (data.id && typeof data.id === 'number') {
                    data.id = 'folder-' + data.id;
                }
                
                // معالجة المجلدات الفرعية بشكل متكرر
                if (data.children && Array.isArray(data.children)) {
                    data.children = data.children.map(child => processTreeData(child));
                }
                
                return data;
            }
            return data;
        }
        
        // معالجة بيانات الشجرة للتأكد من تنسيق المعرفات بشكل صحيح
        treeData = processTreeData(treeData);
        
        // إضافة تنسيق CSS إضافي للمجلد المظلل (مشابه لانتقاء ملف في ويندوز)
        const style = document.createElement('style');
        style.textContent = `
            .highlight-new > .jstree-anchor {
                background-color: #cce8ff !important;
            }
            .jstree-default .jstree-hovered {
                background-color: #f5f5f5 !important;
                box-shadow: none;
            }
            .jstree-default .jstree-icon.fa-folder {
                color: #ffd04c !important;
            }
            .jstree-default .jstree-icon.fa-trash-alt {
                color: #0078d7 !important;
            }
            .jstree-default .jstree-wholerow-clicked {
                background-color: #cce8ff !important;
            }
            .jstree-default .jstree-wholerow-hovered {
                background-color: #f0f0f0 !important;
            }
            .jstree-default .jstree-anchor {
                line-height: 28px;
                height: 28px;
            }
            .jstree-default .jstree-node {
                margin-left: 0;
                background-image: none;
            }
            .jstree-default .jstree-last {
                background-image: none;
            }
        `;
        document.head.appendChild(style);
        
        // تهيئة شجرة المجلدات بمظهر شبيه تماماً لويندوز (كما في الصورة المرجعية)
        $('#folder-tree').jstree({
            'core' : {
                'data' : treeData,
                'themes': {
                    'responsive': true,
                    'name': 'default',
                    'dots': false,  // إخفاء نقاط الاتصال كما في الصورة
                    'icons': true, 
                    'variant': 'large', // حجم مناسب للأيقونات
                    'stripes': false 
                },
                'multiple': false,
                'check_callback': true,
                'strings': {
                    'Loading...': '{% trans "جاري التحميل..." %}',
                    'New node': '{% trans "مجلد جديد" %}'
                }
            },
            'rtl': {% if is_rtl %}true{% else %}false{% endif %},
            'types': {
                'default': {
                    'icon': 'fas fa-folder'
                },
                'system': {
                    'icon': 'fas fa-trash-alt'
                },
                'folder': {
                    'icon': 'fas fa-folder'
                },
                'file': {
                    'icon': 'fas fa-file'
                }
            },
            'plugins': ['types', 'wholerow', 'search', 'changed']
        }).on('select_node.jstree', function(e, data) {
            // التعامل مع معرف المجلد (إزالة البادئة 'folder-' إذا وجدت)
            let folderId = data.node.id;
            const originalId = folderId; // حفظ المعرف الأصلي
            if (folderId.startsWith('folder-')) {
                folderId = folderId.replace('folder-', '');
            }
            
            console.log('تم تحديد المجلد:', folderId);
            
            // تحديث معرف المجلد الأب في نماذج إضافة مجلد جديد ورفع الملفات
            const parentFolderInput = document.getElementById('parent_folder_id');
            const uploadFolderInput = document.getElementById('upload_folder_id');
            
            // تعيين قيمة المجلد الأب في نموذج إضافة المجلد
            if (parentFolderInput && folderId !== 'root') {
                parentFolderInput.value = folderId;
            }
            
            // تعيين قيمة المجلد المحدد في نموذج رفع الملفات
            if (uploadFolderInput && folderId !== 'root') {
                uploadFolderInput.value = folderId;
            }
            
            // إخفاء الرسالة الافتراضية وإظهار محتوى المجلد
            const noFolderMessage = document.getElementById('no-folder-selected');
            const folderContents = document.getElementById('folder-contents');
            
            if (noFolderMessage && folderContents) {
                noFolderMessage.classList.add('d-none');
                folderContents.classList.remove('d-none');
            }
            
            // تحديث معلومات المجلد
            const folderName = document.getElementById('selected-folder-name');
            const folderPath = document.getElementById('folder-full-path');
            const viewFolderBtn = document.getElementById('view-folder-btn');
            
            if (folderName) {
                folderName.textContent = data.node.text;
            }
            
            if (folderPath) {
                // بناء مسار المجلد
                let nodePath = [];
                let currentNode = data.node;
                
                // جمع المسار من المجلد الحالي إلى الجذر
                while (currentNode && currentNode.id !== '#') {
                    nodePath.unshift(currentNode.text);
                    currentNode = data.instance.get_node(currentNode.parent);
                }
                
                // عرض المسار كسلسلة نصية (تخطي الجذر إذا لزم الأمر)
                folderPath.textContent = nodePath.join(' / ');
            }
            
            // تحديث زر عرض المجلد
            if (viewFolderBtn && folderId !== 'root') {
                // تعيين الرابط المناسب للمجلد
                viewFolderBtn.href = `{% url 'admin_archive_folder' 0 %}`.replace(/0/, folderId);
            } else if (viewFolderBtn) {
                viewFolderBtn.href = `{% url 'admin_archive' %}`;
            }
            
            // تحديث إحصائيات المجلد (عدد المجلدات الفرعية والملفات)
            // هنا يمكن إضافة طلب Ajax للحصول على هذه المعلومات من الخادم
            const subfolderCount = document.getElementById('subfolder-count');
            const fileCount = document.getElementById('file-count');
            
            if (subfolderCount) {
                // في هذه النسخة نعرض عدد المجلدات الفرعية المباشرة فقط
                const childCount = data.node.children ? data.node.children.length : 0;
                subfolderCount.textContent = childCount;
            }
            
            // يمكن استخدام Ajax لجلب عدد الملفات الفعلي من الخادم
            if (fileCount) {
                fileCount.textContent = "0"; // قيمة افتراضية
            }
        });
        
        // عند اكتمال تحميل الشجرة
        $('#folder-tree').on('ready.jstree', function() {
            // تحديث عداد العناصر في شريط الحالة (عدد المجلدات الظاهرة)
            const itemsCount = $('#folder-tree').jstree('get_json').length;
            $('#items-count').text(itemsCount + ' items');
            
            // فتح مجلد مميز (مثل New folder كما في الصورة)
            const highlightedNode = $('#folder-tree').find('.highlight-new').first();
            if (highlightedNode.length) {
                const nodeId = highlightedNode.attr('id');
                if (nodeId) {
                    $('#folder-tree').jstree('select_node', nodeId);
                }
            }
            
            console.log("تم تحميل شجرة المجلدات بنجاح");
        });
        
        // البحث في شجرة المجلدات
        const searchInput = document.getElementById('folder-search');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const searchString = this.value;
                $('#folder-tree').jstree('search', searchString);
            });
        }
        
        // تفعيل منطقة رفع الملفات
        const fileUploadZone = document.querySelector('.file-upload-zone');
        const fileInput = document.getElementById('fileUpload');
        
        if (fileUploadZone && fileInput) {
            fileUploadZone.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    fileUploadZone.querySelector('p').textContent = fileName;
                }
            });
        }
    });
</script>
{% endblock %}