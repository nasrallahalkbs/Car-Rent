
{% extends "admin/admin_layout.html" %}
{% load i18n %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css">
<style>
    .archive-container {
        padding: 20px;
        background-color: #f9fafb;
    }
    .folder-tree-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        height: 550px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .folder-tree-header, .folder-status-bar {
        color: #4b5563;
        font-size: 14px;
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 500;
    }
    .folder-status-bar {
        border-top: 1px solid #e5e7eb;
        border-bottom: none;
    }
    #folder-tree {
        font-size: 14px;
        overflow-y: auto;
        flex-grow: 1;
        padding: 15px;
    }
    .jstree-default .jstree-icon.fa-folder {
        color: #f59e0b !important;
    }
    .jstree-default .jstree-icon.fa-trash-alt {
        color: #0078d7 !important;
    }
    .jstree-default .jstree-wholerow-clicked {
        background-color: #e5f0ff !important;
    }
    .jstree-default .jstree-wholerow-hovered {
        background-color: #f9fafb !important;
    }
    .jstree-default .jstree-clicked {
        color: #0d6efd !important;
        font-weight: 500;
    }
    .folder-toolbar {
        background-color: #f8f9fa;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .folder-info {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .hide-content {
        display: none !important;
    }
    
    /* RTL Support for jsTree */
    .jstree-rtl.jstree-default .jstree-node {
        margin-right: 0;
    }
    .jstree-rtl.jstree-default .jstree-icon {
        margin-left: 5px;
        margin-right: 0;
    }
    .jstree-rtl.jstree-default .jstree-anchor {
        padding: 0 4px 0 0 !important;
    }
    
    /* Card Styles */
    .folder-card {
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }
    .folder-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    .folder-card .card-header {
        background-color: #f8f9fa;
        padding: 12px 15px;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 500;
    }
    .search-input {
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        padding: 8px 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .search-input:focus {
        border-color: #93c5fd;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    /* File Grid Styles */
    .file-card {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.2s ease;
        height: 100%;
    }
    .file-card:hover {
        border-color: #93c5fd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .file-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    .file-name {
        font-weight: 500;
        font-size: 15px;
        margin-bottom: 8px;
        color: #374151;
        word-break: break-word;
    }
    .file-meta {
        font-size: 12px;
        color: #6b7280;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }
    .empty-state i {
        font-size: 48px;
        color: #d1d5db;
        margin-bottom: 15px;
    }
    .empty-state p {
        color: #6b7280;
        margin-bottom: 0;
    }
    
    /* Buttons */
    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="archive-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">{% trans "الأرشيف الإلكتروني" %}</h3>
        <div>
            <a href="/ar/dashboard/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-{% if is_rtl %}right{% else %}left{% endif %} {% if is_rtl %}ms-2{% else %}me-2{% endif %}"></i> {% trans "العودة للوحة التحكم" %}
            </a>
        </div>
    </div>
    
    <div class="row">
        <!-- قسم شجرة المجلدات -->
        <div class="col-md-4 mb-4">
            <div class="folder-toolbar d-flex justify-content-between align-items-center">
                <a href="/ar/dashboard/archive/" class="btn btn-sm btn-light">
                    <i class="fas fa-sync-alt"></i> {% trans "تحديث" %}
                </a>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                    <i class="fas fa-folder-plus"></i> {% trans "إضافة مجلد" %}
                </button>
            </div>
            
            <div class="input-group input-group-sm mb-3">
                <input type="text" id="folder-search" class="form-control search-input" placeholder="{% trans 'بحث في المجلدات...' %}">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
            </div>
            
            <div class="folder-tree-container">
                <div class="folder-tree-header d-flex justify-content-between align-items-center">
                    <span>{% trans "المجلدات" %}</span>
                    <i class="fas fa-folder text-warning"></i>
                </div>
                
                <div id="folder-tree" dir="{% if is_rtl %}rtl{% else %}ltr{% endif %}"></div>
                
                <div class="folder-status-bar d-flex justify-content-between align-items-center">
                    <span id="items-count">0 {% trans "عنصر" %}</span>
                    <span id="selected-status"></span>
                </div>
            </div>
        </div>
        
        <!-- قسم عرض محتويات المجلد -->
        <div class="col-md-8">
            <!-- حالة عدم تحديد مجلد -->
            <div id="no-folder-selected" class="text-center p-5">
                <div class="p-5 rounded bg-light">
                    <i class="fas fa-folder-open text-warning" style="font-size: 72px;"></i>
                    <h4 class="mt-3">{% trans "اختر مجلداً من القائمة" %}</h4>
                    <p class="text-muted">{% trans "اختر مجلداً من شجرة المجلدات لعرض محتوياته" %}</p>
                </div>
            </div>
            
            <!-- حالة تحديد مجلد (مخفية افتراضياً) -->
            <div id="folder-contents" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">
                        <i class="fas fa-folder-open text-warning {% if is_rtl %}ms-2{% else %}me-2{% endif %}"></i>
                        <span id="selected-folder-name"></span>
                    </h4>
                    
                    <div>
                        <a href="#" id="view-folder-btn" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye {% if is_rtl %}ms-1{% else %}me-1{% endif %}"></i> {% trans "عرض" %}
                        </a>
                        <button type="button" class="btn btn-sm btn-success {% if is_rtl %}me-2{% else %}ms-2{% endif %}" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                            <i class="fas fa-file-upload {% if is_rtl %}ms-1{% else %}me-1{% endif %}"></i> {% trans "رفع ملف" %}
                        </button>
                    </div>
                </div>
                
                <div class="folder-info">
                    <div class="row">
                        <div class="col">
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-sitemap {% if is_rtl %}ms-1{% else %}me-1{% endif %}"></i> {% trans "المسار:" %} 
                                <span id="folder-full-path"></span>
                            </small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-folder text-warning {% if is_rtl %}ms-2{% else %}me-2{% endif %}"></i>
                                <div>
                                    <small class="text-muted d-block">{% trans "المجلدات الفرعية" %}</small>
                                    <span id="subfolder-count" class="h5 mb-0">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file text-primary {% if is_rtl %}ms-2{% else %}me-2{% endif %}"></i>
                                <div>
                                    <small class="text-muted d-block">{% trans "الملفات" %}</small>
                                    <span id="file-count" class="h5 mb-0">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card folder-card">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="mb-0">{% trans "محتويات المجلد" %}</h5>
                        <div>
                            <select class="form-select form-select-sm" id="view-type">
                                <option value="grid">{% trans "عرض شبكي" %}</option>
                                <option value="list">{% trans "عرض قائمة" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="folder-files" class="row g-3">
                            <!-- يتم إضافة الملفات هنا ديناميكياً -->
                            <div class="col-12 empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>{% trans "لا توجد ملفات في هذا المجلد" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal - إضافة مجلد جديد -->
<div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFolderModalLabel">{% trans "إضافة مجلد جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/ar/dashboard/archive/folder/add/" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="folder-name" class="form-label">{% trans "اسم المجلد" %}</label>
                        <input type="text" class="form-control" id="folder-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="parent-folder" class="form-label">{% trans "المجلد الرئيسي" %}</label>
                        <select class="form-select" id="parent-folder" name="parent_id">
                            <option value="">{% trans "بدون مجلد رئيسي (مجلد جذر)" %}</option>
                            {% for folder in subfolders %}
                                <option value="{{ folder.id }}">{{ folder.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="folder-description" class="form-label">{% trans "وصف المجلد" %}</label>
                        <textarea class="form-control" id="folder-description" name="description" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="selected-parent-id" name="selected_parent_id" value="">
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                        <button type="submit" class="btn btn-primary">{% trans "إضافة المجلد" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal - رفع مستند جديد -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFileModalLabel">{% trans "رفع مستند جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/ar/dashboard/archive/add/" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="file-title" class="form-label">{% trans "عنوان المستند" %}</label>
                        <input type="text" class="form-control" id="file-title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="document-type" class="form-label">{% trans "نوع المستند" %}</label>
                        <select class="form-select" id="document-type" name="document_type">
                            <option value="contract">{% trans "عقد" %}</option>
                            <option value="receipt">{% trans "إيصال" %}</option>
                            <option value="custody">{% trans "عهدة" %}</option>
                            <option value="custody_release">{% trans "إخلاء عهدة" %}</option>
                            <option value="official_document">{% trans "وثيقة رسمية" %}</option>
                            <option value="other">{% trans "أخرى" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="file-upload" class="form-label">{% trans "الملف" %}</label>
                        <input type="file" class="form-control" id="file-upload" name="file" required>
                    </div>
                    <div class="mb-3">
                        <label for="file-folder" class="form-label">{% trans "المجلد" %}</label>
                        <select class="form-select" id="file-folder" name="folder">
                            <option value="">{% trans "بدون مجلد (الجذر)" %}</option>
                            {% for folder in subfolders %}
                                <option value="{{ folder.id }}">{{ folder.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="file-description" class="form-label">{% trans "وصف المستند" %}</label>
                        <textarea class="form-control" id="file-description" name="description" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="selected-folder-id" name="selected_folder_id" value="">
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                        <button type="submit" class="btn btn-primary">{% trans "رفع المستند" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
<script>
    $(document).ready(function() {
        console.log("تهيئة صفحة الأرشيف الإلكتروني...");
        
        // عرض بيانات الشجرة المستلمة من الخادم
        let folderData = {{ folder_tree|safe }};
        console.log("بيانات المجلدات:", folderData);
        
        // إذا كانت البيانات فارغة أو غير محددة، عرض رسالة وإيقاف التنفيذ
        if (!folderData || folderData.length === 0) {
            $('#folder-tree').html('<div class="alert alert-info m-3">لا توجد مجلدات متاحة. يرجى إنشاء مجلد جديد.</div>');
            return;
        }
        
        // تحويل معرفات المجلدات لتوافق jsTree
        function processTreeData(data) {
            if (Array.isArray(data)) {
                return data.map(item => processTreeData(item));
            } else if (typeof data === 'object' && data !== null) {
                if (data.id && typeof data.id === 'number') {
                    data.id = 'folder-' + data.id;
                }
                if (data.children && Array.isArray(data.children)) {
                    data.children = data.children.map(child => processTreeData(child));
                }
                return data;
            }
            return data;
        }
        
        // معالجة بيانات الشجرة
        let treeData = processTreeData(folderData);
        
        // تهيئة jsTree
        $('#folder-tree').jstree({
            'core': {
                'data': treeData,
                'themes': {
                    'responsive': true,
                    'name': 'default',
                    'dots': false,
                    'icons': true,
                    'variant': 'large',
                    'stripes': false
                },
                'multiple': false,
                'check_callback': true
            },
            'rtl': {% if is_rtl %}true{% else %}false{% endif %},
            'types': {
                'default': { 'icon': 'fas fa-folder' },
                'system': { 'icon': 'fas fa-trash-alt' },
                'folder': { 'icon': 'fas fa-folder' },
                'file': { 'icon': 'fas fa-file' }
            },
            'plugins': ['types', 'wholerow', 'search', 'changed', 'state']
        }).on('ready.jstree', function() {
            console.log("تم تهيئة شجرة المجلدات بنجاح");
            
            // تحديد عدد العناصر
            const itemsCount = $('#folder-tree').jstree('get_json').length;
            $('#items-count').text(itemsCount + ' {% trans "عنصر" %}');
            
            // فتح جميع المجلدات (افتراضي)
            $('#folder-tree').jstree('open_all');
            
            // تحديد المجلد الافتراضي (المجلد الأول بعد سلة المحذوفات)
            if (treeData && treeData.length > 1) {
                // البحث عن مجلد تصميم (شجرة) أو استخدام أول مجلد عادي
                let defaultNode = null;
                for (let i = 0; i < treeData.length; i++) {
                    if (treeData[i].id !== 'recycle-bin') {
                        if (treeData[i].text.includes('تصميم')) {
                            defaultNode = treeData[i].id;
                            break;
                        } else if (!defaultNode) {
                            defaultNode = treeData[i].id;
                        }
                    }
                }
                
                if (defaultNode) {
                    $('#folder-tree').jstree('select_node', defaultNode);
                    // فتح المجلد تلقائياً
                    $('#folder-tree').jstree('open_node', defaultNode);
                }
            }
        }).on('select_node.jstree', function(e, data) {
            // عرض محتويات المجلد المحدد
            const nodeId = data.node.id;
            const nodeName = data.node.text;
            console.log("تم اختيار المجلد:", nodeId, nodeName);
            
            // إظهار محتوى المجلد
            $('#no-folder-selected').addClass('d-none');
            $('#folder-contents').removeClass('d-none');
            $('#selected-folder-name').text(nodeName);
            $('#selected-status').text(nodeName);
            
            // بناء مسار المجلد
            let pathParts = [];
            let currentNode = data.node;
            
            if (nodeId === 'recycle-bin') {
                pathParts.push('سلة المحذوفات');
            } else {
                // إضافة اسم المجلد الحالي
                pathParts.push(nodeName);
                
                // إضافة أسماء المجلدات الأب بالترتيب العكسي
                let parentIds = data.node.parents;
                parentIds.forEach(function(pid) {
                    if (pid !== '#' && pid !== 'recycle-bin') {
                        let parentNode = $('#folder-tree').jstree(true).get_node(pid);
                        if (parentNode) {
                            pathParts.push(parentNode.text);
                        }
                    }
                });
                
                // عكس المصفوفة لعرض المسار بترتيب صحيح (من الأب إلى الابن)
                pathParts.reverse();
            }
            
            // بناء المسار المجمع
            const path = '/' + pathParts.join('/');
            $('#folder-full-path').text(path);
            
            // تحديث عدد المجلدات الفرعية
            if (data.node.children && data.node.children.length > 0) {
                $('#subfolder-count').text(data.node.children.length);
            } else {
                $('#subfolder-count').text('0');
            }
            
            // تحديث معرف المجلد للنماذج
            if (nodeId.startsWith('folder-')) {
                const folderId = nodeId.replace('folder-', '');
                $('#selected-parent-id').val(folderId);
                $('#selected-folder-id').val(folderId);
                $('#view-folder-btn').attr('href', '/ar/dashboard/archive/folder/' + folderId + '/');
            } else {
                $('#view-folder-btn').attr('href', '#');
            }
            
            // عدد الملفات (صفر حالياً)
            $('#file-count').text('0');
            
            // محاكاة عرض الملفات للاختبار
            const demoFiles = [
                { name: 'عقد إيجار.pdf', type: 'pdf', date: '٢٠٢٥/٠٤/١٥', size: '٤٥٠ كيلوبايت' },
                { name: 'صورة السيارة.jpg', type: 'image', date: '٢٠٢٥/٠٤/١٠', size: '١.٢ ميجابايت' },
                { name: 'وثيقة التأمين.docx', type: 'doc', date: '٢٠٢٥/٠٤/٠٥', size: '٣٢٠ كيلوبايت' }
            ];
            
            // تنظيف محتوى المجلد وعرض الملفات (للعرض التوضيحي)
            if (nodeId === 'folder-1' || nodeId === 'folder-2') {
                const filesContainer = $('#folder-files');
                filesContainer.empty();
                
                $('#file-count').text(demoFiles.length);
                
                // إنشاء بطاقات للملفات
                demoFiles.forEach(function(file) {
                    let fileIcon, fileClass;
                    
                    switch(file.type) {
                        case 'pdf':
                            fileIcon = 'fas fa-file-pdf';
                            fileClass = 'text-danger';
                            break;
                        case 'image':
                            fileIcon = 'fas fa-file-image';
                            fileClass = 'text-success';
                            break;
                        case 'doc':
                            fileIcon = 'fas fa-file-word';
                            fileClass = 'text-primary';
                            break;
                        default:
                            fileIcon = 'fas fa-file';
                            fileClass = 'text-secondary';
                    }
                    
                    const fileCard = `
                        <div class="col-md-4 col-sm-6">
                            <div class="file-card text-center">
                                <div class="file-icon">
                                    <i class="${fileIcon} ${fileClass}"></i>
                                </div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-meta d-flex justify-content-between">
                                    <span>${file.date}</span>
                                    <span>${file.size}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    filesContainer.append(fileCard);
                });
            } else {
                // إظهار حالة الفراغ لباقي المجلدات
                $('#folder-files').html(`
                    <div class="col-12 empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>{% trans "لا توجد ملفات في هذا المجلد" %}</p>
                    </div>
                `);
            }
        });
        
        // البحث في شجرة المجلدات
        let searchTimeout = null;
        $('#folder-search').on('keyup', function() {
            const searchText = $(this).val();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(function() {
                $('#folder-tree').jstree('search', searchText);
            }, 300);
        });
        
        // تبديل طريقة عرض الملفات (شبكي/قائمة)
        $('#view-type').on('change', function() {
            const viewType = $(this).val();
            
            if (viewType === 'list') {
                // تحويل العرض إلى قائمة
                $('#folder-files').removeClass('row g-3').addClass('list-group');
                
                // إعادة تنسيق كل ملف
                $('#folder-files .col-md-4').each(function() {
                    const fileName = $(this).find('.file-name').text();
                    const fileDate = $(this).find('.file-meta span:first').text();
                    const fileSize = $(this).find('.file-meta span:last').text();
                    const fileIcon = $(this).find('.file-icon i').attr('class');
                    
                    const listItem = `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="${fileIcon} me-3"></i>
                                <span>${fileName}</span>
                            </div>
                            <div class="text-muted small">
                                <span class="me-3">${fileDate}</span>
                                <span>${fileSize}</span>
                            </div>
                        </div>
                    `;
                    
                    $(this).replaceWith(listItem);
                });
                
                // في حالة عدم وجود ملفات، تغيير طريقة العرض
                if ($('#folder-files .empty-state').length) {
                    const emptyState = $('#folder-files .empty-state');
                    const emptyMessage = emptyState.find('p').text();
                    
                    $('#folder-files').html(`
                        <div class="list-group-item text-center py-4">
                            <i class="fas fa-folder-open d-block mb-3" style="font-size: 24px; color: #d1d5db;"></i>
                            <p class="mb-0 text-muted">${emptyMessage}</p>
                        </div>
                    `);
                }
            } else {
                // إعادة تحميل المجلد لإعادة العرض الشبكي
                const nodeId = $('#folder-tree').jstree('get_selected')[0];
                if (nodeId) {
                    $('#folder-tree').jstree('select_node', nodeId);
                }
            }
        });
    });
</script>
{% endblock %}
