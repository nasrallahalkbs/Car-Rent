{% extends "admin_layout.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "الأرشيف الإلكتروني" %} | {% trans "لوحة التحكم" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css">
<style>
    /* لوحة التحكم - الأسلوب المخصص */
    :root {
        --primary-color: #3b82f6;
        --primary-dark: #1e40af;
        --primary-light: #93c5fd;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-color: #1e293b;
        --light-color: #f1f5f9;
        --border-radius: 0.5rem;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* تنسيق عام */
    body.admin {
        background-color: #f8fafc;
    }
    
    /* القائمة الجانبية */
    .admin-sidebar {
        background-color: var(--dark-color);
        color: #fff;
        min-height: 100vh;
    }
    
    .admin-sidebar .nav-link {
        padding: 0.75rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        transition: all 0.2s;
    }
    
    .admin-sidebar .nav-link i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }
    
    .admin-sidebar.rtl .nav-link i {
        margin-right: 0;
        margin-left: 0.75rem;
        text-align: right;
    }
    
    .admin-sidebar .nav-link:hover {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .admin-sidebar .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: 500;
    }
    
    .admin-sidebar .sidebar-heading {
        text-transform: uppercase;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 600;
        padding: 1rem 1.5rem 0.5rem;
    }
    
    /* تنسيقات نظام الأرشيف */
    .archive-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 20px;
        height: calc(100vh - 200px);
        min-height: 500px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        background-color: #fff;
    }
    
    /* لوحة شجرة المجلدات */
    .tree-panel {
        padding: 20px;
        border-right: 1px solid #e0e0e0;
        background-color: #f8f9fa;
        overflow-y: auto;
    }
    
    /* لوحة محتوى المجلد */
    .content-panel {
        padding: 20px;
        overflow-y: auto;
    }
    
    /* مسار المجلد الحالي */
    .breadcrumb-wrapper {
        margin-bottom: 15px;
        padding: 8px 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .folder-path {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .folder-path-item {
        display: flex;
        align-items: center;
    }
    
    .folder-path-item:not(:last-child)::after {
        content: '/';
        margin-left: 5px;
        margin-right: 5px;
        color: #888;
    }
    
    .path-link {
        color: #007bff;
        text-decoration: none;
    }
    
    .current-path {
        font-weight: bold;
        color: #333;
    }
    
    /* تنسيقات صفحة الأرشيف الإلكتروني - مطابقة للصورة المرجعية */
    .archive-main-section {
        margin-top: 20px;
    }
    
    /* تنسيق القسم الرئيسي */
    .simple-archive-container {
        width: 100%;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* تنسيق عنوان الشجرة */
    .tree-title {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    /* تنسيقات شجرة المجلدات - مطابقة للصورة المرجعية */
    .simple-tree-view {
        padding: 10px;
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 500px;
        overflow-y: auto;
    }
    
    /* ألوان أيقونات شجرة المجلدات */
    .jstree-default .jstree-icon {
        color: #333; /* لون افتراضي للأيقونات */
    }
    
    .jstree-default .jstree-themeicon-custom,
    .jstree-default .fa-folder {
        color: #ffc837 !important; /* لون أصفر ذهبي للمجلدات */
    }
    
    .jstree-default .fa-hdd {
        color: #0078d7 !important; /* لون أزرق لأيقونة الكمبيوتر */
    }
    
    /* تنسيق عناصر الشجرة - مشابه لتصميم ويندوز */
    .jstree-default .jstree-anchor {
        white-space: normal;
        height: auto;
        color: #000; /* لون أسود للنص */
        padding: 2px 5px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* خط مشابه لويندوز */
        font-size: 14px;
        line-height: 24px;
    }
    
    /* تنسيق عند تحديد عنصر في الشجرة */
    .jstree-default .jstree-wholerow-clicked {
        background-color: #cce8ff !important; /* لون أزرق فاتح مشابه للصورة عند التحديد */
    }
    
    /* تنسيق لتمرير المؤشر فوق عنصر */
    .jstree-default .jstree-wholerow-hovered {
        background-color: #f0f0f0 !important; /* لون رمادي فاتح عند تمرير المؤشر */
    }
    
    /* تنسيق العنصر المحدد في الشجرة */
    .jstree-default .jstree-clicked {
        background-color: transparent !important; /* إزالة الخلفية الافتراضية */
        color: #000;
        font-weight: 500;
    }
    
    /* تباعد العناصر في الشجرة ونمط مشابه لويندوز */
    .jstree-default .jstree-node {
        min-height: 28px;
        line-height: 28px;
        margin-left: 0;
        background-image: none;
    }
    
    /* تعديل حجم أيقونة المجلد */
    .jstree-default .jstree-icon.fa-folder {
        font-size: 16px;
        color: #ffd04c !important; /* لون المجلد الذهبي مشابه للصورة */
    }
    
    /* تصميم أيقونات التوسيع/الانكماش بشكل مشابه لويندوز */
    .jstree-default .jstree-ocl {
        background-size: 16px auto;
        background-position: center;
        width: 20px;
    }
    
    /* تنسيق محاذاة شجرة المجلدات للغة العربية */
    .jstree-rtl .jstree-node {
        direction: rtl;
        text-align: right;
    }
    
    .jstree-rtl .jstree-icon {
        margin-left: 5px;
        margin-right: 0;
    }
    
    .jstree-rtl .jstree-anchor {
        padding: 3px 5px 3px 0;
    }
    
    /* تنسيق عرض معاينة المجلد */
    .folder-preview {
        min-height: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    /* تنسيق شاشة المحتوى الفارغة */
    .empty-folder-message {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .archive-main-section .row {
            flex-direction: column;
        }
        
        .simple-tree-view {
            min-height: 300px;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- القائمة الجانبية على اليمين في العربية -->
        <div class="col-lg-10 order-1">
            <div class="admin-content p-4">
                <!-- ترويسة الصفحة -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">{% trans "الأرشيف الإلكتروني" %}</h3>
                    <div>
                        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> {% trans "العودة للوحة التحكم" %}
                        </a>
                        <a href="{% url 'admin_archive_folders' %}" class="btn btn-secondary">
                            <i class="fas fa-folder me-2"></i> {% trans "إدارة المجلدات" %}
                        </a>
                    </div>
                </div>
                
                <!-- قسم عرض شجرة المجلدات البسيطة (كما في الصورة المرجعية) -->
                <div class="archive-main-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-folder-open me-2 text-warning"></i> {% trans "مستكشف الأرشيف" %}</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                    <i class="fas fa-file-upload me-1"></i> {% trans "إضافة مستند" %}
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                                    <i class="fas fa-folder-plus me-1"></i> {% trans "إضافة مجلد" %}
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- هيكل بسيط للعرض كما في الصورة المرجعية -->
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- قائمة الشريط العلوي للمجلدات (مشابهة للصورة المرجعية) -->
                                    <div class="folder-toolbar d-flex justify-content-between align-items-center mb-2">
                                        <a href="{% url 'admin_archive' %}" class="btn btn-sm btn-light mb-2">
                                            <i class="fas fa-sync-alt"></i> {% trans "تحديث" %}
                                        </a>
                                        <div>
                                            <a href="{% url 'admin_archive_folder_add' %}" id="add-folder-btn" class="btn btn-sm btn-primary">
                                                <i class="fas fa-folder-plus"></i> {% trans "مجلد جديد" %}
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- مربع البحث في المجلدات -->
                                    <div class="search-box mb-2">
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="folder-search" class="form-control" placeholder="{% trans 'بحث...' %}">
                                            <button class="btn btn-outline-secondary" type="button">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- عرض المجلدات في شكل شجري بتصميم أصلي مشابه للصورة المرجعية -->
                                    <div class="folder-tree-container border bg-white" style="height: 480px; overflow: hidden; display: flex; flex-direction: column;">
                                        <!-- شريط أدوات مشابه للمستكشف -->
                                        <div class="folder-tree-header border-bottom bg-light d-flex justify-content-between align-items-center px-2 py-1">
                                            <span class="text-muted small">{% trans "المجلدات" %}</span>
                                            <i class="fas fa-ellipsis-h text-muted"></i>
                                        </div>
                                        
                                        <!-- شجرة المجلدات -->
                                        <div id="folder-tree" class="tree-view flex-grow-1" dir="{% if is_rtl %}rtl{% else %}ltr{% endif %}" style="overflow-y: auto; padding: 5px;"></div>
                                        
                                        <!-- شريط الحالة في الأسفل -->
                                        <div class="folder-status-bar d-flex justify-content-start align-items-center p-2 border-top bg-light" style="font-size: 12px; height: 24px;">
                                            <span id="items-count">0 عنصر</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- عرض تفاصيل المجلد المختار - كما في الصورة المرجعية -->
                                <div class="col-md-8">
                                    <div class="folder-preview h-100">
                                        <!-- الحالة الأولية - لم يتم تحديد مجلد بعد -->
                                        <div id="no-folder-selected" class="d-flex justify-content-center align-items-center h-100">
                                            <div class="text-center">
                                                <i class="fas fa-folder-open text-warning" style="font-size: 72px;"></i>
                                                <p class="mt-3">{% trans "اختر مجلد من الشجرة لعرض محتوياته" %}</p>
                                            </div>
                                        </div>
                                        
                                        <!-- عرض محتويات المجلد المحدد (يظهر عند تحديد مجلد) -->
                                        <div id="folder-contents" class="d-none">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="folder-title mb-0">
                                                    <i class="fas fa-folder-open text-warning me-2"></i>
                                                    <span id="selected-folder-name"></span>
                                                </h5>
                                                
                                                <div class="folder-actions">
                                                    <a href="#" id="view-folder-btn" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye me-1"></i> {% trans "عرض المجلد" %}
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                                                        <i class="fas fa-folder-plus me-1"></i> {% trans "إضافة مجلد هنا" %}
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                                        <i class="fas fa-file-upload me-1"></i> {% trans "إضافة ملف" %}
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="folder-info bg-light p-3 rounded mb-3">
                                                <div id="folder-path" class="mb-2">
                                                    <small class="text-muted">
                                                        <i class="fas fa-sitemap me-1"></i> {% trans "المسار:" %} 
                                                        <span id="folder-full-path"></span>
                                                    </small>
                                                </div>
                                                <div id="folder-stats" class="d-flex">
                                                    <div class="me-3">
                                                        <small>
                                                            <i class="fas fa-folder me-1"></i> 
                                                            <span id="subfolder-count">0</span> {% trans "مجلد فرعي" %}
                                                        </small>
                                                    </div>
                                                    <div>
                                                        <small>
                                                            <i class="fas fa-file me-1"></i> 
                                                            <span id="file-count">0</span> {% trans "ملف" %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="folder-content-placeholder" class="text-center py-5">
                                                <p class="text-muted">{% trans "سيتم عرض محتوى المجلد هنا عند التنفيذ الكامل للميزة" %}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- المحتوى الرئيسي على اليسار في العربية -->
        <div class="col-lg-2 order-0 p-0 admin-sidebar {% if is_rtl %}rtl{% endif %}">
            {% include "admin/includes/admin_sidebar_menu.html" %}
        </div>
    </div>
</div>

<!-- Modal - إضافة مجلد جديد -->
<div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFolderModalLabel">{% trans "إضافة مجلد جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'admin_archive_folder_add' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="folder-name" class="form-label">{% trans "اسم المجلد" %}</label>
                        <input type="text" class="form-control" id="folder-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="parent-folder" class="form-label">{% trans "المجلد الرئيسي" %}</label>
                        <select class="form-select" id="parent-folder" name="parent_id">
                            <option value="">{% trans "بدون مجلد رئيسي (مجلد جذر)" %}</option>
                            {% for folder in subfolders %}
                                <option value="{{ folder.id }}">{{ folder.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="folder-description" class="form-label">{% trans "وصف المجلد" %}</label>
                        <textarea class="form-control" id="folder-description" name="description" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="selected-parent-id" name="selected_parent_id" value="">
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                        <button type="submit" class="btn btn-primary">{% trans "إضافة المجلد" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal - رفع مستند جديد -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFileModalLabel">{% trans "رفع مستند جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'admin_archive_add' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="file-title" class="form-label">{% trans "عنوان المستند" %}</label>
                        <input type="text" class="form-control" id="file-title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="document-type" class="form-label">{% trans "نوع المستند" %}</label>
                        <select class="form-select" id="document-type" name="document_type">
                            <option value="contract">{% trans "عقد" %}</option>
                            <option value="receipt">{% trans "إيصال" %}</option>
                            <option value="custody">{% trans "عهدة" %}</option>
                            <option value="custody_release">{% trans "إخلاء عهدة" %}</option>
                            <option value="official_document">{% trans "وثيقة رسمية" %}</option>
                            <option value="other">{% trans "أخرى" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="file-upload" class="form-label">{% trans "الملف" %}</label>
                        <input type="file" class="form-control" id="file-upload" name="file" required>
                    </div>
                    <div class="mb-3">
                        <label for="file-folder" class="form-label">{% trans "المجلد" %}</label>
                        <select class="form-select" id="file-folder" name="folder">
                            <option value="">{% trans "بدون مجلد (الجذر)" %}</option>
                            {% for folder in subfolders %}
                                <option value="{{ folder.id }}">{{ folder.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="file-description" class="form-label">{% trans "وصف المستند" %}</label>
                        <textarea class="form-control" id="file-description" name="description" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="selected-folder-id" name="selected_folder_id" value="">
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                        <button type="submit" class="btn btn-primary">{% trans "رفع المستند" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
<script>
    $(document).ready(function() {
        console.log("تهيئة صفحة الأرشيف الإلكتروني...");
        
        // استخدام البيانات من الخادم مباشرة
        let treeData = {{ folder_tree|safe }};
        console.log("بيانات الشجرة المستلمة:", treeData);
        
        // تحويل معرفات المجلدات لتكون متوافقة مع التطبيق
        function processTreeData(data) {
            if (Array.isArray(data)) {
                return data.map(node => processTreeData(node));
            } else if (typeof data === 'object') {
                // التأكد من أن معرف المجلد يحتوي على بادئة "folder-" إذا كان ليس معرفًا خاصًا
                if (data.id && typeof data.id === 'number') {
                    data.id = 'folder-' + data.id;
                }
                
                // معالجة المجلدات الفرعية بشكل متكرر
                if (data.children && Array.isArray(data.children)) {
                    data.children = data.children.map(child => processTreeData(child));
                }
                
                return data;
            }
            return data;
        }
        
        // معالجة بيانات الشجرة للتأكد من تنسيق المعرفات بشكل صحيح
        treeData = processTreeData(treeData);
        
        // إضافة تنسيق CSS إضافي للمجلد المظلل (مشابه لانتقاء ملف في ويندوز)
        const style = document.createElement('style');
        style.textContent = `
            .highlight-new > .jstree-anchor {
                background-color: #cce8ff !important;
            }
            .jstree-default .jstree-hovered {
                background-color: #f5f5f5 !important;
                box-shadow: none;
            }
            .jstree-default .jstree-icon.fa-folder {
                color: #ffd04c !important;
            }
            .jstree-default .jstree-icon.fa-trash-alt {
                color: #0078d7 !important;
            }
            .jstree-default .jstree-wholerow-clicked {
                background-color: #cce8ff !important;
            }
            .jstree-default .jstree-wholerow-hovered {
                background-color: #f0f0f0 !important;
            }
            .jstree-default .jstree-anchor {
                line-height: 28px;
                height: 28px;
            }
            .jstree-default .jstree-node {
                margin-left: 0;
                background-image: none;
            }
            .jstree-default .jstree-last {
                background-image: none;
            }
        `;
        document.head.appendChild(style);
        
        // تهيئة شجرة المجلدات بمظهر شبيه تماماً لويندوز (كما في الصورة المرجعية)
        $('#folder-tree').jstree({
            'core' : {
                'data' : treeData,
                'themes': {
                    'responsive': true,
                    'name': 'default',
                    'dots': false,  // إخفاء نقاط الاتصال كما في الصورة
                    'icons': true, 
                    'variant': 'large', // حجم مناسب للأيقونات
                    'stripes': false 
                },
                'multiple': false,
                'check_callback': true,
                'strings': {
                    'Loading...': '{% trans "جاري التحميل..." %}',
                    'New node': '{% trans "مجلد جديد" %}'
                }
            },
            'rtl': {% if is_rtl %}true{% else %}false{% endif %},
            'types': {
                'default': {
                    'icon': 'fas fa-folder'
                },
                'system': {
                    'icon': 'fas fa-trash-alt'
                },
                'folder': {
                    'icon': 'fas fa-folder'
                },
                'file': {
                    'icon': 'fas fa-file'
                }
            },
            'plugins': ['types', 'wholerow', 'search', 'changed']
        }).on('ready.jstree', function() {
            console.log("تم تهيئة شجرة المجلدات بنجاح");
            
            // تحديد إجمالي العناصر
            const itemsCount = $('#folder-tree').jstree('get_json').length;
            $('#items-count').text(itemsCount + ' {% trans "عنصر" %}');
            
            // تعيين أول مجلد كمجلد محدد افتراضيًا (مجلد "تصميم (شجرة)")
            if (treeData && treeData.length > 0) {
                // ابحث عن المجلد "تصميم (شجرة)" أو استخدم المجلد الأول
                let targetNode = null;
                for (let i = 0; i < treeData.length; i++) {
                    if (treeData[i].text.includes('تصميم')) {
                        targetNode = treeData[i].id;
                        break;
                    }
                }
                
                // إذا لم يتم العثور على مجلد "تصميم"، استخدم المجلد الأول
                if (!targetNode && treeData.length > 0) {
                    targetNode = treeData[0].id;
                }
                
                if (targetNode) {
                    $('#folder-tree').jstree('select_node', targetNode);
                }
            }
        }).on('select_node.jstree', function(e, data) {
            console.log("تم تحديد مجلد:", data.node.id, data.node.text);
            
            // معالجة حدث تحديد مجلد
            const nodeId = data.node.id;
            const nodeName = data.node.text;
            
            // عرض محتويات المجلد المحدد
            $('#no-folder-selected').addClass('d-none');
            $('#folder-contents').removeClass('d-none');
            $('#selected-folder-name').text(nodeName);
            
            // تحديد المسار الكامل للمجلد
            let path = '';
            if (data.node.id === 'recycle-bin') {
                path = '/{% trans "سلة المحذوفات" %}';
            } else if (data.node.parents.length > 0) {
                path = '/' + nodeName;
            } else {
                path = '/' + nodeName;
            }
            $('#folder-full-path').text(path);
            
            // تحديث عداد المجلدات الفرعية والملفات
            if (data.node.children && data.node.children.length > 0) {
                $('#subfolder-count').text(data.node.children.length);
            } else {
                $('#subfolder-count').text('0');
            }
            
            // تحديث معرف المجلد المحدد للنماذج
            $('#selected-parent-id').val(nodeId);
            $('#selected-folder-id').val(nodeId);
            
            // محاكاة عدد الملفات (سيتم تحديثها لاحقًا من الخادم)
            $('#file-count').text('0');
            
            // تحديث رابط "عرض المجلد"
            if (nodeId.startsWith('folder-')) {
                const folder_id = nodeId.replace('folder-', '');
                $('#view-folder-btn').attr('href', '{% url "admin_archive_folder_view" 0 %}'.replace('0', folder_id));
            } else {
                $('#view-folder-btn').attr('href', '#');
            }
        });
        
        // تفعيل خاصية البحث في الشجرة
        $('#folder-search').on('keyup', function() {
            const searchString = $(this).val();
            $('#folder-tree').jstree('search', searchString);
        });
    });
</script>
{% endblock %}