{% extends "admin_layout.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "الأرشيف الإلكتروني" %} | {% trans "لوحة التحكم" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css">
<style>
    /* لوحة التحكم - الأسلوب المخصص */
    :root {
        --primary-color: #3b82f6;
        --primary-dark: #1e40af;
        --primary-light: #93c5fd;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-color: #1e293b;
        --light-color: #f1f5f9;
        --border-radius: 0.5rem;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* تنسيق عام */
    body.admin {
        background-color: #f8fafc;
    }
    
    /* القائمة الجانبية */
    .admin-sidebar {
        background: linear-gradient(135deg, #1e293b, #1e3a8a);
        min-height: calc(100vh - 60px);
        transition: all 0.3s;
        z-index: 1000;
        position: sticky;
        top: 0;
    }
    
    .admin-sidebar .nav-link {
        color: rgba(255, 255, 255, 0.7);
        border-radius: var(--border-radius);
        margin: 0.3rem 0.5rem;
        transition: all 0.3s;
        padding: 0.7rem 1rem;
        text-align: right;
    }
    
    .admin-sidebar .nav-link:hover {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .admin-sidebar .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: 500;
    }
    
    .admin-sidebar .sidebar-heading {
        text-transform: uppercase;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 600;
        padding: 1rem 1.5rem 0.5rem;
    }
    
    /* تنسيقات JSTree مشابهة بالضبط لشجرة ملفات ويندوز */
    .jstree-default .jstree-icon {
        color: #ffc107; /* لون أصفر ذهبي للمجلدات كما في ويندوز */
    }
    
    /* التأكد من لون المجلدات الموحد كما في ويندوز */
    .jstree-default .jstree-themeicon-custom,
    .jstree-default .fa-folder {
        color: #ffc107 !important; /* إجبار اللون الأصفر الذهبي */
    }
    
    /* مظهر خطوط ويندوز للشجرة */
    .jstree-default .jstree-node {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M22 11V3h-7v3H9V3H2v8h7v-3h6v3h7zM7 17H2v4h5v-4zm15 0h-5v4h5v-4z" fill="none" stroke="%23cccccc" stroke-width="1"/></svg>') !important;
        background-position: 0 0 !important;
    }
    
    /* قواعد تنسيق للتشابه مع ويندوز */
    .jstree-default li {
        background-image: none !important;
    }
    
    /* خطوط الربط بين العناصر */
    .jstree-default .jstree-children {
        background-repeat: repeat-y !important;
        background-position: 100% 0 !important;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="2" height="24"><path d="M0,0v24" stroke="%23dddddd" fill="none" /></svg>') !important;
    }
    
    /* تنسيق خطوط الشجرة للغة العربية */
    .jstree-rtl.jstree-default .jstree-children {
        background-position: right !important;
    }
    
    .jstree-default .jstree-anchor {
        white-space: normal;
        height: auto;
        color: #000; /* لون أسود للنص */
        padding: 4px 5px;
        margin: 2px 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* خط مشابه لويندوز */
        font-size: 14px;
    }
    
    /* مؤثرات التحويم على العناصر */
    .jstree-default .jstree-hovered, 
    .jstree-default .jstree-clicked {
        background-color: #e8f0fe; /* لون أزرق فاتح جدًا للتحويم */
        border-radius: 0; /* بدون تقريب الزوايا كما في ويندوز */
    }
    
    /* العنصر المحدد */
    .jstree-default .jstree-clicked {
        background-color: #cce8ff; /* لون أزرق فاتح للتحديد */
        color: #000;
        font-weight: 500;
    }
    
    /* عند تحديد الصف كاملاً */
    .jstree-default .jstree-wholerow-clicked {
        background-color: #cce8ff;
    }
    
    /* عند التحويم على الصف كاملاً */
    .jstree-default .jstree-wholerow-hovered {
        background-color: #e8f0fe;
    }
    
    /* تنسيق شكل الاتصال بين العناصر */
    .jstree-default .jstree-children .jstree-children {
        margin-right: 15px;
    }
    
    /* تظليل الخطوط الرأسية */
    .jstree-default .jstree-container-ul .jstree-node {
        margin-left: 0;
        margin-right: 0;
    }
    
    /* تغيير اتجاه شجرة المجلدات للعربية */
    .jstree-rtl .jstree-node {
        direction: rtl;
        text-align: right;
    }
    
    .jstree-rtl .jstree-icon {
        margin-left: 5px;
        margin-right: 0;
    }
    
    .jstree-rtl .jstree-anchor {
        padding: 3px 5px 3px 0;
    }
    
    /* تنسيقات نظام الأرشيف */
    .archive-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 20px;
        height: calc(100vh - 200px);
        min-height: 500px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        background-color: #fff;
    }
    
    /* لوحة شجرة المجلدات على طراز ويندوز */
    .tree-panel {
        padding: 10px;
        border-right: 1px solid #e0e0e0;
        background-color: #ffffff; /* خلفية بيضاء مثل ويندوز */
        overflow-y: auto;
        max-height: 100%;
        min-height: 400px;
        box-shadow: inset 0 0 2px rgba(0,0,0,0.1); /* ظل داخلي خفيف */
    }
    
    #folder-tree {
        direction: rtl;
        min-height: 300px;
        font-size: 0.95rem;
        max-height: 85vh;
        overflow-y: auto;
        margin-top: 10px;
        border-radius: 0; /* تم إزالة التقريب ليطابق ويندوز */
        border: 1px solid #e6e6e6; /* حدود خفيفة جدًا */
        padding: 5px;
        background-color: #ffffff; /* خلفية بيضاء */
    }
    
    /* تنسيق شجرة المجلدات على طراز ويندوز */
    .jstree-default .jstree-anchor {
        line-height: 24px; /* تصغير ارتفاع الخط ليطابق ويندوز */
        height: 24px;
        width: 95%;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        padding-right: 5px !important; /* تباعد أفضل للنص بالنسبة للواجهة العربية */
    }
    
    .jstree-default .jstree-icon {
        width: 20px;  /* تصغير حجم الأيقونة لتطابق ويندوز */
        height: 20px;
        line-height: 20px;
        margin-top: 2px; /* محاذاة عمودية أفضل */
    }
    
    /* تنسيق المسافات البادئة للعناصر */
    .jstree-default .jstree-node {
        min-height: 24px;
        line-height: 24px;
    }
    
    /* تنسيق خاص للأيقونات */
    .jstree-default .jstree-themeicon {
        margin-left: 2px;
        margin-right: 2px;
    }
    
    /* تنسيق خانات الاختيار */
    .jstree-default .jstree-checkbox {
        width: 16px !important;
        height: 16px !important;
        background-color: #fff;
        border: 1px solid #aaa;
        margin-right: 4px;
        margin-left: 4px;
        position: relative;
    }
    
    /* تنسيق خطوط الشجرة (على طراز ويندوز) */
    .jstree-default .jstree-node {
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAACAQMAAAB49I5GAAAABlBMVEUAAAAAAAClZ7nPAAAAAXRSTlMAQObYZgAAAAxJREFUCNdjIBGMzgAABS0BDikICQYAAAAASUVORK5CYII=');
        background-position: -292px -4px;
        background-repeat: repeat-y;
    }
    
    /* تنسيق آخر سطر في الشجرة */
    .jstree-default .jstree-last {
        background: transparent;
    }
    
    .jstree-default .jstree-icon.jstree-themeicon-custom {
        background-size: contain !important;
    }
    
    #folder-tree .jstree-node[aria-selected="true"] > .jstree-anchor {
        background-color: var(--primary-light) !important;
        color: var(--dark-color) !important;
        font-weight: bold;
    }
    
    /* لوحة محتوى المجلد */
    .content-panel {
        padding: 20px;
        overflow-y: auto;
    }
    
    /* مسار المجلد الحالي */
    .breadcrumb-wrapper {
        margin-bottom: 15px;
        padding: 8px 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .folder-path {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .folder-path-item {
        display: flex;
        align-items: center;
    }
    
    .folder-path-item:not(:last-child)::after {
        content: '/';
        margin-left: 5px;
        margin-right: 5px;
        color: #888;
    }
    
    .path-link {
        color: #007bff;
        text-decoration: none;
    }
    
    .current-path {
        font-weight: bold;
        color: #333;
    }
    
    /* رأس معلومات المجلد */
    .folder-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    /* شبكة عرض الملفات والمجلدات */
    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .file-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px 10px;
        border-radius: 5px;
        text-decoration: none;
        color: #333;
        transition: all 0.2s;
        text-align: center;
    }
    
    .file-card:hover {
        background-color: #f5f5f5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .file-icon {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        font-size: 24px;
    }
    
    .file-icon.folder {
        color: #ffc107 !important; /* لون موحد للمجلدات في اللوحة الرئيسية أيضًا */
    }
    
    .file-icon.pdf {
        color: #dc3545;
    }
    
    .file-icon.image {
        color: #28a745;
    }
    
    .file-icon.doc {
        color: #007bff;
    }
    
    .file-icon.excel {
        color: #198754;
    }
    
    .file-name {
        font-size: 12px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* نموذج رفع الملفات */
    .file-upload-zone {
        border: 2px dashed #ccc;
        padding: 30px;
        text-align: center;
        border-radius: 5px;
        cursor: pointer;
        transition: border-color 0.3s;
    }
    
    .file-upload-zone:hover {
        border-color: #007bff;
    }
    
    .file-upload-icon {
        font-size: 48px;
        color: #aaa;
        margin-bottom: 15px;
    }
    
    .file-preview {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        margin-top: 15px;
    }
    
    /* أزرار الوظائف الرئيسية */
    .function-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    /* تفاصيل المجلد */
    .folder-details {
        display: grid;
        gap: 15px;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
    }
    
    .detail-label {
        font-size: 12px;
        color: #777;
        margin-bottom: 5px;
    }
    
    .detail-value {
        font-weight: 500;
    }
    
    @media (max-width: 768px) {
        .archive-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .tree-panel {
            border-right: none;
            border-bottom: 1px solid #e0e0e0;
            max-height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- المحتوى الرئيسي على اليسار -->
        <div class="col-lg-10 order-1">
            <div class="py-4 px-3">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">
                        {% trans "الأرشيف الإلكتروني" %}
                    </h1>
                </div>

                <!-- أزرار العمليات الرئيسية -->
                <div class="function-buttons">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                        <i class="fas fa-folder-plus me-2"></i> {% trans "إنشاء مجلد جديد" %}
                    </button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                        <i class="fas fa-file-upload me-2"></i> {% trans "رفع ملف" %}
                    </button>
                    <a href="{% url 'admin_archive_tree' %}" class="btn btn-info">
                        <i class="fas fa-sitemap me-2"></i> {% trans "عرض هيكل المجلدات" %}
                    </a>
                    <a href="{% url 'admin_archive_explorer' %}" class="btn btn-primary">
                        <i class="fas fa-folder-open me-2"></i> {% trans "تصفح الأرشيف" %}
                    </a>
                    <a href="{% url 'admin_archive_folders' %}" class="btn btn-secondary">
                        <i class="fas fa-folder me-2"></i> {% trans "إدارة المجلدات" %}
                    </a>
                </div>
                
                <!-- نظام الأرشيف الرئيسي -->
                <div class="archive-container">
                    <!-- لوحة الشجرة الجانبية -->
                    <div class="tree-panel">
                        <h5 class="mb-3">{% trans "تصميم (شجرة)" %}</h5>
                        <!-- مربع البحث في المجلدات -->
                        <div class="search-box mb-3">
                            <div class="input-group">
                                <input type="text" id="folder-search" class="form-control" placeholder="{% trans 'البحث في المجلدات...' %}">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div id="folder-tree" dir="{% if is_rtl %}rtl{% else %}ltr{% endif %}"></div>
                    </div>
                    
                    <!-- لوحة عرض المحتوى -->
                    <div class="content-panel">
                        <!-- مسار المجلد الحالي -->
                        <div class="breadcrumb-wrapper">
                            <div class="folder-path">
                                <div class="folder-path-item">
                                    <a href="#" class="path-link home-link">
                                        <i class="fas fa-home"></i>
                                    </a>
                                </div>
                                {% if current_folder %}
                                    {% for folder in folder_path %}
                                        <div class="folder-path-item">
                                            {% if folder.id == current_folder.id %}
                                                <span class="current-path">{{ folder.name }}</span>
                                            {% else %}
                                                <a href="#" class="path-link folder-link" data-folder-id="{{ folder.id }}">{{ folder.name }}</a>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- رأس المجلد مع المعلومات -->
                        <div class="folder-header">
                            <div>
                                <h4>
                                    {% if current_folder %}
                                        <i class="fas fa-folder-open me-2 text-warning"></i> {{ current_folder.name }}
                                    {% else %}
                                        <i class="fas fa-hdd me-2"></i> {% trans "الرئيسية" %}
                                    {% endif %}
                                </h4>
                                <p class="text-muted mb-0">
                                    {% if current_folder %}
                                        {{ current_folder.description }}
                                    {% else %}
                                        {% trans "عرض كافة المجلدات والملفات" %}
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                {% if current_folder %}
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="folderActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="folderActionsDropdown">
                                        <li>
                                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editFolderModal" data-folder-id="{{ current_folder.id }}">
                                                <i class="fas fa-edit me-2 text-primary"></i> {% trans "تعديل المجلد" %}
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                                <i class="fas fa-file-upload me-2 text-success"></i> {% trans "رفع ملف للمجلد" %}
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteFolderModal" data-folder-id="{{ current_folder.id }}">
                                                <i class="fas fa-trash-alt me-2"></i> {% trans "حذف المجلد" %}
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- التبويبات -->
                        <ul class="nav nav-tabs mb-3" id="contentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files-content" type="button" role="tab" aria-controls="files-content" aria-selected="true">
                                    <i class="fas fa-th me-1"></i> {% trans "المحتويات" %}
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-content" type="button" role="tab" aria-controls="details-content" aria-selected="false">
                                    <i class="fas fa-info-circle me-1"></i> {% trans "التفاصيل" %}
                                </button>
                            </li>
                        </ul>
                        
                        <!-- محتوى التبويبات -->
                        <div class="tab-content" id="contentTabsContent">
                            <!-- تبويب الملفات والمجلدات -->
                            <div class="tab-pane fade show active" id="files-content" role="tabpanel" aria-labelledby="files-tab">
                                {% if subfolders or files %}
                                    <div class="files-grid">
                                        <!-- المجلدات -->
                                        {% for subfolder in subfolders %}
                                            <a href="#" class="file-card folder-card" data-folder-id="{{ subfolder.id }}">
                                                <div class="file-icon folder">
                                                    <i class="fas fa-folder"></i>
                                                </div>
                                                <div class="file-name">{{ subfolder.name }}</div>
                                            </a>
                                        {% endfor %}
                                        
                                        <!-- الملفات -->
                                        {% for file in files %}
                                            <a href="#" class="file-card file-item" data-file-id="{{ file.id }}" data-file-type="{{ file.file_type }}">
                                                <div class="file-icon {% if 'pdf' in file.file_type %}pdf
                                                            {% elif 'image' in file.file_type %}image
                                                            {% elif 'word' in file.file_type or 'text' in file.file_type %}doc
                                                            {% elif 'excel' in file.file_type or 'spreadsheet' in file.file_type %}excel
                                                            {% else %}{% endif %}">
                                                    {% if 'pdf' in file.file_type %}
                                                        <i class="fas fa-file-pdf"></i>
                                                    {% elif 'image' in file.file_type %}
                                                        <i class="fas fa-file-image"></i>
                                                    {% elif 'word' in file.file_type or 'text' in file.file_type %}
                                                        <i class="fas fa-file-word"></i>
                                                    {% elif 'excel' in file.file_type or 'spreadsheet' in file.file_type %}
                                                        <i class="fas fa-file-excel"></i>
                                                    {% else %}
                                                        <i class="fas fa-file"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="file-name">{{ file.filename }}</div>
                                            </a>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i class="fas fa-folder-open" style="font-size: 48px; color: #ccc;"></i>
                                        </div>
                                        <h5>{% trans "المجلد فارغ" %}</h5>
                                        <p class="text-muted">{% trans "لا توجد ملفات أو مجلدات في هذا المجلد." %}</p>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                                                <i class="fas fa-folder-plus me-1"></i> {% trans "إنشاء مجلد" %}
                                            </button>
                                            <button type="button" class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                                <i class="fas fa-file-upload me-1"></i> {% trans "رفع ملف" %}
                                            </button>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- تبويب التفاصيل -->
                            <div class="tab-pane fade" id="details-content" role="tabpanel" aria-labelledby="details-tab">
                                <div class="folder-details">
                                    {% if current_folder %}
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "اسم المجلد" %}</span>
                                            <span class="detail-value">{{ current_folder.name }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "نوع المجلد" %}</span>
                                            <span class="detail-value">
                                                {% if current_folder.folder_type == 'reservations' %}
                                                    {% trans "حجوزات" %}
                                                {% elif current_folder.folder_type == 'cars' %}
                                                    {% trans "سيارات" %}
                                                {% elif current_folder.folder_type == 'customers' %}
                                                    {% trans "عملاء" %}
                                                {% elif current_folder.folder_type == 'general' %}
                                                    {% trans "عام" %}
                                                {% else %}
                                                    {{ current_folder.folder_type }}
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "تاريخ الإنشاء" %}</span>
                                            <span class="detail-value">
                                                {% if current_folder.created_at %}
                                                    {{ current_folder.created_at|date:'Y-m-d H:i' }}
                                                {% else %}
                                                    {% trans "غير معروف" %}
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "آخر تحديث" %}</span>
                                            <span class="detail-value">
                                                {% if current_folder.updated_at %}
                                                    {{ current_folder.updated_at|date:'Y-m-d H:i' }}
                                                {% else %}
                                                    {% trans "غير معروف" %}
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "عدد الملفات" %}</span>
                                            <span class="detail-value">{{ files|length }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "عدد المجلدات الفرعية" %}</span>
                                            <span class="detail-value">{{ subfolders|length }}</span>
                                        </div>
                                    {% else %}
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "المجلد" %}</span>
                                            <span class="detail-value">{% trans "الرئيسية" %}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "عدد المجلدات" %}</span>
                                            <span class="detail-value">{{ subfolders|length }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">{% trans "عدد الملفات" %}</span>
                                            <span class="detail-value">{{ files|length }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- المودالز -->
            <!-- مودال إنشاء مجلد جديد -->
            <div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="newFolderModalLabel">{% trans "إنشاء مجلد جديد" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                        </div>
                        <form action="{% url 'admin_archive_folder_add' %}" method="post">
                            {% csrf_token %}
                            <div class="modal-body">
                                {% if current_folder %}
                                <input type="hidden" name="parent_folder" value="{{ current_folder.id }}">
                                {% endif %}
                                
                                <div class="mb-3">
                                    <label for="folderName" class="form-label">{% trans "اسم المجلد" %}</label>
                                    <input type="text" class="form-control" id="folderName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="folderDescription" class="form-label">{% trans "وصف المجلد" %}</label>
                                    <textarea class="form-control" id="folderDescription" name="description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="folderType" class="form-label">{% trans "نوع المجلد" %}</label>
                                    <select class="form-select" id="folderType" name="folder_type">
                                        <option value="general">{% trans "عام" %}</option>
                                        <option value="reservations">{% trans "حجوزات" %}</option>
                                        <option value="cars">{% trans "سيارات" %}</option>
                                        <option value="customers">{% trans "عملاء" %}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                                <button type="submit" class="btn btn-primary">{% trans "إنشاء المجلد" %}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- مودال رفع ملف -->
            <div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="uploadFileModalLabel">{% trans "رفع ملف جديد" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                        </div>
                        <form action="{% url 'admin_archive_add' %}" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="modal-body">
                                {% if current_folder %}
                                <input type="hidden" name="folder_id" value="{{ current_folder.id }}">
                                {% endif %}
                                
                                <div class="mb-3">
                                    <label for="fileDescription" class="form-label">{% trans "وصف الملف" %}</label>
                                    <textarea class="form-control" id="fileDescription" name="description" rows="2"></textarea>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label">{% trans "الملف" %}</label>
                                    <div class="file-upload-zone" id="fileDropzone">
                                        <input type="file" id="fileUpload" name="file" style="display: none;">
                                        <div class="file-upload-icon">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                        </div>
                                        <p class="mb-1">{% trans "اسحب الملف هنا أو انقر للتصفح" %}</p>
                                        <p class="small text-muted">{% trans "الحد الأقصى لحجم الملف: 50 ميجابايت" %}</p>
                                    </div>
                                    <div id="filePreview" class="file-preview d-none">
                                        <div>
                                            <i class="fas fa-file me-2"></i>
                                            <span id="fileNamePreview"></span>
                                        </div>
                                        <button type="button" id="removeFile" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                                <button type="submit" class="btn btn-primary">{% trans "رفع الملف" %}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- مودال عرض الملف -->
            <div class="modal fade" id="viewFileModal" tabindex="-1" aria-labelledby="viewFileModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="viewFileModalLabel">{% trans "عرض الملف" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                        </div>
                        <div class="modal-body">
                            <iframe id="fileViewer" src="" style="width: 100%; height: 500px; border: none;"></iframe>
                        </div>
                        <div class="modal-footer">
                            <a id="downloadFileBtn" href="#" class="btn btn-primary" download>
                                <i class="fas fa-download me-2"></i> {% trans "تنزيل الملف" %}
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إغلاق" %}</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- مودال تعديل المجلد -->
            <div class="modal fade" id="editFolderModal" tabindex="-1" aria-labelledby="editFolderModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editFolderModalLabel">{% trans "تعديل المجلد" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                        </div>
                        <form action="" method="post" id="editFolderForm">
                            {% csrf_token %}
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="editFolderName" class="form-label">{% trans "اسم المجلد" %}</label>
                                    <input type="text" class="form-control" id="editFolderName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editFolderDescription" class="form-label">{% trans "وصف المجلد" %}</label>
                                    <textarea class="form-control" id="editFolderDescription" name="description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editFolderType" class="form-label">{% trans "نوع المجلد" %}</label>
                                    <select class="form-select" id="editFolderType" name="folder_type">
                                        <option value="general">{% trans "عام" %}</option>
                                        <option value="reservations">{% trans "حجوزات" %}</option>
                                        <option value="cars">{% trans "سيارات" %}</option>
                                        <option value="customers">{% trans "عملاء" %}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                                <button type="submit" class="btn btn-primary">{% trans "حفظ التغييرات" %}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- مودال حذف المجلد -->
            <div class="modal fade" id="deleteFolderModal" tabindex="-1" aria-labelledby="deleteFolderModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteFolderModalLabel">{% trans "حذف المجلد" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                        </div>
                        <form action="" method="post" id="deleteFolderForm">
                            {% csrf_token %}
                            <div class="modal-body">
                                <p>{% trans "هل أنت متأكد من رغبتك في حذف هذا المجلد؟" %}</p>
                                <p><strong id="deleteFolderName"></strong></p>
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    {% trans "تحذير: سيتم حذف جميع الملفات والمجلدات الفرعية داخل هذا المجلد بشكل نهائي!" %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                                <button type="submit" class="btn btn-danger">{% trans "حذف المجلد" %}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- القائمة الجانبية للوحة التحكم -->
        <div class="col-lg-2 admin-sidebar order-2">
            <div class="py-4 px-3">
                <div class="admin-logo-container mb-4 text-center">
                    <img src="{% static 'images/car-rental-logo-white.svg' %}" alt="كاررنتال" height="40">
                </div>
                
                <div class="sidebar-heading">{% trans "لوحة التحكم" %}</div>
                <ul class="nav flex-column mb-0">
                    <li class="nav-item">
                        <a class="nav-link {% if request.path == '/dashboard/' or request.path == '/ar/dashboard/' %}active{% endif %}" 
                           href="{% url 'admin_index' %}">
                            <i class="fas fa-tachometer-alt ms-2"></i>
                            {% trans "الرئيسية" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if '/reservations' in request.path %}active{% endif %}" 
                           href="{% url 'admin_reservations' %}">
                            <i class="fas fa-calendar-check ms-2"></i>
                            {% trans "الحجوزات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if '/cars' in request.path %}active{% endif %}" 
                           href="{% url 'admin_cars' %}">
                            <i class="fas fa-car ms-2"></i>
                            {% trans "السيارات" %}
                        </a>
                    </li>
                </ul>
                
                <div class="sidebar-heading">{% trans "النظام" %}</div>
                <ul class="nav flex-column mb-0">
                    <li class="nav-item">
                        <a class="nav-link {% if '/analytics' in request.path %}active{% endif %}" 
                           href="{% url 'admin_payment_analytics' %}">
                            <i class="fas fa-chart-line ms-2"></i>
                            {% trans "التحليلات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if '/payments' in request.path %}active{% endif %}" 
                           href="{% url 'admin_payments' %}">
                            <i class="fas fa-money-bill-wave ms-2"></i>
                            {% trans "المدفوعات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if '/users' in request.path %}active{% endif %}" 
                           href="{% url 'admin_users' %}">
                            <i class="fas fa-users ms-2"></i>
                            {% trans "المستخدمين" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" 
                           href="{% url 'admin_archive' %}">
                            <i class="fas fa-archive ms-2"></i>
                            {% trans "الأرشيف" %}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تخصيص بيانات الشجرة لتتطابق مع الصورة المرجعية بمظهر ويندوز
        const customFolderData = [
            { 
              'id': 'folder-root', 
              'text': 'تصميم (شجرة)', 
              'icon': 'fas fa-folder text-warning',
              'type': 'root',
              'state': { 'opened': true },
              'children': [
                { 
                  'id': 'folder-1', 
                  'text': 'رسوم (1)', 
                  'icon': 'fas fa-folder text-warning',
                  'type': 'folder'
                },
                { 
                  'id': 'folder-2', 
                  'text': 'حضور (2)', 
                  'icon': 'fas fa-folder text-warning',
                  'type': 'folder' 
                },
                { 
                  'id': 'folder-3', 
                  'text': 'حسابات (3)', 
                  'icon': 'fas fa-folder text-warning',
                  'type': 'folder'
                },
                { 
                  'id': 'folder-4', 
                  'text': 'محفوظات (4)', 
                  'icon': 'fas fa-folder text-warning',
                  'type': 'folder' 
                },
                { 
                  'id': 'folder-5', 
                  'text': 'توكيلات (5)', 
                  'icon': 'fas fa-folder text-warning',
                  'type': 'folder'
                }
              ]
            }
        ];
        
        // استخدام البيانات المخصصة إذا لم تكن هناك بيانات من الخادم
        const treeData = (!{{ folder_tree|safe }} || {{ folder_tree|safe }}.length === 0) ? customFolderData : {{ folder_tree|safe }};
        
        // تهيئة شجرة المجلدات بمظهر شبيه لويندوز
        $('#folder-tree').jstree({
            'core' : {
                'data' : treeData,
                'themes': {
                    'responsive': true,
                    'name': 'default-rtl',
                    'dots': true,  // إظهار نقاط الاتصال
                    'icons': true, // إظهار الأيقونات
                    'variant': 'large', // حجم أكبر للأيقونات
                    'stripes': false // إزالة الخطوط البديلة للصفوف
                },
                'multiple': false,
                'check_callback': true,
                'strings': {
                    'Loading...': 'جاري التحميل...',
                    'New node': 'مجلد جديد'
                }
            },
            'checkbox': {
                'keep_selected_style': false, // عدم تغيير نمط العناصر المحددة
                'three_state': false, // عدم تفعيل خاصية الحالة الثلاثية
                'whole_node': false, // تحديد الخلية فقط وليس العقدة كاملة
                'tie_selection': false // فصل التحديد عن الاختيار
            },
            'rtl': true, // تفعيل دعم اللغة العربية (من اليمين إلى اليسار)
            'types': {
                'default': {
                    'icon': 'fas fa-folder text-warning'
                },
                'root': {
                    'icon': 'fas fa-folder text-warning'
                },
                'folder': {
                    'icon': 'fas fa-folder text-warning'
                },
                'file': {
                    'icon': 'fas fa-file text-primary'
                }
            },
            'plugins': ['types', 'wholerow', 'changed', 'state', 'checkbox', 'search']
        }).on('select_node.jstree', function(e, data) {
            const folderId = data.node.id;
            if (folderId !== '#') {
                window.location.href = "{% url 'admin_archive_folder' 0 %}".replace('0', folderId);
            } else {
                window.location.href = "{% url 'admin_archive' %}";
            }
        });
        
        // عند اكتمال تحميل الشجرة
        $('#folder-tree').on('ready.jstree', function() {
            // فتح جميع العقد الجذرية
            $(this).jstree('open_all');
            console.log("تم تحميل شجرة المجلدات بنجاح");
        });
        
        // معالجة رفع الملفات
        const fileDropzone = document.getElementById('fileDropzone');
        const fileInput = document.getElementById('fileUpload');
        const filePreview = document.getElementById('filePreview');
        const fileNamePreview = document.getElementById('fileNamePreview');
        const removeFileBtn = document.getElementById('removeFile');
        
        if (fileDropzone) {
            fileDropzone.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileDropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileDropzone.classList.add('border-primary');
            });
            
            fileDropzone.addEventListener('dragleave', function() {
                fileDropzone.classList.remove('border-primary');
            });
            
            fileDropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                fileDropzone.classList.remove('border-primary');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    updateFilePreview();
                }
            });
            
            fileInput.addEventListener('change', updateFilePreview);
        }
        
        function updateFilePreview() {
            if (fileInput.files.length) {
                const file = fileInput.files[0];
                fileNamePreview.textContent = file.name;
                filePreview.classList.remove('d-none');
            } else {
                filePreview.classList.add('d-none');
            }
        }
        
        if (removeFileBtn) {
            removeFileBtn.addEventListener('click', function() {
                fileInput.value = '';
                filePreview.classList.add('d-none');
            });
        }
        
        // عرض المستندات
        document.querySelectorAll('.file-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const fileId = this.dataset.fileId;
                const fileType = this.dataset.fileType;
                
                const viewerModal = new bootstrap.Modal(document.getElementById('viewFileModal'));
                const fileViewer = document.getElementById('fileViewer');
                const downloadBtn = document.getElementById('downloadFileBtn');
                
                // تحديد URL العرض والتنزيل
                const viewUrl = "{% url 'admin_archive_view' 0 %}".replace('0', fileId);
                const downloadUrl = "{% url 'admin_archive_download' 0 %}".replace('0', fileId);
                
                fileViewer.src = viewUrl;
                downloadBtn.href = downloadUrl;
                
                viewerModal.show();
            });
        });
        
        // النقر على بطاقات المجلدات
        document.querySelectorAll('.folder-card').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const folderId = this.dataset.folderId;
                window.location.href = "{% url 'admin_archive_folder' 0 %}".replace('0', folderId);
            });
        });
        
        // الزر الرئيسي في مسار المجلدات
        const homeLink = document.querySelector('.home-link');
        if (homeLink) {
            homeLink.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = "{% url 'admin_archive' %}";
            });
        }
        
        // روابط المجلدات في مسار التنقل
        document.querySelectorAll('.folder-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const folderId = this.dataset.folderId;
                window.location.href = "{% url 'admin_archive_folder' 0 %}".replace('0', folderId);
            });
        });
        
        // تحديث نموذج حذف المجلد
        const deleteFolderModal = document.getElementById('deleteFolderModal');
        if (deleteFolderModal) {
            deleteFolderModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const folderId = button.getAttribute('data-folder-id');
                const folderName = document.querySelector('h4')?.textContent.trim() || 'هذا المجلد';
                
                const deleteForm = document.getElementById('deleteFolderForm');
                const folderNameElement = document.getElementById('deleteFolderName');
                
                deleteForm.action = "{% url 'admin_archive_folder_delete' 0 %}".replace('0', folderId);
                folderNameElement.textContent = `المجلد: ${folderName}`;
            });
        }
        
        // تحديث نموذج تعديل المجلد
        const editFolderModal = document.getElementById('editFolderModal');
        if (editFolderModal) {
            editFolderModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const folderId = button.getAttribute('data-folder-id');
                
                // ملء بيانات المجلد (في حالة توفرها)
                {% if current_folder %}
                const folderName = "{{ current_folder.name }}";
                const folderDescription = "{{ current_folder.description|default:'' }}";
                const folderType = "{{ current_folder.folder_type|default:'' }}";
                
                document.getElementById('editFolderName').value = folderName;
                document.getElementById('editFolderDescription').value = folderDescription;
                
                const typeSelect = document.getElementById('editFolderType');
                for (let i = 0; i < typeSelect.options.length; i++) {
                    if (typeSelect.options[i].value === folderType) {
                        typeSelect.options[i].selected = true;
                        break;
                    }
                }
                {% endif %}
                
                const editForm = document.getElementById('editFolderForm');
                editForm.action = "{% url 'admin_archive_folder_edit' 0 %}".replace('0', folderId);
            });
        }
    });
</script>
{% endblock %}