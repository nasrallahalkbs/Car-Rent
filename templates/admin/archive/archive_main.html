{% extends "admin_layout.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "الأرشيف الإلكتروني" %} | {% trans "لوحة التحكم" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css">
<style>
    /* لوحة التحكم - الأسلوب المخصص */
    :root {
        --primary-color: #3b82f6;
        --primary-dark: #1e40af;
        --primary-light: #93c5fd;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-color: #1e293b;
        --light-color: #f1f5f9;
        --border-radius: 0.5rem;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* تنسيق عام */
    body.admin {
        background-color: #f8fafc;
    }
    
    /* القائمة الجانبية */
    .admin-sidebar {
        background-color: var(--dark-color);
        color: #fff;
        min-height: 100vh;
    }
    
    .admin-sidebar .nav-link {
        padding: 0.75rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        transition: all 0.2s;
    }
    
    .admin-sidebar .nav-link i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }
    
    .admin-sidebar.rtl .nav-link i {
        margin-right: 0;
        margin-left: 0.75rem;
        text-align: right;
    }
    
    .admin-sidebar .nav-link:hover {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .admin-sidebar .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: 500;
    }
    
    .admin-sidebar .sidebar-heading {
        text-transform: uppercase;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.4);
        font-weight: 600;
        padding: 1rem 1.5rem 0.5rem;
    }
    
    /* تنسيقات صفحة الأرشيف الإلكتروني - مطابقة للصورة المرجعية */
    .archive-main-section {
        margin-top: 20px;
    }
    
    /* تنسيق القسم الرئيسي */
    .simple-archive-container {
        width: 100%;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* تنسيق عنوان الشجرة */
    .tree-title {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    /* تنسيقات شجرة المجلدات - مطابقة للصورة المرجعية */
    .simple-tree-view {
        padding: 10px;
        background-color: #ffffff;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 500px;
        overflow-y: auto;
    }
    
    /* ألوان أيقونات شجرة المجلدات */
    .jstree-default .jstree-icon {
        color: #333; /* لون افتراضي للأيقونات */
    }
    
    .jstree-default .jstree-themeicon-custom,
    .jstree-default .fa-folder {
        color: #ffc837 !important; /* لون أصفر ذهبي للمجلدات */
    }
    
    .jstree-default .fa-hdd {
        color: #0078d7 !important; /* لون أزرق لأيقونة الكمبيوتر */
    }
    
    /* تنسيق عناصر الشجرة */
    .jstree-default .jstree-anchor {
        white-space: normal;
        height: auto;
        color: #000; /* لون أسود للنص */
        padding: 2px 5px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* خط مشابه لويندوز */
        font-size: 14px;
        line-height: 24px;
    }
    
    /* تنسيق عند تحديد عنصر في الشجرة */
    .jstree-default .jstree-wholerow-clicked {
        background-color: #e7f4ff !important; /* لون أزرق فاتح عند التحديد */
    }
    
    /* تنسيق العنصر المحدد في الشجرة */
    .jstree-default .jstree-clicked {
        background-color: transparent !important; /* إزالة الخلفية الافتراضية */
        color: #000;
        font-weight: 500;
    }
    
    /* تباعد العناصر في الشجرة */
    .jstree-default .jstree-node {
        min-height: 24px;
        line-height: 24px;
    }
    
    /* تنسيق محاذاة شجرة المجلدات للغة العربية */
    .jstree-rtl .jstree-node {
        direction: rtl;
        text-align: right;
    }
    
    .jstree-rtl .jstree-icon {
        margin-left: 5px;
        margin-right: 0;
    }
    
    .jstree-rtl .jstree-anchor {
        padding: 3px 5px 3px 0;
    }
    
    /* تنسيق عرض معاينة المجلد */
    .folder-preview {
        min-height: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    /* تنسيق شاشة المحتوى الفارغة */
    .empty-folder-message {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .archive-main-section .row {
            flex-direction: column;
        }
        
        .simple-tree-view {
            min-height: 300px;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- القائمة الجانبية على اليمين في العربية -->
        <div class="col-lg-10 order-1">
            <div class="admin-content p-4">
                <!-- ترويسة الصفحة -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">{% trans "الأرشيف الإلكتروني" %}</h3>
                    <div>
                        <a href="#" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i> {% trans "العودة للوحة التحكم" %}
                        </a>
                        <a href="#" class="btn btn-secondary">
                            <i class="fas fa-folder me-2"></i> {% trans "إدارة المجلدات" %}
                        </a>
                    </div>
                </div>
                
                <!-- قسم عرض شجرة المجلدات البسيطة (كما في الصورة المرجعية) -->
                <div class="archive-main-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-folder-open me-2 text-warning"></i> {% trans "مستكشف الأرشيف" %}</h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                    <i class="fas fa-file-upload me-1"></i> {% trans "إضافة مستند" %}
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                                    <i class="fas fa-folder-plus me-1"></i> {% trans "إضافة مجلد" %}
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- هيكل بسيط للعرض كما في الصورة المرجعية -->
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- عنوان الشجرة -->
                                    <div class="tree-title">
                                        {% trans "تصميم (شجرة)" %}
                                    </div>
                                    
                                    <!-- مربع البحث في المجلدات -->
                                    <div class="search-box mb-3">
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="folder-search" class="form-control" placeholder="{% trans 'البحث في المجلدات...' %}">
                                            <button class="btn btn-outline-secondary" type="button">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- عرض المجلدات في شكل شجري بسيط -->
                                    <div id="folder-tree" class="simple-tree-view" dir="{% if is_rtl %}rtl{% else %}ltr{% endif %}"></div>
                                </div>
                                
                                <!-- عرض تفاصيل المجلد المختار - كما في الصورة المرجعية -->
                                <div class="col-md-8">
                                    <div class="folder-preview d-flex justify-content-center align-items-center h-100">
                                        <div class="text-center">
                                            <i class="fas fa-folder-open text-warning" style="font-size: 72px;"></i>
                                            <p class="mt-3">{% trans "اختر مجلد من الشجرة لعرض محتوياته" %}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- إحصائيات الأرشيف -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{% trans "إجمالي المجلدات" %}</h6>
                                        <h3 class="mt-2 mb-0">{{ total_folders }}</h3>
                                    </div>
                                    <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                        <i class="fas fa-folder fs-4 text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{% trans "إجمالي الملفات" %}</h6>
                                        <h3 class="mt-2 mb-0">{{ total_files }}</h3>
                                    </div>
                                    <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                        <i class="fas fa-file fs-4 text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{% trans "تاريخ اليوم" %}</h6>
                                        <h3 class="mt-2 mb-0">{{ today }}</h3>
                                    </div>
                                    <div class="rounded-circle bg-info bg-opacity-10 p-3">
                                        <i class="fas fa-calendar-day fs-4 text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- القائمة الجانبية للوحة التحكم - تم تبسيطها -->
        <div class="col-lg-2 admin-sidebar order-2 {% if is_rtl %}rtl{% endif %}">
            <div class="py-4 px-3">
                <div class="admin-logo-container mb-4 text-center">
                    <img src="{% static 'images/car-rental-logo-white.svg' %}" alt="كاررنتال" height="40">
                </div>
                
                <!-- القائمة الرئيسية المبسطة -->
                <div class="sidebar-heading">{% trans "لوحة التحكم" %}</div>
                <ul class="nav flex-column mb-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-tachometer-alt"></i>
                            {% trans "الرئيسية" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-calendar-check"></i>
                            {% trans "الحجوزات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-car"></i>
                            {% trans "السيارات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-users"></i>
                            {% trans "المستخدمون" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-credit-card"></i>
                            {% trans "المدفوعات" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-archive"></i>
                            {% trans "الأرشيف" %}
                        </a>
                    </li>
                </ul>
                
                <!-- قائمة الإعدادات المبسطة -->
                <div class="sidebar-heading mt-4">{% trans "الإعدادات" %}</div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-cog"></i>
                            {% trans "إعدادات النظام" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-user-cog"></i>
                            {% trans "الملف الشخصي" %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-sign-out-alt"></i>
                            {% trans "تسجيل الخروج" %}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- المودالز -->
<!-- مودال إنشاء مجلد جديد -->
<div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFolderModalLabel">{% trans "إنشاء مجلد جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="#" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="parent_folder" value="1">
                    
                    <div class="mb-3">
                        <label for="folderName" class="form-label">{% trans "اسم المجلد" %}</label>
                        <input type="text" class="form-control" id="folderName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="folderDescription" class="form-label">{% trans "وصف المجلد" %}</label>
                        <textarea class="form-control" id="folderDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="folderType" class="form-label">{% trans "نوع المجلد" %}</label>
                        <select class="form-select" id="folderType" name="folder_type">
                            <option value="general">{% trans "عام" %}</option>
                            <option value="reservations">{% trans "حجوزات" %}</option>
                            <option value="cars">{% trans "سيارات" %}</option>
                            <option value="customers">{% trans "عملاء" %}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "إنشاء المجلد" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- مودال رفع ملف جديد -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFileModalLabel">{% trans "رفع ملف جديد" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="#" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="folder_id" value="1">
                    
                    <div class="file-upload-zone mb-3">
                        <div class="file-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <p>{% trans "اسحب الملف هنا أو انقر للرفع" %}</p>
                        <input type="file" id="fileUpload" name="file" class="d-none" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fileDescription" class="form-label">{% trans "وصف الملف" %}</label>
                        <textarea class="form-control" id="fileDescription" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="fileType" class="form-label">{% trans "نوع الملف" %}</label>
                        <select class="form-select" id="fileType" name="file_type">
                            <option value="document">{% trans "مستند" %}</option>
                            <option value="image">{% trans "صورة" %}</option>
                            <option value="contract">{% trans "عقد" %}</option>
                            <option value="invoice">{% trans "فاتورة" %}</option>
                            <option value="other">{% trans "أخرى" %}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "رفع الملف" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // بيانات تخصيص الشجرة لتتطابق مع الصورة المرجعية
        const customFolderData = [
            { 
              'id': 'root', 
              'text': '{% trans "الكمبيوتر" %}', 
              'icon': 'fas fa-hdd',
              'type': 'root',
              'state': { 'opened': true },
              'children': [
                { 
                  'id': 'folder-design', 
                  'text': '{% trans "تصميم (شجرة)" %}', 
                  'icon': 'fas fa-folder',
                  'type': 'folder',
                  'state': { 'opened': true },
                  'children': [
                    { 
                      'id': 'folder-1', 
                      'text': '{% trans "رسوم (1)" %}', 
                      'icon': 'fas fa-folder',
                      'type': 'folder'
                    },
                    { 
                      'id': 'folder-2', 
                      'text': '{% trans "حضور (2)" %}', 
                      'icon': 'fas fa-folder',
                      'type': 'folder' 
                    },
                    { 
                      'id': 'folder-3', 
                      'text': '{% trans "حسابات (3)" %}', 
                      'icon': 'fas fa-folder',
                      'type': 'folder'
                    },
                    { 
                      'id': 'folder-4', 
                      'text': '{% trans "محفوظات (4)" %}', 
                      'icon': 'fas fa-folder',
                      'type': 'folder' 
                    },
                    { 
                      'id': 'folder-5', 
                      'text': '{% trans "توكيلات (5)" %}', 
                      'icon': 'fas fa-folder',
                      'type': 'folder'
                    }
                  ]
                }
              ]
            }
        ];
        
        // استخدام البيانات المخصصة إذا لم تكن هناك بيانات من الخادم
        const treeData = (!{{ folder_tree|safe }} || {{ folder_tree|safe }}.length === 0) ? customFolderData : {{ folder_tree|safe }};
        
        // تهيئة شجرة المجلدات بمظهر شبيه لويندوز (شجرة بسيطة كما في الصورة)
        $('#folder-tree').jstree({
            'core' : {
                'data' : treeData,
                'themes': {
                    'responsive': true,
                    'name': 'default',
                    'dots': true,  // إظهار نقاط الاتصال بين الفروع
                    'icons': true, // إظهار الأيقونات
                    'variant': 'small', // حجم مناسب للأيقونات
                    'stripes': false // إزالة الخطوط البديلة للصفوف
                },
                'multiple': false,
                'check_callback': true,
                'strings': {
                    'Loading...': '{% trans "جاري التحميل..." %}',
                    'New node': '{% trans "مجلد جديد" %}'
                }
            },
            'rtl': {% if is_rtl %}true{% else %}false{% endif %}, // تفعيل دعم اللغة العربية عند الحاجة
            'types': {
                'default': {
                    'icon': 'fas fa-folder'
                },
                'root': {
                    'icon': 'fas fa-hdd'
                },
                'folder': {
                    'icon': 'fas fa-folder'
                },
                'file': {
                    'icon': 'fas fa-file'
                }
            },
            'plugins': ['types', 'wholerow', 'search']
        }).on('select_node.jstree', function(e, data) {
            const folderId = data.node.id;
            console.log('تم تحديد المجلد:', folderId);
            // في هذه النسخة التجريبية، نظهر فقط رسالة توضيحية عن تحديد المجلد
            const previewEl = document.querySelector('.folder-preview .text-center p');
            if (previewEl) {
                previewEl.textContent = '{% trans "تم تحديد المجلد: " %}' + data.node.text;
            }
        });
        
        // عند اكتمال تحميل الشجرة
        $('#folder-tree').on('ready.jstree', function() {
            // فتح جميع العقد الجذرية
            $(this).jstree('open_all');
            console.log("تم تحميل شجرة المجلدات بنجاح");
        });
        
        // البحث في شجرة المجلدات
        const searchInput = document.getElementById('folder-search');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const searchString = this.value;
                $('#folder-tree').jstree('search', searchString);
            });
        }
        
        // تفعيل منطقة رفع الملفات
        const fileUploadZone = document.querySelector('.file-upload-zone');
        const fileInput = document.getElementById('fileUpload');
        
        if (fileUploadZone && fileInput) {
            fileUploadZone.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    fileUploadZone.querySelector('p').textContent = fileName;
                }
            });
        }
    });
</script>
{% endblock %}