<!-- CACHE_BUSTER 1745274700 -->{% extends 'admin_layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Edit Document" %} - {{ document.title }}{% endblock %}

{% block page_title %}{% trans "Edit Document" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_archive' %}">{% trans "Document Archive" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'admin_archive_detail' document.id %}">{% trans "Document Details" %}</a></li>
<li class="breadcrumb-item active">{% trans "Edit Document" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        margin-bottom: 2rem;
    }
    
    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .file-upload-container {
        border: 2px dashed #cbd5e1;
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s;
    }
    
    .file-upload-container:hover {
        border-color: #94a3b8;
    }
    
    .file-upload-container.dragover {
        border-color: #3b82f6;
        background-color: #dbeafe;
    }
    
    .file-preview {
        max-width: 100%;
        max-height: 200px;
        margin-top: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .file-info {
        margin-top: 1rem;
        color: #64748b;
        font-size: 0.875rem;
    }
    
    .btn-file {
        position: relative;
        overflow: hidden;
    }
    
    .btn-file input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        background: white;
        cursor: pointer;
        display: block;
    }
    
    .related-entity-select {
        display: none;
    }
    
    .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .tag {
        background-color: #f1f5f9;
        color: #475569;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
    }
    
    .tag .remove-tag {
        margin-{% if is_english %}left{% else %}right{% endif %}: 0.25rem;
        cursor: pointer;
        color: #94a3b8;
    }
    
    .tag .remove-tag:hover {
        color: #ef4444;
    }
    
    .required-label::after {
        content: " *";
        color: #ef4444;
    }
    
    .current-file-container {
        background-color: #f8fafc;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .current-file-info {
        display: flex;
        align-items: center;
    }
    
    .current-file-icon {
        width: 48px;
        height: 48px;
        border-radius: 0.5rem;
        background-color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-{% if is_english %}right{% else %}left{% endif %}: 1rem;
        color: #475569;
        font-size: 1.5rem;
    }
    
    .current-file-details {
        flex: 1;
    }
    
    .current-file-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
        word-break: break-all;
    }
    
    .current-file-metadata {
        font-size: 0.875rem;
        color: #64748b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-0">{% trans "Edit Document" %}</h1>
                    <p class="text-muted">{% trans "Update document information" %}</p>
                </div>
                <div>
                    <a href="{% url 'admin_archive_detail' document.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i> {% trans "Back to Document" %}
                    </a>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="post" action="{% url 'admin_archive_edit' document.id %}" enctype="multipart/form-data" id="document-form">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-lg-8">
                                <!-- معلومات المستند -->
                                <div class="form-section">
                                    <h3 class="form-section-title">{% trans "Document Information" %}</h3>
                                    
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="title" class="form-label required-label">{% trans "Document Title" %}</label>
                                            <input type="text" class="form-control" id="title" name="title" value="{{ document.title }}" required>
                                            <div class="form-text">{% trans "Enter a descriptive title for the document" %}</div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="document_type" class="form-label required-label">{% trans "Document Type" %}</label>
                                            <select class="form-select" id="document_type" name="document_type" required>
                                                <option value="" disabled>{% trans "Select Document Type" %}</option>
                                                {% for type_value, type_name in document_types %}
                                                <option value="{{ type_value }}" {% if document.document_type == type_value %}selected{% endif %}>{{ type_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="document_date" class="form-label required-label">{% trans "Document Date" %}</label>
                                            <input type="date" class="form-control" id="document_date" name="document_date" value="{{ document.document_date|date:'Y-m-d' }}" required>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="expiry_date" class="form-label">{% trans "Expiry Date" %} <small class="text-muted">({% trans "if applicable" %})</small></label>
                                            <input type="date" class="form-control" id="expiry_date" name="expiry_date" value="{% if document.expiry_date %}{{ document.expiry_date|date:'Y-m-d' }}{% endif %}">
                                        </div>
                                        
                                        <div class="col-12">
                                            <label for="description" class="form-label">{% trans "Description" %}</label>
                                            <textarea class="form-control" id="description" name="description" rows="3">{{ document.description }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- العلاقات -->
                                <div class="form-section">
                                    <h3 class="form-section-title">{% trans "Document Relationships" %}</h3>
                                    
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="related_to" class="form-label required-label">{% trans "Related To" %}</label>
                                            <select class="form-select" id="related_to" name="related_to" required>
                                                <option value="" disabled>{% trans "Select Relationship Type" %}</option>
                                                {% for type_value, type_name in related_to_types %}
                                                <option value="{{ type_value }}" {% if document.related_to == type_value %}selected{% endif %}>{{ type_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <!-- قوائم الكيانات المختلفة -->
                                            <div id="select-reservation" class="related-entity-select" {% if document.related_to == 'reservation' %}style="display: block;"{% endif %}>
                                                <label for="reservation_id" class="form-label">{% trans "Select Reservation" %}</label>
                                                <select class="form-select" id="reservation_id" name="related_id">
                                                    <option value="">{% trans "Select Reservation" %}</option>
                                                    {% for reservation in reservations %}
                                                    <option value="{{ reservation.id }}" {% if document.reservation and document.reservation.id == reservation.id %}selected{% endif %}>{% trans "Reservation" %} #{{ reservation.id }} - {{ reservation.user.first_name|default:reservation.user.username }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div id="select-car" class="related-entity-select" {% if document.related_to == 'car' %}style="display: block;"{% endif %}>
                                                <label for="car_id" class="form-label">{% trans "Select Car" %}</label>
                                                <select class="form-select" id="car_id" name="related_id">
                                                    <option value="">{% trans "Select Car" %}</option>
                                                    {% for car in cars %}
                                                    <option value="{{ car.id }}" {% if document.car and document.car.id == car.id %}selected{% endif %}>{{ car.make }} {{ car.model }} ({{ car.license_plate }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div id="select-user" class="related-entity-select" {% if document.related_to == 'user' %}style="display: block;"{% endif %}>
                                                <label for="user_id" class="form-label">{% trans "Select User" %}</label>
                                                <select class="form-select" id="user_id" name="related_id">
                                                    <option value="">{% trans "Select User" %}</option>
                                                    {% for user in users %}
                                                    <option value="{{ user.id }}" {% if document.user and document.user.id == user.id %}selected{% endif %}>{{ user.first_name|default:user.username }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div id="select-other" class="related-entity-select" {% if document.related_to == 'other' or document.related_to == 'employee' %}style="display: block;"{% endif %}>
                                                <div class="alert alert-info">
                                                    {% trans "No specific entity needs to be selected for this relationship type." %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- الكلمات المفتاحية -->
                                <div class="form-section">
                                    <h3 class="form-section-title">{% trans "Tags & Keywords" %}</h3>
                                    
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="tag-input" class="form-label">{% trans "Tags" %}</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="tag-input" placeholder="{% trans 'Add tags for better search' %}">
                                                <button class="btn btn-outline-secondary" type="button" id="add-tag-btn">{% trans "Add" %}</button>
                                            </div>
                                            <div class="form-text">{% trans "Press Enter or click Add after typing each tag" %}</div>
                                            
                                            <div class="tag-container" id="tag-container"></div>
                                            <input type="hidden" name="tags" id="tags-hidden" value="{{ document.tags }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <!-- الملف الحالي والتحديث -->
                                <div class="form-section">
                                    <h3 class="form-section-title">{% trans "Document File" %}</h3>
                                    
                                    <div class="current-file-container">
                                        <h5 class="mb-3">{% trans "Current File" %}</h5>
                                        <div class="current-file-info">
                                            <div class="current-file-icon">
                                                {% if document.is_image %}
                                                <i class="fas fa-file-image"></i>
                                                {% elif document.is_pdf %}
                                                <i class="fas fa-file-pdf"></i>
                                                {% else %}
                                                <i class="fas fa-file"></i>
                                                {% endif %}
                                            </div>
                                            <div class="current-file-details">
                                                <div class="current-file-name">{{ document.file.name|default:"Unknown file" }}</div>
                                                <div class="current-file-metadata">
                                                    {{ document.file_size_display }}
                                                    {% if document.file_extension %}
                                                    • {{ document.file_extension|upper }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <a href="{% url 'admin_archive_view' document.id %}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                                <i class="fas fa-eye me-1"></i> {% trans "View" %}
                                            </a>
                                            <a href="{% url 'admin_archive_download' document.id %}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-download me-1"></i> {% trans "Download" %}
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="file-upload-container" id="file-drop-area">
                                        <div class="file-icon mb-3">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                        </div>
                                        <h5>{% trans "Upload New File" %} <small class="text-muted">({% trans "Optional" %})</small></h5>
                                        <p class="text-muted">{% trans "Only upload a new file if you want to replace the current one" %}</p>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-primary btn-file">
                                                <i class="fas fa-file-upload me-2"></i> {% trans "Select New File" %}
                                                <input type="file" name="file" id="file-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xls,.xlsx,.txt,.rtf,.csv">
                                            </button>
                                        </div>
                                        <div id="file-preview-container" class="mt-3" style="display: none;">
                                            <img id="file-preview" class="file-preview" style="display: none;">
                                            <div id="file-icon" style="display: none;">
                                                <i class="fas fa-5x"></i>
                                            </div>
                                            <div id="file-info" class="file-info"></div>
                                        </div>
                                    </div>
                                    <div class="form-text mt-2">
                                        {% trans "Supported file types: PDF, Word, Excel, Images, Text files" %}<br>
                                        {% trans "Maximum file size: 10MB" %}
                                    </div>
                                </div>
                                
                                <!-- زر الحفظ -->
                                <div class="form-section">
                                    <button type="submit" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-save me-2"></i> {% trans "Save Changes" %}
                                    </button>
                                    <a href="{% url 'admin_archive_detail' document.id %}" class="btn btn-outline-secondary w-100 mt-3">
                                        <i class="fas fa-times me-2"></i> {% trans "Cancel" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تهيئة الكلمات المفتاحية الحالية
        const tagInput = document.getElementById('tag-input');
        const addTagBtn = document.getElementById('add-tag-btn');
        const tagContainer = document.getElementById('tag-container');
        const tagsHidden = document.getElementById('tags-hidden');
        
        let tags = [];
        
        // تحميل الكلمات المفتاحية الحالية إذا وجدت
        if (tagsHidden.value) {
            tags = tagsHidden.value.split(',').map(tag => tag.trim());
            updateTags();
        }
        
        function addTag(text) {
            if (text === '' || tags.includes(text)) return;
            
            tags.push(text);
            updateTags();
            tagInput.value = '';
        }
        
        function removeTag(index) {
            tags.splice(index, 1);
            updateTags();
        }
        
        function updateTags() {
            // تحديث عناصر DOM
            tagContainer.innerHTML = '';
            tags.forEach((tag, index) => {
                const tagElement = document.createElement('div');
                tagElement.classList.add('tag');
                tagElement.innerHTML = `
                    <i class="fas fa-times-circle remove-tag" data-index="${index}"></i>
                    <span>${tag}</span>
                `;
                tagContainer.appendChild(tagElement);
            });
            
            // تحديث الحقل المخفي للنموذج
            tagsHidden.value = tags.join(', ');
            
            // إضافة مستمعات الأحداث لأزرار الحذف
            document.querySelectorAll('.remove-tag').forEach(btn => {
                btn.addEventListener('click', function() {
                    removeTag(this.getAttribute('data-index'));
                });
            });
        }
        
        addTagBtn.addEventListener('click', function() {
            addTag(tagInput.value.trim());
        });
        
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(this.value.trim());
            }
        });
        
        // التعامل مع تغيير نوع العلاقة
        const relatedToSelect = document.getElementById('related_to');
        const relationshipSelects = {
            reservation: document.getElementById('select-reservation'),
            car: document.getElementById('select-car'),
            user: document.getElementById('select-user'),
            other: document.getElementById('select-other'),
            employee: document.getElementById('select-other') // استخدام other لموظف
        };
        
        relatedToSelect.addEventListener('change', function() {
            // إخفاء جميع قوائم العلاقات
            Object.values(relationshipSelects).forEach(select => {
                select.style.display = 'none';
            });
            
            // إظهار القائمة المناسبة
            const selectedRelation = this.value;
            if (relationshipSelects[selectedRelation]) {
                relationshipSelects[selectedRelation].style.display = 'block';
            }
        });
        
        // التعامل مع ملف التحميل
        const fileInput = document.getElementById('file-input');
        const fileDropArea = document.getElementById('file-drop-area');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreview = document.getElementById('file-preview');
        const fileIcon = document.getElementById('file-icon');
        const fileInfo = document.getElementById('file-info');
        
        // التعامل مع تغيير اختيار الملف
        fileInput.addEventListener('change', function(e) {
            handleFileSelection(this.files[0]);
        });
        
        // تفعيل خاصية السحب والإفلات
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            fileDropArea.classList.add('dragover');
        }
        
        function unhighlight() {
            fileDropArea.classList.remove('dragover');
        }
        
        fileDropArea.addEventListener('drop', function(e) {
            const file = e.dataTransfer.files[0];
            fileInput.files = e.dataTransfer.files;
            handleFileSelection(file);
        });
        
        function handleFileSelection(file) {
            if (!file) return;
            
            // عرض معلومات الملف
            filePreviewContainer.style.display = 'block';
            fileInfo.innerHTML = `<strong>${file.name}</strong><br>${formatFileSize(file.size)}`;
            
            // التعامل مع أنواع الملفات المختلفة
            const fileType = file.type;
            
            // إعادة تعيين
            filePreview.style.display = 'none';
            fileIcon.style.display = 'none';
            
            if (fileType.startsWith('image/')) {
                // عرض معاينة للصور
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreview.src = e.target.result;
                    filePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                // عرض أيقونة حسب نوع الملف
                fileIcon.style.display = 'block';
                let iconClass = 'fa-file';
                
                if (fileType.includes('pdf')) {
                    iconClass = 'fa-file-pdf text-danger';
                } else if (fileType.includes('word') || fileType.includes('document')) {
                    iconClass = 'fa-file-word text-primary';
                } else if (fileType.includes('excel') || fileType.includes('sheet')) {
                    iconClass = 'fa-file-excel text-success';
                } else if (fileType.includes('text')) {
                    iconClass = 'fa-file-alt text-secondary';
                }
                
                fileIcon.innerHTML = `<i class="fas ${iconClass} fa-5x"></i>`;
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    });
</script>
{% endblock %}

{% block additional_head %}
<style>
    .form-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-section-title {
        border-bottom: 2px solid #e3e6f0;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .document-preview {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        margin-top: 20px;
        border-radius: 10px;
    }
    
    .current-file {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

<!-- محتوى القالب الإضافي -->
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">تعديل الوثيقة</h1>
        <div>
            <a href="{% url 'admin_document_detail' document.id %}" class="d-none d-sm-inline-block btn btn-secondary shadow-sm">
                <i class="fas fa-arrow-right fa-sm text-white-50 ms-1"></i> العودة للتفاصيل
            </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- معلومات المستند الأساسية -->
                <div class="form-section">
                    <h5 class="form-section-title">معلومات المستند الأساسية</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="title" class="form-label">عنوان المستند *</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ document.title }}" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="document_type" class="form-label">نوع المستند *</label>
                            <select class="form-select" id="document_type" name="document_type" required>
                                <option value="">اختر نوع المستند</option>
                                {% for type_code, type_name in document_type_choices %}
                                <option value="{{ type_code }}" {% if document.document_type == type_code %}selected{% endif %}>{{ type_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="reference_number" class="form-label">الرقم المرجعي</label>
                            <input type="text" class="form-control" id="reference_number" name="reference_number" value="{{ document.reference_number }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="description" class="form-label">وصف المستند</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ document.description }}</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- ملف المستند -->
                <div class="form-section">
                    <h5 class="form-section-title">ملف المستند</h5>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="current-file">
                                <div class="d-flex align-items-center">
                                    {% if document.is_image %}
                                    <img src="{{ document.file.url }}" alt="{{ document.title }}" style="max-height: 100px; max-width: 100px;" class="me-3">
                                    {% elif document.is_pdf %}
                                    <i class="far fa-file-pdf fa-3x text-danger me-3"></i>
                                    {% else %}
                                    <i class="far fa-file fa-3x me-3"></i>
                                    {% endif %}
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ document.file.name|slice:"25:" }}</h6>
                                        <p class="text-muted mb-0">الحجم: {{ document.file_size_display }}</p>
                                        <a href="{{ document.file.url }}" class="btn btn-sm btn-outline-primary mt-2" target="_blank">معاينة الملف</a>
                                    </div>
                                </div>
                            </div>
                            
                            <label for="file" class="form-label">تغيير الملف</label>
                            <input type="file" class="form-control" id="file" name="file">
                            <small class="text-muted">اترك هذا الحقل فارغًا للاحتفاظ بالملف الحالي. الملفات المدعومة: PDF, JPG, PNG, DOCX (الحد الأقصى: 10 ميجابايت)</small>
                        </div>
                    </div>
                    <div class="document-preview" id="filePreview">
                        <i class="fas fa-upload fa-3x mb-3"></i>
                        <p>اسحب الملف هنا أو انقر للاختيار</p>
                    </div>
                </div>
                
                <!-- تواريخ المستند -->
                <div class="form-section">
                    <h5 class="form-section-title">تواريخ المستند</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="document_date" class="form-label">تاريخ المستند *</label>
                            <input type="date" class="form-control" id="document_date" name="document_date" value="{{ document.document_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="expiry_date" class="form-label">تاريخ انتهاء الصلاحية</label>
                            <input type="date" class="form-control" id="expiry_date" name="expiry_date" value="{% if document.expiry_date %}{{ document.expiry_date|date:'Y-m-d' }}{% endif %}">
                            <small class="text-muted">اتركه فارغاً إذا كان المستند غير محدد المدة</small>
                        </div>
                    </div>
                </div>
                
                <!-- علاقات المستند -->
                <div class="form-section">
                    <h5 class="form-section-title">علاقات المستند</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="related_to" class="form-label">متعلق بـ *</label>
                            <select class="form-select" id="related_to" name="related_to" required>
                                <option value="">اختر نوع العلاقة</option>
                                {% for relation_code, relation_name in related_to_choices %}
                                <option value="{{ relation_code }}" {% if document.related_to == relation_code %}selected{% endif %}>{{ relation_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3 relation-field" id="reservation_relation">
                            <label for="reservation_id" class="form-label">الحجز المرتبط</label>
                            <select class="form-select" id="reservation_id" name="reservation_id">
                                <option value="">اختر حجزًا</option>
                                {% for reservation in reservations %}
                                <option value="{{ reservation.id }}" {% if document.reservation and document.reservation.id == reservation.id %}selected{% endif %}>{{ reservation.reservation_number }} - {{ reservation.car }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3 relation-field" id="car_relation">
                            <label for="car_id" class="form-label">السيارة المرتبطة</label>
                            <select class="form-select" id="car_id" name="car_id">
                                <option value="">اختر سيارة</option>
                                {% for car in cars %}
                                <option value="{{ car.id }}" {% if document.car and document.car.id == car.id %}selected{% endif %}>{{ car }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3 relation-field" id="user_relation">
                            <label for="user_id" class="form-label">المستخدم المرتبط</label>
                            <select class="form-select" id="user_id" name="user_id">
                                <option value="">اختر مستخدمًا</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {% if document.user and document.user.id == user.id %}selected{% endif %}>{{ user.username }} ({{ user.get_full_name|default:user.username }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label for="tags" class="form-label">الكلمات المفتاحية</label>
                            <input type="text" class="form-control" id="tags" name="tags" placeholder="أدخل الكلمات المفتاحية مفصولة بفواصل..." value="{{ document.tags }}">
                            <small class="text-muted">مثال: عقد إيجار، سيارة، عميل</small>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i> حفظ التغييرات</button>
                    <a href="{% url 'admin_document_detail' document.id %}" class="btn btn-light btn-lg">إلغاء</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // إخفاء جميع حقول العلاقة
        $('.relation-field').hide();
        
        // عرض حقل العلاقة المناسب بناءً على نوع العلاقة الحالي
        var currentRelation = $('#related_to').val();
        if (currentRelation === 'reservation') {
            $('#reservation_relation').show();
        } else if (currentRelation === 'car') {
            $('#car_relation').show();
        } else if (currentRelation === 'user') {
            $('#user_relation').show();
        }
        
        // عرض حقل العلاقة المناسب عند تغيير نوع العلاقة
        $('#related_to').change(function() {
            var relatedTo = $(this).val();
            $('.relation-field').hide();
            
            if (relatedTo === 'reservation') {
                $('#reservation_relation').show();
            } else if (relatedTo === 'car') {
                $('#car_relation').show();
            } else if (relatedTo === 'user') {
                $('#user_relation').show();
            }
        });
        
        // معاينة الملف عند اختياره
        $('#file').change(function() {
            var file = this.files[0];
            var filePreview = $('#filePreview');
            
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    if (file.type.match('image.*')) {
                        filePreview.html('<img src="' + e.target.result + '" class="img-fluid" style="max-height: 300px;">');
                    } else if (file.type === 'application/pdf') {
                        filePreview.html('<i class="far fa-file-pdf fa-5x text-danger"></i><p class="mt-2">' + file.name + '</p>');
                    } else {
                        filePreview.html('<i class="far fa-file fa-5x"></i><p class="mt-2">' + file.name + '</p>');
                    }
                };
                reader.readAsDataURL(file);
            } else {
                filePreview.html('<i class="fas fa-upload fa-3x mb-3"></i><p>اسحب الملف هنا أو انقر للاختيار</p>');
            }
        });
        
        // إضافة سحب وإفلات للملفات
        var fileInput = document.getElementById('file');
        var dropZone = document.getElementById('filePreview');
        
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('bg-light');
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dropZone.classList.remove('bg-light');
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('bg-light');
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                $(fileInput).trigger('change');
            }
        });
        
        dropZone.addEventListener('click', function() {
            fileInput.click();
        });
    });
</script>
{% endblock %}
