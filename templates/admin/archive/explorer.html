{% extends 'admin_layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "تصفح الأرشيف" %}{% endblock %}

{% block page_title %}{% trans "الأرشيف الإلكتروني" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_archive' %}">{% trans "أرشيف" %}</a></li>
<li class="breadcrumb-item active">{% trans "تصفح الأرشيف" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    /* أنماط للأرشيف الإلكتروني - مشابه لمستكشف ويندوز */
    
    /* الحاوية الرئيسية لمستكشف الملفات */
    .explorer-container {
        display: flex;
        height: calc(100vh - 250px);
        min-height: 500px;
        border: 1px solid #ddd;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    /* شريط الأدوات العلوي بنمط ويندوز 10 */
    .explorer-toolbar {
        background-color: #f0f0f0;
        border-bottom: 1px solid #ddd;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .toolbar-group {
        display: flex;
        align-items: center;
    }
    
    .toolbar-btn {
        background-color: transparent;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
        color: #333;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
    }
    
    .toolbar-btn:hover {
        background-color: #e3e3e3;
    }
    
    .toolbar-btn:active {
        background-color: #d1d1d1;
    }
    
    .toolbar-btn i {
        margin-right: 5px;
    }
    
    /* القائمة الشجرية للمجلدات - الجزء الأيسر */
    .folder-tree-panel {
        width: 280px;
        background-color: #f8f9fa;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        padding: 0;
    }
    
    /* تنسيق شبيه بويندوز 10 للعناوين */
    .win10-nav-header {
        padding: 10px 16px;
        font-weight: 500;
        color: #333;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #eee;
    }
    
    .win10-nav-header i {
        margin-right: 10px;
        color: #0078d7;
    }
    
    /* تنسيق لقائمة الوصول السريع */
    .win10-container {
        display: flex;
        flex-direction: column;
    }
    
    .quick-access-item {
        padding: 8px 16px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.1s;
        user-select: none;
    }
    
    .quick-access-item:hover {
        background-color: #f0f0f0;
    }
    
    .quick-access-item:active {
        background-color: #e3e3e3;
    }
    
    .quick-access-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* تنسيق شجرة المجلدات */
    .folder-tree {
        padding: 10px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    /* لوحة المحتوى - الجزء الأيمن */
    .content-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: white;
    }
    
    /* شريط العنوان بنمط ويندوز */
    .address-bar {
        display: flex;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        padding: 8px;
        align-items: center;
    }
    
    .nav-buttons {
        display: flex;
        margin-right: 10px;
    }
    
    .nav-btn {
        width: 32px;
        height: 32px;
        border-radius: 4px;
        border: 1px solid transparent;
        background-color: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 4px;
        cursor: pointer;
        color: #555;
    }
    
    .nav-btn:hover {
        background-color: #f0f0f0;
        border-color: #ddd;
    }
    
    .nav-btn:active {
        background-color: #e0e0e0;
    }
    
    .nav-btn.disabled {
        color: #ccc;
        cursor: default;
    }
    
    .address-input {
        flex: 1;
        height: 32px;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding: 0 10px;
        background-color: white;
    }
    
    .home-icon {
        color: #0078d7;
        margin-right: 8px;
    }
    
    .address-text {
        flex: 1;
    }
    
    .breadcrumb-separator {
        margin: 0 5px;
        color: #999;
    }
    
    /* شريط الأدوات */
    .toolbar {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
    }
    
    .view-options {
        display: flex;
    }
    
    .view-btn {
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
        color: #333;
        display: flex;
        align-items: center;
    }
    
    .view-btn:hover {
        background-color: #f0f0f0;
        border-color: #ddd;
    }
    
    .view-btn.active {
        background-color: #e3e3e3;
        border-color: #ccc;
    }
    
    .search-bar {
        position: relative;
        width: 300px;
    }
    
    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #777;
    }
    
    #content-search {
        width: 100%;
        padding: 5px 10px 5px 30px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    /* عرض المحتوى */
    .content-view {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    /* عرض الشبكة */
    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 20px;
    }
    
    .folder-item, .file-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        padding: 10px;
        border-radius: 4px;
        transition: background-color 0.1s;
        position: relative;
    }
    
    .folder-item:hover, .file-item:hover {
        background-color: #f0f0f0;
    }
    
    .folder-item.selected, .file-item.selected {
        background-color: #e7f1fb;
    }
    
    .folder-icon, .file-icon {
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
    }
    
    .folder-icon i {
        font-size: 40px;
        color: #fccd36;
    }
    
    .file-icon i {
        font-size: 40px;
    }
    
    .file-icon.pdf i {
        color: #e74c3c;
    }
    
    .file-icon.doc i {
        color: #3498db;
    }
    
    .file-icon.xls i {
        color: #2ecc71;
    }
    
    .file-icon.zip i {
        color: #f39c12;
    }
    
    .folder-name, .file-name {
        text-align: center;
        font-size: 12px;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* عرض القائمة */
    .files-list-container {
        width: 100%;
        height: 100%;
        overflow: auto;
    }
    
    .files-list {
        width: 100%;
        border-collapse: collapse;
    }
    
    .files-list th {
        padding: 10px 15px;
        text-align: right;
        border-bottom: 1px solid #ddd;
        background-color: #f8f9fa;
        font-weight: 500;
        color: #555;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .files-list td {
        padding: 8px 15px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .files-list tr:hover {
        background-color: #f5f5f5;
    }
    
    .files-list tr.selected {
        background-color: #e7f1fb;
    }
    
    .file-cell {
        display: flex;
        align-items: center;
    }
    
    .file-list-icon {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    /* شريط الحالة */
    .status-bar {
        display: flex;
        padding: 5px 10px;
        background-color: #f3f3f3;
        border-top: 1px solid #ddd;
        font-size: 12px;
        color: #555;
    }
    
    .status-bar-item {
        margin-right: 15px;
    }
    
    /* التوافق RTL */
    [dir="rtl"] .quick-access-item i {
        margin-right: 0;
        margin-left: 10px;
    }
    
    [dir="rtl"] .win10-nav-header i {
        margin-right: 0;
        margin-left: 10px;
    }
    
    [dir="rtl"] .nav-buttons {
        margin-right: 0;
        margin-left: 10px;
    }
    
    [dir="rtl"] .nav-btn {
        margin-right: 0;
        margin-left: 4px;
    }
    
    [dir="rtl"] .home-icon {
        margin-right: 0;
        margin-left: 8px;
    }
    
    [dir="rtl"] .files-list th {
        text-align: left;
    }
    
    [dir="rtl"] .file-list-icon {
        margin-right: 0;
        margin-left: 10px;
    }
    
    [dir="rtl"] .view-btn {
        margin-right: 0;
        margin-left: 5px;
    }
    
    [dir="rtl"] .search-icon {
        left: auto;
        right: 10px;
    }
    
    [dir="rtl"] #content-search {
        padding: 5px 30px 5px 10px;
    }
    
    /* أنماط إضافية لتأثيرات التحديد */
    .highlight-new {
        animation: highlight-pulse 2s infinite;
    }
    
    @keyframes highlight-pulse {
        0% {
            background-color: transparent;
        }
        50% {
            background-color: #e7f1fb;
        }
        100% {
            background-color: transparent;
        }
    }
    
    /* الصفحة المسؤولة */
    @media (max-width: 992px) {
        .explorer-container {
            flex-direction: column;
            height: auto;
        }
        
        .folder-tree-panel {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #ddd;
            max-height: 300px;
        }
        
        .search-bar {
            width: 200px;
        }
    }
    
    @media (max-width: 768px) {
        .files-grid {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
        
        .search-bar {
            width: 150px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{% trans "استعراض ملفات الأرشيف" %}</h5>
                        <div class="btn-group">
                            <a href="{% url 'admin_archive_add' %}" class="btn btn-primary">
                                <i class="fas fa-folder-plus me-2"></i> {% trans "إضافة مجلد" %}
                            </a>
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                                <i class="fas fa-file-upload me-2"></i> {% trans "رفع ملف" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- مستكشف الملفات -->
    <div class="explorer-container">
        <!-- القائمة الشجرية - الجزء الأيسر بنمط ويندوز 10 -->
        <div class="folder-tree-panel win10-container">
            <!-- قائمة التنقل السريع -->
            <div class="win10-nav-header">
                <i class="fas fa-star"></i>
                <span>{% trans "الوصول السريع" %}</span>
            </div>
            <div class="quick-access-links p-2">
                <!-- عرض المجلدات الرئيسية في الوصول السريع -->
                {% for folder in root_folders %}
                <div class="quick-access-item d-flex align-items-center p-2" data-folder-id="{{ folder.id }}">
                    <i class="fas fa-folder me-2 text-warning"></i>
                    <span>{{ folder.name }}</span>
                </div>
                {% empty %}
                <!-- إذا لم توجد مجلدات في قاعدة البيانات، نقوم بإنشاء مجلدات افتراضية للعرض -->
                <div class="quick-access-item d-flex align-items-center p-2" data-folder-id="1">
                    <i class="fas fa-folder me-2 text-warning"></i>
                    <span>{% trans "رسوم (1)" %}</span>
                </div>
                <div class="quick-access-item d-flex align-items-center p-2" data-folder-id="2">
                    <i class="fas fa-folder me-2 text-warning"></i>
                    <span>{% trans "حضور (2)" %}</span>
                </div>
                <div class="quick-access-item d-flex align-items-center p-2" data-folder-id="3">
                    <i class="fas fa-folder me-2 text-warning"></i>
                    <span>{% trans "حسابات (3)" %}</span>
                </div>
                <div class="quick-access-item d-flex align-items-center p-2" data-folder-id="4">
                    <i class="fas fa-folder me-2 text-warning"></i>
                    <span>{% trans "محفوظات (4)" %}</span>
                </div>
                <div class="quick-access-item d-flex align-items-center p-2" data-folder-id="5">
                    <i class="fas fa-folder me-2 text-warning"></i>
                    <span>{% trans "توكيلات (5)" %}</span>
                </div>
                {% endfor %}
            </div>
            
            <!-- شجرة المجلدات -->
            <div class="win10-nav-header mt-3">
                <i class="fas fa-folder"></i>
                <span>{% trans "تصميم (شجرة)" %}</span>
            </div>
            <div id="folder-tree" class="folder-tree" dir="{% if is_rtl %}rtl{% else %}ltr{% endif %}"></div>
            
            <!-- البحث في المجلدات -->
            <div class="p-3 border-top">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="folder-search" placeholder="{% trans 'البحث في المجلدات...' %}">
                </div>
            </div>
        </div>
        
        <!-- لوحة المحتوى - الجزء الأيمن -->
        <div class="content-panel">
            <!-- شريط العنوان -->
            <div class="address-bar">
                <div class="nav-buttons">
                    <button class="nav-btn" id="back-btn" title="{% trans 'الرجوع للخلف' %}">
                        <i class="fas fa-arrow-{% if is_rtl %}right{% else %}left{% endif %}"></i>
                    </button>
                    <button class="nav-btn" id="forward-btn" title="{% trans 'الانتقال للأمام' %}">
                        <i class="fas fa-arrow-{% if is_rtl %}left{% else %}right{% endif %}"></i>
                    </button>
                    <button class="nav-btn" id="up-btn" title="{% trans 'الانتقال للأعلى' %}">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="nav-btn" id="refresh-btn" title="{% trans 'تحديث' %}">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="address-input">
                    <span class="home-icon">
                        <i class="fas fa-home"></i>
                    </span>
                    <span class="address-text">
                        <a href="#" class="text-decoration-none">{% trans "الرئيسية" %}</a>
                        {% if current_folder %}
                            <span class="breadcrumb-separator">/</span>
                            {% for parent in folder_path %}
                                <a href="#" class="text-decoration-none">{{ parent.name }}</a>
                                <span class="breadcrumb-separator">/</span>
                            {% endfor %}
                            <span>{{ current_folder.name }}</span>
                        {% else %}
                            <span class="breadcrumb-separator">/</span>
                            <span>{% trans "الإيصالات" %}</span>
                        {% endif %}
                    </span>
                </div>
            </div>
            
            <!-- شريط الأدوات -->
            <div class="toolbar">
                <div class="view-options">
                    <button class="view-btn active" id="grid-view-btn" title="{% trans 'عرض الأيقونات الكبيرة' %}">
                        <i class="fas fa-th-large me-1"></i> {% trans "أيقونات كبيرة" %}
                    </button>
                    <button class="view-btn" id="list-view-btn" title="{% trans 'عرض التفاصيل' %}">
                        <i class="fas fa-list me-1"></i> {% trans "تفاصيل" %}
                    </button>
                </div>
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="content-search" placeholder="{% trans 'البحث في الملفات...' %}">
                </div>
            </div>
            
            <!-- عرض المحتوى -->
            <div class="content-view">
                <!-- عرض الشبكة (الافتراضي) -->
                <div class="files-grid" id="grid-view">
                    <!-- المجلدات -->
                    <div class="folder-item" data-folder-id="folder-1">
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name">{% trans "رسوم (1)" %}</div>
                    </div>
                    
                    <div class="folder-item" data-folder-id="folder-2">
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name">{% trans "حضور (2)" %}</div>
                    </div>
                    
                    <div class="folder-item" data-folder-id="folder-3">
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name">{% trans "حسابات (3)" %}</div>
                    </div>
                    
                    <div class="folder-item" data-folder-id="folder-4">
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name">{% trans "محفوظات (4)" %}</div>
                    </div>
                    
                    <div class="folder-item" data-folder-id="folder-5">
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name">{% trans "توكيلات (5)" %}</div>
                    </div>
                    
                    <!-- ملفات (عينة) -->
                    <div class="file-item" data-file-id="file-root-1">
                        <div class="file-icon pdf">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="file-name">تقرير_مالي.pdf</div>
                    </div>
                    
                    <div class="file-item" data-file-id="file-root-2">
                        <div class="file-icon doc">
                            <i class="fas fa-file-word"></i>
                        </div>
                        <div class="file-name">نموذج_توكيل.docx</div>
                    </div>
                    
                    <div class="file-item" data-file-id="file-root-3">
                        <div class="file-icon xls">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="file-name">جدول_الحضور.xlsx</div>
                    </div>
                </div>
                
                <!-- عرض القائمة (مخفي افتراضياً) -->
                <div class="files-list-container" id="list-view" style="display: none;">
                    <table class="files-list">
                        <thead>
                            <tr>
                                <th width="50%">{% trans "الاسم" %}</th>
                                <th width="15%">{% trans "النوع" %}</th>
                                <th width="15%">{% trans "الحجم" %}</th>
                                <th width="20%">{% trans "تاريخ التعديل" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- المجلدات -->
                            <tr data-folder-id="folder-1">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon folder">
                                            <i class="fas fa-folder"></i>
                                        </div>
                                        <span>{% trans "رسوم (1)" %}</span>
                                    </div>
                                </td>
                                <td>{% trans "مجلد ملفات" %}</td>
                                <td>-</td>
                                <td>21/04/2025</td>
                            </tr>
                            
                            <tr data-folder-id="folder-2">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon folder">
                                            <i class="fas fa-folder"></i>
                                        </div>
                                        <span>{% trans "حضور (2)" %}</span>
                                    </div>
                                </td>
                                <td>{% trans "مجلد ملفات" %}</td>
                                <td>-</td>
                                <td>21/04/2025</td>
                            </tr>
                            
                            <tr data-folder-id="folder-3">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon folder">
                                            <i class="fas fa-folder"></i>
                                        </div>
                                        <span>{% trans "حسابات (3)" %}</span>
                                    </div>
                                </td>
                                <td>{% trans "مجلد ملفات" %}</td>
                                <td>-</td>
                                <td>21/04/2025</td>
                            </tr>
                            
                            <tr data-folder-id="folder-4">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon folder">
                                            <i class="fas fa-folder"></i>
                                        </div>
                                        <span>{% trans "محفوظات (4)" %}</span>
                                    </div>
                                </td>
                                <td>{% trans "مجلد ملفات" %}</td>
                                <td>-</td>
                                <td>21/04/2025</td>
                            </tr>
                            
                            <tr data-folder-id="folder-5">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon folder">
                                            <i class="fas fa-folder"></i>
                                        </div>
                                        <span>{% trans "توكيلات (5)" %}</span>
                                    </div>
                                </td>
                                <td>{% trans "مجلد ملفات" %}</td>
                                <td>-</td>
                                <td>21/04/2025</td>
                            </tr>
                            
                            <!-- الملفات (عينة) -->
                            <tr data-file-id="file-root-1">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon pdf">
                                            <i class="fas fa-file-pdf"></i>
                                        </div>
                                        <span>تقرير_مالي.pdf</span>
                                    </div>
                                </td>
                                <td>{% trans "ملف PDF" %}</td>
                                <td>2.1 MB</td>
                                <td>20/04/2025</td>
                            </tr>
                            
                            <tr data-file-id="file-root-2">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon doc">
                                            <i class="fas fa-file-word"></i>
                                        </div>
                                        <span>نموذج_توكيل.docx</span>
                                    </div>
                                </td>
                                <td>{% trans "مستند Word" %}</td>
                                <td>358 KB</td>
                                <td>19/04/2025</td>
                            </tr>
                            
                            <tr data-file-id="file-root-3">
                                <td>
                                    <div class="file-cell">
                                        <div class="file-list-icon xls">
                                            <i class="fas fa-file-excel"></i>
                                        </div>
                                        <span>جدول_الحضور.xlsx</span>
                                    </div>
                                </td>
                                <td>{% trans "جدول Excel" %}</td>
                                <td>780 KB</td>
                                <td>18/04/2025</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- شريط الحالة -->
            <div class="status-bar">
                <div class="status-bar-item item-count">3 عناصر</div>
                <div class="status-bar-item">{% trans "مساحة متاحة:" %} 45.8 GB</div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة رفع ملف -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFileModalLabel">{% trans "رفع ملف" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadFileForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="file" class="form-label">{% trans "اختر الملف" %}</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                    </div>
                    <div class="mb-3">
                        <label for="folder" class="form-label">{% trans "المجلد" %}</label>
                        <select class="form-select" id="folder" name="folder">
                            <option value="">{% trans "المجلد الرئيسي" %}</option>
                            {% for folder in root_folders %}
                            <option value="{{ folder.id }}">{{ folder.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">{% trans "عنوان الملف (اختياري)" %}</label>
                        <input type="text" class="form-control" id="title" name="title">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">{% trans "وصف (اختياري)" %}</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="selected-folder-id" name="selected_folder_id" value="">
                    <input type="hidden" id="selected-parent-id" name="selected_parent_id" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إلغاء" %}</button>
                <button type="button" class="btn btn-primary" id="submitUploadForm">{% trans "رفع الملف" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- نافذة معاينة الملف -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">معاينة ملف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="previewModalContent">
                <!-- سيتم إضافة محتوى المعاينة ديناميكيًا -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "إغلاق" %}</button>
                <button type="button" class="btn btn-primary">{% trans "فتح" %}</button>
                <button type="button" class="btn btn-success">{% trans "تنزيل" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script>
$(document).ready(function() {
    // ============= وظائف عرض المجلدات والملفات =============
    
    // عرض محتويات مجلد محدد
    window.showFolderContents = function(folderId) {
        // تنظيف معرف المجلد
        let realFolderId = folderId;
        if (folderId && typeof folderId === 'string' && folderId.startsWith('folder-')) {
            realFolderId = folderId.replace('folder-', '');
        }
        
        console.log(`عرض محتويات المجلد: ${folderId} (المعرف الحقيقي: ${realFolderId})`);
        
        // تحديث الواجهة لإظهار أن المجلد تم اختياره
        $('.folder-item').removeClass('selected');
        $(`.folder-item[data-folder-id="${folderId}"]`).addClass('selected');
        
        let filesHtml = '';
        let listHtml = '';
        let itemCount = 0;
        
        // إذا كان المجلد هو "رسوم" (رقم 1)، سنعرض ملفات PDF
        if (folderId === 'folder-1' || realFolderId === '1') {
            filesHtml = `
                <div class="file-item" data-file-id="file-1-1">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">رسم_بياني_1.pdf</div>
                </div>
                <div class="file-item" data-file-id="file-1-2">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">رسم_بياني_2.pdf</div>
                </div>
            `;
            
            listHtml = `
                <tr data-file-id="file-1-1">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>رسم_بياني_1.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>854 KB</td>
                    <td>21/04/2025</td>
                </tr>
                <tr data-file-id="file-1-2">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>رسم_بياني_2.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>1.1 MB</td>
                    <td>21/04/2025</td>
                </tr>
            `;
            
            itemCount = 2;
        }
        // إذا كان المجلد هو "حضور" (رقم 2)، سنعرض ملفات Excel
        else if (folderId === 'folder-2' || realFolderId === '2') {
            filesHtml = `
                <div class="file-item" data-file-id="file-2-1">
                    <div class="file-icon xls">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="file-name">سجل_الحضور_ابريل.xlsx</div>
                </div>
                <div class="file-item" data-file-id="file-2-2">
                    <div class="file-icon xls">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="file-name">سجل_الحضور_مارس.xlsx</div>
                </div>
                <div class="file-item" data-file-id="file-2-3">
                    <div class="file-icon doc">
                        <i class="fas fa-file-word"></i>
                    </div>
                    <div class="file-name">تقرير_الحضور.docx</div>
                </div>
            `;
            
            listHtml = `
                <tr data-file-id="file-2-1">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon xls">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <span>سجل_الحضور_ابريل.xlsx</span>
                        </div>
                    </td>
                    <td>جدول Excel</td>
                    <td>655 KB</td>
                    <td>19/04/2025</td>
                </tr>
                <tr data-file-id="file-2-2">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon xls">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <span>سجل_الحضور_مارس.xlsx</span>
                        </div>
                    </td>
                    <td>جدول Excel</td>
                    <td>578 KB</td>
                    <td>01/04/2025</td>
                </tr>
                <tr data-file-id="file-2-3">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon doc">
                                <i class="fas fa-file-word"></i>
                            </div>
                            <span>تقرير_الحضور.docx</span>
                        </div>
                    </td>
                    <td>مستند Word</td>
                    <td>325 KB</td>
                    <td>20/04/2025</td>
                </tr>
            `;
            
            itemCount = 3;
        }
        // إذا كان المجلد هو "حسابات" (رقم 3)، سنعرض ملفات مالية
        else if (folderId === 'folder-3' || realFolderId === '3') {
            filesHtml = `
                <div class="file-item" data-file-id="file-3-1">
                    <div class="file-icon xls">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="file-name">ميزانية_2025.xlsx</div>
                </div>
                <div class="file-item" data-file-id="file-3-2">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">تقرير_مالي_سنوي.pdf</div>
                </div>
                <div class="file-item" data-file-id="file-3-3">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">فواتير_مارس.pdf</div>
                </div>
            `;
            
            listHtml = `
                <tr data-file-id="file-3-1">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon xls">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <span>ميزانية_2025.xlsx</span>
                        </div>
                    </td>
                    <td>جدول Excel</td>
                    <td>982 KB</td>
                    <td>15/04/2025</td>
                </tr>
                <tr data-file-id="file-3-2">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>تقرير_مالي_سنوي.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>1.5 MB</td>
                    <td>18/04/2025</td>
                </tr>
                <tr data-file-id="file-3-3">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>فواتير_مارس.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>750 KB</td>
                    <td>10/04/2025</td>
                </tr>
            `;
            
            itemCount = 3;
        }
        // إذا كان المجلد هو "محفوظات" (رقم 4)، سنعرض ملفات أرشيفية
        else if (folderId === 'folder-4' || realFolderId === '4') {
            filesHtml = `
                <div class="file-item" data-file-id="file-4-1">
                    <div class="file-icon zip">
                        <i class="fas fa-file-archive"></i>
                    </div>
                    <div class="file-name">أرشيف_2024.zip</div>
                </div>
                <div class="file-item" data-file-id="file-4-2">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">سجلات_قديمة.pdf</div>
                </div>
            `;
            
            listHtml = `
                <tr data-file-id="file-4-1">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon zip">
                                <i class="fas fa-file-archive"></i>
                            </div>
                            <span>أرشيف_2024.zip</span>
                        </div>
                    </td>
                    <td>ملف مضغوط</td>
                    <td>15.7 MB</td>
                    <td>05/01/2025</td>
                </tr>
                <tr data-file-id="file-4-2">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>سجلات_قديمة.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>3.2 MB</td>
                    <td>12/02/2025</td>
                </tr>
            `;
            
            itemCount = 2;
        }
        // إذا كان المجلد هو "توكيلات" (رقم 5)، سنعرض ملفات توكيلات
        else if (folderId === 'folder-5' || realFolderId === '5') {
            filesHtml = `
                <div class="file-item" data-file-id="file-5-1">
                    <div class="file-icon doc">
                        <i class="fas fa-file-word"></i>
                    </div>
                    <div class="file-name">نموذج_توكيل_رسمي.docx</div>
                </div>
                <div class="file-item" data-file-id="file-5-2">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">توكيل_محمد_احمد.pdf</div>
                </div>
                <div class="file-item" data-file-id="file-5-3">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">توكيل_خالد_محمود.pdf</div>
                </div>
                <div class="file-item" data-file-id="file-5-4">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">توكيل_عمر_سعيد.pdf</div>
                </div>
            `;
            
            listHtml = `
                <tr data-file-id="file-5-1">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon doc">
                                <i class="fas fa-file-word"></i>
                            </div>
                            <span>نموذج_توكيل_رسمي.docx</span>
                        </div>
                    </td>
                    <td>مستند Word</td>
                    <td>245 KB</td>
                    <td>20/04/2025</td>
                </tr>
                <tr data-file-id="file-5-2">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>توكيل_محمد_احمد.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>508 KB</td>
                    <td>19/04/2025</td>
                </tr>
                <tr data-file-id="file-5-3">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>توكيل_خالد_محمود.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>512 KB</td>
                    <td>18/04/2025</td>
                </tr>
                <tr data-file-id="file-5-4">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>توكيل_عمر_سعيد.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>495 KB</td>
                    <td>17/04/2025</td>
                </tr>
            `;
            
            itemCount = 4;
        }
        // إذا كان المجلد الجذر أو غير معروف، سنعرض المجلدات الرئيسية
        else {
            filesHtml = `
                <div class="folder-item" data-folder-id="folder-1">
                    <div class="folder-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <div class="folder-name">رسوم (1)</div>
                </div>
                
                <div class="folder-item" data-folder-id="folder-2">
                    <div class="folder-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <div class="folder-name">حضور (2)</div>
                </div>
                
                <div class="folder-item" data-folder-id="folder-3">
                    <div class="folder-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <div class="folder-name">حسابات (3)</div>
                </div>
                
                <div class="folder-item" data-folder-id="folder-4">
                    <div class="folder-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <div class="folder-name">محفوظات (4)</div>
                </div>
                
                <div class="folder-item" data-folder-id="folder-5">
                    <div class="folder-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <div class="folder-name">توكيلات (5)</div>
                </div>
                
                <!-- ملفات (عينة) -->
                <div class="file-item" data-file-id="file-root-1">
                    <div class="file-icon pdf">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-name">تقرير_مالي.pdf</div>
                </div>
                
                <div class="file-item" data-file-id="file-root-2">
                    <div class="file-icon doc">
                        <i class="fas fa-file-word"></i>
                    </div>
                    <div class="file-name">نموذج_توكيل.docx</div>
                </div>
                
                <div class="file-item" data-file-id="file-root-3">
                    <div class="file-icon xls">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="file-name">جدول_الحضور.xlsx</div>
                </div>
            `;
            
            listHtml = `
                <!-- المجلدات -->
                <tr data-folder-id="folder-1">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon folder">
                                <i class="fas fa-folder"></i>
                            </div>
                            <span>رسوم (1)</span>
                        </div>
                    </td>
                    <td>مجلد ملفات</td>
                    <td>-</td>
                    <td>21/04/2025</td>
                </tr>
                
                <tr data-folder-id="folder-2">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon folder">
                                <i class="fas fa-folder"></i>
                            </div>
                            <span>حضور (2)</span>
                        </div>
                    </td>
                    <td>مجلد ملفات</td>
                    <td>-</td>
                    <td>21/04/2025</td>
                </tr>
                
                <tr data-folder-id="folder-3">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon folder">
                                <i class="fas fa-folder"></i>
                            </div>
                            <span>حسابات (3)</span>
                        </div>
                    </td>
                    <td>مجلد ملفات</td>
                    <td>-</td>
                    <td>21/04/2025</td>
                </tr>
                
                <tr data-folder-id="folder-4">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon folder">
                                <i class="fas fa-folder"></i>
                            </div>
                            <span>محفوظات (4)</span>
                        </div>
                    </td>
                    <td>مجلد ملفات</td>
                    <td>-</td>
                    <td>21/04/2025</td>
                </tr>
                
                <tr data-folder-id="folder-5">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon folder">
                                <i class="fas fa-folder"></i>
                            </div>
                            <span>توكيلات (5)</span>
                        </div>
                    </td>
                    <td>مجلد ملفات</td>
                    <td>-</td>
                    <td>21/04/2025</td>
                </tr>
                
                <!-- الملفات (عينة) -->
                <tr data-file-id="file-root-1">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon pdf">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <span>تقرير_مالي.pdf</span>
                        </div>
                    </td>
                    <td>ملف PDF</td>
                    <td>2.1 MB</td>
                    <td>20/04/2025</td>
                </tr>
                
                <tr data-file-id="file-root-2">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon doc">
                                <i class="fas fa-file-word"></i>
                            </div>
                            <span>نموذج_توكيل.docx</span>
                        </div>
                    </td>
                    <td>مستند Word</td>
                    <td>358 KB</td>
                    <td>19/04/2025</td>
                </tr>
                
                <tr data-file-id="file-root-3">
                    <td>
                        <div class="file-cell">
                            <div class="file-list-icon xls">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <span>جدول_الحضور.xlsx</span>
                        </div>
                    </td>
                    <td>جدول Excel</td>
                    <td>780 KB</td>
                    <td>18/04/2025</td>
                </tr>
            `;
            
            itemCount = 8; // 5 مجلدات و 3 ملفات
        }
        
        // تحديث عرض الملفات
        $('#grid-view').html(filesHtml);
        
        // تحديث عرض القائمة
        $('#list-view tbody').html(listHtml);
        
        // تحديث عدد العناصر
        const itemCountText = itemCount > 0 ? `${itemCount} عنصر` : 'لا توجد عناصر';
        $('.item-count').text(itemCountText);
    }
    
    // ============= احداث النقر والتفاعل =============
    
    // تفعيل النقر على عناصر الوصول السريع
    $(document).on('click', '.quick-access-item', function(e) {
        e.preventDefault(); // منع السلوك الافتراضي للرابط
        const folderId = $(this).data('folder-id');
        if (folderId) {
            console.log(`تم النقر على عنصر الوصول السريع: ${folderId}`);
            
            // عرض محتويات المجلد
            showFolderContents(folderId);
            
            // تحديث العنوان في شريط العنوان
            const folderName = $(this).find('span').text();
            $('.address-text').html('<a href="#" class="text-decoration-none">الرئيسية</a>' + 
                '<span class="breadcrumb-separator">/</span>' + folderName);
        }
    });
    
    // تفعيل النقر على المجلدات في عرض الشبكة (Grid View)
    $(document).on('click', '.folder-item', function(e) {
        const folderId = $(this).data('folder-id');
        if (folderId) {
            console.log(`تم النقر على مجلد في عرض الشبكة: ${folderId}`);
            
            // عرض محتويات المجلد
            showFolderContents(folderId);
            
            // تحديث العنوان في شريط العنوان
            const folderName = $(this).find('.folder-name').text();
            $('.address-text').html('<a href="#" class="text-decoration-none">الرئيسية</a>' + 
                '<span class="breadcrumb-separator">/</span>' + folderName);
        }
    });
    
    // تفعيل النقر على المجلدات في عرض القائمة (List View)
    $(document).on('click', 'tr[data-folder-id]', function(e) {
        const folderId = $(this).data('folder-id');
        if (folderId) {
            console.log(`تم النقر على مجلد في عرض القائمة: ${folderId}`);
            
            // عرض محتويات المجلد
            showFolderContents(folderId);
            
            // تحديث العنوان في شريط العنوان
            const folderName = $(this).find('span').text();
            $('.address-text').html('<a href="#" class="text-decoration-none">الرئيسية</a>' + 
                '<span class="breadcrumb-separator">/</span>' + folderName);
        }
    });
    
    // تفعيل النقر على الملفات (فتح نافذة معاينة)
    $(document).on('click', '.file-item, tr[data-file-id]', function(e) {
        const fileId = $(this).data('file-id');
        if (fileId) {
            console.log(`تم النقر على ملف: ${fileId}`);
            
            // تحديد نوع الملف وعرض رسالة مناسبة
            let fileName = '';
            let fileType = '';
            
            if ($(this).hasClass('file-item')) {
                fileName = $(this).find('.file-name').text();
                if ($(this).find('.file-icon').hasClass('pdf')) fileType = 'PDF';
                else if ($(this).find('.file-icon').hasClass('doc')) fileType = 'Word';
                else if ($(this).find('.file-icon').hasClass('xls')) fileType = 'Excel';
                else if ($(this).find('.file-icon').hasClass('zip')) fileType = 'ZIP';
                else fileType = 'مستند';
            } else {
                fileName = $(this).find('span').text();
                const cellText = $(this).find('td:nth-child(2)').text();
                if (cellText.includes('PDF')) fileType = 'PDF';
                else if (cellText.includes('Word')) fileType = 'Word';
                else if (cellText.includes('Excel')) fileType = 'Excel';
                else if (cellText.includes('مضغوط')) fileType = 'ZIP';
                else fileType = 'مستند';
            }
            
            // عرض نافذة المعاينة
            $('#previewModal .modal-title').text(fileName);
            $('#previewModalContent').html(`
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-file-${fileType.toLowerCase() === 'pdf' ? 'pdf' : 
                                             fileType.toLowerCase() === 'word' ? 'word' :
                                             fileType.toLowerCase() === 'excel' ? 'excel' : 
                                             fileType.toLowerCase() === 'zip' ? 'archive' : 'alt'} fa-4x"></i>
                    </div>
                    <h5>معاينة ${fileName}</h5>
                    <p class="text-muted">جاري تحميل ملف ${fileType}...</p>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 75%"></div>
                    </div>
                    <p class="small">سيتم فتح الملف في التطبيق المناسب عند اكتمال التحميل.</p>
                </div>
            `);
            
            // إظهار النافذة
            const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
            previewModal.show();
        }
    });
    
    // ============= وظائف العرض =============
    
    // تفعيل أزرار تبديل العرض (شبكة/قائمة)
    $('#grid-view-btn').on('click', function() {
        $(this).addClass('active');
        $('#list-view-btn').removeClass('active');
        $('#grid-view').show();
        $('#list-view').hide();
    });
    
    $('#list-view-btn').on('click', function() {
        $(this).addClass('active');
        $('#grid-view-btn').removeClass('active');
        $('#list-view').show();
        $('#grid-view').hide();
    });
    
    // تفعيل زر البحث
    $('#content-search').on('keyup', function() {
        const searchText = $(this).val().toLowerCase();
        
        // بحث في عرض الشبكة
        $('.file-item, .folder-item').each(function() {
            const itemName = $(this).find('.file-name, .folder-name').text().toLowerCase();
            if (itemName.includes(searchText)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
        
        // بحث في عرض القائمة
        $('#list-view tbody tr').each(function() {
            const itemName = $(this).find('span').text().toLowerCase();
            if (itemName.includes(searchText)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // النقر على رابط الرئيسية
    $(document).on('click', '.address-text a', function(e) {
        e.preventDefault();
        showFolderContents('folder-root');
        $('.address-text').html('<a href="#" class="text-decoration-none">الرئيسية</a>');
    });
    
    // تفعيل زر العودة للأعلى
    $('#up-btn').on('click', function() {
        showFolderContents('folder-root');
        $('.address-text').html('<a href="#" class="text-decoration-none">الرئيسية</a>');
    });
    
    // تفعيل زر التحديث
    $('#refresh-btn').on('click', function() {
        showFolderContents('folder-root');
        $('.address-text').html('<a href="#" class="text-decoration-none">الرئيسية</a>');
    });
    
    // ============= تحميل البيانات الأولية =============
    
    // إظهار المجلدات الرئيسية عند تحميل الصفحة
    showFolderContents('folder-root');
    
    // JsTree Configuration (for reference, not used directly in this simplified version)
    if ($('#folder-tree').length) {
        $('#folder-tree').jstree({
            'core': { 
                'themes': {
                    'responsive': true,
                    'name': 'default',
                    'icons': true,
                    'dots': true,
                    'variant': 'large'
                }
            },
            'plugins': ['types', 'state', 'wholerow'],
            'types': {
                'default': { 'icon': 'fas fa-folder text-warning' },
                'folder': { 'icon': 'fas fa-folder text-warning' }
            }
        });
    }
});
</script>
{% endblock %}