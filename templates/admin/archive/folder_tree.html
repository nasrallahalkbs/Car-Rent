<!-- CACHE_BUSTER 1745273815 -->{% extends 'admin_sidebar_layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Archive Folder Tree" %}{% endblock %}

{% block page_title %}{% trans "Archive Folder Tree" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_archive' %}">{% trans "Archive" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'admin_archive_folders' %}">{% trans "Folders" %}</a></li>
<li class="breadcrumb-item active">{% trans "Folder Tree" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .folder-tree-container {
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .folder-tree {
        font-size: 1rem;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .jstree-default .jstree-anchor {
        line-height: 32px;
        height: 32px;
    }
    
    .jstree-default .jstree-icon {
        width: 32px;
        height: 32px;
        line-height: 32px;
    }
    
    .folder-badge {
        display: inline-block;
        font-size: 0.75rem;
        line-height: 1;
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        margin-{% if is_english %}left{% else %}right{% endif %}: 0.5rem;
        vertical-align: middle;
    }
    
    .folder-count {
        font-size: 0.75rem;
        color: #64748b;
        margin-{% if is_english %}left{% else %}right{% endif %}: 0.5rem;
        vertical-align: middle;
    }
    
    .tree-info-panel {
        background-color: #f8fafc;
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    
    .tree-info-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1e293b;
    }
    
    .tree-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .legend-icon {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-{% if is_english %}right{% else %}left{% endif %}: 0.5rem;
        font-size: 0.875rem;
    }
    
    .legend-text {
        font-size: 0.875rem;
        color: #334155;
    }
    
    /* Stat Cards */
    .stat-card {
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background-color: #fff;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }
    
    .folder-types {
        margin-top: 1.5rem;
    }
    
    .folder-type-badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: 0.75rem;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        margin-{% if is_english %}right{% else %}left{% endif %}: 0.25rem;
        margin-bottom: 0.25rem;
    }
</style>
<!-- إضافة مكتبة jsTree لعرض الشجرة -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">{% trans "Archive Folder Tree" %}</h1>
                    <p class="text-muted">{% trans "Visual representation of your archive folder structure" %}</p>
                </div>
                <div>
                    <a href="{% url 'admin_archive_folder_add' %}" class="btn btn-primary">
                        <i class="fas fa-folder-plus me-2"></i> {% trans "Add New Folder" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- الإحصائيات -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-primary text-white">
                    <i class="fas fa-folder-open"></i>
                </div>
                <div class="h6 text-muted">{% trans "Total Folders" %}</div>
                <div class="h3">{{ total_folders }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #8338ec; color: white;">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="h6 text-muted">{% trans "System Folders" %}</div>
                <div class="h3">{{ system_folders }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #3a86ff; color: white;">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="h6 text-muted">{% trans "Custom Folders" %}</div>
                <div class="h3">{{ custom_folders }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #ff006e; color: white;">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="h6 text-muted">{% trans "Total Documents" %}</div>
                <div class="h3">{{ total_documents }}</div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="folder-tree-container">
                <h4 class="mb-4">{% trans "Folder Hierarchy" %}</h4>
                
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="folder-search" placeholder="{% trans 'Search folders...' %}">
                    </div>
                </div>
                
                <div id="folder-tree" class="folder-tree"></div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="tree-info-panel">
                <h5 class="tree-info-title">{% trans "About the Archive Structure" %}</h5>
                <p>{% trans "This tree view gives you a complete overview of your archive organization. You can navigate through folders, see their hierarchy, and quickly access any folder or document." %}</p>
                
                <h6 class="mt-4">{% trans "How to use" %}:</h6>
                <ul>
                    <li>{% trans "Click on a folder to expand or collapse it" %}</li>
                    <li>{% trans "Use the search box to quickly find folders" %}</li>
                    <li>{% trans "Click the folder name to navigate to its contents" %}</li>
                    <li>{% trans "Numbers indicate documents in each folder" %}</li>
                </ul>
                
                <div class="tree-legend">
                    <div class="legend-item">
                        <div class="legend-icon" style="background-color: #3a86ff; color: white;">
                            <i class="fas fa-folder"></i>
                        </div>
                        <span class="legend-text">{% trans "Regular Folder" %}</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-icon" style="background-color: #8338ec; color: white;">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <span class="legend-text">{% trans "System Folder" %}</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-icon" style="background-color: #ff006e; color: white;">
                            <i class="fas fa-file"></i>
                        </div>
                        <span class="legend-text">{% trans "Contains Documents" %}</span>
                    </div>
                </div>
                
                <div class="folder-types">
                    <h6>{% trans "Folder Types" %}:</h6>
                    <div class="mt-2">
                        <span class="folder-type-badge" style="background-color: #3a86ff;">{% trans "Reservations" %}</span>
                        <span class="folder-type-badge" style="background-color: #ff006e;">{% trans "Cars" %}</span>
                        <span class="folder-type-badge" style="background-color: #fb5607;">{% trans "Contracts" %}</span>
                        <span class="folder-type-badge" style="background-color: #ffbe0b;">{% trans "Receipts" %}</span>
                        <span class="folder-type-badge" style="background-color: #8338ec;">{% trans "Official Documents" %}</span>
                        <span class="folder-type-badge" style="background-color: #3a86ff;">{% trans "Other" %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4 mb-5">
        <a href="{% url 'admin_archive_folders' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> {% trans "Back to Folders" %}
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // بيانات شجرة المجلدات
        const folderData = {{ folder_tree|safe }};
        
        // تحويل البيانات إلى التنسيق المطلوب لـ jsTree
        const treeData = folderData.map(folder => convertFolderToTreeNode(folder));
        
        // إنشاء شجرة المجلدات
        $('#folder-tree').jstree({
            'core': {
                'data': treeData,
                'themes': {
                    'responsive': true,
                    'variant': 'large'
                }
            },
            'plugins': ['search', 'types', 'wholerow'],
            'types': {
                'default': {
                    'icon': 'fas fa-folder'
                },
                'system-folder': {
                    'icon': 'fas fa-cogs'
                },
                'document-folder': {
                    'icon': 'fas fa-folder-open'
                }
            },
            'search': {
                'case_sensitive': false,
                'show_only_matches': true
            }
        });
        
        // التعامل مع النقر على العناصر
        $('#folder-tree').on('select_node.jstree', function(e, data) {
            if (data.node.original.folder_url) {
                window.location.href = data.node.original.folder_url;
            }
        });
        
        // تفعيل خاصية البحث
        const searchTimeout = 300;
        let searchTimer = null;
        
        $('#folder-search').keyup(function() {
            if (searchTimer) {
                clearTimeout(searchTimer);
            }
            searchTimer = setTimeout(function() {
                const searchString = $('#folder-search').val();
                $('#folder-tree').jstree('search', searchString);
            }, searchTimeout);
        });
        
        // دالة تحويل بيانات المجلد إلى تنسيق jsTree
        function convertFolderToTreeNode(folder) {
            // تحديد نوع العقدة
            let nodeType = 'default';
            if (folder.is_system) {
                nodeType = 'system-folder';
            } else if (folder.document_count > 0) {
                nodeType = 'document-folder';
            }
            
            // تحديد نص العقدة
            let text = folder.name;
            
            // إضافة شارة نوع المجلد
            if (folder.type && folder.type !== 'folder') {
                text += `<span class="folder-badge bg-primary text-white">${folder.type}</span>`;
            }
            
            // إضافة عدد المستندات
            if (folder.document_count > 0) {
                text += `<span class="folder-count">${folder.document_count} {% trans "documents" %}</span>`;
            }
            
            // إضافة شارة المجلد النظامي
            if (folder.is_system) {
                text += `<span class="folder-badge" style="background-color: #8338ec; color: white;">{% trans "System" %}</span>`;
            }
            
            // إنشاء العقدة
            const node = {
                id: `folder-${folder.id}`,
                text: text,
                type: nodeType,
                folder_url: `/dashboard/archive/folder/${folder.id}/`,
                state: {
                    opened: folder.children.length > 0 && folder.children.length < 5,  // فتح المجلدات ذات الأبناء القليلة
                    selected: false
                }
            };
            
            // إضافة الأبناء إذا وجدت
            if (folder.children && folder.children.length > 0) {
                node.children = folder.children.map(child => convertFolderToTreeNode(child));
            }
            
            return node;
        }
    });
</script>
{% endblock %}