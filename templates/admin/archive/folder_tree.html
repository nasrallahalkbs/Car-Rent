<!-- CACHE_BUSTER 1745274700 -->{% extends 'admin_layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Archive Folder Tree" %}{% endblock %}

{% block page_title %}{% trans "Archive Folder Tree" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_archive' %}">{% trans "Archive" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'admin_archive_folders' %}">{% trans "Folders" %}</a></li>
<li class="breadcrumb-item active">{% trans "Folder Tree" %}</li>
{% endblock %}

{% block extra_css %}
<style>
    .folder-tree-container {
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .folder-tree {
        font-size: 1rem;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .jstree-default .jstree-anchor {
        line-height: 32px;
        height: 32px;
    }
    
    .jstree-default .jstree-icon {
        width: 32px;
        height: 32px;
        line-height: 32px;
    }
    
    .folder-badge {
        display: inline-block;
        font-size: 0.75rem;
        line-height: 1;
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        margin-{% if is_english %}left{% else %}right{% endif %}: 0.5rem;
        vertical-align: middle;
    }
    
    .folder-count {
        font-size: 0.75rem;
        color: #64748b;
        margin-{% if is_english %}left{% else %}right{% endif %}: 0.5rem;
        vertical-align: middle;
    }
    
    .tree-info-panel {
        background-color: #f8fafc;
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    
    .tree-info-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1e293b;
    }
    
    .tree-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .legend-icon {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-{% if is_english %}right{% else %}left{% endif %}: 0.5rem;
        font-size: 0.875rem;
    }
    
    .legend-text {
        font-size: 0.875rem;
        color: #334155;
    }
    
    /* Stat Cards */
    .stat-card {
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background-color: #fff;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }
    
    .folder-types {
        margin-top: 1.5rem;
    }
    
    .folder-type-badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: 0.75rem;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        margin-{% if is_english %}right{% else %}left{% endif %}: 0.25rem;
        margin-bottom: 0.25rem;
    }
</style>
<!-- إضافة مكتبة jsTree لعرض الشجرة -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">{% trans "شجرة المجلدات" %}</h1>
                    <p class="text-muted">{% trans "الهيكل التنظيمي للأرشيف الإلكتروني" %}</p>
                </div>
                <div>
                    <a href="{% url 'admin_archive_folder_add' %}" class="btn btn-primary">
                        <i class="fas fa-folder-plus me-2"></i> {% trans "إضافة مجلد جديد" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- رسائل التشخيص -->
    <div id="diagnostics" class="d-none">
        <div class="alert alert-info">
            <h5>معلومات تشخيصية للمطورين:</h5>
            <pre>عدد المجلدات الإجمالي: {{ total_folders }}</pre>
            <pre>عدد المجلدات النظامية: {{ system_folders }}</pre>
            <pre>عدد المجلدات المخصصة: {{ custom_folders }}</pre>
            <pre>عدد المستندات الإجمالي: {{ total_files }}</pre>
            <pre>بيانات عينة من folder_tree: {{ folder_tree|slice:":100" }}</pre>
        </div>
    </div>
    
    <!-- زر لعرض/إخفاء التشخيص -->
    <div class="mb-3">
        <button id="toggle-diagnostic" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-bug me-1"></i> {% trans "Show/Hide Diagnostic Info" %}
        </button>
    </div>
    
    <!-- الإحصائيات -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-primary text-white">
                    <i class="fas fa-folder-open"></i>
                </div>
                <div class="h6 text-muted">{% trans "Total Folders" %}</div>
                <div class="h3">{{ total_folders }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #8338ec; color: white;">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="h6 text-muted">{% trans "System Folders" %}</div>
                <div class="h3">{{ system_folders }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #3a86ff; color: white;">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="h6 text-muted">{% trans "Custom Folders" %}</div>
                <div class="h3">{{ custom_folders }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #ff006e; color: white;">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="h6 text-muted">{% trans "Total Documents" %}</div>
                <div class="h3">{{ total_documents }}</div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="folder-tree-container">
                <h4 class="mb-4">{% trans "شجرة المجلدات" %}</h4>
                
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="folder-search" placeholder="{% trans 'البحث في المجلدات...' %}">
                    </div>
                </div>
                
                <div id="folder-tree" class="folder-tree" dir="{% if is_rtl %}rtl{% else %}ltr{% endif %}"></div>
<div class="mt-3 d-flex justify-content-end">
    <button class="btn btn-outline-secondary btn-sm print-tree-btn">
        <i class="fas fa-print me-1"></i> {% trans "Print Tree" %}
    </button>
</div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="tree-info-panel">
                <h5 class="tree-info-title">{% trans "About the Archive Structure" %}</h5>
                <p>{% trans "This tree view gives you a complete overview of your archive organization. You can navigate through folders, see their hierarchy, and quickly access any folder or document." %}</p>
                
                <h6 class="mt-4">{% trans "How to use" %}:</h6>
                <ul>
                    <li>{% trans "Click on a folder to expand or collapse it" %}</li>
                    <li>{% trans "Use the search box to quickly find folders" %}</li>
                    <li>{% trans "Click the folder name to navigate to its contents" %}</li>
                    <li>{% trans "Numbers indicate documents in each folder" %}</li>
                </ul>
                
                <div class="tree-legend">
                    <div class="legend-item">
                        <div class="legend-icon" style="background-color: #3a86ff; color: white;">
                            <i class="fas fa-folder"></i>
                        </div>
                        <span class="legend-text">{% trans "Regular Folder" %}</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-icon" style="background-color: #8338ec; color: white;">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <span class="legend-text">{% trans "System Folder" %}</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-icon" style="background-color: #ff006e; color: white;">
                            <i class="fas fa-file"></i>
                        </div>
                        <span class="legend-text">{% trans "Contains Documents" %}</span>
                    </div>
                </div>
                
                <div class="folder-types">
                    <h6>{% trans "Folder Types" %}:</h6>
                    <div class="mt-2">
                        <span class="folder-type-badge" style="background-color: #3a86ff;">{% trans "رسوم" %} (1)</span>
                        <span class="folder-type-badge" style="background-color: #ff006e;">{% trans "حضور" %} (2)</span>
                        <span class="folder-type-badge" style="background-color: #fb5607;">{% trans "حسابات" %} (3)</span>
                        <span class="folder-type-badge" style="background-color: #ffbe0b;">{% trans "محفوظات" %} (4)</span>
                        <span class="folder-type-badge" style="background-color: #8338ec;">{% trans "توكيلات" %} (5)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4 mb-5">
        <a href="{% url 'admin_archive_folders' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> {% trans "Back to Folders" %}
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // بيانات شجرة المجلدات
        const folderData = {{ folder_tree|safe }};
        
        console.log("بيانات المجلدات:", folderData); // للمساعدة في التشخيص
        
        // إضافة رسالة تشخيص
        if (!folderData || folderData.length === 0) {
            console.error("لا توجد بيانات مجلدات! يرجى التحقق من إنشاء المجلدات في النظام");
            $('#folder-tree').html('<div class="alert alert-warning">لم يتم العثور على أي مجلدات. يرجى إنشاء مجلدات أولاً.</div>');
        }
        
        // تخصيص بيانات الشجرة لتتطابق مع الصورة المرجعية
        const customFolderData = [
            { 
              'id': 'folder-root', 
              'text': 'شجرة المجلدات', 
              'icon': 'fas fa-tree text-success',
              'state': { 'opened': true },
              'children': [
                { 
                  'id': 'folder-1', 
                  'text': 'رسوم (1)', 
                  'icon': 'fas fa-folder text-warning' 
                },
                { 
                  'id': 'folder-2', 
                  'text': 'حضور (2)', 
                  'icon': 'fas fa-folder text-warning' 
                },
                { 
                  'id': 'folder-3', 
                  'text': 'حسابات (3)', 
                  'icon': 'fas fa-folder text-primary' 
                },
                { 
                  'id': 'folder-4', 
                  'text': 'محفوظات (4)', 
                  'icon': 'fas fa-folder text-danger' 
                },
                { 
                  'id': 'folder-5', 
                  'text': 'توكيلات (5)', 
                  'icon': 'fas fa-folder text-info' 
                }
              ]
            }
        ];
        
        // استخدام البيانات المخصصة إذا لم تكن هناك بيانات من الخادم
        const treeData = (!folderData || folderData.length === 0) ? customFolderData : folderData;
        
        // إنشاء شجرة المجلدات
        $('#folder-tree').jstree({
            'core': {
                'data': treeData,
                'themes': {
                    'responsive': true,
                    'variant': 'large'
                },
                'check_callback': true
            },
            'plugins': ['search', 'types', 'wholerow'],
            'types': {
                'default': {
                    'icon': 'fas fa-folder'
                },
                'system-folder': {
                    'icon': 'fas fa-folder text-warning'
                },
                'document-folder': {
                    'icon': 'fas fa-folder text-primary'
                }
            },
            'search': {
                'case_sensitive': false,
                'show_only_matches': true
            }
        });
        
        // التعامل مع النقر على العناصر
        $('#folder-tree').on('select_node.jstree', function(e, data) {
            // تحقق مما إذا كان المعرف يبدأ بـ '#' (الجذر) أو يحتوي على 'folder-'
            const nodeId = data.node.id;
            
            if (nodeId === '#') {
                // الانتقال إلى الصفحة الرئيسية للأرشيف
                window.location.href = "/dashboard/archive/";
                return;
            }
            
            // استخراج معرف المجلد من هوية العقدة
            const idMatch = nodeId.match(/folder-(\d+)/);
            if (idMatch && idMatch[1]) {
                const folderId = idMatch[1];
                window.location.href = `/dashboard/archive/folder/${folderId}/`;
            }
        });
        
        // تفعيل خاصية البحث
        const searchTimeout = 300;
        let searchTimer = null;
        
        $('#folder-search').keyup(function() {
            if (searchTimer) {
                clearTimeout(searchTimer);
            }
            searchTimer = setTimeout(function() {
                const searchString = $('#folder-search').val();
                $('#folder-tree').jstree('search', searchString);
            }, searchTimeout);
        });
        
        // إضافة تفاعلية إضافية
        $('#folder-tree').on('ready.jstree', function() {
            // فتح كل المجلدات الجذرية عند التحميل
            const rootNodes = $('#folder-tree').jstree(true).get_json('#', { flat: false });
            for (const node of rootNodes) {
                $('#folder-tree').jstree('open_node', node.id);
            }
            
            console.log("تم تحميل شجرة المجلدات بنجاح!");
        });
        
        // دعم للطباعة
        $('.print-tree-btn').on('click', function() {
            window.print();
        });
        
        // تفعيل زر التشخيص
        $('#toggle-diagnostic').on('click', function() {
            $('#diagnostics').toggleClass('d-none');
        });
    });
</script>
{% endblock %}