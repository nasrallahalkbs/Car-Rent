{% extends "admin/enhanced/admin_layout.html" %}
<!-- CACHE_BUSTER {{ now.timestamp|floatformat:0 }} -->
{% load i18n %}
{% load static %}
{% load custom_filters %}

{% block title %}{% trans "إدارة التقارير" %} - كاررنتال{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports_management.css' %}?v=20250515" id="reports-css">
<!-- إضافة كود JavaScript لضمان تحميل CSS حتى بعد الخروج من الصفحة -->
<script>
    // التحقق من تحميل ملف CSS بنجاح
    document.addEventListener('DOMContentLoaded', function() {
        const cssLink = document.getElementById('reports-css');
        if (cssLink) {
            // إعادة تحميل CSS إذا لم يتم تحميله بشكل صحيح
            cssLink.onerror = function() {
                console.log("فشل تحميل ملف CSS، جاري إعادة المحاولة...");
                const newLink = document.createElement('link');
                newLink.rel = 'stylesheet';
                newLink.href = "{% static 'css/reports_management.css' %}?v=20250515&retry=1";
                document.head.appendChild(newLink);
            };
            
            // تخزين معلومات في localStorage للتأكد من تحميل CSS في المرات القادمة
            localStorage.setItem('reports_css_loaded', 'true');
        }
        
        // إخفاء القائمة الجانبية وجعل المحتوى يأخذ عرض الصفحة كاملاً
        document.querySelector('.admin-sidebar').style.display = 'none';
        document.querySelector('.main-content').style.marginRight = '0';
        document.querySelector('.main-content').style.marginLeft = '0';
        document.querySelector('.main-content').style.width = '100%';
    });
</script>

<style>
    /* تعديل نمط الصفحة لتأخذ كامل العرض بدون شريط جانبي */
    .admin-sidebar {
        display: none !important;
    }
    
    .main-content {
        margin-right: 0 !important;
        margin-left: 0 !important;
        width: 100% !important;
    }
    
    .content-wrapper {
        padding-left: 0;
        padding-right: 0;
    }
    
    /* جعل شريط العنوان في الأعلى يأخذ العرض كاملاً */
    .topbar {
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- نبدأ مباشرة بالتبويبات في أعلى الصفحة -->
    <div class="reports-container reports-container-full">
        <!-- شريط التبويبات بتصميم البرامج القديمة (Classic Desktop Menu) -->
        <div class="ribbon-menu">
            <!-- صف التبويبات العلوي -->
            <div class="menu-tabs">
                <div class="ribbon-tab active" data-tab="reservations">
                    <i class="fas fa-calendar-check"></i> {% trans "الحجوزات" %}
                </div>
                <div class="ribbon-tab" data-tab="cars">
                    <i class="fas fa-car"></i> {% trans "السيارات" %}
                </div>
                <div class="ribbon-tab" data-tab="customers">
                    <i class="fas fa-users"></i> {% trans "العملاء" %}
                </div>
                <div class="ribbon-tab" data-tab="custody">
                    <i class="fas fa-key"></i> {% trans "العهدة" %}
                </div>
                <div class="ribbon-tab" data-tab="car-conditions">
                    <i class="fas fa-car-crash"></i> {% trans "حالة السيارات" %}
                </div>
                <div class="ribbon-tab" data-tab="payments">
                    <i class="fas fa-file-invoice-dollar"></i> {% trans "المدفوعات" %}
                </div>
            </div>

            <!-- القسم الذي يحتوي على أزرار الأدوات -->
            <div class="menu-content">
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-add">
                        <i class="fas fa-plus"></i> {% trans "إضافة" %}
                    </div>
                    <div class="toolbar-btn btn-edit">
                        <i class="fas fa-edit"></i> {% trans "تعديل" %}
                    </div>
                    <div class="toolbar-btn btn-delete">
                        <i class="fas fa-trash"></i> {% trans "حذف" %}
                    </div>
                </div>
                
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-pdf">
                        <i class="fas fa-file-pdf"></i> {% trans "PDF" %}
                    </div>
                    <div class="toolbar-btn btn-excel">
                        <i class="fas fa-file-excel"></i> {% trans "Excel" %}
                    </div>
                    <div class="toolbar-btn btn-print">
                        <i class="fas fa-print"></i> {% trans "طباعة" %}
                    </div>
                </div>
                
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-save">
                        <i class="fas fa-save"></i> {% trans "حفظ التقرير" %}
                    </div>
                </div>
            </div>
        </div>

        <!-- منطقة المحتوى -->
        <div class="tab-content pb-3">
            <!-- تبويب الحجوزات -->
            <div class="tab-pane active px-2" id="reservations-tab">
                <!-- لم نعد نحتاج إلى قسم الفلاتر المنفصل لأننا سنضع الفلاتر في كل عمود -->
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول البيانات -->
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all">
                                </th>
                                <th class="filterable" data-column="reservation_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="car">
                                    <div class="column-header">
                                        <span>{% trans "السيارة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="user">
                                    <div class="column-header">
                                        <span>{% trans "العميل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="reservation_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="pickup_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الاستلام" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="return_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ التسليم" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="amount">
                                    <div class="column-header">
                                        <span>{% trans "المبلغ" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="status">
                                    <div class="column-header">
                                        <span>{% trans "حالة الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="payment_status">
                                    <div class="column-header">
                                        <span>{% trans "حالة الدفع" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="payment_method">
                                    <div class="column-header">
                                        <span>{% trans "طريقة الدفع" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="transaction_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم العملية" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="admin">
                                    <div class="column-header">
                                        <span>{% trans "المسؤول" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ reservation.id }}</td>
                                <td>{{ reservation.car.make }} {{ reservation.car.model }}</td>
                                <td>{{ reservation.user.get_full_name|default:reservation.user.username }}</td>
                                <td>{{ reservation.created_at|date:"Y-m-d" }}</td>
                                <td>{{ reservation.start_date|date:"Y-m-d" }}</td>
                                <td>{{ reservation.end_date|date:"Y-m-d" }}</td>
                                <td>{{ reservation.total_price }} {% trans "ريال" %}</td>
                                <td>
                                    {% if reservation.status == 'confirmed' %}
                                    <span class="reservation-status confirmed">{% trans "مؤكد" %}</span>
                                    {% elif reservation.status == 'pending' %}
                                    <span class="reservation-status pending">{% trans "قيد الانتظار" %}</span>
                                    {% elif reservation.status == 'completed' %}
                                    <span class="reservation-status completed">{% trans "مكتمل" %}</span>
                                    {% elif reservation.status == 'cancelled' %}
                                    <span class="reservation-status cancelled">{% trans "ملغي" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reservation.payment_status == 'paid' %}
                                    <span class="reservation-status confirmed">{% trans "مدفوع" %}</span>
                                    {% elif reservation.payment_status == 'pending' %}
                                    <span class="reservation-status pending">{% trans "قيد الانتظار" %}</span>
                                    {% elif reservation.payment_status == 'cancelled' %}
                                    <span class="reservation-status cancelled">{% trans "ملغي" %}</span>
                                    {% else %}
                                    <span class="reservation-status">{{ reservation.payment_status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ reservation.payment_method|default:"-" }}</td>
                                <td>{{ reservation.transaction_id|default:"-" }}</td>
                                <td>{{ reservation.admin_notes|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr class="empty-table-row">
                                <td colspan="10" class="text-center">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 50px 0;">
                                        <i class="fas fa-calendar-times" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "لا توجد حجوزات" %}</div>
                                        <div style="color: #64748b; max-width: 400px; text-align: center;">{% trans "لم يتم العثور على حجوزات مطابقة للمعايير الحالية. يمكنك إضافة حجز جديد أو تعديل معايير البحث." %}</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تبويب السيارات -->
            <div class="tab-pane" id="cars-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول بيانات السيارات -->
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all-cars">
                                </th>
                                <th class="filterable" data-column="car_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم السيارة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="make">
                                    <div class="column-header">
                                        <span>{% trans "الماركة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="model">
                                    <div class="column-header">
                                        <span>{% trans "الموديل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="year">
                                    <div class="column-header">
                                        <span>{% trans "السنة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="license_plate">
                                    <div class="column-header">
                                        <span>{% trans "رقم اللوحة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="color">
                                    <div class="column-header">
                                        <span>{% trans "اللون" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="category">
                                    <div class="column-header">
                                        <span>{% trans "الفئة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="price">
                                    <div class="column-header">
                                        <span>{% trans "السعر اليومي" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="status">
                                    <div class="column-header">
                                        <span>{% trans "الحالة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="mileage">
                                    <div class="column-header">
                                        <span>{% trans "المسافة المقطوعة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for car in cars %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ car.id }}</td>
                                <td>{{ car.make }}</td>
                                <td>{{ car.model }}</td>
                                <td>{{ car.year }}</td>
                                <td>{{ car.license_plate|default:"-" }}</td>
                                <td>{{ car.color|default:"-" }}</td>
                                <td>{{ car.category|default:"-" }}</td>
                                <td>{{ car.daily_rate }} {% trans "ريال" %}</td>
                                <td>
                                    {% if car.status == 'available' %}
                                    <span class="reservation-status confirmed">{% trans "متاحة" %}</span>
                                    {% else %}
                                    <span class="reservation-status cancelled">{% trans "غير متاحة" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ car.mileage|default:"0" }} {% trans "كم" %}</td>
                            </tr>
                            {% empty %}
                            <tr class="empty-table-row">
                                <td colspan="11" class="text-center">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 50px 0;">
                                        <i class="fas fa-car-alt" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "لا توجد سيارات" %}</div>
                                        <div style="color: #64748b; max-width: 400px; text-align: center;">{% trans "لم يتم العثور على سيارات مطابقة للمعايير الحالية." %}</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تبويب العملاء -->
            <div class="tab-pane" id="customers-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول بيانات العملاء -->
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all-customers">
                                </th>
                                <th class="filterable" data-column="customer_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم العميل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="full_name">
                                    <div class="column-header">
                                        <span>{% trans "الاسم الكامل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="email">
                                    <div class="column-header">
                                        <span>{% trans "البريد الإلكتروني" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="phone">
                                    <div class="column-header">
                                        <span>{% trans "رقم الهاتف" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="registration_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ التسجيل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="address">
                                    <div class="column-header">
                                        <span>{% trans "العنوان" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="id_number">
                                    <div class="column-header">
                                        <span>{% trans "رقم الهوية" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="driver_license">
                                    <div class="column-header">
                                        <span>{% trans "رخصة القيادة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="total_rentals">
                                    <div class="column-header">
                                        <span>{% trans "إجمالي الحجوزات" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ customer.id }}</td>
                                <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                                <td>{{ customer.email }}</td>
                                <td>{{ customer.phone }}</td>
                                <td>{{ customer.date_joined|date:"Y-m-d" }}</td>
                                <td>{{ customer.address|default:"-" }}</td>
                                <td>{{ customer.id_number|default:"-" }}</td>
                                <td>{{ customer.driver_license|default:"-" }}</td>
                                <td>{{ customer.reservations.count }}</td>
                            </tr>
                            {% empty %}
                            <tr class="empty-table-row">
                                <td colspan="10" class="text-center">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 50px 0;">
                                        <i class="fas fa-users" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "لا يوجد عملاء" %}</div>
                                        <div style="color: #64748b; max-width: 400px; text-align: center;">{% trans "لم يتم العثور على عملاء مطابقين للمعايير الحالية." %}</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تبويب العهدة والمستندات -->
            <div class="tab-pane" id="custody-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول بيانات عهدات العملاء -->
                <div class="table-responsive">
                    <!-- إحصائيات العهدات -->
                    <div class="reports-stats-row">
                        <div class="stats-card">
                            <div class="stats-title">{% trans "إجمالي العهدات" %}</div>
                            <div class="stats-value">{{ custody_stats.total|default:"0" }}</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title">{% trans "العهدات النشطة" %}</div>
                            <div class="stats-value">{{ custody_stats.active|default:"0" }}</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title">{% trans "العهدات المستردة" %}</div>
                            <div class="stats-value">{{ custody_stats.returned|default:"0" }}</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title">{% trans "العهدات المحتجزة" %}</div>
                            <div class="stats-value">{{ custody_stats.withheld|default:"0" }}</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title">{% trans "إجمالي القيمة" %}</div>
                            <div class="stats-value">{{ custody_stats.total_value|default:"0" }} {% trans "ريال" %}</div>
                        </div>
                    </div>
                    
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all-custody">
                                </th>
                                <th class="filterable" data-column="guarantee_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم العهدة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="name">
                                    <div class="column-header">
                                        <span>{% trans "اسم العهدة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="guarantee_type">
                                    <div class="column-header">
                                        <span>{% trans "نوع العهدة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="customer">
                                    <div class="column-header">
                                        <span>{% trans "العميل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="value">
                                    <div class="column-header">
                                        <span>{% trans "القيمة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="handover_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ التسليم" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="return_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الاسترداد" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="status">
                                    <div class="column-header">
                                        <span>{% trans "الحالة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="reservation">
                                    <div class="column-header">
                                        <span>{% trans "رقم الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="car">
                                    <div class="column-header">
                                        <span>{% trans "السيارة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="deductions">
                                    <div class="column-header">
                                        <span>{% trans "الخصومات" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="returned_amount">
                                    <div class="column-header">
                                        <span>{% trans "المبلغ المسترد" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="created_at">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الإنشاء" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for guarantee in guarantees %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ guarantee.id }}</td>
                                <td>{{ guarantee.name }}</td>
                                <td>{{ guarantee.get_guarantee_type_display }}</td>
                                <td>{{ guarantee.customer.get_full_name }}</td>
                                <td>{{ guarantee.value }} {% trans "ريال" %}</td>
                                <td>{{ guarantee.handover_date|date:"Y-m-d" }}</td>
                                <td>{{ guarantee.return_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>
                                    {% if guarantee.status == "active" %}
                                    <span class="guarantee-status active">{% trans "نشطة" %}</span>
                                    {% elif guarantee.status == "returned" %}
                                    <span class="guarantee-status returned">{% trans "مستردة" %}</span>
                                    {% elif guarantee.status == "partially_returned" %}
                                    <span class="guarantee-status partially-returned">{% trans "مستردة جزئياً" %}</span>
                                    {% elif guarantee.status == "withheld" %}
                                    <span class="guarantee-status withheld">{% trans "محتجزة" %}</span>
                                    {% elif guarantee.status == "claimed" %}
                                    <span class="guarantee-status claimed">{% trans "مطالب بها" %}</span>
                                    {% else %}
                                    <span class="guarantee-status">{{ guarantee.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ guarantee.reservation.reservation_number }}</td>
                                <td>{{ guarantee.car.make }} {{ guarantee.car.model|default:"-" }}</td>
                                <td>{{ guarantee.deductions }} {% trans "ريال" %}</td>
                                <td>{{ guarantee.returned_amount|default:"-" }}</td>
                                <td>{{ guarantee.created_at|date:"Y-m-d" }}</td>
                                <td>
                                    {% if document.expiry_date %}
                                    {{ document.expiry_date|date:"Y-m-d" }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if document.file_type %}
                                    <span class="file-type-badge">{{ document.file_type|cut:"application/"|default:document.file_extension|default:"" }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ document.file_size_display|default:"-" }}</td>
                                <td>
                                    {% if document.related_to == 'reservation' %}
                                    <span class="related-tag reservation">{% trans "حجز" %}</span>
                                    {% elif document.related_to == 'car' %}
                                    <span class="related-tag car">{% trans "سيارة" %}</span>
                                    {% elif document.related_to == 'user' %}
                                    <span class="related-tag user">{% trans "مستخدم" %}</span>
                                    {% elif document.related_to == 'employee' %}
                                    <span class="related-tag employee">{% trans "موظف" %}</span>
                                    {% else %}
                                    <span class="related-tag other">{% trans "أخرى" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if document.car %}
                                    {{ document.car.make }} {{ document.car.model }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if document.reservation %}
                                    <a href="{% url 'admin_reservation_detail' document.reservation.id %}" class="reservation-link">
                                        {{ document.reservation.reservation_number|default:document.reservation.id }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if document.user %}
                                    {{ document.user.get_full_name|default:document.user.username }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if document.added_by %}
                                    {{ document.added_by.get_full_name|default:document.added_by.username }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ document.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr class="empty-table-row">
                                <td colspan="16" class="text-center">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 50px 0;">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "لا توجد مستندات" %}</div>
                                        <div style="color: #64748b; max-width: 400px; text-align: center;">{% trans "لم يتم العثور على مستندات مطابقة للمعايير الحالية." %}</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تبويب حالة السيارات -->
            <div class="tab-pane" id="car-conditions-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- رسالة توضيحية نظراً لعدم وجود بيانات كافية حالياً -->
                <div class="empty-data-message">
                    <i class="fas fa-car-crash" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "تقارير حالة السيارات" %}</div>
                    <div style="color: #64748b; max-width: 600px; text-align: center;">{% trans "سيتم عرض تقارير حالة السيارات هنا في التحديثات القادمة. يمكنك الآن استخدام التبويبات الأخرى المفعلة." %}</div>
                </div>
            </div>

            <!-- تبويب المدفوعات -->
            <div class="tab-pane" id="payments-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- رسالة توضيحية نظراً لعدم وجود بيانات كافية حالياً -->
                <div class="empty-data-message">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "تقارير المدفوعات" %}</div>
                    <div style="color: #64748b; max-width: 600px; text-align: center;">{% trans "سيتم عرض تقارير المدفوعات هنا في التحديثات القادمة. يمكنك الآن استخدام التبويبات الأخرى المفعلة." %}</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- قوالب صناديق الفلاتر المنبثقة -->
<div id="filter-popups-container">
    <!-- قوالب الفلاتر المنبثقة (ستكون مخفية بشكل افتراضي) -->
    <!-- قالب فلتر النص -->
    <div id="text-filter" class="column-filter-popup" style="display: none;">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
    
    <!-- قالب فلتر التاريخ -->
    <div id="date-filter" class="column-filter-popup" style="display: none;">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <div class="date-filter-form">
            <label>{% trans "من" %}</label>
            <input type="date" class="filter-input date-from">
            <label>{% trans "إلى" %}</label>
            <input type="date" class="filter-input date-to">
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
    
    <!-- قالب فلتر الاختيار -->
    <div id="select-filter" class="column-filter-popup" style="display: none;">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</div>

<!-- للمتصفحات التي لا تدعم قوالب HTML5، نحتفظ بهذه القوالب -->
<template id="text-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

<template id="date-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <div class="date-filter-form">
            <label>{% trans "من" %}</label>
            <input type="date" class="filter-input date-from">
            <label>{% trans "إلى" %}</label>
            <input type="date" class="filter-input date-to">
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

<template id="select-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

{% block extra_js %}
<script src="{% static 'js/simple_filters.js' %}?v={{ now.timestamp|floatformat:0 }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ربط الأزرار بالوظائف المناسبة
        setupReportButtons();
        
        // الوظيفة المسؤولة عن إعداد أزرار التقارير
        function setupReportButtons() {
            // زر الطباعة
            const printBtn = document.querySelector('.btn-print');
            if (printBtn) {
                printBtn.addEventListener('click', handlePrintClick);
            }
            
            // أزرار التبويبات
            const tabButtons = document.querySelectorAll('.ribbon-tab');
            if (tabButtons) {
                tabButtons.forEach(tab => {
                    tab.addEventListener('click', handleTabClick);
                });
            }
        }
        
        // معالجة النقر على زر الطباعة
        function handlePrintClick() {
            // تحديد نوع التقرير الحالي (بافتراض أن التبويب النشط هو نوع التقرير)
            const activeTab = document.querySelector('.ribbon-tab.active');
            let reportType = 'reservations'; // القيمة الافتراضية
            
            if (activeTab) {
                reportType = activeTab.getAttribute('data-tab');
            }
            
            // الانتقال إلى صفحة إعدادات الطباعة مع تحديد نوع التقرير
            window.location.href = "{% url 'report_print_settings' 'placeholder' %}".replace('placeholder', reportType);
        }
        
        // معالجة النقر على التبويبات
        function handleTabClick(event) {
            // إزالة الحالة النشطة من جميع التبويبات
            document.querySelectorAll('.ribbon-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إضافة الحالة النشطة للتبويب الحالي
            this.classList.add('active');
            
            // إخفاء جميع أقسام المحتوى
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.style.display = 'none';
                pane.classList.remove('active');
            });
            
            // عرض قسم المحتوى المرتبط بالتبويب الحالي
            const tabId = this.getAttribute('data-tab') + '-tab';
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }
        }
    });
</script>
{% endblock %}
