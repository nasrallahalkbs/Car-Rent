{% extends "admin/enhanced/admin_layout.html" %}
<!-- CACHE_BUSTER {{ now.timestamp|floatformat:0 }} -->
{% load i18n %}
{% load static %}
{% load custom_filters %}

{% block title %}{% trans "إدارة التقارير" %} - كاررنتال{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports_management.css' %}?v=20250515" id="reports-css">
<!-- إضافة كود JavaScript لضمان تحميل CSS حتى بعد الخروج من الصفحة -->
<script>
    // التحقق من تحميل ملف CSS بنجاح
    document.addEventListener('DOMContentLoaded', function() {
        const cssLink = document.getElementById('reports-css');
        if (cssLink) {
            // إعادة تحميل CSS إذا لم يتم تحميله بشكل صحيح
            cssLink.onerror = function() {
                console.log("فشل تحميل ملف CSS، جاري إعادة المحاولة...");
                const newLink = document.createElement('link');
                newLink.rel = 'stylesheet';
                newLink.href = "{% static 'css/reports_management.css' %}?v=20250515&retry=1";
                document.head.appendChild(newLink);
            };
            
            // تخزين معلومات في localStorage للتأكد من تحميل CSS في المرات القادمة
            localStorage.setItem('reports_css_loaded', 'true');
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- نبدأ مباشرة بالتبويبات في أعلى الصفحة -->
    <div class="reports-container reports-container-full">
        <!-- شريط التبويبات بتصميم البرامج القديمة (Classic Desktop Menu) -->
        <div class="ribbon-menu">
            <!-- صف التبويبات العلوي -->
            <div class="menu-tabs">
                <div class="ribbon-tab active" data-tab="reservations">
                    <i class="fas fa-calendar-check"></i> {% trans "الحجوزات" %}
                </div>
                <div class="ribbon-tab" data-tab="cars">
                    <i class="fas fa-car"></i> {% trans "السيارات" %}
                </div>
                <div class="ribbon-tab" data-tab="customers">
                    <i class="fas fa-users"></i> {% trans "العملاء" %}
                </div>
                <div class="ribbon-tab" data-tab="custody">
                    <i class="fas fa-key"></i> {% trans "العهدة" %}
                </div>
                <div class="ribbon-tab" data-tab="car-conditions">
                    <i class="fas fa-car-crash"></i> {% trans "حالة السيارات" %}
                </div>
                <div class="ribbon-tab" data-tab="payments">
                    <i class="fas fa-file-invoice-dollar"></i> {% trans "المدفوعات" %}
                </div>
            </div>

            <!-- القسم الذي يحتوي على أزرار الأدوات -->
            <div class="menu-content">
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-add">
                        <i class="fas fa-plus"></i> {% trans "إضافة" %}
                    </div>
                    <div class="toolbar-btn btn-edit">
                        <i class="fas fa-edit"></i> {% trans "تعديل" %}
                    </div>
                    <div class="toolbar-btn btn-delete">
                        <i class="fas fa-trash"></i> {% trans "حذف" %}
                    </div>
                </div>
                
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-pdf">
                        <i class="fas fa-file-pdf"></i> {% trans "PDF" %}
                    </div>
                    <div class="toolbar-btn btn-excel">
                        <i class="fas fa-file-excel"></i> {% trans "Excel" %}
                    </div>
                    <div class="toolbar-btn btn-print">
                        <i class="fas fa-print"></i> {% trans "طباعة" %}
                    </div>
                </div>
                
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-save">
                        <i class="fas fa-save"></i> {% trans "حفظ التقرير" %}
                    </div>
                </div>
            </div>
        </div>

        <!-- منطقة المحتوى -->
        <div class="tab-content pb-3">
            <!-- تبويب الحجوزات -->
            <div class="tab-pane active px-2" id="reservations-tab">
                <!-- لم نعد نحتاج إلى قسم الفلاتر المنفصل لأننا سنضع الفلاتر في كل عمود -->
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول البيانات -->
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all">
                                </th>
                                <th class="filterable" data-column="reservation_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="car">
                                    <div class="column-header">
                                        <span>{% trans "السيارة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="reservation_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="pickup_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الاستلام" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="return_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ التسليم" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="amount">
                                    <div class="column-header">
                                        <span>{% trans "المبلغ" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="status">
                                    <div class="column-header">
                                        <span>{% trans "حالة الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="admin">
                                    <div class="column-header">
                                        <span>{% trans "المسؤول" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ reservation.id }}</td>
                                <td>{{ reservation.car.make }} {{ reservation.car.model }}</td>
                                <td>{{ reservation.created_at|date:"Y-m-d" }}</td>
                                <td>{{ reservation.start_date|date:"Y-m-d" }}</td>
                                <td>{{ reservation.end_date|date:"Y-m-d" }}</td>
                                <td>{{ reservation.total_amount }} {% trans "ريال" %}</td>
                                <td>
                                    {% if reservation.status == 'confirmed' %}
                                    <span class="reservation-status confirmed">{% trans "مؤكد" %}</span>
                                    {% elif reservation.status == 'pending' %}
                                    <span class="reservation-status pending">{% trans "قيد الانتظار" %}</span>
                                    {% elif reservation.status == 'completed' %}
                                    <span class="reservation-status completed">{% trans "مكتمل" %}</span>
                                    {% elif reservation.status == 'cancelled' %}
                                    <span class="reservation-status cancelled">{% trans "ملغي" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ reservation.admin.username }}</td>
                            </tr>
                            {% empty %}
                            <tr class="empty-table-row">
                                <td colspan="10" class="text-center">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 50px 0;">
                                        <i class="fas fa-calendar-times" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "لا توجد حجوزات" %}</div>
                                        <div style="color: #64748b; max-width: 400px; text-align: center;">{% trans "لم يتم العثور على حجوزات مطابقة للمعايير الحالية. يمكنك إضافة حجز جديد أو تعديل معايير البحث." %}</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تبويب السيارات -->
            <div class="tab-pane" id="cars-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول بيانات السيارات -->
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all-cars">
                                </th>
                                <th class="filterable" data-column="car_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم السيارة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="make">
                                    <div class="column-header">
                                        <span>{% trans "الماركة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="model">
                                    <div class="column-header">
                                        <span>{% trans "الموديل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="year">
                                    <div class="column-header">
                                        <span>{% trans "السنة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="price">
                                    <div class="column-header">
                                        <span>{% trans "السعر اليومي" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="status">
                                    <div class="column-header">
                                        <span>{% trans "الحالة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for car in cars %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ car.id }}</td>
                                <td>{{ car.make }}</td>
                                <td>{{ car.model }}</td>
                                <td>{{ car.year }}</td>
                                <td>{{ car.price_per_day }} {% trans "ريال" %}</td>
                                <td>
                                    {% if car.is_available %}
                                    <span class="reservation-status confirmed">{% trans "متاحة" %}</span>
                                    {% else %}
                                    <span class="reservation-status cancelled">{% trans "غير متاحة" %}</span>
                                    {% endif %}
                                </td>
                                <td class="action-btns">
                                    <a href="#" title="{% trans 'عرض' %}"><i class="fas fa-eye"></i></a>
                                    <a href="#" title="{% trans 'تعديل' %}"><i class="fas fa-edit"></i></a>
                                    <a href="#" title="{% trans 'طباعة' %}"><i class="fas fa-print"></i></a>
                                </td>
                                        <i class="fas fa-car-alt" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "لا توجد سيارات" %}</div>
                                        <div style="color: #64748b; max-width: 400px; text-align: center;">{% trans "لم يتم العثور على سيارات مطابقة للمعايير الحالية." %}</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تبويب العملاء -->
            <div class="tab-pane" id="customers-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول بيانات العملاء -->
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all-customers">
                                </th>
                                <th class="filterable" data-column="customer_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم العميل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="full_name">
                                    <div class="column-header">
                                        <span>{% trans "الاسم الكامل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="email">
                                    <div class="column-header">
                                        <span>{% trans "البريد الإلكتروني" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="phone">
                                    <div class="column-header">
                                        <span>{% trans "رقم الهاتف" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="registration_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ التسجيل" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ customer.id }}</td>
                                <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                                <td>{{ customer.email }}</td>
                                <td>{{ customer.phone_number }}</td>
                                <td>{{ customer.date_joined|date:"Y-m-d" }}</td>
                                <td class="action-btns">
                                    <a href="#" title="{% trans 'عرض' %}"><i class="fas fa-eye"></i></a>
                                    <a href="#" title="{% trans 'تعديل' %}"><i class="fas fa-edit"></i></a>
                                    <a href="#" title="{% trans 'طباعة' %}"><i class="fas fa-print"></i></a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr class="empty-table-row">
                                <td colspan="7" class="text-center">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 50px 0;">
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تبويب العهدة والمستندات -->
            <div class="tab-pane" id="custody-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- رسالة توضيحية نظراً لعدم وجود بيانات كافية حالياً -->
                <div class="empty-data-message">
                    <i class="fas fa-key" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "تقارير العهدة" %}</div>
                    <div style="color: #64748b; max-width: 600px; text-align: center;">{% trans "سيتم عرض تقارير العهدة والمستندات هنا في التحديثات القادمة. يمكنك الآن استخدام التبويبات الأخرى المفعلة." %}</div>
                </div>
            </div>

            <!-- تبويب حالة السيارات -->
            <div class="tab-pane" id="car-conditions-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- رسالة توضيحية نظراً لعدم وجود بيانات كافية حالياً -->
                <div class="empty-data-message">
                    <i class="fas fa-car-crash" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "تقارير حالة السيارات" %}</div>
                    <div style="color: #64748b; max-width: 600px; text-align: center;">{% trans "سيتم عرض تقارير حالة السيارات هنا في التحديثات القادمة. يمكنك الآن استخدام التبويبات الأخرى المفعلة." %}</div>
                </div>
            </div>

            <!-- تبويب المدفوعات -->
            <div class="tab-pane" id="payments-tab" style="display: none;">
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- رسالة توضيحية نظراً لعدم وجود بيانات كافية حالياً -->
                <div class="empty-data-message">
                    <i class="fas fa-file-invoice-dollar" style="font-size: 3rem; color: #c9a96e; margin-bottom: 1rem;"></i>
                    <div style="font-size: 1.25rem; font-weight: 600; color: #5a4a2e; margin-bottom: 0.5rem;">{% trans "تقارير المدفوعات" %}</div>
                    <div style="color: #64748b; max-width: 600px; text-align: center;">{% trans "سيتم عرض تقارير المدفوعات هنا في التحديثات القادمة. يمكنك الآن استخدام التبويبات الأخرى المفعلة." %}</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- قوالب صناديق الفلاتر المنبثقة -->
<div id="filter-popups-container">
    <!-- قوالب الفلاتر المنبثقة (ستكون مخفية بشكل افتراضي) -->
    <!-- قالب فلتر النص -->
    <div id="text-filter" class="column-filter-popup" style="display: none;">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
    
    <!-- قالب فلتر التاريخ -->
    <div id="date-filter" class="column-filter-popup" style="display: none;">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <div class="date-filter-form">
            <label>{% trans "من" %}</label>
            <input type="date" class="filter-input date-from">
            <label>{% trans "إلى" %}</label>
            <input type="date" class="filter-input date-to">
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
    
    <!-- قالب فلتر الاختيار -->
    <div id="select-filter" class="column-filter-popup" style="display: none;">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</div>

<!-- للمتصفحات التي لا تدعم قوالب HTML5، نحتفظ بهذه القوالب -->
<template id="text-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

<template id="date-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <div class="date-filter-form">
            <label>{% trans "من" %}</label>
            <input type="date" class="filter-input date-from">
            <label>{% trans "إلى" %}</label>
            <input type="date" class="filter-input date-to">
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

<template id="select-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

{% block extra_js %}
<script src="{% static 'js/simple_filters.js' %}?v={{ now.timestamp|floatformat:0 }}"></script>
{% endblock %}
