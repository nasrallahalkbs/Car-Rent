{% extends "admin/enhanced/admin_layout.html" %}
<!-- CACHE_BUSTER {{ now.timestamp|floatformat:0 }} -->
{% load i18n %}
{% load static %}
{% load custom_filters %}

{% block title %}{% trans "إدارة التقارير" %} - كاررنتال{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports_management.css' %}?v={{ now.timestamp|floatformat:0 }}">
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- نبدأ مباشرة بالتبويبات في أعلى الصفحة -->
    <div class="reports-container reports-container-full">
        <!-- شريط التبويبات بتصميم البرامج القديمة (Classic Desktop Menu) -->
        <div class="ribbon-menu">
            <!-- صف التبويبات العلوي -->
            <div class="menu-tabs">
                <div class="ribbon-tab active" data-tab="reservations">
                    <i class="fas fa-calendar-check"></i> {% trans "الحجوزات" %}
                </div>
                <div class="ribbon-tab" data-tab="cars">
                    <i class="fas fa-car"></i> {% trans "السيارات" %}
                </div>
                <div class="ribbon-tab" data-tab="customers">
                    <i class="fas fa-users"></i> {% trans "العملاء" %}
                </div>
                <div class="ribbon-tab" data-tab="custody">
                    <i class="fas fa-key"></i> {% trans "العهدة" %}
                </div>
                <div class="ribbon-tab" data-tab="car-conditions">
                    <i class="fas fa-car-crash"></i> {% trans "حالة السيارات" %}
                </div>
                <div class="ribbon-tab" data-tab="payments">
                    <i class="fas fa-file-invoice-dollar"></i> {% trans "المدفوعات" %}
                </div>
            </div>

            <!-- القسم الذي يحتوي على أزرار الأدوات -->
            <div class="menu-content">
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-add">
                        <i class="fas fa-plus"></i> {% trans "إضافة" %}
                    </div>
                    <div class="toolbar-btn btn-edit">
                        <i class="fas fa-edit"></i> {% trans "تعديل" %}
                    </div>
                    <div class="toolbar-btn btn-delete">
                        <i class="fas fa-trash"></i> {% trans "حذف" %}
                    </div>
                </div>
                
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-pdf">
                        <i class="fas fa-file-pdf"></i> {% trans "PDF" %}
                    </div>
                    <div class="toolbar-btn btn-excel">
                        <i class="fas fa-file-excel"></i> {% trans "Excel" %}
                    </div>
                    <div class="toolbar-btn btn-print">
                        <i class="fas fa-print"></i> {% trans "طباعة" %}
                    </div>
                </div>
                
                <div class="toolbar-section">
                    <div class="toolbar-btn btn-save">
                        <i class="fas fa-save"></i> {% trans "حفظ التقرير" %}
                    </div>
                </div>
            </div>
        </div>

        <!-- منطقة المحتوى -->
        <div class="tab-content pb-3">
            <!-- تبويب الحجوزات -->
            <div class="tab-pane active px-2" id="reservations-tab">
                <!-- لم نعد نحتاج إلى قسم الفلاتر المنفصل لأننا سنضع الفلاتر في كل عمود -->
                <div class="column-filters-toolbar">
                    <div class="filter-buttons">
                        <button class="filter-btn reset-btn">{% trans "إعادة تعيين الفلاتر" %}</button>
                        <button class="filter-btn apply-btn">{% trans "تطبيق الفلاتر" %}</button>
                    </div>
                </div>

                <!-- جدول البيانات -->
                <div class="table-responsive">
                    <table class="reports-table">
                        <thead>
                            <tr class="column-headers">
                                <th width="30px">
                                    <input type="checkbox" class="form-check-input" id="select-all">
                                </th>
                                <th class="filterable" data-column="reservation_id">
                                    <div class="column-header">
                                        <span>{% trans "رقم الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="car">
                                    <div class="column-header">
                                        <span>{% trans "السيارة" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="reservation_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="pickup_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ الاستلام" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="return_date">
                                    <div class="column-header">
                                        <span>{% trans "تاريخ التسليم" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="amount">
                                    <div class="column-header">
                                        <span>{% trans "المبلغ" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="status">
                                    <div class="column-header">
                                        <span>{% trans "حالة الحجز" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th class="filterable" data-column="admin">
                                    <div class="column-header">
                                        <span>{% trans "المسؤول" %}</span>
                                        <i class="fas fa-filter filter-icon"></i>
                                    </div>
                                </th>
                                <th>{% trans "إجراءات" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-checkbox">
                                </td>
                                <td>{{ reservation.id }}</td>
                                <td>{{ reservation.car.make }} {{ reservation.car.model }}</td>
                                <td>{{ reservation.created_at|date:"Y-m-d" }}</td>
                                <td>{{ reservation.start_date|date:"Y-m-d" }}</td>
                                <td>{{ reservation.end_date|date:"Y-m-d" }}</td>
                                <td>{{ reservation.total_amount }} {% trans "ريال" %}</td>
                                <td>
                                    {% if reservation.status == 'confirmed' %}
                                    <span class="reservation-status confirmed">{% trans "مؤكد" %}</span>
                                    {% elif reservation.status == 'pending' %}
                                    <span class="reservation-status pending">{% trans "قيد الانتظار" %}</span>
                                    {% elif reservation.status == 'completed' %}
                                    <span class="reservation-status completed">{% trans "مكتمل" %}</span>
                                    {% elif reservation.status == 'cancelled' %}
                                    <span class="reservation-status cancelled">{% trans "ملغي" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ reservation.admin.username }}</td>
                                <td class="action-btns">
                                    <a href="#" title="{% trans 'عرض' %}"><i class="fas fa-eye"></i></a>
                                    <a href="#" title="{% trans 'تعديل' %}"><i class="fas fa-edit"></i></a>
                                    <a href="#" title="{% trans 'طباعة' %}"><i class="fas fa-print"></i></a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center py-3">{% trans "لا توجد حجوزات" %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- باقي التبويبات (سيتم تفعيلها لاحقاً) -->
            <div class="tab-pane" id="cars-tab" style="display: none;">
                <!-- محتوى تبويب السيارات -->
            </div>
            <div class="tab-pane" id="customers-tab" style="display: none;">
                <!-- محتوى تبويب العملاء -->
            </div>
            <div class="tab-pane" id="custody-tab" style="display: none;">
                <!-- محتوى تبويب العهدة -->
            </div>
            <div class="tab-pane" id="car-conditions-tab" style="display: none;">
                <!-- محتوى تبويب حالة السيارات -->
            </div>
            <div class="tab-pane" id="payments-tab" style="display: none;">
                <!-- محتوى تبويب المدفوعات -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- قوالب صناديق الفلاتر المنبثقة -->
<div id="filter-popups-container"></div>

<!-- قوالب صناديق الفلاتر المنبثقة (سيتم نسخها وإظهارها عبر JavaScript) -->
<template id="text-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

<template id="date-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <div class="date-filter-form">
            <label>{% trans "من" %}</label>
            <input type="date" class="filter-input date-from">
            <label>{% trans "إلى" %}</label>
            <input type="date" class="filter-input date-to">
        </div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

<template id="select-filter-template">
    <div class="column-filter-popup">
        <div class="filter-header">
            <div class="filter-title"></div>
            <i class="fas fa-times close-filter"></i>
        </div>
        <input type="text" class="filter-input" placeholder="{% trans 'بحث...' %}">
        <div class="filter-options-list"></div>
        <div class="filter-actions">
            <button class="filter-btn reset-filter">{% trans "إعادة تعيين" %}</button>
            <button class="filter-btn apply-filter">{% trans "تطبيق" %}</button>
        </div>
    </div>
</template>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // التبديل بين التبويبات
    const ribbonTabs = document.querySelectorAll('.ribbon-tab');
    const tabPanes = document.querySelectorAll('.tab-pane');

    ribbonTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // إزالة الفئة النشطة من جميع التبويبات
            ribbonTabs.forEach(t => t.classList.remove('active'));
            
            // إضافة الفئة النشطة للتبويب المحدد
            tab.classList.add('active');
            
            // إخفاء جميع المحتويات
            tabPanes.forEach(pane => pane.style.display = 'none');
            
            // عرض المحتوى المناسب
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(tabId + '-tab').style.display = 'block';
        });
    });
    
    // التحقق من مربعات الاختيار
    const mainCheckbox = document.getElementById('select-all');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    
    if (mainCheckbox) {
        mainCheckbox.addEventListener('change', function() {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    // تحديث مربع الاختيار الرئيسي عندما تتغير حالة مربعات الاختيار الفردية
    rowCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(rowCheckboxes).every(c => c.checked);
            const someChecked = Array.from(rowCheckboxes).some(c => c.checked);
            
            if (mainCheckbox) {
                mainCheckbox.checked = allChecked;
                mainCheckbox.indeterminate = someChecked && !allChecked;
            }
        });
    });

    // منطق فلاتر الأعمدة
    const filterIcons = document.querySelectorAll('.filter-icon');
    const filterPopupsContainer = document.getElementById('filter-popups-container');
    
    // بيانات الفلترة لكل عمود
    const filterTemplates = {
        'reservation_id': { type: 'text', title: '{% trans "فلترة بحسب رقم الحجز" %}', template: 'text-filter-template', options: [] },
        'car': { type: 'text', title: '{% trans "فلترة بحسب نوع السيارة" %}', template: 'text-filter-template', options: [] },
        'reservation_date': { type: 'date', title: '{% trans "فلترة بحسب تاريخ الحجز" %}', template: 'date-filter-template' },
        'pickup_date': { type: 'date', title: '{% trans "فلترة بحسب تاريخ الاستلام" %}', template: 'date-filter-template' },
        'return_date': { type: 'date', title: '{% trans "فلترة بحسب تاريخ التسليم" %}', template: 'date-filter-template' },
        'amount': { type: 'text', title: '{% trans "فلترة بحسب المبلغ" %}', template: 'text-filter-template', options: [] },
        'status': { 
            type: 'select', 
            title: '{% trans "فلترة بحسب الحالة" %}', 
            template: 'select-filter-template', 
            options: [
                { value: 'confirmed', label: '{% trans "مؤكد" %}' },
                { value: 'pending', label: '{% trans "قيد الانتظار" %}' },
                { value: 'completed', label: '{% trans "مكتمل" %}' },
                { value: 'cancelled', label: '{% trans "ملغي" %}' }
            ]
        },
        'admin': { 
            type: 'select', 
            title: '{% trans "فلترة بحسب المسؤول" %}', 
            template: 'select-filter-template', 
            options: [
                {% for admin in admins %}
                { value: '{{ admin.id }}', label: '{{ admin.username }}' },
                {% endfor %}
            ]
        }
    };

    let activeFilterPopup = null;

    // إغلاق أي صندوق فلتر مفتوح عند النقر في مكان آخر
    document.addEventListener('click', function(event) {
        if (activeFilterPopup && !event.target.closest('.column-filter-popup') && 
            !event.target.closest('.filter-icon')) {
            closeFilterPopup();
        }
    });

    filterIcons.forEach(icon => {
        icon.addEventListener('click', function(event) {
            event.stopPropagation();
            
            // إغلاق أي صندوق فلتر مفتوح
            if (activeFilterPopup) {
                closeFilterPopup();
            }
            
            // إنشاء صندوق الفلتر الجديد
            const columnHeader = icon.closest('.filterable');
            const columnName = columnHeader.getAttribute('data-column');
            const filterConfig = filterTemplates[columnName];
            
            if (filterConfig) {
                const template = document.getElementById(filterConfig.template);
                const filterPopup = template.content.cloneNode(true);
                
                // تعيين العنوان
                filterPopup.querySelector('.filter-title').textContent = filterConfig.title;
                
                // وضع خيارات الفلتر (للفلاتر النصية وفلاتر الاختيار)
                if (filterConfig.type === 'select' || filterConfig.type === 'text') {
                    const optionsList = filterPopup.querySelector('.filter-options-list');
                    filterConfig.options.forEach(option => {
                        const optionElement = document.createElement('div');
                        optionElement.className = 'filter-option';
                        optionElement.textContent = option.label;
                        optionElement.dataset.value = option.value;
                        optionsList.appendChild(optionElement);
                        
                        // تفعيل خيارات الفلتر
                        optionElement.addEventListener('click', function() {
                            this.classList.toggle('selected');
                        });
                    });
                }
                
                filterPopupsContainer.innerHTML = '';
                filterPopupsContainer.appendChild(filterPopup);
                
                activeFilterPopup = filterPopupsContainer.querySelector('.column-filter-popup');
                
                // تحديد موقع صندوق الفلتر
                const iconRect = icon.getBoundingClientRect();
                const isRtl = document.documentElement.dir === 'rtl';
                
                // تحديد موقع الفلتر المنبثق بناءً على اتجاه الصفحة
                activeFilterPopup.style.top = (iconRect.bottom + window.scrollY) + 'px';
                
                if (isRtl) {
                    activeFilterPopup.style.right = (window.innerWidth - iconRect.right) + 'px';
                } else {
                    activeFilterPopup.style.left = iconRect.left + 'px';
                }
                
                activeFilterPopup.classList.add('show');
                
                // إضافة حدث إغلاق الفلتر
                activeFilterPopup.querySelector('.close-filter').addEventListener('click', closeFilterPopup);
                
                // إضافة أحداث أزرار إعادة التعيين والتطبيق
                activeFilterPopup.querySelector('.reset-filter').addEventListener('click', function() {
                    // منطق إعادة تعيين الفلتر
                    closeFilterPopup();
                });
                
                activeFilterPopup.querySelector('.apply-filter').addEventListener('click', function() {
                    // منطق تطبيق الفلتر
                    closeFilterPopup();
                });
            }
        });
    });

    function closeFilterPopup() {
        if (activeFilterPopup) {
            activeFilterPopup.classList.remove('show');
            setTimeout(function() {
                filterPopupsContainer.innerHTML = '';
                activeFilterPopup = null;
            }, 200);
        }
    }
});
</script>
{% endblock %}