
{% extends "admin/enhanced/admin_layout.html" %}
<!-- CACHE_BUSTER {{ now.timestamp|floatformat:0 }} -->
{% load i18n %}
{% load static %}

{% block title %}{% trans "إعدادات طباعة التقرير" %} - كاررنتال{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/print_settings.css' %}?v={{ now.timestamp|floatformat:0 }}">
<style>
    /* تنسيقات أساسية لصفحة إعدادات الطباعة */
    .print-settings-container {
        display: flex;
        flex-direction: row-reverse; /* للدعم العربي RTL */
        gap: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        min-height: 80vh;
    }

    /* لوحة الإعدادات */
    .settings-panel {
        flex: 1;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    /* لوحة المعاينة */
    .preview-panel {
        flex: 2;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        overflow: auto;
    }

    .preview-paper {
        background-color: white;
        border: 1px solid #ddd;
        margin: 0 auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    /* A4 بالافتراض */
    .paper-a4 {
        width: 210mm;
        height: 297mm;
        max-width: 100%;
        max-height: 80vh;
    }

    /* A5 */
    .paper-a5 {
        width: 148mm;
        height: 210mm;
        max-width: 100%;
        max-height: 80vh;
    }

    /* Letter */
    .paper-letter {
        width: 216mm;
        height: 279mm;
        max-width: 100%;
        max-height: 80vh;
    }

    /* Legal */
    .paper-legal {
        width: 216mm;
        height: 356mm;
        max-width: 100%;
        max-height: 80vh;
    }

    /* تحديد هوامش المعاينة */
    .preview-content {
        transition: all 0.3s ease;
    }

    /* عنوان الإعدادات */
    .settings-title {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        font-weight: bold;
        font-size: 18px;
        color: #333;
    }

    /* مجموعات الإعدادات */
    .settings-group {
        margin-bottom: 25px;
    }

    .settings-group h3 {
        margin-bottom: 15px;
        font-size: 16px;
        color: #555;
    }

    .settings-group .form-group {
        margin-bottom: 15px;
    }

    .settings-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #666;
    }

    /* مساحة بين عناصر التحكم */
    .settings-group select,
    .settings-group input[type="number"],
    .settings-group input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .margins-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .margin-input {
        display: flex;
        flex-direction: column;
    }

    .action-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }

    .btn-print {
        background-color: #ffc107;
        color: #000;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    }

    .btn-print:hover {
        background-color: #e0a800;
    }

    .btn-cancel {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn-cancel:hover {
        background-color: #5a6268;
    }

    .preview-content {
        padding: 20px;
    }

    /* تنسيق الجدول في المعاينة */
    .preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .preview-table th, .preview-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: right;
    }

    .preview-table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    .preview-table tr:nth-child(even) td {
        background-color: #f9f9f9;
    }

    /* أنماط ألوان الجداول */
    .table-blue th {
        background-color: #2c3e50 !important;
        color: white !important;
        border-color: #34495e !important;
    }
    .table-blue tr:nth-child(even) td {
        background-color: #ecf0f1 !important;
    }

    .table-green th {
        background-color: #27ae60 !important;
        color: white !important;
        border-color: #2ecc71 !important;
    }
    .table-green tr:nth-child(even) td {
        background-color: #e8f5e9 !important;
    }

    .table-orange th {
        background-color: #e67e22 !important;
        color: white !important;
        border-color: #d35400 !important;
    }
    .table-orange tr:nth-child(even) td {
        background-color: #fff3e0 !important;
    }

    .table-red th {
        background-color: #c0392b !important;
        color: white !important;
        border-color: #e74c3c !important;
    }
    .table-red tr:nth-child(even) td {
        background-color: #ffebee !important;
    }

    .table-purple th {
        background-color: #8e44ad !important;
        color: white !important;
        border-color: #9b59b6 !important;
    }
    .table-purple tr:nth-child(even) td {
        background-color: #f3e5f5 !important;
    }

    .preview-title {
        text-align: center;
        margin-bottom: 20px;
        font-size: 18pt;
        font-weight: bold;
    }

    /* تحكم الطابعة */
    .printer-control {
        display: none; /* يظهر فقط عند تفعيل خيار البحث */
        margin-top: 10px;
    }

    /* تنسيق حقل النص قبل الجدول */
    .pre-table-text {
        display: none; /* يظهر فقط عند تفعيل الخيار */
        margin-top: 10px;
    }

    /* نمط لإظهار حدود الصفحة في المعاينة */
    .paper-border {
        border: 1px dashed #aaa;
    }

    /* للطباعة فقط - مخفي لأن الطباعة أصبحت تتم في نافذة منفصلة */
    @media print {
        /* حذف الكود السابق لأن الطباعة تتم الآن في نافذة منفصلة */
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-print ml-1"></i> {% trans "إعدادات طباعة التقرير" %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="print-settings-container">
                        <!-- لوحة الإعدادات -->
                        <div class="settings-panel">
                            <div class="settings-title">{% trans "إعدادات الطباعة" %}</div>

                            <!-- إعدادات الصفحة -->
                            <div class="settings-group">
                                <h3>{% trans "إعدادات الصفحة" %}</h3>

                                <div class="form-group">
                                    <label for="paperSize">{% trans "حجم الورق" %}</label>
                                    <select id="paperSize" class="form-control">
                                        <option value="a4" selected>A4</option>
                                        <option value="a5">A5</option>
                                        <option value="letter">Letter</option>
                                        <option value="legal">Legal</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>{% trans "الهوامش (مم)" %}</label>
                                    <div class="margins-group">
                                        <div class="margin-input">
                                            <label for="marginTop">{% trans "أعلى" %}</label>
                                            <input type="number" id="marginTop" class="form-control" value="20" min="0" max="100">
                                        </div>
                                        <div class="margin-input">
                                            <label for="marginRight">{% trans "يمين" %}</label>
                                            <input type="number" id="marginRight" class="form-control" value="20" min="0" max="100">
                                        </div>
                                        <div class="margin-input">
                                            <label for="marginBottom">{% trans "أسفل" %}</label>
                                            <input type="number" id="marginBottom" class="form-control" value="20" min="0" max="100">
                                        </div>
                                        <div class="margin-input">
                                            <label for="marginLeft">{% trans "يسار" %}</label>
                                            <input type="number" id="marginLeft" class="form-control" value="20" min="0" max="100">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="printerSearch">
                                        <label class="custom-control-label" for="printerSearch">{% trans "البحث عن الطابعات المتوفرة" %}</label>
                                    </div>

                                    <div id="printerControl" class="printer-control">
                                        <select id="printerSelect" class="form-control mt-2">
                                            <option value="" selected>{% trans "اختر الطابعة..." %}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- إعدادات العنوان -->
                            <div class="settings-group">
                                <h3>{% trans "إعدادات العنوان" %}</h3>

                                <div class="form-group">
                                    <label for="reportTitle">{% trans "عنوان التقرير" %}</label>
                                    <input type="text" id="reportTitle" class="form-control" value="{% trans "تقرير الحجوزات" %}">
                                </div>

                                <div class="form-group">
                                    <label for="titleFontSize">{% trans "حجم خط العنوان" %}</label>
                                    <select id="titleFontSize" class="form-control">
                                        <option value="16pt">{% trans "صغير" %} (16pt)</option>
                                        <option value="18pt" selected>{% trans "متوسط" %} (18pt)</option>
                                        <option value="22pt">{% trans "كبير" %} (22pt)</option>
                                        <option value="26pt">{% trans "كبير جداً" %} (26pt)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- إعدادات الجدول -->
                            <div class="settings-group">
                                <h3>{% trans "إعدادات الجدول" %}</h3>

                                <div class="form-group">
                                    <label for="tableRows">{% trans "عدد الصفوف" %}</label>
                                    <input type="number" id="tableRows" class="form-control" value="5" min="1" max="30">
                                </div>

                                <div class="form-group">
                                    <label for="tableWidth">{% trans "عرض الجدول (%)" %}</label>
                                    <input type="number" id="tableWidth" class="form-control" value="100" min="50" max="100">
                                </div>

                                <div class="form-group">
                                    <label for="tableFontSize">{% trans "حجم الخط داخل الجدول" %}</label>
                                    <select id="tableFontSize" class="form-control">
                                        <option value="8pt">{% trans "صغير جداً" %} (8pt)</option>
                                        <option value="10pt">{% trans "صغير" %} (10pt)</option>
                                        <option value="12pt" selected>{% trans "متوسط" %} (12pt)</option>
                                        <option value="14pt">{% trans "كبير" %} (14pt)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="tableColor">{% trans "لون الجدول" %}</label>
                                    <select id="tableColor" class="form-control">
                                        <option value="default" selected>{% trans "الافتراضي (أبيض/رمادي)" %}</option>
                                        <option value="blue">{% trans "أزرق" %}</option>
                                        <option value="green">{% trans "أخضر" %}</option>
                                        <option value="orange">{% trans "برتقالي" %}</option>
                                        <option value="red">{% trans "أحمر" %}</option>
                                        <option value="purple">{% trans "بنفسجي" %}</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>{% trans "اتجاه الجدول" %}</label>
                                    <div class="custom-control custom-radio">
                                        <input type="radio" id="orientationHorizontal" name="tableOrientation" class="custom-control-input" value="horizontal" checked>
                                        <label class="custom-control-label" for="orientationHorizontal">{% trans "أفقي (الصفوف والأعمدة كما هي)" %}</label>
                                    </div>
                                    <div class="custom-control custom-radio">
                                        <input type="radio" id="orientationVertical" name="tableOrientation" class="custom-control-input" value="vertical">
                                        <label class="custom-control-label" for="orientationVertical">{% trans "عمودي (تبديل الصفوف والأعمدة)" %}</label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="addTextBeforeTable">
                                        <label class="custom-control-label" for="addTextBeforeTable">{% trans "إدراج نص قبل الجدول" %}</label>
                                    </div>

                                    <div id="preTableTextControl" class="pre-table-text">
                                        <textarea id="preTableText" class="form-control" rows="3" placeholder="{% trans 'ادخل النص هنا...' %}"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- أزرار التحكم -->
                            <div class="action-buttons">
                                <button id="printButton" class="btn-print">
                                    <i class="fas fa-print ml-1"></i> {% trans "طباعة" %}
                                </button>
                                <div>
                                    <button id="resetButton" class="btn-cancel mx-2">
                                        <i class="fas fa-sync-alt ml-1"></i> {% trans "إعادة تعيين" %}
                                    </button>
                                    <a href="{% url 'admin_reports' %}" class="btn-cancel">
                                        <i class="fas fa-times ml-1"></i> {% trans "إلغاء" %}
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- لوحة معاينة التقرير -->
                        <div class="preview-panel">
                            <div id="previewPaper" class="preview-paper paper-a4 paper-border">
                                <div id="previewContent" class="preview-content">
                                    <div id="previewTitle" class="preview-title">{% trans "تقرير الحجوزات" %}</div>

                                    <div id="previewPreText" style="display: none; margin-bottom: 20px;"></div>

                                    <table id="previewTable" class="preview-table">
                                        <thead>
                                            <tr>
                                                <th>{% trans "رقم الحجز" %}</th>
                                                <th>{% trans "السيارة" %}</th>
                                                <th>{% trans "تاريخ الحجز" %}</th>
                                                <th>{% trans "تاريخ الاستلام" %}</th>
                                                <th>{% trans "تاريخ التسليم" %}</th>
                                                <th>{% trans "المبلغ" %}</th>
                                                <th>{% trans "حالة الحجز" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for reservation in reservations %}
                                            <tr>
                                                <td>{{ reservation.id }}</td>
                                                <td>{{ reservation.car.make }} {{ reservation.car.model }}</td>
                                                <td>{{ reservation.created_at|date:"Y-m-d" }}</td>
                                                <td>{{ reservation.start_date|date:"Y-m-d" }}</td>
                                                <td>{{ reservation.end_date|date:"Y-m-d" }}</td>
                                                <td>{{ reservation.total_price }} {% trans "ريال" %}</td>
                                                <td>
                                                    {% if reservation.status == 'confirmed' %}
                                                    <span>{% trans "مؤكد" %}</span>
                                                    {% elif reservation.status == 'pending' %}
                                                    <span>{% trans "قيد الانتظار" %}</span>
                                                    {% elif reservation.status == 'completed' %}
                                                    <span>{% trans "مكتمل" %}</span>
                                                    {% elif reservation.status == 'cancelled' %}
                                                    <span>{% trans "ملغي" %}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            <!-- الصفوف الإضافية ستضاف ديناميكياً بواسطة JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تسجيل رسالة تأكيد تحميل الصفحة للتحقق من تشغيل الكود
    console.log("تم تحميل صفحة إعدادات الطباعة");

    // ========================
    // متغيرات عناصر واجهة المستخدم
    // ========================
    const paperSizeSelect = document.getElementById('paperSize');
    const marginTop = document.getElementById('marginTop');
    const marginRight = document.getElementById('marginRight');
    const marginBottom = document.getElementById('marginBottom');
    const marginLeft = document.getElementById('marginLeft');
    const printerSearch = document.getElementById('printerSearch');
    const printerControl = document.getElementById('printerControl');
    const printerSelect = document.getElementById('printerSelect');
    const reportTitle = document.getElementById('reportTitle');
    const titleFontSize = document.getElementById('titleFontSize');
    const tableRows = document.getElementById('tableRows');
    const tableWidth = document.getElementById('tableWidth');
    const tableFontSize = document.getElementById('tableFontSize');
    const tableColor = document.getElementById('tableColor');
    const orientationHorizontal = document.getElementById('orientationHorizontal');
    const orientationVertical = document.getElementById('orientationVertical');
    const addTextBeforeTable = document.getElementById('addTextBeforeTable');
    const preTableTextControl = document.getElementById('preTableTextControl');
    const preTableText = document.getElementById('preTableText');
    const printButton = document.getElementById('printButton');
    const resetButton = document.getElementById('resetButton');

    // ========================
    // عناصر المعاينة
    // ========================
    const previewPaper = document.getElementById('previewPaper');
    const previewContent = document.getElementById('previewContent');
    const previewTitle = document.getElementById('previewTitle');
    const previewPreText = document.getElementById('previewPreText');
    const previewTable = document.getElementById('previewTable');
    
    // التحقق من وجود جميع العناصر المطلوبة
    if (!previewPaper || !previewContent || !previewTitle || !previewTable) {
        console.error("خطأ: لم يتم العثور على عناصر المعاينة");
    }

    // ========================
    // دوال التحديث
    // ========================

    // تحديث حجم الورق
    function updatePaperSize() {
        // إزالة جميع فئات الورق السابقة
        previewPaper.classList.remove('paper-a4', 'paper-a5', 'paper-letter', 'paper-legal');
        // إضافة فئة الورق المحدد
        previewPaper.classList.add('paper-' + paperSizeSelect.value);
        console.log("تم تحديث حجم الورق إلى: " + paperSizeSelect.value);
    }

    // تحديث الهوامش
    function updateMargins() {
        const topVal = marginTop.value;
        const rightVal = marginRight.value;
        const bottomVal = marginBottom.value;
        const leftVal = marginLeft.value;
        previewContent.style.padding = `${topVal}mm ${rightVal}mm ${bottomVal}mm ${leftVal}mm`;
        console.log(`تم تحديث الهوامش: أعلى=${topVal}mm، يمين=${rightVal}mm، أسفل=${bottomVal}mm، يسار=${leftVal}mm`);
    }

    // تحديث عنوان التقرير
    function updateTitle() {
        previewTitle.textContent = reportTitle.value;
        previewTitle.style.fontSize = titleFontSize.value;
        console.log("تم تحديث العنوان إلى: " + reportTitle.value + " بحجم خط: " + titleFontSize.value);
    }

    // تحديث عرض الجدول
    function updateTableWidth() {
        previewTable.style.width = tableWidth.value + '%';
        console.log("تم تحديث عرض الجدول إلى: " + tableWidth.value + "%");
    }

    // تحديث أحجام الخطوط
    function updateFontSizes() {
        previewTable.style.fontSize = tableFontSize.value;
        console.log("تم تحديث حجم خط الجدول إلى: " + tableFontSize.value);
    }

    // تحديث لون الجدول
    function updateTableColor() {
        // إزالة كل الألوان القديمة
        previewTable.classList.remove('table-blue', 'table-green', 'table-orange', 'table-red', 'table-purple');

        // تطبيق اللون الجديد
        if (tableColor.value !== 'default') {
            previewTable.classList.add('table-' + tableColor.value);
            console.log("تم تطبيق لون الجدول: " + tableColor.value);

            // تطبيق أنماط CSS حسب اللون المختار
            const headerCells = previewTable.querySelectorAll('th');
            const dataCells = previewTable.querySelectorAll('td');
            const evenRows = previewTable.querySelectorAll('tr:nth-child(even)');

            // إعادة تعيين الأنماط
            headerCells.forEach(cell => {
                cell.style.backgroundColor = '';
                cell.style.color = '';
                cell.style.borderColor = '';
            });

            dataCells.forEach(cell => {
                cell.style.backgroundColor = '';
                cell.style.color = '';
                cell.style.borderColor = '';
            });

            // تطبيق الأنماط الجديدة حسب اللون المختار
            switch(tableColor.value) {
                case 'blue':
                    applyTableColorStyles('#2c3e50', 'white', '#34495e', '#ecf0f1');
                    break;
                case 'green':
                    applyTableColorStyles('#27ae60', 'white', '#2ecc71', '#e8f5e9');
                    break;
                case 'orange':
                    applyTableColorStyles('#e67e22', 'white', '#d35400', '#fff3e0');
                    break;
                case 'red':
                    applyTableColorStyles('#c0392b', 'white', '#e74c3c', '#ffebee');
                    break;
                case 'purple':
                    applyTableColorStyles('#8e44ad', 'white', '#9b59b6', '#f3e5f5');
                    break;
            }
        } else {
            // إعادة تعيين لألوان الافتراضية
            applyTableColorStyles('#f2f2f2', 'black', '#ddd', '#f9f9f9');
            console.log("تم إعادة تعيين لون الجدول إلى الافتراضي");
        }
    }

    // وظيفة مساعدة لتطبيق تنسيقات الألوان على الجدول
    function applyTableColorStyles(headerBg, headerColor, borderColor, evenRowBg) {
        const headerCells = previewTable.querySelectorAll('th');
        headerCells.forEach(cell => {
            cell.style.backgroundColor = headerBg;
            cell.style.color = headerColor;
            cell.style.borderColor = borderColor;
        });

        // تطبيق لون الصفوف المتناوبة
        previewTable.querySelectorAll('tr:nth-child(even) td').forEach(cell => {
            cell.style.backgroundColor = evenRowBg;
        });
    }

    // تخزين نسخة من بنية الجدول الأفقي الأصلية
    let originalTableHTML = '';

    // تحديث اتجاه الجدول (أفقي / عمودي)
    function updateTableOrientation() {
        if (orientationVertical.checked) {
            // تحويل الجدول إلى الاتجاه العمودي (تبديل الصفوف والأعمدة)
            transposeTable();
            console.log("تم تغيير اتجاه الجدول إلى عمودي");
        } else {
            // إعادة الجدول إلى الاتجاه الأفقي (الافتراضي)
            restoreHorizontalTable();
            console.log("تم تغيير اتجاه الجدول إلى أفقي");
        }
    }

    // تحويل الجدول من أفقي إلى عمودي (تبديل الصفوف والأعمدة)
    function transposeTable() {
        // حفظ نسخة من الجدول الأصلي إذا لم يتم ذلك بعد
        if (originalTableHTML === '') {
            originalTableHTML = previewTable.innerHTML;
        }

        // استخراج البيانات من الجدول الحالي
        const rows = Array.from(previewTable.querySelectorAll('tr'));
        const columnCount = rows[0].querySelectorAll('th, td').length;
        const rowCount = rows.length;

        // مصفوفة لتخزين البيانات
        const data = [];

        // استخراج البيانات من الجدول
        rows.forEach((row, rowIndex) => {
            const cells = Array.from(row.querySelectorAll('th, td'));
            cells.forEach((cell, colIndex) => {
                if (!data[colIndex]) {
                    data[colIndex] = [];
                }
                data[colIndex][rowIndex] = {
                    content: cell.innerHTML,
                    isHeader: cell.tagName.toLowerCase() === 'th'
                };
            });
        });

        // إنشاء الجدول العمودي
        let newTable = '<thead><tr>';

        // إضافة صف الرأس (العناوين تصبح في العمود الأول)
        data.forEach((row, rowIndex) => {
            if (rowIndex === 0) {
                newTable += `<th>${row[0].content}</th>`;
            } else {
                newTable += `<th>${row[0].content}</th>`;
            }
        });

        newTable += '</tr></thead><tbody>';

        // إضافة باقي البيانات
        for (let colIndex = 1; colIndex < rowCount; colIndex++) {
            newTable += '<tr>';

            for (let rowIndex = 0; rowIndex < columnCount; rowIndex++) {
                if (data[rowIndex] && data[rowIndex][colIndex]) {
                    newTable += `<td>${data[rowIndex][colIndex].content}</td>`;
                } else {
                    newTable += '<td></td>';
                }
            }

            newTable += '</tr>';
        }

        newTable += '</tbody>';

        // تطبيق الجدول العمودي
        previewTable.innerHTML = newTable;

        // إعادة تطبيق لون الجدول بعد التحويل
        updateTableColor();
    }

    // إعادة الجدول إلى الاتجاه الأفقي
    function restoreHorizontalTable() {
        if (originalTableHTML !== '') {
            previewTable.innerHTML = originalTableHTML;

            // إعادة تطبيق لون الجدول بعد العودة للوضع الأفقي
            updateTableColor();
        }
    }

    // إضافة صفوف إضافية للجدول
    function addExtraRows() {
        try {
            const tbody = previewTable.querySelector('tbody');
            if (!tbody) {
                console.error("لا يمكن العثور على جسم الجدول (tbody)");
                return;
            }
            
            const currentRows = tbody.querySelectorAll('tr:not(.extra-row)').length;
            const targetRows = parseInt(tableRows.value);

            // حذف الصفوف الإضافية الموجودة
            tbody.querySelectorAll('tr.extra-row').forEach(row => {
                row.remove();
            });

            // إضافة صفوف جديدة إذا كان العدد المطلوب أكبر
            if (targetRows > currentRows) {
                const columnsCount = previewTable.querySelector('thead tr').cells.length;

                for (let i = 0; i < targetRows - currentRows; i++) {
                    const newRow = document.createElement('tr');
                    newRow.className = 'extra-row';

                    for (let j = 0; j < columnsCount; j++) {
                        const cell = document.createElement('td');

                        if (j === 0) {
                            cell.textContent = `#${currentRows + i + 1}`;
                        } else if (j === 1) {
                            cell.textContent = 'سيارة نموذجية';
                        } else if (j === columnsCount - 1) {
                            cell.textContent = 'قيد الانتظار';
                        } else {
                            cell.textContent = '2025-05-15';
                        }

                        newRow.appendChild(cell);
                    }

                    tbody.appendChild(newRow);
                }
                console.log(`تم إضافة ${targetRows - currentRows} صفوف جديدة للجدول`);
            } else {
                console.log(`لم تتم إضافة صفوف جديدة، العدد المطلوب (${targetRows}) أقل من أو يساوي العدد الحالي (${currentRows})`);
            }

            // إعادة تطبيق اللون بعد إضافة صفوف
            updateTableColor();
        } catch (error) {
            console.error("خطأ أثناء إضافة صفوف إضافية:", error);
        }
    }

    // تحديث النص قبل الجدول
    function updatePreTableText() {
        previewPreText.textContent = preTableText.value;
        previewPreText.style.display = addTextBeforeTable.checked ? 'block' : 'none';
        console.log("تم تحديث النص قبل الجدول: " + (addTextBeforeTable.checked ? "ظاهر" : "مخفي"));
    }

    // دالة تهيئة المعاينة الأولية
    function initializePreview() {
        console.log("بدء تهيئة المعاينة الأولية...");
        
        try {
            // 1. تهيئة قيم العناصر حسب القيم الافتراضية في النموذج
            updatePaperSize();
            updateMargins();
            updateTitle();
            updateTableWidth();
            updateFontSizes();
            updateTableColor();
            updateTableOrientation();
            addExtraRows();
            updatePreTableText();
            
            // 2. تطبيق الأنماط الإضافية
            previewTable.classList.add('preview-initialized');
            
            console.log("تمت تهيئة المعاينة الأولية بنجاح");
        } catch (error) {
            console.error("خطأ أثناء تهيئة المعاينة:", error);
        }
    }

    // ========================
    // مستمعي الأحداث
    // ========================
    
    // تغيير حجم الورق
    paperSizeSelect.addEventListener('change', updatePaperSize);

    // تغيير الهوامش
    [marginTop, marginRight, marginBottom, marginLeft].forEach(input => {
        input.addEventListener('input', updateMargins);
    });

    // تغيير عنوان التقرير
    reportTitle.addEventListener('input', updateTitle);
    titleFontSize.addEventListener('change', updateTitle);

    // تغيير إعدادات الجدول
    tableRows.addEventListener('input', addExtraRows);
    tableWidth.addEventListener('input', updateTableWidth);
    tableFontSize.addEventListener('change', updateFontSizes);
    tableColor.addEventListener('change', updateTableColor);
    
    // تغيير اتجاه الجدول
    [orientationHorizontal, orientationVertical].forEach(radio => {
        radio.addEventListener('change', updateTableOrientation);
    });

    // تغيير إظهار/إخفاء الطابعات
    printerSearch.addEventListener('change', function() {
        printerControl.style.display = this.checked ? 'block' : 'none';
        console.log("البحث عن الطابعات: " + (this.checked ? "مفعل" : "معطل"));
        
        // عند التفعيل، محاولة البحث عن الطابعات المتوفرة
        if (this.checked && 'Printer' in window) {
            try {
                Printer.getPrinterList().then(printers => {
                    printerSelect.innerHTML = '<option value="" selected>اختر الطابعة...</option>';
                    printers.forEach(printer => {
                        const option = document.createElement('option');
                        option.value = printer.name;
                        option.textContent = printer.name;
                        printerSelect.appendChild(option);
                    });
                }).catch(error => {
                    console.error("خطأ في استرجاع قائمة الطابعات:", error);
                });
            } catch (error) {
                console.error("الوصول للطابعات غير متاح:", error);
            }
        }
    });

    // تغيير إظهار/إخفاء النص قبل الجدول
    addTextBeforeTable.addEventListener('change', function() {
        preTableTextControl.style.display = this.checked ? 'block' : 'none';
        updatePreTableText();
    });

    // تغيير محتوى النص قبل الجدول
    preTableText.addEventListener('input', updatePreTableText);

    // إعادة تعيين الإعدادات
    resetButton.addEventListener('click', function() {
        console.log("تم النقر على زر إعادة الضبط");
        
        // إعادة تعيين جميع عناصر التحكم إلى قيمها الافتراضية
        paperSizeSelect.value = 'a4';
        marginTop.value = 20;
        marginRight.value = 20;
        marginBottom.value = 20;
        marginLeft.value = 20;
        reportTitle.value = 'تقرير الحجوزات';
        titleFontSize.value = '18pt';
        tableRows.value = 5;
        tableWidth.value = 100;
        tableFontSize.value = '12pt';
        tableColor.value = 'default';
        orientationHorizontal.checked = true;
        printerSearch.checked = false;
        printerControl.style.display = 'none';
        addTextBeforeTable.checked = false;
        preTableTextControl.style.display = 'none';
        preTableText.value = '';
        
        // إعادة تهيئة المعاينة
        setTimeout(initializePreview, 50);
    });

    // الطباعة
    printButton.addEventListener('click', function() {
        console.log("تم النقر على زر الطباعة");
        
        // جمع البيانات من الجدول
        const tableHeaders = Array.from(previewTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
        const tableRows = Array.from(previewTable.querySelectorAll('tbody tr')).map(row => {
            return Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
        });
        
        // تحديد محتوى النص قبل الجدول
        const preText = addTextBeforeTable.checked ? preTableText.value : '';
        
        // تعيين ألوان الجدول استناداً إلى الاختيار
        let headerBgColor = '#f2f2f2';
        let headerTextColor = 'black';
        let headerBorderColor = '#ddd';
        let evenRowBgColor = '#f9f9f9';
        
        switch(tableColor.value) {
            case 'blue':
                headerBgColor = '#2c3e50';
                headerTextColor = 'white';
                headerBorderColor = '#34495e';
                evenRowBgColor = '#ecf0f1';
                break;
            case 'green':
                headerBgColor = '#27ae60';
                headerTextColor = 'white';
                headerBorderColor = '#2ecc71';
                evenRowBgColor = '#e8f5e9';
                break;
            case 'orange':
                headerBgColor = '#e67e22';
                headerTextColor = 'white';
                headerBorderColor = '#d35400';
                evenRowBgColor = '#fff3e0';
                break;
            case 'red':
                headerBgColor = '#c0392b';
                headerTextColor = 'white';
                headerBorderColor = '#e74c3c';
                evenRowBgColor = '#ffebee';
                break;
            case 'purple':
                headerBgColor = '#8e44ad';
                headerTextColor = 'white';
                headerBorderColor = '#9b59b6';
                evenRowBgColor = '#f3e5f5';
                break;
        }
        
        // إنشاء نافذة الطباعة
        const printWindow = window.open('', '_blank', 'height=600,width=800,scrollbars=yes');
        
        if (!printWindow) {
            alert('يرجى السماح بفتح النوافذ المنبثقة للطباعة.');
            return;
        }
        
        // بناء محتوى HTML للطباعة
        let tableHTML;
        
        if (orientationVertical.checked) {
            // بناء جدول بالاتجاه العمودي
            tableHTML = `<table class="print-table" style="width:${tableWidth.value}%; border-collapse:collapse; font-size:${tableFontSize.value};">`;
            
            // صفوف الجدول العمودي
            for (let i = 0; i < tableHeaders.length; i++) {
                tableHTML += '<tr>';
                tableHTML += `<th style="background-color:${headerBgColor}; color:${headerTextColor}; border:1px solid ${headerBorderColor}; padding:8px; text-align:right; font-weight:bold;">${tableHeaders[i]}</th>`;
                
                for (let j = 0; j < tableRows.length; j++) {
                    const cellStyle = j % 2 === 1 
                        ? `background-color:${evenRowBgColor};` 
                        : '';
                    
                    if (tableRows[j] && tableRows[j][i] !== undefined) {
                        tableHTML += `<td style="border:1px solid #ddd; padding:8px; text-align:right; ${cellStyle}">${tableRows[j][i]}</td>`;
                    } else {
                        tableHTML += `<td style="border:1px solid #ddd; padding:8px; text-align:right; ${cellStyle}"></td>`;
                    }
                }
                
                tableHTML += '</tr>';
            }
            
            tableHTML += '</table>';
        } else {
            // بناء جدول بالاتجاه الأفقي
            tableHTML = `
                <table class="print-table" style="width:${tableWidth.value}%; border-collapse:collapse; font-size:${tableFontSize.value};">
                    <thead>
                        <tr>
                            ${tableHeaders.map(header => 
                                `<th style="background-color:${headerBgColor}; color:${headerTextColor}; border:1px solid ${headerBorderColor}; padding:8px; text-align:right; font-weight:bold;">${header}</th>`
                            ).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows.map((row, rowIndex) => 
                            `<tr style="${rowIndex % 2 === 1 ? 'background-color:' + evenRowBgColor + ';' : ''}">
                                ${row.map(cell => 
                                    `<td style="border:1px solid #ddd; padding:8px; text-align:right;">${cell}</td>`
                                ).join('')}
                            </tr>`
                        ).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // كتابة المحتوى إلى نافذة الطباعة
        printWindow.document.write(`
            <!DOCTYPE html>
            <html dir="rtl">
            <head>
                <meta charset="UTF-8">
                <title>${reportTitle.value}</title>
                <style>
                    @page {
                        size: ${paperSizeSelect.value};
                        margin: ${marginTop.value}mm ${marginRight.value}mm ${marginBottom.value}mm ${marginLeft.value}mm;
                    }
                    @media print {
                        body {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        .no-print {
                            display: none !important;
                        }
                    }
                    body {
                        font-family: 'Tajawal', 'Cairo', Arial, sans-serif;
                        margin: 0;
                        padding: 0;
                        background-color: white;
                        color: black;
                    }
                    .print-container {
                        width: 100%;
                        padding: 0;
                    }
                    .report-title {
                        text-align: center;
                        font-size: ${titleFontSize.value};
                        font-weight: bold;
                        margin-bottom: 20px;
                        padding: 0;
                    }
                    .pre-table-text {
                        margin-bottom: 15px;
                        font-size: 12pt;
                    }
                    .print-button {
                        margin: 20px auto;
                        padding: 10px 20px;
                        background-color: #ffc107;
                        color: black;
                        border: none;
                        border-radius: 5px;
                        font-weight: bold;
                        cursor: pointer;
                        display: block;
                    }
                </style>
            </head>
            <body>
                <div class="print-container">
                    <h2 class="report-title">${reportTitle.value}</h2>
                    
                    ${preText ? `<div class="pre-table-text">${preText}</div>` : ''}
                    
                    ${tableHTML}
                    
                    <button class="print-button no-print" onclick="window.print(); return false;">طباعة التقرير</button>
                </div>

                <script>
                    // طباعة تلقائية بمجرد تحميل الصفحة
                    window.onload = function() {
                        // إضافة تأخير قصير لضمان تحميل التنسيقات
                        setTimeout(function() {
                            window.print();
                        }, 500);
                    };
                </script>
            </body>
            </html>
        `);
        
        printWindow.document.close();
    });

    // تهيئة المعاينة عند تحميل الصفحة
    setTimeout(initializePreview, 300);
});
</script>
{% endblock %}
