{% extends "layout_django.html" %}
{% load static %}

{% block title %}Payment Details | Admin Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-3">Payment Details</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'admin_index' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'admin_payments' %}">Payments</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Payment {{ payment.id }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{% url 'print_receipt' payment_id=payment.id %}" class="btn btn-outline-primary" target="_blank">
                    <i class="fa fa-print"></i> Print Receipt
                </a>
                <a href="{% url 'download_receipt' payment_id=payment.id %}" class="btn btn-outline-primary">
                    <i class="fa fa-download"></i> Download PDF
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Payment Information Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Payment Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Payment ID:</strong> {{ payment.id }}</p>
                            <p><strong>Date:</strong> {{ payment.date|date:"F j, Y, g:i a" }}</p>
                            <p><strong>Amount:</strong> ${{ payment.amount }}</p>
                            <p>
                                <strong>Status:</strong>
                                {% if payment.status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                                {% elif payment.status == 'pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                                {% elif payment.status == 'refunded' %}
                                <span class="badge bg-info">Refunded</span>
                                {% else %}
                                <span class="badge bg-danger">Failed</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p>
                                <strong>Payment Method:</strong>
                                {% if payment.payment_method == 'visa' %}
                                <span><i class="fab fa-cc-visa"></i> Visa</span>
                                {% elif payment.payment_method == 'mastercard' %}
                                <span><i class="fab fa-cc-mastercard"></i> MasterCard</span>
                                {% elif payment.payment_method == 'amex' %}
                                <span><i class="fab fa-cc-amex"></i> American Express</span>
                                {% elif payment.payment_method == 'discover' %}
                                <span><i class="fab fa-cc-discover"></i> Discover</span>
                                {% else %}
                                <span><i class="fa fa-credit-card"></i> Credit Card</span>
                                {% endif %}
                                •••• {{ payment.card_last4 }}
                            </p>
                            <p><strong>Card Holder:</strong> {{ payment.card_holder_name }}</p>
                            <p><strong>Expiry:</strong> {{ payment.card_expiry_month }}/{{ payment.card_expiry_year }}</p>
                            <p><strong>Reservation ID:</strong> #{{ payment.reservation.id }}</p>
                        </div>
                    </div>

                    <!-- Refund details if applicable -->
                    {% if payment.status == 'refunded' %}
                    <div class="alert alert-info mt-3">
                        <h5><i class="fa fa-info-circle"></i> Refund Information</h5>
                        <p><strong>Refund Date:</strong> {{ payment.refund_date|date:"F j, Y, g:i a" }}</p>
                        <p><strong>Refund Amount:</strong> ${{ payment.refund_amount }}</p>
                        <p><strong>Transaction ID:</strong> {{ payment.refund_transaction_id }}</p>
                        <p><strong>Reason:</strong> {{ payment.refund_reason }}</p>
                    </div>
                    {% endif %}

                    <!-- Error details if applicable -->
                    {% if payment.status == 'failed' %}
                    <div class="alert alert-danger mt-3">
                        <h5><i class="fa fa-exclamation-triangle"></i> Payment Error</h5>
                        <p><strong>Error Date:</strong> {{ payment.error_date|date:"F j, Y, g:i a" }}</p>
                        <p><strong>Error Code:</strong> {{ payment.error_code }}</p>
                        <p><strong>Error Message:</strong> {{ payment.error_message }}</p>
                    </div>
                    {% endif %}

                    {% if payment.status == 'pending' %}
                    <div class="d-flex mt-3">
                        <form action="{% url 'mark_as_paid' payment_id=payment.id %}" method="post" class="me-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">
                                <i class="fa fa-check"></i> Mark as Paid
                            </button>
                        </form>
                        <form action="{% url 'cancel_payment' payment_id=payment.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                <i class="fa fa-times"></i> Cancel Payment
                            </button>
                        </form>
                    </div>
                    {% elif payment.status == 'paid' %}
                    <div class="mt-3">
                        <form action="{% url 'process_refund' payment_id=payment.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning">
                                <i class="fa fa-undo"></i> Process Refund
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Reservation Details Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Reservation Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Start Date:</strong> {{ payment.reservation.start_date|date:"F j, Y" }}</p>
                            <p><strong>End Date:</strong> {{ payment.reservation.end_date|date:"F j, Y" }}</p>
                            <p><strong>Duration:</strong> {{ payment.reservation.days }} days</p>
                            <p>
                                <strong>Status:</strong>
                                {% if payment.reservation.status == 'pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                                {% elif payment.reservation.status == 'confirmed' %}
                                <span class="badge bg-success">Confirmed</span>
                                {% elif payment.reservation.status == 'completed' %}
                                <span class="badge bg-primary">Completed</span>
                                {% elif payment.reservation.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Daily Rate:</strong> ${{ payment.reservation.car.daily_rate }}</p>
                            <p><strong>Subtotal:</strong> ${{ payment.reservation.subtotal }}</p>
                            <p><strong>Tax Rate:</strong> {{ payment.reservation.tax_rate }}%</p>
                            <p><strong>Tax Amount:</strong> ${{ payment.reservation.tax_amount }}</p>
                            <p><strong>Total:</strong> ${{ payment.amount }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Customer Information Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">Customer Information</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar-circle me-3">
                            {{ payment.user.first_name|slice:":1" }}{{ payment.user.last_name|slice:":1" }}
                        </div>
                        <div>
                            <h5 class="mb-0">{{ payment.user.first_name }} {{ payment.user.last_name }}</h5>
                            <p class="text-muted mb-0">{{ payment.user.email }}</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p><strong>Phone:</strong> {{ payment.user.phone }}</p>
                        <p><strong>Username:</strong> {{ payment.user.username }}</p>
                        <p><strong>Account Since:</strong> {{ payment.user.created_at|date:"F j, Y" }}</p>
                        <p><strong>Total Reservations:</strong> {{ payment.user.total_reservations }}</p>
                    </div>
                    <a href="#" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="fa fa-user"></i> View Customer Profile
                    </a>
                </div>
            </div>

            <!-- Vehicle Information Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">Vehicle Information</h5>
                </div>
                <div class="card-body">
                    {% if payment.car.image_url %}
                    <img src="{{ payment.car.image_url }}" class="img-fluid rounded mb-3" alt="{{ payment.car.make }} {{ payment.car.model }}">
                    {% else %}
                    <div class="bg-light p-3 text-center rounded mb-3">
                        <i class="fa fa-car fa-3x text-muted"></i>
                    </div>
                    {% endif %}
                    <h5>{{ payment.car.year }} {{ payment.car.make }} {{ payment.car.model }}</h5>
                    <p class="text-muted">{{ payment.car.color }} | {{ payment.car.license_plate }}</p>
                    <div class="row mt-3">
                        <div class="col-6">
                            <p><strong>Category:</strong> {{ payment.car.category }}</p>
                        </div>
                        <div class="col-6">
                            <p><strong>Seats:</strong> {{ payment.car.seats }}</p>
                        </div>
                        <div class="col-6">
                            <p><strong>Transmission:</strong> {{ payment.car.transmission }}</p>
                        </div>
                        <div class="col-6">
                            <p><strong>Fuel:</strong> {{ payment.car.fuel_type }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 50px;
    height: 50px;
    background-color: #6c757d;
    color: white;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: bold;
}
</style>
{% endblock %}