
{% extends 'layout_django.html' %}
{% load i18n %}
{% load static %}

{% block title %}التفاصيل الكاملة للحجز #{{ reservation.reservation_number }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0 fs-4">التفاصيل الكاملة للحجز #{{ reservation.reservation_number }}</h3>
                        <div>
                            {% if reservation.status == 'pending' %}
                            <span class="badge bg-warning">قيد المراجعة</span>
                            {% elif reservation.status == 'confirmed' %}
                            <span class="badge bg-success">تمت الموافقة</span>
                            {% elif reservation.status == 'completed' %}
                            <span class="badge bg-info">مكتمل</span>
                            {% elif reservation.status == 'cancelled' %}
                            <span class="badge bg-danger">ملغي</span>
                            {% endif %}

                            {% if reservation.payment_status == 'pending' %}
                            <span class="badge bg-secondary">في انتظار الدفع</span>
                            {% elif reservation.payment_status == 'paid' %}
                            <span class="badge bg-success">مدفوع</span>
                            {% elif reservation.payment_status == 'refunded' %}
                            <span class="badge bg-danger">مسترجع</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- بطاقة معلومات رئيسية -->
                    <div class="row border-bottom pb-4 mb-4">
                        <div class="col-md-3 text-center">
                            <div class="reservation-id-box border bg-light p-3 rounded mb-3">
                                <h5 class="text-muted mb-1">رقم الحجز</h5>
                                <div class="fs-4 fw-bold">{{ reservation.reservation_number }}</div>
                            </div>
                            <div class="reservation-date-box border bg-light p-3 rounded">
                                <h5 class="text-muted mb-1">تاريخ الحجز</h5>
                                <div class="fs-5 fw-bold">{{ reservation.created_at|date:"Y/m/d" }}</div>
                                <div class="small text-muted">{{ reservation.created_at|date:"H:i" }}</div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="row mb-3">
                                <div class="col-sm-4">
                                    <div class="data-field border-start ps-3 h-100">
                                        <h5 class="text-muted mb-1">الحالة</h5>
                                        <div class="fw-bold">
                                            {% if reservation.status == 'pending' %}
                                                <span class="text-warning">قيد المراجعة</span>
                                            {% elif reservation.status == 'confirmed' %}
                                                <span class="text-success">تمت الموافقة</span>
                                            {% elif reservation.status == 'completed' %}
                                                <span class="text-info">مكتمل</span>
                                            {% elif reservation.status == 'cancelled' %}
                                                <span class="text-danger">ملغي</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="data-field border-start ps-3 h-100">
                                        <h5 class="text-muted mb-1">حالة الدفع</h5>
                                        <div class="fw-bold">
                                            {% if reservation.payment_status == 'pending' %}
                                                <span class="text-warning">في انتظار الدفع</span>
                                            {% elif reservation.payment_status == 'paid' %}
                                                <span class="text-success">تم الدفع</span>
                                            {% elif reservation.payment_status == 'refunded' %}
                                                <span class="text-danger">تم استرداد المبلغ</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="data-field ps-3 h-100">
                                        <h5 class="text-muted mb-1">المبلغ الإجمالي</h5>
                                        <div class="fw-bold fs-4 text-primary">{{ reservation.total_price }} دينار</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="data-field border-start ps-3 h-100">
                                        <h5 class="text-muted mb-1">تاريخ الاستلام</h5>
                                        <div class="fw-bold">{{ reservation.start_date|date:"Y/m/d" }}</div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="data-field border-start ps-3 h-100">
                                        <h5 class="text-muted mb-1">تاريخ التسليم</h5>
                                        <div class="fw-bold">{{ reservation.end_date|date:"Y/m/d" }}</div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="data-field ps-3 h-100">
                                        <h5 class="text-muted mb-1">مدة الإيجار</h5>
                                        <div class="fw-bold">{{ reservation.days }} يوم</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- معلومات السيارة -->
                    <div class="section mb-4">
                        <div class="section-header mb-3">
                            <h4 class="section-title">معلومات السيارة</h4>
                        </div>
                        <div class="section-content border p-3 rounded">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    {% if reservation.car.image %}
                                    <img src="{{ reservation.car.image.url }}" alt="{{ reservation.car.make }}" class="img-fluid rounded shadow-sm">
                                    {% else %}
                                    <img src="{% static 'images/car-placeholder.svg' %}" alt="{{ reservation.car.make }}" class="img-fluid rounded shadow-sm">
                                    {% endif %}
                                </div>
                                <div class="col-md-9">
                                    <h4 class="mb-3">{{ reservation.car.make }} {{ reservation.car.model }} {{ reservation.car.year }}</h4>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <span class="d-block mb-2">
                                                <i class="fas fa-car text-primary ms-1"></i>
                                                <span class="fw-bold">الفئة:</span> {{ reservation.car.get_category_display }}
                                            </span>
                                            <span class="d-block mb-2">
                                                <i class="fas fa-cog text-primary ms-1"></i>
                                                <span class="fw-bold">ناقل الحركة:</span> {{ reservation.car.get_transmission_display }}
                                            </span>
                                        </div>
                                        <div class="col-md-4">
                                            <span class="d-block mb-2">
                                                <i class="fas fa-gas-pump text-primary ms-1"></i>
                                                <span class="fw-bold">نوع الوقود:</span> {{ reservation.car.get_fuel_type_display }}
                                            </span>
                                            <span class="d-block mb-2">
                                                <i class="fas fa-palette text-primary ms-1"></i>
                                                <span class="fw-bold">اللون:</span> {{ reservation.car.color }}
                                            </span>
                                        </div>
                                        <div class="col-md-4">
                                            <span class="d-block mb-2">
                                                <i class="fas fa-users text-primary ms-1"></i>
                                                <span class="fw-bold">عدد المقاعد:</span> {{ reservation.car.seats }}
                                            </span>
                                            <span class="d-block mb-2">
                                                <i class="fas fa-id-card text-primary ms-1"></i>
                                                <span class="fw-bold">رقم اللوحة:</span> {{ reservation.car.license_plate }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- معلومات العميل -->
                        <div class="col-md-6">
                            <div class="section mb-4">
                                <div class="section-header mb-3">
                                    <h4 class="section-title">معلومات العميل</h4>
                                </div>
                                <div class="section-content border p-3 rounded">
                                    <table class="table table-striped table-bordered mb-0">
                                        <tbody>
                                            <tr>
                                                <th class="bg-light" width="35%">الاسم الكامل</th>
                                                <td>{{ reservation.full_name }}</td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light">رقم الهوية</th>
                                                <td>{{ reservation.national_id }}</td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light">البريد الإلكتروني</th>
                                                <td>{{ reservation.user.email }}</td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light">رقم الهاتف</th>
                                                <td>{{ reservation.user.phone|default:"غير متوفر" }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- معلومات إضافية -->
                            <div class="section mb-4">
                                <div class="section-header mb-3">
                                    <h4 class="section-title">معلومات إضافية</h4>
                                </div>
                                <div class="section-content border p-3 rounded">
                                    <table class="table table-striped table-bordered mb-0">
                                        <tbody>
                                            <tr>
                                                <th class="bg-light" width="35%">نوع الإيجار</th>
                                                <td>{{ reservation.get_rental_type_display }}</td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light">نوع الضمان</th>
                                                <td>{{ reservation.get_guarantee_type_display }}</td>
                                            </tr>
                                            {% if reservation.deposit_amount %}
                                            <tr>
                                                <th class="bg-light">مبلغ التأمين</th>
                                                <td>{{ reservation.deposit_amount }} دينار</td>
                                            </tr>
                                            {% endif %}
                                            {% if reservation.guarantee_details %}
                                            <tr>
                                                <th class="bg-light">تفاصيل الضمان</th>
                                                <td>{{ reservation.guarantee_details }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if reservation.notes %}
                                            <tr>
                                                <th class="bg-light">ملاحظات</th>
                                                <td>{{ reservation.notes }}</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- بطاقة صورة الهوية -->
                            {% if reservation.id_card_image %}
                            <div class="section mb-4">
                                <div class="section-header mb-3">
                                    <h4 class="section-title">صورة الهوية</h4>
                                </div>
                                <div class="section-content border p-3 rounded text-center">
                                    <img src="{{ reservation.id_card_image.url }}" alt="صورة الهوية" class="img-fluid rounded shadow-sm" style="max-height: 250px;">
                                </div>
                            </div>
                            {% endif %}

                            <!-- معلومات الدفع -->
                            <div class="section mb-4">
                                <div class="section-header mb-3">
                                    <h4 class="section-title">معلومات الدفع</h4>
                                </div>
                                <div class="section-content border p-3 rounded">
                                    <table class="table table-striped table-bordered mb-0">
                                        <tbody>
                                            <tr>
                                                <th class="bg-light" width="35%">طريقة الدفع</th>
                                                <td>{{ reservation.get_payment_method_display|default:"لم يتم تحديدها بعد" }}</td>
                                            </tr>
                                            <tr>
                                                <th class="bg-light">حالة الدفع</th>
                                                <td>
                                                    {% if reservation.payment_status == 'pending' %}
                                                        <span class="text-warning">في انتظار الدفع</span>
                                                    {% elif reservation.payment_status == 'paid' %}
                                                        <span class="text-success">تم الدفع</span>
                                                    {% elif reservation.payment_status == 'refunded' %}
                                                        <span class="text-danger">تم استرداد المبلغ</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if reservation.payment_reference %}
                                            <tr>
                                                <th class="bg-light">رقم المرجع</th>
                                                <td>{{ reservation.payment_reference }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if reservation.payment_date %}
                                            <tr>
                                                <th class="bg-light">تاريخ الدفع</th>
                                                <td>{{ reservation.payment_date|date:"Y/m/d H:i" }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if reservation.transaction_id %}
                                            <tr>
                                                <th class="bg-light">رقم المعاملة</th>
                                                <td>{{ reservation.transaction_id }}</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- أزرار الإجراءات -->
                    <div class="section mt-4 text-center">
                        <div class="border-top pt-4 d-flex justify-content-center gap-3">
                            {% if reservation.status == 'confirmed' and reservation.payment_status == 'pending' %}
                            <a href="{% url 'checkout' %}?reservation_id={{ reservation.id }}" class="btn btn-success px-4">
                                <i class="fas fa-credit-card ms-2"></i>
                                إتمام الدفع
                            </a>
                            {% endif %}

                            {% if reservation.status == 'pending' %}
                            <a href="{% url 'modify_reservation' reservation_id=reservation.id %}" class="btn btn-primary px-4">
                                <i class="fas fa-edit ms-2"></i>
                                تعديل الحجز
                            </a>
                            <a href="{% url 'cancel_reservation' reservation_id=reservation.id %}" class="btn btn-danger px-4">
                                <i class="fas fa-times ms-2"></i>
                                إلغاء الحجز
                            </a>
                            {% endif %}

                            <a href="{% url 'my_reservations' %}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-arrow-right ms-2"></i>
                                العودة للحجوزات
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* تنسيق قسم التفاصيل الرئيسية */
    .section-title {
        color: #3c4b64;
        font-size: 1.25rem;
        font-weight: 600;
        position: relative;
        padding-right: 1rem;
    }
    
    .section-title:before {
        content: "";
        position: absolute;
        right: 0;
        top: 50%;
        width: 5px;
        height: 20px;
        background-color: #0d6efd;
        transform: translateY(-50%);
        border-radius: 5px;
    }
    
    .section-header {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    
    .section-content {
        background-color: #fff;
    }
    
    /* تنسيق الجداول والخلايا */
    .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .table th {
        font-weight: 600;
        color: #495057;
    }
    
    /* تنسيق الحالات والمعلومات الرئيسية */
    .data-field {
        padding: 0.5rem 0;
    }
    
    .reservation-id-box, .reservation-date-box {
        border-radius: 8px;
    }
    
    /* تنسيق الأيقونات */
    .fas {
        width: 18px;
        text-align: center;
        color: #0d6efd;
    }
    
    /* تنسيق البطاقة الرئيسية */
    .card {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .card-header {
        border-radius: 0 !important;
    }

    /* تنسيق الأزرار */
    .btn {
        font-weight: 500;
        padding: 0.5rem 1.5rem;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}
