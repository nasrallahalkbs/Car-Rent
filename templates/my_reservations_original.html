{% extends 'layout_django.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "My Reservations" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/status_badges_fixed.css' %}">
<style>
    /* تحسين أسلوب صفحة الحجوزات */
    .page-header {
        background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
        padding: 3rem 0;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='rgba(255,255,255,.05)' fill-rule='evenodd'/%3E%3C/svg%3E");
        z-index: 1;
    }
    
    .page-header .container {
        position: relative;
        z-index: 2;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
        margin-bottom: 0;
    }
    
    /* تنسيق الجدول */
    .custom-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .custom-table thead th {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1.25rem 1rem;
        border-bottom: 2px solid rgba(0,0,0,0.05);
        white-space: nowrap;
    }
    
    .custom-table tbody tr {
        transition: all 0.25s ease;
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 8px;
        height: 90px; /* توحيد ارتفاع الصفوف */
        margin-bottom: 5px;
    }
    
    .custom-table tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .custom-table tbody tr:hover {
        background-color: rgba(37, 99, 235, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        z-index: 1;
        position: relative;
        border: 1px solid rgba(37, 99, 235, 0.2);
    }
    
    .custom-table td {
        padding: 1rem;
        vertical-align: middle;
        border-color: rgba(0,0,0,0.05);
    }
    
    /* ترويسة الحجز */
    .reservation-id {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1rem;
    }
    
    /* صورة السيارة */
    .car-img-wrapper {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        background-color: #f8f9fa;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    
    .car-thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* اسم السيارة */
    .car-name {
        font-size: 1rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.25rem;
    }
    
    /* أيقونة التاريخ */
    .date-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        color: var(--primary-color);
        flex-shrink: 0;
    }
    
    /* نطاق التاريخ */
    .date-range {
        font-size: 0.9rem;
        color: #495057;
    }
    
    /* مدة الحجز */
    .duration-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 30px;
        background-color: #f8f9fa;
        color: #495057;
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    
    /* السعر */
    .price-amount {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.1rem;
    }
    
    /* شارات الحالة */
    .status-badge,
    .payment-badge {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: auto !important;
        margin: 0 4px !important;
        padding: 8px 16px !important;
        border-radius: 30px !important;
        font-size: 13px !important;
        font-weight: 600 !important;
        white-space: nowrap !important;
        text-align: center !important;
        min-width: 120px !important;
        max-width: 180px !important;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1) !important;
        position: relative !important;
        z-index: 1 !important;
        border: none !important;
        transform: scale(1) !important;
    }
    
    /* حاوية الشارات */
    .badges-container {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: wrap !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 8px !important;
        width: 100% !important;
    }
    
    .status-pending {
        background-color: #ffc107;
        color: #000;
        border: none;
    }
    
    .status-confirmed {
        background-color: #28a745;
        color: white;
        border: none;
    }
    
    .status-completed {
        background-color: #17a2b8;
        color: white;
        border: none;
    }
    
    .status-cancelled {
        background-color: #dc3545;
        color: white;
        border: none;
    }
    
    .payment-pending {
        background-color: #6c757d;
        color: white;
        border: none;
    }
    
    .payment-paid {
        background-color: #28a745;
        color: white;
        border: none;
    }
    
    .payment-refunded {
        background-color: #dc3545;
        color: white;
        border: none;
    }
    
    /* أزرار العمليات */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
    
    .btn-action {
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn-view {
        background-color: #f8f9fa;
        color: var(--primary-color);
        border: 1px solid rgba(var(--primary-rgb), 0.2);
    }
    
    .btn-view:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn-pay {
        background-color: #f8f9fa;
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .btn-pay:hover {
        background-color: #28a745;
        color: white;
    }
    
    .btn-cancel {
        background-color: #f8f9fa;
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    .btn-cancel:hover {
        background-color: #dc3545;
        color: white;
    }
    
    /* حالة فارغة */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .empty-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(45deg, var(--light), #f8f9fa);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        color: var(--primary-color);
        box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    
    .empty-icon i {
        font-size: 2.5rem;
        opacity: 0.8;
    }
    
    /* زر الاستكشاف */
    .explore-btn {
        padding: 0.75rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
        border: none;
        color: white;
        box-shadow: 0 5px 15px rgba(var(--primary-rgb), 0.2);
        transition: all 0.3s ease;
    }
    
    .explore-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(var(--primary-rgb), 0.3);
        color: white;
    }
    
    /* تحسينات RTL */
    html[dir="rtl"] .action-buttons {
        justify-content: flex-start;
    }
    
    /* تحسينات تباعد الأيقونات */
    html[dir="rtl"] .me-2 {
        margin-right: 0 !important;
        margin-left: 0.5rem !important;
    }
    
    html[dir="rtl"] .ms-2 {
        margin-left: 0 !important;
        margin-right: 0.5rem !important;
    }
    
    html[dir="rtl"] .me-3 {
        margin-right: 0 !important;
        margin-left: 1rem !important;
    }
    
    html[dir="rtl"] .ms-3 {
        margin-left: 0 !important;
        margin-right: 1rem !important;
    }
    
    /* تأثيرات متحركة */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease forwards;
    }
</style>
{% endblock %}

{% block content %}
<!-- ترويسة الصفحة -->
<header class="page-header">
    <div class="container">
        <h1 class="page-title">{% trans "My Reservations" %}</h1>
        <p class="page-subtitle">{% if is_english %}View and manage all your car bookings{% else %}عرض وإدارة جميع حجوزات السيارات الخاصة بك{% endif %}</p>
    </div>
</header>

<div class="container py-4">
    {% if reservations %}
    <div class="card shadow-lg border-0 animate-fade-in-up">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 custom-table">
                    <thead>
                        <tr>
                            <th>{% trans "Reservation ID" %}</th>
                            <th>{% trans "Car" %}</th>
                            <th>{% trans "Dates" %}</th>
                            <th>{% trans "Duration" %}</th>
                            <th>{% trans "Total" %}</th>
                            <th style="min-width: 160px;">{% trans "Status" %}</th>
                            <th class="{% if is_english %}text-end{% else %}text-start{% endif %}">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reservation in reservations %}
                        <tr>
                            <td>
                                <span class="reservation-id">#{{ reservation.id }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if reservation.car.image_url %}
                                    <div class="car-img-wrapper {% if is_english %}me-3{% else %}ms-3{% endif %}">
                                        <img src="{{ reservation.car.image_url }}" alt="{{ reservation.car.make }}" class="car-thumb">
                                    </div>
                                    {% else %}
                                    <div class="car-img-wrapper {% if is_english %}me-3{% else %}ms-3{% endif %}">
                                        <img src="{% static 'images/car-placeholder.svg' %}" alt="{{ reservation.car.make }}" class="car-thumb">
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="car-name">{{ reservation.car.make }} {{ reservation.car.model }}</div>
                                        <small class="text-muted">{{ reservation.car.year }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="date-icon {% if is_english %}me-2{% else %}ms-2{% endif %}">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div>
                                        <div class="date-range">
                                            {% if is_english %}
                                                {{ reservation.start_date|date:"m/d/Y" }} - {{ reservation.end_date|date:"m/d/Y" }}
                                            {% else %}
                                                {{ reservation.start_date|date:"d/m/Y" }} - {{ reservation.end_date|date:"d/m/Y" }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="duration-badge">
                                    {{ reservation.start_date|timesince:reservation.end_date|slice:":-1" }} {% if is_english %}days{% else %}يوم{% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="price-amount">
                                    {% if is_english %}
                                        ${{ reservation.total_price }}
                                    {% else %}
                                        {{ reservation.total_price }} دينار
                                    {% endif %}
                                </span>
                            </td>
                            <td style="min-width: 250px;">
                                <div class="badges-container" style="justify-content: center;">
                                    {% if reservation.status == 'pending' %}
                                    <span class="status-badge status-pending">{% if is_english %}Pending Review{% else %}قيد المراجعة{% endif %}</span>
                                    {% elif reservation.status == 'confirmed' %}
                                    <span class="status-badge status-confirmed">{% if is_english %}Approved{% else %}تمت الموافقة{% endif %}</span>
                                    {% elif reservation.status == 'completed' %}
                                    <span class="status-badge status-completed">{% if is_english %}Completed{% else %}مكتمل{% endif %}</span>
                                    {% elif reservation.status == 'cancelled' %}
                                    <span class="status-badge status-cancelled">{% if is_english %}Cancelled{% else %}ملغي{% endif %}</span>
                                    {% endif %}
                                    
                                    {% if reservation.payment_status == 'pending' %}
                                    <span class="payment-badge payment-pending">{% if is_english %}Awaiting Payment{% else %}في انتظار الدفع{% endif %}</span>
                                    {% elif reservation.payment_status == 'paid' %}
                                    <span class="payment-badge payment-paid">{% if is_english %}Paid{% else %}مدفوع{% endif %}</span>
                                    {% elif reservation.payment_status == 'refunded' %}
                                    <span class="payment-badge payment-refunded">{% if is_english %}Refunded{% else %}مسترجع{% endif %}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'reservation_detail' reservation_id=reservation.id %}" class="btn btn-action btn-view" data-bs-toggle="tooltip" title="{% if is_english %}View Details{% else %}عرض التفاصيل{% endif %}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    {% if reservation.status == 'confirmed' and reservation.payment_status == 'pending' %}
                                    <a href="{% url 'checkout' %}?reservation_id={{ reservation.id }}" class="btn btn-action btn-pay" data-bs-toggle="tooltip" title="{% if is_english %}Make Payment{% else %}إجراء الدفع{% endif %}">
                                        <i class="fas fa-credit-card"></i>
                                    </a>
                                    <div class="countdown-container ms-2 d-inline-block" 
                                         data-reservation-id="{{ reservation.id }}"
                                         {% if reservation.confirmation_expiry %}
                                         data-expiry="{{ reservation.confirmation_expiry|date:'c' }}"
                                         {% endif %}></div>
                                    {% endif %}
                                    
                                    {% if reservation.status == 'pending' %}
                                    <a href="{% url 'cancel_reservation' reservation_id=reservation.id %}" class="btn btn-action btn-cancel" data-bs-toggle="tooltip" title="{% if is_english %}Cancel Reservation{% else %}إلغاء الحجز{% endif %}">
                                        <i class="fas fa-times"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="mt-4 text-center animate-fade-in-up" style="animation-delay: 0.2s;">
        <a href="{% url 'cars' %}" class="explore-btn">
            <i class="fas fa-search {% if is_english %}me-2{% else %}ms-2{% endif %}"></i>
            {% if is_english %}Search for more cars{% else %}البحث عن المزيد من السيارات{% endif %}
        </a>
    </div>
    {% else %}
    <div class="empty-state animate-fade-in-up">
        <div class="empty-icon">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <h3>{% if is_english %}No Reservations Found{% else %}لا توجد حجوزات{% endif %}</h3>
        <p class="text-muted mb-4">
            {% if is_english %}
            You haven't made any reservations yet. Start by exploring available cars for rent.
            {% else %}
            لم تقم بإجراء أي حجوزات بعد. ابدأ باستكشاف السيارات المتاحة للإيجار.
            {% endif %}
        </p>
        <a href="{% url 'cars' %}" class="explore-btn">
            <i class="fas fa-search {% if is_english %}me-2{% else %}ms-2{% endif %}"></i>
            {% if is_english %}Explore Cars{% else %}استكشاف السيارات{% endif %}
        </a>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // تفعيل tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

{% block extra_js %}
<!-- تحميل ملف العد التنازلي المحدث -->
<script src="{% static 'js/countdown-timer-fix.js' %}?v={{ now|date:'U' }}"></script>
<script>
    // إضافة معرفات للصفوف
    document.addEventListener('DOMContentLoaded', function() {
        console.log('تم تحميل صفحة الحجوزات الأصلية');
        
        // إضافة معرفات للصفوف
        const rows = document.querySelectorAll('table tbody tr');
        rows.forEach(function(row, index) {
            if (!row.id) {
                // البحث عن معرف الحجز في الصف
                const reservationIdCell = row.querySelector('td:first-child');
                if (reservationIdCell) {
                    const match = reservationIdCell.textContent.match(/#(\d+)/);
                    if (match && match[1]) {
                        const id = match[1];
                        row.id = 'reservation-' + id;
                        
                        // إضافة سمة تاريخ انتهاء الصلاحية لحجوزات الحالة "confirmed" مع "payment_status = pending"
                        const statusCell = row.querySelector('.status-badge.status-confirmed');
                        const paymentCell = row.querySelector('.payment-badge.payment-pending');
                        
                        if (statusCell && paymentCell) {
                            // للاختبار نضيف تاريخ انتهاء افتراضي (بعد 24 ساعة من الآن)
                            const expiryDate = new Date();
                            expiryDate.setHours(expiryDate.getHours() + 24);
                            row.setAttribute('data-expiry', expiryDate.toISOString());
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}