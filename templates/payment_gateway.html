{% extends 'layout_django.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% if is_english %}Secure Payment Gateway{% else %}بوابة الدفع الآمن{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/payment.css' %}">
<style>
/* Global Payment Gateway Styles */
:root {
    --pg-primary: #2563eb;
    --pg-primary-dark: #1d4ed8;
    --pg-primary-light: #dbeafe;
    --pg-success: #10b981;
    --pg-warning: #f59e0b;
    --pg-danger: #ef4444;
    --pg-dark: #1f2937;
    --pg-gray: #6b7280;
    --pg-light: #f9fafb;
    --pg-border: #e5e7eb;
    --pg-light-blue: #f0f7ff;
}

.pg-container {
    max-width: 1140px;
    margin: 0 auto;
    padding: 2rem 1rem;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}

.pg-flex {
    display: flex;
}

.pg-flex-col {
    flex-direction: column;
}

.pg-items-center {
    align-items: center;
}

.pg-justify-between {
    justify-content: space-between;
}

.pg-header {
    border-bottom: 1px solid var(--pg-border);
    padding-bottom: 1.5rem;
    margin-bottom: 2rem;
}

.pg-logo-container {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
}

.pg-logo-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--pg-primary);
    color: white;
    margin-right: 0.75rem;
}

.rtl .pg-logo-icon {
    margin-right: 0;
    margin-left: 0.75rem;
}

.pg-heading {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--pg-dark);
    margin: 0;
}

.pg-subheading {
    font-size: 0.95rem;
    color: var(--pg-gray);
    margin-top: 0.25rem;
}

.pg-security-badge {
    display: flex;
    align-items: center;
    font-size: 0.8rem;
    color: var(--pg-success);
    margin-top: 0.5rem;
}

.pg-security-badge i {
    margin-right: 0.25rem;
}

.rtl .pg-security-badge i {
    margin-right: 0;
    margin-left: 0.25rem;
}

.pg-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2.5rem;
    position: relative;
}

.pg-steps::before {
    content: '';
    position: absolute;
    top: 24px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: var(--pg-border);
    z-index: 1;
}

.pg-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    width: 25%;
}

.pg-step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: white;
    border: 2px solid var(--pg-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--pg-gray);
    transition: all 0.3s ease;
}

.pg-step.active .pg-step-circle {
    background-color: var(--pg-primary);
    border-color: var(--pg-primary);
    color: white;
    box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4);
}

.pg-step.completed .pg-step-circle {
    background-color: var(--pg-success);
    border-color: var(--pg-success);
    color: white;
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
}

.pg-step-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--pg-gray);
    text-align: center;
}

.pg-step.active .pg-step-label {
    color: var(--pg-primary);
    font-weight: 600;
}

.pg-step.completed .pg-step-label {
    color: var(--pg-success);
    font-weight: 600;
}

.pg-step.active::before, 
.pg-step.completed::before {
    content: '';
    position: absolute;
    top: 24px;
    left: -50%;
    width: 100%;
    height: 2px;
    background: var(--pg-primary);
    z-index: -1;
    transition: all 0.3s ease;
}

.pg-step:first-child.active::before, 
.pg-step:first-child.completed::before {
    display: none;
}

.pg-step.completed::before {
    background: var(--pg-success);
}

.pg-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
}

.pg-main {
    flex: 1;
    min-width: 0;
}

.pg-sidebar {
    width: 350px;
}

.pg-card {
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    background-color: white;
    border: 1px solid rgba(229, 231, 235, 0.5);
    transition: box-shadow 0.3s ease;
}

.pg-card:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.07);
}

.pg-card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--pg-border);
    background-color: var(--pg-light-blue);
}

.pg-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--pg-dark);
    margin: 0;
    display: flex;
    align-items: center;
}

.pg-card-title i {
    margin-right: 0.5rem;
    color: var(--pg-primary);
}

.rtl .pg-card-title i {
    margin-right: 0;
    margin-left: 0.5rem;
}

.pg-card-body {
    padding: 1.5rem;
}

.pg-payment-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.pg-payment-option {
    position: relative;
}

.pg-payment-option input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.pg-payment-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.25rem 1rem;
    border: 1px solid var(--pg-border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    height: 100%;
    position: relative;
}

.pg-payment-label:hover {
    border-color: var(--pg-primary-light);
    background-color: rgba(219, 234, 254, 0.1);
    transform: translateY(-2px);
}

.pg-payment-option input:checked + .pg-payment-label {
    border-color: var(--pg-primary);
    background-color: rgba(219, 234, 254, 0.3);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
}

.pg-payment-option input:checked + .pg-payment-label::after {
    content: '';
    position: absolute;
    top: -6px;
    right: -6px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background-color: var(--pg-primary);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23fff'%3E%3Cpath fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z' clip-rule='evenodd'/%3E%3C/svg%3E");
    background-size: 14px;
    background-position: center;
    background-repeat: no-repeat;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.rtl .pg-payment-option input:checked + .pg-payment-label::after {
    right: auto;
    left: -6px;
}

.pg-payment-icon {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.75rem;
}

.pg-payment-icon img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.pg-payment-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--pg-dark);
    text-align: center;
}

.pg-processing-badge {
    font-size: 0.75rem;
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background-color: #ecfdf5;
    color: #065f46;
    border-radius: 9999px;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.pg-form-group {
    margin-bottom: 1.5rem;
}

.pg-form-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--pg-dark);
    margin-bottom: 0.5rem;
}

.pg-form-control {
    display: block;
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    line-height: 1.5;
    color: var(--pg-dark);
    background-color: white;
    border: 1px solid var(--pg-border);
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.pg-form-control:focus {
    border-color: var(--pg-primary);
    outline: 0;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.pg-form-control.error {
    border-color: var(--pg-danger);
}

.pg-form-row {
    display: flex;
    gap: 1rem;
}

.pg-form-col {
    flex: 1;
    min-width: 0;
}

.pg-form-col.small {
    flex: 0 0 120px;
}

.pg-credit-card {
    position: relative;
    width: 100%;
    height: 230px;
    perspective: 1000px;
    margin-bottom: 2.5rem;
}

.pg-credit-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.8s;
    transform-style: preserve-3d;
}

.pg-credit-card.flipped .pg-credit-card-inner {
    transform: rotateY(180deg);
}

.pg-credit-card-front, .pg-credit-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    overflow: hidden;
}

.pg-credit-card-front {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.pg-credit-card-back {
    background: linear-gradient(135deg, #1e40af, #3b82f6);
    color: white;
    transform: rotateY(180deg);
}

.pg-cc-bank {
    text-align: right;
    font-size: 1.25rem;
    font-weight: 600;
    letter-spacing: 0.05rem;
    margin-bottom: 1rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.rtl .pg-cc-bank {
    text-align: left;
}

.pg-cc-chip {
    width: 60px;
    height: 45px;
    background: linear-gradient(135deg, #f7df94, #daa520);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.pg-cc-chip::before, .pg-cc-chip::after {
    content: '';
    position: absolute;
    background: rgba(0, 0, 0, 0.1);
}

.pg-cc-chip::before {
    width: 30px;
    height: 25px;
    top: 10px;
    left: 15px;
    border-radius: 4px;
}

.pg-cc-chip::after {
    width: 15px;
    height: 15px;
    top: 5px;
    right: 5px;
    border-radius: 50%;
}

.pg-cc-number {
    font-size: 1.4rem;
    letter-spacing: 0.15rem;
    font-family: monospace;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    margin-bottom: 1.5rem;
}

.pg-cc-info-row {
    display: flex;
    justify-content: space-between;
}

.pg-cc-info {
    text-align: left;
}

.rtl .pg-cc-info {
    text-align: right;
}

.pg-cc-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.03rem;
    opacity: 0.8;
}

.pg-cc-value {
    font-size: 0.9rem;
    letter-spacing: 0.03rem;
    font-weight: 500;
}

.pg-cc-logo {
    position: absolute;
    bottom: 1.5rem;
    right: 1.5rem;
    height: 40px;
}

.rtl .pg-cc-logo {
    right: auto;
    left: 1.5rem;
}

.pg-cc-back-stripe {
    height: 50px;
    background-color: rgba(0, 0, 0, 0.5);
    margin: 1.5rem -1.5rem;
}

.pg-cc-cvv-box {
    background-color: rgba(255, 255, 255, 0.9);
    color: #333;
    padding: 0.5rem;
    text-align: right;
    margin: 1rem 0;
    border-radius: 4px;
    font-family: monospace;
    font-size: 1rem;
    letter-spacing: 0.1rem;
}

.rtl .pg-cc-cvv-box {
    text-align: left;
}

.pg-cc-back-text {
    font-size: 0.7rem;
    opacity: 0.7;
    text-align: left;
    margin-top: 1rem;
}

.rtl .pg-cc-back-text {
    text-align: right;
}

.pg-cc-decoration {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
}

.pg-cc-decoration-1 {
    width: 150px;
    height: 150px;
    top: -50px;
    right: -30px;
}

.pg-cc-decoration-2 {
    width: 200px;
    height: 200px;
    bottom: -80px;
    left: -50px;
}

.pg-secure-input {
    position: relative;
}

.pg-secure-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--pg-success);
}

.rtl .pg-secure-icon {
    right: auto;
    left: 1rem;
}

.pg-input-error {
    color: var(--pg-danger);
    font-size: 0.8rem;
    margin-top: 0.25rem;
    display: none;
}

.pg-form-control.error + .pg-input-error {
    display: block;
}

.pg-summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--pg-border);
}

.pg-summary-item:last-of-type {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.pg-summary-label {
    font-size: 0.9rem;
    color: var(--pg-gray);
}

.pg-summary-value {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--pg-dark);
}

.pg-summary-total {
    display: flex;
    justify-content: space-between;
    padding-top: 1rem;
    margin-top: 1rem;
    border-top: 2px solid var(--pg-border);
}

.pg-summary-total-label {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--pg-dark);
}

.pg-summary-total-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--pg-primary);
}

.pg-product-card {
    display: flex;
    background-color: var(--pg-light-blue);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.pg-product-image {
    width: 90px;
    height: 90px;
    border-radius: 8px;
    overflow: hidden;
    margin-right: 1rem;
    flex-shrink: 0;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rtl .pg-product-image {
    margin-right: 0;
    margin-left: 1rem;
}

.pg-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.pg-product-info {
    flex: 1;
    min-width: 0;
}

.pg-product-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--pg-dark);
    margin-bottom: 0.25rem;
}

.pg-product-subtitle {
    font-size: 0.85rem;
    color: var(--pg-gray);
    margin-bottom: 0.5rem;
}

.pg-product-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.5rem;
}

.pg-product-meta-item {
    display: flex;
    align-items: center;
    font-size: 0.85rem;
    color: var(--pg-gray);
}

.pg-product-meta-item i {
    color: var(--pg-primary);
    margin-right: 0.25rem;
}

.rtl .pg-product-meta-item i {
    margin-right: 0;
    margin-left: 0.25rem;
}

.pg-btn {
    display: inline-block;
    font-weight: 500;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;
    user-select: none;
    padding: 0.875rem 1.75rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
    border: 1px solid transparent;
    position: relative;
    overflow: hidden;
}

.pg-btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

.pg-btn:focus {
    outline: 0;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
}

.pg-btn:active::after {
    animation: ripple 1s ease-out;
}

@keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.5;
    }
    100% {
        transform: scale(20, 20);
        opacity: 0;
    }
}

.pg-btn-primary {
    color: white;
    background-color: var(--pg-primary);
    border-color: var(--pg-primary);
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.12);
}

.pg-btn-primary:hover {
    background-color: var(--pg-primary-dark);
    border-color: var(--pg-primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 6px 12px rgba(37, 99, 235, 0.15);
}

.pg-btn-primary:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(37, 99, 235, 0.1);
}

.pg-btn-lg {
    padding: 1rem 2rem;
    font-size: 1.125rem;
    line-height: 1.5;
    border-radius: 0.5rem;
}

.pg-btn-block {
    display: block;
    width: 100%;
}

.pg-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 500;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 9999px;
}

.pg-badge-success {
    color: #065f46;
    background-color: #d1fae5;
}

.pg-badge-warning {
    color: #92400e;
    background-color: #fef3c7;
}

.pg-badge-primary {
    color: #1e40af;
    background-color: #dbeafe;
}

.pg-text-danger {
    color: var(--pg-danger);
}

.pg-input-hint {
    font-size: 0.8rem;
    color: var(--pg-gray);
    margin-top: 0.25rem;
}

.pg-checkout-message {
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
}

.pg-checkout-message.warning {
    background-color: #fffbeb;
    border: 1px solid #fef3c7;
}

.pg-checkout-message-icon {
    flex-shrink: 0;
    color: var(--pg-warning);
    margin-right: 0.75rem;
    font-size: 1.25rem;
}

.rtl .pg-checkout-message-icon {
    margin-right: 0;
    margin-left: 0.75rem;
}

.pg-checkout-message-content {
    font-size: 0.9rem;
    color: #92400e;
}

.pg-checkout-message-content strong {
    font-weight: 600;
}

.pg-trustbadges {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1.5rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--pg-border);
}

.pg-trustbadge {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.pg-trustbadge-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: var(--pg-light-blue);
    margin-bottom: 0.5rem;
    color: var(--pg-primary);
    font-size: 1.25rem;
}

.pg-trustbadge-icon.success {
    background-color: #ecfdf5;
    color: var(--pg-success);
}

.pg-trustbadge-text {
    font-size: 0.8rem;
    color: var(--pg-gray);
    max-width: 120px;
}

.pg-method-section {
    display: none;
}

.pg-method-section.active {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.pg-form-check {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.pg-form-check-input {
    margin-right: 0.5rem;
    margin-top: 0.25rem;
    flex-shrink: 0;
}

.rtl .pg-form-check-input {
    margin-right: 0;
    margin-left: 0.5rem;
}

.pg-form-check-label {
    font-size: 0.9rem;
    color: var(--pg-gray);
}

.pg-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.pg-loader.active {
    opacity: 1;
    visibility: visible;
}

.pg-loader-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--pg-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

.pg-loader-text {
    font-size: 1.25rem;
    font-weight: 500;
    color: var(--pg-dark);
    text-align: center;
}

.pg-loader-subtext {
    font-size: 0.9rem;
    color: var(--pg-gray);
    text-align: center;
    max-width: 300px;
    margin-top: 0.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.pg-verified-badge {
    display: inline-flex;
    align-items: center;
    font-size: 0.8rem;
    color: var(--pg-success);
    margin-left: 0.5rem;
}

.rtl .pg-verified-badge {
    margin-left: 0;
    margin-right: 0.5rem;
}

.pg-verified-badge i {
    margin-right: 0.25rem;
}

.rtl .pg-verified-badge i {
    margin-right: 0;
    margin-left: 0.25rem;
}

.pg-cc-notification {
    background-color: rgba(37, 99, 235, 0.1);
    color: var(--pg-primary);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
}

.pg-cc-notification i {
    margin-right: 0.5rem;
    font-size: 1rem;
}

.rtl .pg-cc-notification i {
    margin-right: 0;
    margin-left: 0.5rem;
}

/* Responsive styles */
@media (max-width: 991px) {
    .pg-layout {
        flex-direction: column;
    }
    
    .pg-sidebar {
        width: 100%;
        order: -1;
    }
}

@media (max-width: 767px) {
    .pg-payment-options {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .pg-form-row {
        flex-direction: column;
        gap: 1rem;
    }
    
    .pg-form-col.small {
        flex: 1;
    }
    
    .pg-step-label {
        display: none;
    }
}

/* RTL Support */
.rtl .pg-steps::before {
    left: 0;
    right: 0;
}

.rtl .pg-step.active::before, 
.rtl .pg-step.completed::before {
    left: auto;
    right: -50%;
}

/* 3D Secure Modal */
.pg-3dsecure-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    visibility: hidden;
    opacity: 0;
    transition: all 0.3s ease;
}

.pg-3dsecure-modal.active {
    visibility: visible;
    opacity: 1;
}

.pg-3dsecure-content {
    width: 100%;
    max-width: 500px;
    background-color: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: all 0.3s ease;
}

.pg-3dsecure-modal.active .pg-3dsecure-content {
    transform: translateY(0);
}

.pg-3dsecure-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--pg-border);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.pg-3dsecure-header img {
    height: 36px;
}

.pg-3dsecure-close {
    position: absolute;
    right: 1.5rem;
    top: 1.5rem;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--pg-light);
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
}

.rtl .pg-3dsecure-close {
    right: auto;
    left: 1.5rem;
}

.pg-3dsecure-close:hover {
    background-color: var(--pg-border);
}

.pg-3dsecure-body {
    padding: 2rem 1.5rem;
}

.pg-3dsecure-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--pg-dark);
    margin-bottom: 1rem;
    text-align: center;
}

.pg-3dsecure-subtitle {
    font-size: 0.9rem;
    color: var(--pg-gray);
    margin-bottom: 1.5rem;
    text-align: center;
}

.pg-3dsecure-otp {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-bottom: 2rem;
}

.pg-3dsecure-otp-input {
    width: 50px;
    height: 60px;
    border: 1px solid var(--pg-border);
    border-radius: 8px;
    font-size: 1.5rem;
    text-align: center;
    transition: all 0.2s ease;
}

.pg-3dsecure-otp-input:focus {
    border-color: var(--pg-primary);
    outline: 0;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.pg-3dsecure-message {
    font-size: 0.85rem;
    color: var(--pg-gray);
    text-align: center;
    margin-bottom: 1.5rem;
}

.pg-3dsecure-actions {
    display: flex;
    justify-content: center;
}
</style>
{% endblock %}

{% block content %}
<div class="pg-container {% if is_rtl %}rtl{% endif %}">
    <!-- Payment Header -->
    <div class="pg-header">
        <div class="pg-logo-container">
            <div class="pg-logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div>
                <h1 class="pg-heading">{% if is_english %}Secure Payment Gateway{% else %}بوابة الدفع الآمن{% endif %}</h1>
                <p class="pg-subheading">{% if is_english %}Complete your reservation with secure payment{% else %}أكمل عملية الدفع بأمان لتأكيد حجزك{% endif %}</p>
                <div class="pg-security-badge">
                    <i class="fas fa-lock"></i>
                    <span>{% if is_english %}Secure connection with 256-bit SSL encryption{% else %}اتصال آمن مع تشفير SSL بطول 256 بت{% endif %}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Steps -->
    <div class="pg-steps">
        <div class="pg-step completed">
            <div class="pg-step-circle">
                <i class="fas fa-check"></i>
            </div>
            <div class="pg-step-label">{% if is_english %}Car Selection{% else %}اختيار السيارة{% endif %}</div>
        </div>
        <div class="pg-step completed">
            <div class="pg-step-circle">
                <i class="fas fa-check"></i>
            </div>
            <div class="pg-step-label">{% if is_english %}Booking Details{% else %}تفاصيل الحجز{% endif %}</div>
        </div>
        <div class="pg-step active">
            <div class="pg-step-circle">3</div>
            <div class="pg-step-label">{% if is_english %}Payment{% else %}الدفع{% endif %}</div>
        </div>
        <div class="pg-step">
            <div class="pg-step-circle">4</div>
            <div class="pg-step-label">{% if is_english %}Confirmation{% else %}التأكيد{% endif %}</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="pg-layout">
        <!-- Main Column -->
        <div class="pg-main">
            <form method="post" action="{% url 'international_payment' %}{% if not from_cart %}?reservation_id={{ reservation.id }}{% endif %}" id="payment-form">
                {% csrf_token %}
                
                <!-- Payment Methods Card -->
                <div class="pg-card">
                    <div class="pg-card-header">
                        <h3 class="pg-card-title">
                            <i class="fas fa-credit-card"></i>
                            {% if is_english %}Select Payment Method{% else %}اختر طريقة الدفع{% endif %}
                        </h3>
                    </div>
                    <div class="pg-card-body">
                        <div class="pg-payment-options">
                            <div class="pg-payment-option">
                                <input type="radio" name="payment_method" id="visa" value="visa" checked>
                                <label for="visa" class="pg-payment-label">
                                    <div class="pg-payment-icon">
                                        <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/brand-visa.svg" alt="Visa">
                                    </div>
                                    <div class="pg-payment-name">Visa</div>
                                </label>
                            </div>
                            
                            <div class="pg-payment-option">
                                <input type="radio" name="payment_method" id="mastercard" value="mastercard">
                                <label for="mastercard" class="pg-payment-label">
                                    <div class="pg-payment-icon">
                                        <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/brand-mastercard.svg" alt="Mastercard">
                                    </div>
                                    <div class="pg-payment-name">Mastercard</div>
                                </label>
                            </div>
                            
                            <div class="pg-payment-option">
                                <input type="radio" name="payment_method" id="amex" value="amex">
                                <label for="amex" class="pg-payment-label">
                                    <div class="pg-payment-icon">
                                        <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/brand-american-express.svg" alt="American Express">
                                    </div>
                                    <div class="pg-payment-name">Amex</div>
                                </label>
                            </div>
                            
                            <div class="pg-payment-option">
                                <input type="radio" name="payment_method" id="bank" value="bank">
                                <label for="bank" class="pg-payment-label">
                                    <div class="pg-payment-icon">
                                        <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/building-bank.svg" alt="Bank Transfer">
                                    </div>
                                    <div class="pg-payment-name">{% if is_english %}Bank Transfer{% else %}تحويل بنكي{% endif %}</div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Processing Badge -->
                        <div class="pg-processing-badge">
                            <i class="fas fa-shield-alt"></i>
                            {% if is_english %}Secure Processing{% else %}معالجة آمنة{% endif %}
                        </div>
                        
                        <!-- Card Section (Visa, Mastercard, Amex) -->
                        <div id="card-section" class="pg-method-section active">
                            <div class="pg-cc-notification">
                                <i class="fas fa-info-circle"></i>
                                {% if is_english %}
                                    All card information is securely processed. We never store your full card details.
                                {% else %}
                                    تتم معالجة جميع معلومات البطاقة بأمان. نحن لا نخزن تفاصيل بطاقتك كاملة أبدًا.
                                {% endif %}
                            </div>
                        
                            <!-- Credit Card Preview -->
                            <div class="pg-credit-card" id="credit-card">
                                <div class="pg-credit-card-inner">
                                    <div class="pg-credit-card-front">
                                        <div class="pg-cc-bank">BANK</div>
                                        <div class="pg-cc-chip"></div>
                                        <div class="pg-cc-number">•••• •••• •••• ••••</div>
                                        <div class="pg-cc-info-row">
                                            <div class="pg-cc-info">
                                                <div class="pg-cc-label">{% if is_english %}CARD HOLDER{% else %}حامل البطاقة{% endif %}</div>
                                                <div class="pg-cc-value">{{ request.user.get_full_name }}</div>
                                            </div>
                                            <div class="pg-cc-info">
                                                <div class="pg-cc-label">{% if is_english %}EXPIRES{% else %}تنتهي في{% endif %}</div>
                                                <div class="pg-cc-value">••/••</div>
                                            </div>
                                        </div>
                                        <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/brand-visa.svg" alt="Visa" class="pg-cc-logo" id="card-brand-logo">
                                        <div class="pg-cc-decoration pg-cc-decoration-1"></div>
                                        <div class="pg-cc-decoration pg-cc-decoration-2"></div>
                                    </div>
                                    <div class="pg-credit-card-back">
                                        <div class="pg-cc-back-stripe"></div>
                                        <div class="pg-cc-cvv-box" id="cvv-preview">•••</div>
                                        <div class="pg-cc-back-text">
                                            {% if is_english %}
                                                For customer service, call +1-234-567-8900 or visit our website at www.bank.com
                                            {% else %}
                                                لخدمة العملاء، اتصل على 8900-567-234-1+ أو قم بزيارة موقعنا على www.bank.com
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Number -->
                            <div class="pg-form-group">
                                <label for="card_number" class="pg-form-label">{% if is_english %}Card Number{% else %}رقم البطاقة{% endif %}</label>
                                <div class="pg-secure-input">
                                    <input type="text" class="pg-form-control pg-card-input" id="card_number" placeholder="•••• •••• •••• ••••" maxlength="19" autocomplete="cc-number">
                                    <i class="fas fa-lock pg-secure-icon"></i>
                                </div>
                                <div class="pg-input-error">{% if is_english %}Please enter a valid card number{% else %}يرجى إدخال رقم بطاقة صحيح{% endif %}</div>
                            </div>
                            
                            <!-- Card Holder Name -->
                            <div class="pg-form-group">
                                <label for="card_holder" class="pg-form-label">{% if is_english %}Card Holder{% else %}حامل البطاقة{% endif %}</label>
                                <input type="text" class="pg-form-control" id="card_holder" value="{{ request.user.get_full_name }}" autocomplete="cc-name">
                                <div class="pg-input-error">{% if is_english %}Please enter card holder name{% else %}يرجى إدخال اسم حامل البطاقة{% endif %}</div>
                            </div>
                            
                            <!-- Expiry Date & CVV -->
                            <div class="pg-form-row">
                                <div class="pg-form-col">
                                    <div class="pg-form-group">
                                        <label for="expiry_date" class="pg-form-label">{% if is_english %}Expiry Date{% else %}تاريخ الانتهاء{% endif %}</label>
                                        <input type="text" class="pg-form-control" id="expiry_date" placeholder="MM / YY" maxlength="7" autocomplete="cc-exp">
                                        <div class="pg-input-error">{% if is_english %}Please enter a valid expiry date{% else %}يرجى إدخال تاريخ انتهاء صحيح{% endif %}</div>
                                    </div>
                                </div>
                                <div class="pg-form-col small">
                                    <div class="pg-form-group">
                                        <label for="cvv" class="pg-form-label">CVV</label>
                                        <input type="text" class="pg-form-control" id="cvv" placeholder="•••" maxlength="3" autocomplete="cc-csc">
                                        <div class="pg-input-error">{% if is_english %}Please enter CVV{% else %}يرجى إدخال رمز CVV{% endif %}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bank Transfer Section -->
                        <div id="bank-section" class="pg-method-section">
                            <div class="text-center mb-4">
                                <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/building-bank.svg" alt="Bank Transfer" style="height: 60px;">
                            </div>
                            <div class="alert alert-info">
                                {% if is_english %}
                                    Please make a bank transfer to the account details below and provide your reference number.
                                {% else %}
                                    يرجى إجراء تحويل بنكي إلى تفاصيل الحساب أدناه وتقديم رقم المرجع الخاص بك.
                                {% endif %}
                            </div>
                            
                            <div class="pg-bank-details">
                                <div class="pg-form-group">
                                    <label class="pg-form-label">{% if is_english %}Bank Name{% else %}اسم البنك{% endif %}</label>
                                    <div class="pg-bank-info">Example Bank</div>
                                </div>
                                
                                <div class="pg-form-group">
                                    <label class="pg-form-label">{% if is_english %}Account Name{% else %}اسم الحساب{% endif %}</label>
                                    <div class="pg-bank-info">Car Rental Company LLC</div>
                                </div>
                                
                                <div class="pg-form-group">
                                    <label class="pg-form-label">{% if is_english %}Account Number{% else %}رقم الحساب{% endif %}</label>
                                    <div class="pg-bank-info">1234567890</div>
                                </div>
                                
                                <div class="pg-form-group">
                                    <label class="pg-form-label">{% if is_english %}IBAN{% else %}رقم الآيبان{% endif %}</label>
                                    <div class="pg-bank-info">SA1234567890123456789012</div>
                                </div>
                                
                                <div class="pg-form-group">
                                    <label class="pg-form-label">{% if is_english %}SWIFT/BIC Code{% else %}رمز سويفت/BIC{% endif %}</label>
                                    <div class="pg-bank-info">EXAMPLECODE</div>
                                </div>
                                
                                <div class="pg-form-group">
                                    <label class="pg-form-label">{% if is_english %}Reference Number{% else %}رقم المرجع{% endif %}</label>
                                    <div class="pg-bank-info">{{ request.user.id }}-{% now "Ymd" %}</div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning mt-3">
                                {% if is_english %}
                                    Important: Please include the reference number in your transfer to help us identify your payment.
                                {% else %}
                                    هام: يرجى تضمين رقم المرجع في التحويل الخاص بك لمساعدتنا في تحديد دفعتك.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Billing Information -->
                <div class="pg-card">
                    <div class="pg-card-header">
                        <h3 class="pg-card-title">
                            <i class="fas fa-file-invoice"></i>
                            {% if is_english %}Billing Information{% else %}معلومات الفوترة{% endif %}
                        </h3>
                    </div>
                    <div class="pg-card-body">
                        <!-- Name -->
                        <div class="pg-form-row">
                            <div class="pg-form-col">
                                <div class="pg-form-group">
                                    <label for="first_name" class="pg-form-label">{% if is_english %}First Name{% else %}الاسم الأول{% endif %}</label>
                                    <input type="text" class="pg-form-control" id="first_name" value="{{ request.user.first_name }}">
                                </div>
                            </div>
                            <div class="pg-form-col">
                                <div class="pg-form-group">
                                    <label for="last_name" class="pg-form-label">{% if is_english %}Last Name{% else %}اسم العائلة{% endif %}</label>
                                    <input type="text" class="pg-form-control" id="last_name" value="{{ request.user.last_name }}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email & Phone -->
                        <div class="pg-form-row">
                            <div class="pg-form-col">
                                <div class="pg-form-group">
                                    <label for="email" class="pg-form-label">{% if is_english %}Email Address{% else %}البريد الإلكتروني{% endif %}</label>
                                    <input type="email" class="pg-form-control" id="email" value="{{ request.user.email }}">
                                </div>
                            </div>
                            <div class="pg-form-col">
                                <div class="pg-form-group">
                                    <label for="phone" class="pg-form-label">{% if is_english %}Phone Number{% else %}رقم الهاتف{% endif %}</label>
                                    <input type="tel" class="pg-form-control" id="phone" value="{{ request.user.phone|default:'' }}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms Checkbox -->
                        <div class="pg-form-check">
                            <input class="pg-form-check-input" type="checkbox" id="terms_agree" checked required>
                            <label class="pg-form-check-label" for="terms_agree">
                                {% if is_english %}
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a> and <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a>
                                {% else %}
                                أوافق على <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">الشروط والأحكام</a> و <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">سياسة الخصوصية</a>
                                {% endif %}
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button with Messages -->
                <div class="mb-4">
                    <div class="pg-checkout-message warning">
                        <i class="fas fa-exclamation-triangle pg-checkout-message-icon"></i>
                        <div class="pg-checkout-message-content">
                            {% if is_english %}
                            <strong>Important:</strong> This payment will be processed after your reservation has been confirmed by an administrator. You won't be charged until then.
                            {% else %}
                            <strong>هام:</strong> ستتم معالجة هذا الدفع بعد أن يتم تأكيد حجزك من قبل المسؤول. لن يتم خصم المبلغ حتى ذلك الحين.
                            {% endif %}
                        </div>
                    </div>
                    
                    <button type="submit" class="pg-btn pg-btn-primary pg-btn-lg pg-btn-block" id="submit-payment">
                        {% if is_english %}Complete Payment{% else %}إكمال الدفع{% endif %}
                    </button>
                    
                    <div class="pg-trustbadges">
                        <div class="pg-trustbadge">
                            <div class="pg-trustbadge-icon">
                                <i class="fas fa-lock"></i>
                            </div>
                            <div class="pg-trustbadge-text">
                                {% if is_english %}Secure Payment{% else %}دفع آمن{% endif %}
                            </div>
                        </div>
                        <div class="pg-trustbadge">
                            <div class="pg-trustbadge-icon success">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="pg-trustbadge-text">
                                {% if is_english %}Data Protection{% else %}حماية البيانات{% endif %}
                            </div>
                        </div>
                        <div class="pg-trustbadge">
                            <div class="pg-trustbadge-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="pg-trustbadge-text">
                                {% if is_english %}Encrypted Transaction{% else %}معاملة مشفرة{% endif %}
                            </div>
                        </div>
                        <div class="pg-trustbadge">
                            <div class="pg-trustbadge-icon success">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="pg-trustbadge-text">
                                {% if is_english %}PCI Compliant{% else %}متوافق مع معايير PCI{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Sidebar -->
        <div class="pg-sidebar">
            <!-- Order Summary -->
            <div class="pg-card">
                <div class="pg-card-header">
                    <h3 class="pg-card-title">
                        <i class="fas fa-receipt"></i>
                        {% if is_english %}Order Summary{% else %}ملخص الطلب{% endif %}
                    </h3>
                </div>
                <div class="pg-card-body">
                    {% if reservation %}
                    <!-- Single Reservation Summary -->
                    <div class="pg-product-card">
                        {% if reservation.car.image %}
                            <div class="pg-product-image">
                                <img src="{{ reservation.car.image.url }}" alt="{{ reservation.car.make }} {{ reservation.car.model }}">
                            </div>
                        {% elif reservation.car.image_url %}
                            <div class="pg-product-image">
                                <img src="{{ reservation.car.image_url }}" alt="{{ reservation.car.make }} {{ reservation.car.model }}">
                            </div>
                        {% else %}
                            <div class="pg-product-image">
                                <i class="fas fa-car fa-2x" style="color: #3b82f6;"></i>
                            </div>
                        {% endif %}
                        <div class="pg-product-info">
                            <div class="pg-product-title">{{ reservation.car.make }} {{ reservation.car.model }}</div>
                            <div class="pg-product-subtitle">{{ reservation.car.year }} | {{ reservation.car.category }}</div>
                            <div class="pg-product-meta">
                                <div class="pg-product-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    {% if is_english %}
                                    {{ reservation.days }} days
                                    {% else %}
                                    {{ reservation.days }} يوم
                                    {% endif %}
                                </div>
                                <div class="pg-product-meta-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    {% if is_english %}
                                    {{ reservation.start_date|date:"M d, Y" }} - {{ reservation.end_date|date:"M d, Y" }}
                                    {% else %}
                                    {{ reservation.start_date|date:"Y/m/d" }} - {{ reservation.end_date|date:"Y/m/d" }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Items -->
                    <div class="pg-summary-item">
                        <div class="pg-summary-label">{% if is_english %}Daily Rate{% else %}السعر اليومي{% endif %}</div>
                        <div class="pg-summary-value">{{ reservation.car.price_per_day }} {% if is_english %}JOD{% else %}دينار{% endif %}</div>
                    </div>
                    <div class="pg-summary-item">
                        <div class="pg-summary-label">{% if is_english %}Rental Duration{% else %}مدة الإيجار{% endif %}</div>
                        <div class="pg-summary-value">{{ reservation.days }} {% if is_english %}Days{% else %}يوم{% endif %}</div>
                    </div>
                    <div class="pg-summary-item">
                        <div class="pg-summary-label">{% if is_english %}Subtotal{% else %}المجموع الفرعي{% endif %}</div>
                        <div class="pg-summary-value">{{ reservation.total_price }} {% if is_english %}JOD{% else %}دينار{% endif %}</div>
                    </div>
                    
                    <!-- Total -->
                    <div class="pg-summary-total">
                        <div class="pg-summary-total-label">{% if is_english %}Total{% else %}المجموع{% endif %}</div>
                        <div class="pg-summary-total-value">{{ reservation.total_price }} {% if is_english %}JOD{% else %}دينار{% endif %}</div>
                    </div>
                    {% else %}
                    <!-- Cart Items Summary -->
                    {% for item in cart_items %}
                    <div class="pg-product-card">
                        {% if item.car.image %}
                            <div class="pg-product-image">
                                <img src="{{ item.car.image.url }}" alt="{{ item.car.make }} {{ item.car.model }}">
                            </div>
                        {% elif item.car.image_url %}
                            <div class="pg-product-image">
                                <img src="{{ item.car.image_url }}" alt="{{ item.car.make }} {{ item.car.model }}">
                            </div>
                        {% else %}
                            <div class="pg-product-image">
                                <i class="fas fa-car fa-2x" style="color: #3b82f6;"></i>
                            </div>
                        {% endif %}
                        <div class="pg-product-info">
                            <div class="pg-product-title">{{ item.car.make }} {{ item.car.model }}</div>
                            <div class="pg-product-subtitle">{{ item.car.year }} | {{ item.car.category }}</div>
                            <div class="pg-product-meta">
                                <div class="pg-product-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    {% if is_english %}
                                    {{ item.days }} days
                                    {% else %}
                                    {{ item.days }} يوم
                                    {% endif %}
                                </div>
                                <div class="pg-product-meta-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    {% if is_english %}
                                    {{ item.start_date|date:"M d, Y" }} - {{ item.end_date|date:"M d, Y" }}
                                    {% else %}
                                    {{ item.start_date|date:"Y/m/d" }} - {{ item.end_date|date:"Y/m/d" }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Total -->
                    <div class="pg-summary-total">
                        <div class="pg-summary-total-label">{% if is_english %}Total{% else %}المجموع{% endif %}</div>
                        <div class="pg-summary-total-value">{{ total_amount }} {% if is_english %}JOD{% else %}دينار{% endif %}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3D Secure Authentication Modal -->
<div class="pg-3dsecure-modal" id="secure-modal">
    <div class="pg-3dsecure-content">
        <div class="pg-3dsecure-header">
            <img src="https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/3d-cube-sphere.svg" alt="3D Secure">
            <div class="pg-3dsecure-close" id="close-modal">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="pg-3dsecure-body">
            <div class="pg-3dsecure-title">{% if is_english %}Authentication Required{% else %}مطلوب المصادقة{% endif %}</div>
            <div class="pg-3dsecure-subtitle">
                {% if is_english %}
                Enter the verification code sent to +•••••••{% if request.user.phone %}{{ request.user.phone|slice:"-4:" }}{% else %}1234{% endif %}
                {% else %}
                أدخل رمز التحقق المرسل إلى +•••••••{% if request.user.phone %}{{ request.user.phone|slice:"-4:" }}{% else %}1234{% endif %}
                {% endif %}
            </div>
            
            <div class="pg-3dsecure-otp">
                <input type="text" maxlength="1" class="pg-3dsecure-otp-input" data-index="1">
                <input type="text" maxlength="1" class="pg-3dsecure-otp-input" data-index="2">
                <input type="text" maxlength="1" class="pg-3dsecure-otp-input" data-index="3">
                <input type="text" maxlength="1" class="pg-3dsecure-otp-input" data-index="4">
                <input type="text" maxlength="1" class="pg-3dsecure-otp-input" data-index="5">
                <input type="text" maxlength="1" class="pg-3dsecure-otp-input" data-index="6">
            </div>
            
            <div class="pg-3dsecure-message">
                {% if is_english %}
                Didn't receive the code? <a href="#">Resend Code</a>
                {% else %}
                لم تستلم الرمز؟ <a href="#">إعادة إرسال الرمز</a>
                {% endif %}
            </div>
            
            <div class="pg-3dsecure-actions">
                <button class="pg-btn pg-btn-primary" id="verify-otp">
                    {% if is_english %}Verify & Complete Payment{% else %}تحقق وأكمل الدفع{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Processing Overlay -->
<div class="pg-loader" id="payment-loader">
    <div class="pg-loader-spinner"></div>
    <div class="pg-loader-text">{% if is_english %}Processing Payment{% else %}جارٍ معالجة الدفع{% endif %}</div>
    <div class="pg-loader-subtext">{% if is_english %}Please don't refresh or close this page{% else %}يرجى عدم تحديث أو إغلاق هذه الصفحة{% endif %}</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Payment Method Selection
        const paymentOptions = document.querySelectorAll('.pg-payment-option input');
        const methodSections = document.querySelectorAll('.pg-method-section');
        const cardBrandLogo = document.getElementById('card-brand-logo');
        
        function updatePaymentMethod() {
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
            
            // Hide all sections
            methodSections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected method section
            if (selectedMethod === 'visa' || selectedMethod === 'mastercard' || selectedMethod === 'amex') {
                document.getElementById('card-section').classList.add('active');
                
                // Update card logo based on selection
                if (selectedMethod === 'visa') {
                    cardBrandLogo.src = 'https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/brand-visa.svg';
                } else if (selectedMethod === 'mastercard') {
                    cardBrandLogo.src = 'https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/brand-mastercard.svg';
                } else if (selectedMethod === 'amex') {
                    cardBrandLogo.src = 'https://cdn.jsdelivr.net/gh/tabler/tabler-icons@master/icons/brand-american-express.svg';
                }
            } else if (selectedMethod === 'bank') {
                document.getElementById('bank-section').classList.add('active');
            }
        }
        
        paymentOptions.forEach(option => {
            option.addEventListener('change', updatePaymentMethod);
        });
        
        // Card Flipper
        const creditCard = document.getElementById('credit-card');
        const cvvInput = document.getElementById('cvv');
        
        cvvInput.addEventListener('focus', function() {
            creditCard.classList.add('flipped');
        });
        
        cvvInput.addEventListener('blur', function() {
            creditCard.classList.remove('flipped');
        });
        
        // Card Form Input Updates
        const cardNumberInput = document.getElementById('card_number');
        const cardHolderInput = document.getElementById('card_holder');
        const expiryInput = document.getElementById('expiry_date');
        const cvvPreview = document.getElementById('cvv-preview');
        
        // Card number formatting and preview update
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            let formattedValue = '';
            
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += ' ';
                }
                formattedValue += value[i];
            }
            
            e.target.value = formattedValue;
            
            // Update card preview
            const cardNumberDisplay = document.querySelector('.pg-cc-number');
            if (formattedValue) {
                let displayValue = formattedValue;
                // Mask all but last 4 digits
                if (displayValue.length > 4) {
                    displayValue = '•••• •••• •••• ' + displayValue.slice(-4);
                }
                cardNumberDisplay.textContent = displayValue;
            } else {
                cardNumberDisplay.textContent = '•••• •••• •••• ••••';
            }
            
            // Basic validation
            if (value.length < 16) {
                cardNumberInput.classList.add('error');
            } else {
                cardNumberInput.classList.remove('error');
            }
        });
        
        // Card holder name update
        cardHolderInput.addEventListener('input', function(e) {
            const cardHolderDisplay = document.querySelector('.pg-cc-value');
            cardHolderDisplay.textContent = e.target.value || '{{ request.user.get_full_name }}';
            
            // Basic validation
            if (!e.target.value.trim()) {
                cardHolderInput.classList.add('error');
            } else {
                cardHolderInput.classList.remove('error');
            }
        });
        
        // Expiry date formatting and preview update
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 2) {
                value = value.substring(0, 2) + ' / ' + value.substring(2, 4);
            }
            
            e.target.value = value;
            
            // Update card preview
            const expiryDisplay = document.querySelectorAll('.pg-cc-value')[1];
            if (value) {
                let month = value.substring(0, 2);
                let year = value.substring(5, 7);
                
                if (month > 12) {
                    month = '12';
                }
                
                if (month && year) {
                    expiryDisplay.textContent = month + '/' + year;
                } else if (month) {
                    expiryDisplay.textContent = month + '/••';
                } else {
                    expiryDisplay.textContent = '••/••';
                }
            } else {
                expiryDisplay.textContent = '••/••';
            }
            
            // Basic validation
            if (value.replace(/\s|\/|\D/g, '').length < 4) {
                expiryInput.classList.add('error');
            } else {
                expiryInput.classList.remove('error');
            }
        });
        
        // CVV input and preview update
        cvvInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value.substring(0, 3);
            
            // Update CVV preview
            if (value) {
                cvvPreview.textContent = value.padEnd(3, '•');
            } else {
                cvvPreview.textContent = '•••';
            }
            
            // Basic validation
            if (value.length < 3) {
                cvvInput.classList.add('error');
            } else {
                cvvInput.classList.remove('error');
            }
        });
        
        // 3D Secure Modal
        const secureModal = document.getElementById('secure-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const verifyOtpBtn = document.getElementById('verify-otp');
        const paymentForm = document.getElementById('payment-form');
        const submitBtn = document.getElementById('submit-payment');
        const paymentLoader = document.getElementById('payment-loader');
        const otpInputs = document.querySelectorAll('.pg-3dsecure-otp-input');
        
        // OTP input behavior
        otpInputs.forEach(input => {
            input.addEventListener('keyup', function(e) {
                const index = parseInt(this.dataset.index);
                
                if (e.key >= 0 && e.key <= 9) {
                    if (index < 6) {
                        otpInputs[index].focus();
                    }
                } else if (e.key === 'Backspace') {
                    if (index > 1) {
                        otpInputs[index - 2].focus();
                    }
                }
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key >= 0 && e.key <= 9) {
                    this.value = '';
                }
            });
        });
        
        // Submit form handler
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Validate form
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
            
            // For card payments
            if (selectedMethod === 'visa' || selectedMethod === 'mastercard' || selectedMethod === 'amex') {
                const cardNumber = cardNumberInput.value.replace(/\s/g, '');
                const cardHolder = cardHolderInput.value.trim();
                const expiry = expiryInput.value.replace(/\s|\/|\D/g, '');
                const cvv = cvvInput.value;
                
                let isValid = true;
                
                if (cardNumber.length < 16) {
                    cardNumberInput.classList.add('error');
                    isValid = false;
                }
                
                if (!cardHolder) {
                    cardHolderInput.classList.add('error');
                    isValid = false;
                }
                
                if (expiry.length < 4) {
                    expiryInput.classList.add('error');
                    isValid = false;
                }
                
                if (cvv.length < 3) {
                    cvvInput.classList.add('error');
                    isValid = false;
                }
                
                if (!isValid) {
                    return;
                }
                
                // Show 3D Secure modal for card payments
                secureModal.classList.add('active');
                otpInputs[0].focus();
            } else if (selectedMethod === 'bank') {
                // For Bank Transfer, we submit form directly
                paymentLoader.classList.add('active');
                
                // Simulate processing and submit form
                setTimeout(() => {
                    paymentForm.submit();
                }, 2000);
            }
        });
        
        // Close modal
        closeModalBtn.addEventListener('click', function() {
            secureModal.classList.remove('active');
        });
        
        // Verify OTP button
        verifyOtpBtn.addEventListener('click', function() {
            // Check if OTP is complete (for demo, we accept any complete OTP)
            let otpComplete = true;
            otpInputs.forEach(input => {
                if (!input.value) {
                    otpComplete = false;
                }
            });
            
            if (!otpComplete) {
                return;
            }
            
            // Close the modal and show loader
            secureModal.classList.remove('active');
            paymentLoader.classList.add('active');
            
            // Simulate processing and submit form
            setTimeout(() => {
                paymentForm.submit();
            }, 2000);
        });
        
        // Initialize payment method
        updatePaymentMethod();
    });
</script>
{% endblock %}