{% extends 'superadmin/layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©" %} - {{ admin.user.get_full_name }}{% endblock %}

{% block extra_css %}
<!-- ØªØ¶Ù…ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª CSS Ø§Ù„Ù„Ø§Ø²Ù…Ø© -->
<link rel="stylesheet" href="{% static 'css/permissions_redesign.css' %}">
<link rel="stylesheet" href="{% static 'css/admin_permissions_cards.css' %}">
<link rel="stylesheet" href="{% static 'css/admin_permissions_redesign.css' %}">
<!-- Ù…Ù„Ù Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø®ØµØµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØµÙØ­Ø© -->
<link rel="stylesheet" href="{% static 'css/admin_permissions_dynamic.css' %}">
{% endblock %}

{% block extra_js %}
<!-- Ø¥Ø¶Ø§ÙØ© jQuery Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/permissions_dynamic_handler.js' %}"></script>
<script src="{% static 'js/permissions_redesign.js' %}"></script>
<script>
    // ØªØ¹Ø±ÙŠÙ ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±ÙŠÙ†)
    function updatePermissionCounts() {
        console.log("ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...");
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        document.querySelectorAll('.permissions-section').forEach(section => {
            const sectionId = section.id;
            const sectionName = sectionId.replace('section-', '');
            
            // Ø¹Ø¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ù‚Ø³Ù…
            const totalCards = section.querySelectorAll('.permission-card').length;
            const activeCards = section.querySelectorAll('.permission-card.active').length;
            
            console.log(`âš¡ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø³Ù… (${sectionName}): Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø© = ${activeCards}`);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…
            const sectionCount = section.querySelector('.section-count');
            if (sectionCount) {
                sectionCount.textContent = `${activeCards} / ${totalCards}`;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
            const tabCount = document.querySelector(`.tab-item[data-section="${sectionName}"] .tab-count`);
            if (tabCount) {
                tabCount.textContent = activeCards;
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø¯ ØµÙØ±ØŒ Ø£Ø¶Ù ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ
                if (activeCards === 0) {
                    console.log(`ğŸš¨ ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ Ù‚Ø³Ù… ${sectionName}`);
                    tabCount.classList.add('empty');
                } else {
                    tabCount.classList.remove('empty');
                }
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙƒÙ…Ø«Ø§Ù„
        const reservationsSection = document.getElementById('section-reservations');
        if (reservationsSection) {
            const totalReservations = reservationsSection.querySelectorAll('.permission-card').length;
            const activeReservations = reservationsSection.querySelectorAll('.permission-card.active').length;
            console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø³Ù… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: Ø¥Ø¬Ù…Ø§Ù„ÙŠ = ${totalReservations}ØŒ Ù†Ø´Ø· = ${activeReservations}`);
        }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…ÙƒØªØ¨Ø© jQuery Ù…ØªØ§Ø­Ø©
        if (typeof jQuery === 'undefined') {
            console.error('jQuery ØºÙŠØ± Ù…ØªÙˆÙØ±! ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø© jQuery.');
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        setTimeout(updatePermissionCounts, 500);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø£ÙŠ ØµÙ„Ø§Ø­ÙŠØ©
        document.querySelectorAll('.permission-card').forEach(card => {
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„
            const newCard = card.cloneNode(true);
            card.parentNode.replaceChild(newCard, card);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø£Ø­Ø¯Ø§Ø« Ø¬Ø¯ÙŠØ¯
            newCard.addEventListener('click', function(e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± ØªÙØ§Ø¹Ù„ÙŠ
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button')) {
                    return;
                }
                
                // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·
                this.classList.toggle('active');
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = this.classList.contains('active');
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                setTimeout(updatePermissionCounts, 100);
            });
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // ØªØ¬Ø§Ù‡Ù„ Ø²Ø± ÙØªØ­ Ø§Ù„ÙƒÙ„
                if (this.classList.contains('utility')) {
                    return;
                }
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
                document.querySelectorAll('.tab-item').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
                this.classList.add('active');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø³Ù…
                const sectionName = this.getAttribute('data-section');
                
                // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                document.querySelectorAll('.permissions-section').forEach(section => {
                    section.classList.remove('active');
                    const sectionBody = section.querySelector('.section-body');
                    if (sectionBody) {
                        sectionBody.style.display = 'none';
                    }
                });
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                const targetSection = document.getElementById('section-' + sectionName);
                if (targetSection) {
                    targetSection.classList.add('active');
                    const sectionBody = targetSection.querySelector('.section-body');
                    if (sectionBody) {
                        sectionBody.style.display = 'block';
                    }
                }
            });
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± ÙØªØ­/Ø·ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        document.querySelectorAll('.toggle-section').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                
                const section = this.closest('.permissions-section');
                const sectionBody = section.querySelector('.section-body');
                
                if (sectionBody.style.display === 'none') {
                    // ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
                    sectionBody.style.display = 'block';
                    this.innerHTML = '<i class="fas fa-chevron-up"></i>';
                } else {
                    // Ø·ÙŠ Ø§Ù„Ù‚Ø³Ù…
                    sectionBody.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-chevron-down"></i>';
                }
            });
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± ÙØªØ­ Ø§Ù„ÙƒÙ„
        document.getElementById('expand-all').addEventListener('click', function() {
            document.querySelectorAll('.section-body').forEach(body => {
                body.style.display = 'block';
            });
            
            document.querySelectorAll('.toggle-section').forEach(button => {
                button.innerHTML = '<i class="fas fa-chevron-up"></i>';
            });
        });
        
        // ØªÙ‡ÙŠØ¦Ø© Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… AJAX
        $('#direct-save-btn').off('click').on('click', function(e) {
            e.preventDefault();
            
            console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… AJAX');
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
            // ...
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            $('#permissions-form').submit();
            
            return false;
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØµÙØ­Ø© -->
    <div class="page-header">
        <div>
            <h1 class="page-title">{% trans "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©" %}</h1>
            <p class="page-description">{% trans "Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" %} {{ admin.user.get_full_name }}</p>
        </div>
        <a href="{% url 'superadmin_manage_admins' %}" class="action-btn outline">
            <i class="fas fa-arrow-right"></i>
            <span>{% trans "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†" %}</span>
        </a>
    </div>

    <div class="row">
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="col-lg-4">
            <div class="user-profile-card">
                <div class="user-profile-header">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 class="user-name">{{ admin.user.get_full_name }}</h3>
                    <p class="user-role">
                        {% if admin.is_superadmin %}
                            {% trans "Ù…Ø³Ø¤ÙˆÙ„ Ø£Ø¹Ù„Ù‰" %}
                        {% else %}
                            {% trans "Ù…Ø³Ø¤ÙˆÙ„" %}
                        {% endif %}
                    </p>
                </div>
                <div class="user-profile-info">
                    <div class="user-info-item">
                        <div class="info-label">{% trans "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" %}</div>
                        <div class="info-value">{{ admin.user.username }}</div>
                    </div>
                    <div class="user-info-item">
                        <div class="info-label">{% trans "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" %}</div>
                        <div class="info-value">{{ admin.user.email }}</div>
                    </div>
                    <div class="user-info-item">
                        <div class="info-label">{% trans "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" %}</div>
                        <div class="info-value">
                            {% if admin.is_superadmin %}
                                {% trans "Ù…Ø³Ø¤ÙˆÙ„ Ø£Ø¹Ù„Ù‰" %}
                            {% else %}
                                {% trans "Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø§Ø¯ÙŠ" %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="user-info-item">
                        <div class="info-label">{% trans "Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨" %}</div>
                        <div class="info-value">
                            <span class="status-badge {% if admin.is_active %}active{% else %}inactive{% endif %}">
                                {% if admin.is_active %}
                                    <i class="fas fa-check-circle"></i> {% trans "Ù†Ø´Ø·" %}
                                {% else %}
                                    <i class="fas fa-times-circle"></i> {% trans "ØºÙŠØ± Ù†Ø´Ø·" %}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="user-info-item">
                        <div class="info-label">{% trans "Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„" %}</div>
                        <div class="info-value">{{ admin.user.last_login|date:"d/m/Y H:i" }}</div>
                    </div>
                    
                    <div class="user-profile-actions">
                        <a href="{% url 'superadmin_admin_details' admin.id %}" class="profile-action-btn primary">
                            <i class="fas fa-user-cog"></i>
                            <span>{% trans "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ" %}</span>
                        </a>
                        
                        {% if admin.is_superadmin %}
                        <button class="profile-action-btn disabled">
                            <i class="fas fa-ban"></i>
                            <span>{% trans "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù„Ù‰" %}</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="info-card mb-4">
                <div class="info-card-header">
                    <h4>{% trans "Ø¯Ù„ÙŠÙ„ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" %}</h4>
                </div>
                <div class="info-card-body">
                    <div class="permission-level-guide">
                        <div class="level-item">
                            <div class="level-badge r">R</div>
                            <div>{% trans "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶" %}</div>
                        </div>
                        <div class="level-item">
                            <div class="level-badge w">W</div>
                            <div>{% trans "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ©" %}</div>
                        </div>
                        <div class="level-item">
                            <div class="level-badge d">D</div>
                            <div>{% trans "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù" %}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <div class="info-card-header">
                    <h4>{% trans "Ø¯Ù„ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" %}</h4>
                </div>
                <div class="info-card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--primary-color);"></div>
                        <div class="ms-2">{% trans "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶" %}</div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--success-color);"></div>
                        <div class="ms-2">{% trans "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ©" %}</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: var(--warning-color);"></div>
                        <div class="ms-2">{% trans "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø°Ù" %}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
        <div class="col-lg-8">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %} mb-4">
                        <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
            
            <form method="POST" id="permissions-form">
                {% csrf_token %}
                <input type="hidden" id="permissions_data" name="permissions_data" value="{{ permissions_json }}">
                
                <div class="permissions-card">
                    <div class="card-header">
                        <h4 class="mb-0">{% trans "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" %}</h4>
                        <div class="header-actions">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-save me-1"></i> {% trans "Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" %}
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="select-all-permissions">
                                <i class="fas fa-check-double me-1"></i> {% trans "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„" %}
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="deselect-all-permissions">
                                <i class="fas fa-times-circle me-1"></i> {% trans "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯" %}
                            </button>
                        </div>
                    </div>
                    
                    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
                    <div class="permissions-tabs">
                        {% for section, perms in permissions.items %}
                        <div class="tab-item {% if forloop.first %}active{% endif %}" data-section="{{ section }}">
                            <i class="fas 
                                {% if section == 'dashboard' %}fa-tachometer-alt
                                {% elif section == 'reservations' %}fa-calendar-check
                                {% elif section == 'confirmation' %}fa-clipboard-check
                                {% elif section == 'customers' %}fa-users
                                {% elif section == 'vehicles' %}fa-car
                                {% elif section == 'custody' %}fa-clipboard-list
                                {% elif section == 'payments' %}fa-money-bill-wave
                                {% elif section == 'archive' %}fa-archive
                                {% elif section == 'archive_folders' %}fa-folder
                                {% elif section == 'archive_upload' %}fa-file-upload
                                {% elif section == 'archive_quick_upload' %}fa-cloud-upload-alt
                                {% elif section == 'condition' %}fa-clipboard-check
                                {% elif section == 'repairs' %}fa-tools
                                {% elif section == 'analytics' %}fa-chart-bar
                                {% elif section == 'reports' %}fa-file-alt
                                {% elif section == 'dashboard_analytics' %}fa-chart-pie
                                {% elif section == 'payment_analytics' %}fa-chart-line
                                {% elif section == 'settings' %}fa-cog
                                {% elif section == 'reviews' %}fa-star
                                {% elif section == 'system_logs' %}fa-history
                                {% elif section == 'backup' %}fa-save
                                {% elif section == 'diagnostics' %}fa-stethoscope
                                {% else %}fa-key{% endif %}"></i>
                            <span>
                                {% if section == 'dashboard' %}{% trans "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" %}
                                {% elif section == 'reservations' %}{% trans "Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª" %}
                                {% elif section == 'confirmation' %}{% trans "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª" %}
                                {% elif section == 'customers' %}{% trans "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" %}
                                {% elif section == 'vehicles' %}{% trans "Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª" %}
                                {% elif section == 'custody' %}{% trans "Ø§Ù„Ø¹Ù‡Ø¯Ø©" %}
                                {% elif section == 'payments' %}{% trans "Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª" %}
                                {% elif section == 'archive' %}{% trans "Ø§Ù„Ø£Ø±Ø´ÙŠÙ" %}
                                {% elif section == 'archive_folders' %}{% trans "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª" %}
                                {% elif section == 'archive_upload' %}{% trans "Ø±ÙØ¹ ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©" %}
                                {% elif section == 'archive_quick_upload' %}{% trans "Ø±ÙØ¹ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ù„ÙØ§Øª" %}
                                {% elif section == 'condition' %}{% trans "Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª" %}
                                {% elif section == 'repairs' %}{% trans "Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª" %}
                                {% elif section == 'analytics' %}{% trans "Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª" %}
                                {% elif section == 'reports' %}{% trans "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±" %}
                                {% elif section == 'dashboard_analytics' %}{% trans "ØªØ­Ù„ÙŠÙ„Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©" %}
                                {% elif section == 'payment_analytics' %}{% trans "ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª" %}
                                {% elif section == 'settings' %}{% trans "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" %}
                                {% elif section == 'reviews' %}{% trans "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª" %}
                                {% elif section == 'system_logs' %}{% trans "Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…" %}
                                {% elif section == 'backup' %}{% trans "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ" %}
                                {% elif section == 'diagnostics' %}{% trans "ØªØ´Ø®ÙŠØµ ÙˆØ¥ØµÙ„Ø§Ø­" %}
                                {% else %}{{ section }}{% endif %}
                            </span>
                            <span class="action-count tab-count">0</span>
                        </div>
                        {% endfor %}
                        
                        <div class="tab-item utility" id="expand-all">
                            <i class="fas fa-expand-arrows-alt"></i>
                            <span>{% trans "ÙØªØ­ Ø§Ù„ÙƒÙ„" %}</span>
                        </div>
                    </div>
                    
                    <!-- Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
                    {% for section, perms in permissions.items %}
                    <div class="permissions-section {% if forloop.first %}active{% endif %}" id="section-{{ section }}">
                        <div class="section-title">
                            <i class="fas 
                                {% if section == 'dashboard' %}fa-tachometer-alt
                                {% elif section == 'reservations' %}fa-calendar-check
                                {% elif section == 'confirmation' %}fa-clipboard-check
                                {% elif section == 'customers' %}fa-users
                                {% elif section == 'vehicles' %}fa-car
                                {% elif section == 'custody' %}fa-clipboard-list
                                {% elif section == 'payments' %}fa-money-bill-wave
                                {% elif section == 'archive' %}fa-archive
                                {% elif section == 'archive_folders' %}fa-folder
                                {% elif section == 'archive_upload' %}fa-file-upload
                                {% elif section == 'archive_quick_upload' %}fa-cloud-upload-alt
                                {% elif section == 'condition' %}fa-clipboard-check
                                {% elif section == 'repairs' %}fa-tools
                                {% elif section == 'analytics' %}fa-chart-bar
                                {% elif section == 'reports' %}fa-file-alt
                                {% elif section == 'dashboard_analytics' %}fa-chart-pie
                                {% elif section == 'payment_analytics' %}fa-chart-line
                                {% elif section == 'settings' %}fa-cog
                                {% elif section == 'reviews' %}fa-star
                                {% elif section == 'system_logs' %}fa-history
                                {% elif section == 'backup' %}fa-save
                                {% elif section == 'diagnostics' %}fa-stethoscope
                                {% else %}fa-key{% endif %}"></i>
                            <span>
                                {% if section == 'dashboard' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" %}
                                {% elif section == 'reservations' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª" %}
                                {% elif section == 'confirmation' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª" %}
                                {% elif section == 'customers' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" %}
                                {% elif section == 'vehicles' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª" %}
                                {% elif section == 'custody' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ù‡Ø¯Ø©" %}
                                {% elif section == 'payments' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª" %}
                                {% elif section == 'archive' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ" %}
                                {% elif section == 'archive_folders' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª" %}
                                {% elif section == 'archive_upload' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø±ÙØ¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚" %}
                                {% elif section == 'archive_quick_upload' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹" %}
                                {% elif section == 'condition' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª" %}
                                {% elif section == 'repairs' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª" %}
                                {% elif section == 'analytics' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª" %}
                                {% elif section == 'reports' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±" %}
                                {% elif section == 'dashboard_analytics' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª ØªØ­Ù„ÙŠÙ„Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©" %}
                                {% elif section == 'payment_analytics' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª" %}
                                {% elif section == 'settings' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" %}
                                {% elif section == 'reviews' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª" %}
                                {% elif section == 'system_logs' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…" %}
                                {% elif section == 'backup' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ" %}
                                {% elif section == 'diagnostics' %}{% trans "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­" %}
                                {% else %}{{ section }}{% endif %}
                            </span>
                        </div>
                        
                        <div class="section-actions">
                            <button type="button" class="action-btn outline toggle-section">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button type="button" class="action-btn outline select-all" data-section="{{ section }}">
                                <i class="fas fa-check-double"></i>
                                <span>{% trans "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„" %}</span>
                            </button>
                            <div class="action-count section-count">0 / {{ perms|length }}</div>
                        </div>
                        
                        <div class="section-body" {% if not forloop.first %}style="display: none;"{% endif %}>
                            <div class="permissions-grid">
                                {% for perm in perms %}
                                <div class="permission-card {% if perm.active %}active{% endif %}">
                                    <input type="checkbox" name="{{ section }}_{{ perm.name }}" id="{{ section }}_{{ perm.name }}" class="permission-checkbox" style="display: none;" {% if perm.active %}checked{% endif %}>
                                    <div class="permission-indicator"></div>
                                    <div class="permission-level">
                                        {% if 'view' in perm.name or 'read' in perm.name %}R
                                        {% elif 'delete' in perm.name %}D
                                        {% else %}W{% endif %}
                                    </div>
                                    <div class="permission-icon">
                                        <i class="fas 
                                            {% if 'view' in perm.name or 'read' in perm.name %}fa-eye
                                            {% elif 'create' in perm.name or 'add' in perm.name %}fa-plus-circle
                                            {% elif 'edit' in perm.name or 'update' in perm.name %}fa-edit
                                            {% elif 'delete' in perm.name %}fa-trash-alt
                                            {% elif 'export' in perm.name %}fa-file-export
                                            {% elif 'import' in perm.name %}fa-file-import
                                            {% elif 'approve' in perm.name %}fa-check-circle
                                            {% elif 'reject' in perm.name %}fa-times-circle
                                            {% elif 'print' in perm.name %}fa-print
                                            {% elif 'download' in perm.name %}fa-download
                                            {% elif 'upload' in perm.name %}fa-upload
                                            {% elif 'manage' in perm.name %}fa-cog
                                            {% else %}fa-key{% endif %}"></i>
                                    </div>
                                    <div class="permission-title">
                                        {% if perm.name == 'view_dashboard' %}{% trans "Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" %}
                                        {% elif perm.name == 'view_calendar' %}{% trans "Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©" %}
                                        {% elif perm.name == 'view_notifications' %}{% trans "Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" %}
                                        {% elif perm.name == 'customize_dashboard' %}{% trans "ØªØ®ØµÙŠØµ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" %}
                                        {% else %}{{ perm.name|title }}{% endif %}
                                    </div>
                                    <div class="permission-desc">{% trans "ÙˆØµÙ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©" %}</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> {% trans "Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}