{% extends 'superadmin/layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "لوحة معلومات المسؤول الأعلى" %}{% endblock %}

{% block extra_css %}
<style>
    .activity-timeline {
        position: relative;
        padding-left: 1.5rem;
    }
    
    .activity-timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 2px;
        background-color: #e2e8f0;
    }
    
    .activity-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    
    .activity-item:last-child {
        padding-bottom: 0;
    }
    
    .activity-dot {
        position: absolute;
        left: -1.5rem;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--primary-color);
        border: 2px solid white;
    }
    
    .activity-date {
        font-size: 0.75rem;
        color: #64748b;
    }
    
    .activity-content {
        margin-top: 0.25rem;
    }
    
    .review-stats .card {
        border-top: 4px solid transparent;
    }
    
    .review-stats .card.purple {
        border-top-color: var(--primary-color);
    }
    
    .review-stats .card.green {
        border-top-color: var(--success-color);
    }
    
    .review-stats .card.orange {
        border-top-color: var(--warning-color);
    }
    
    .review-stats .card.red {
        border-top-color: var(--danger-color);
    }
    
    /* RTL specific styles */
    .rtl .activity-timeline {
        padding-left: 0;
        padding-right: 1.5rem;
    }
    
    .rtl .activity-timeline::before {
        left: auto;
        right: 0;
    }
    
    .rtl .activity-dot {
        left: auto;
        right: -1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3">{% trans "لوحة المعلومات" %}</h1>
        <p class="text-muted">{% trans "مرحباً بك في لوحة تحكم المسؤول الأعلى" %}</p>
    </div>
    <div>
        <span class="badge bg-primary">{{ total_admins }} {% trans "مسؤول" %}</span>
        <span class="badge bg-success">{{ active_admins }} {% trans "نشط" %}</span>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-stat">
                <div class="stat-icon purple">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">{% trans "إجمالي المسؤولين" %}</div>
                    <div class="stat-value">{{ total_admins }}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> {{ superadmins }} {% trans "مسؤول أعلى" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-stat">
                <div class="stat-icon blue">
                    <i class="fas fa-user-tag"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">{% trans "الأدوار" %}</div>
                    <div class="stat-value">{{ total_roles }}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-check"></i> {% trans "محدث" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-stat">
                <div class="stat-icon green">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">{% trans "مسؤولين نشطين" %}</div>
                    <div class="stat-value">{{ active_admins }}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> {{ active_admins|floatformat:0 }}%
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-stat">
                <div class="stat-icon orange">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">{% trans "التقييمات قيد المراجعة" %}</div>
                    <div class="stat-value">{{ reviews_stats.pending_moderation }}</div>
                    <div class="stat-change">
                        <i class="fas fa-clock"></i> {% trans "قيد الانتظار" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Review Statistics -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">{% trans "إحصائيات التقييمات" %}</h5>
                <a href="{% url 'superadmin_manage_reviews' %}" class="btn btn-sm btn-outline-primary">{% trans "عرض الكل" %}</a>
            </div>
            <div class="card-body">
                <div class="review-stats row g-3">
                    <div class="col-6">
                        <div class="card purple">
                            <div class="card-body text-center py-3">
                                <div class="h2">{{ reviews_stats.total }}</div>
                                <div class="small text-muted">{% trans "إجمالي" %}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card orange">
                            <div class="card-body text-center py-3">
                                <div class="h2">{{ reviews_stats.pending_moderation }}</div>
                                <div class="small text-muted">{% trans "قيد المراجعة" %}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card green">
                            <div class="card-body text-center py-3">
                                <div class="h2">{{ reviews_stats.approved }}</div>
                                <div class="small text-muted">{% trans "معتمد" %}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card red">
                            <div class="card-body text-center py-3">
                                <div class="h2">{{ reviews_stats.rejected }}</div>
                                <div class="small text-muted">{% trans "مرفوض" %}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Logins -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">{% trans "آخر تسجيلات الدخول" %}</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for login in recent_logins %}
                    <div class="list-group-item px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="avatar me-3">
                                {{ login.admin.user.username|first|upper }}
                            </div>
                            <div>
                                <div class="fw-medium">{{ login.admin.user.get_full_name|default:login.admin.user.username }}</div>
                                <div class="small text-muted">{{ login.created_at|date:'Y-m-d H:i' }}</div>
                                <div class="small text-muted">IP: {{ login.ip_address }}</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="list-group-item px-4 py-3 text-center">
                        <p class="text-muted mb-0">{% trans "لا توجد بيانات" %}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activities -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">{% trans "آخر الأنشطة" %}</h5>
                <a href="{% url 'superadmin_system_logs' %}" class="btn btn-sm btn-outline-primary">{% trans "عرض الكل" %}</a>
            </div>
            <div class="card-body">
                <div class="activity-timeline {% if LANGUAGE_CODE == 'ar' %}rtl{% endif %}">
                    {% for activity in recent_activities %}
                    <div class="activity-item">
                        <div class="activity-dot"></div>
                        <div class="activity-date">{{ activity.created_at|date:'Y-m-d H:i' }}</div>
                        <div class="activity-content">
                            <strong>{{ activity.admin.user.username }}</strong> {{ activity.action }}
                            <p class="small text-muted mb-0">{{ activity.details }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">{% trans "لا توجد أنشطة حديثة" %}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Distribution Chart -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">{% trans "توزيع المسؤولين والأدوار" %}</h5>
            </div>
            <div class="card-body">
                <div id="adminDistributionChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // إنشاء مخطط توزيع المسؤولين
    $(document).ready(function() {
        // بيانات افتراضية للمخطط
        var options = {
            series: [{
                name: '{% trans "عدد المسؤولين" %}',
                data: [{{ active_admins }}, {{ total_admins }} - {{ active_admins }}, {{ superadmins }}]
            }],
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    borderRadius: 8,
                    distributed: true,
                }
            },
            colors: ['#10b981', '#64748b', '#6366f1'],
            dataLabels: {
                enabled: false
            },
            legend: {
                show: false
            },
            grid: {
                borderColor: '#e2e8f0',
                strokeDashArray: 4
            },
            xaxis: {
                categories: [
                    '{% trans "نشط" %}', 
                    '{% trans "غير نشط" %}', 
                    '{% trans "مسؤول أعلى" %}'
                ],
                labels: {
                    style: {
                        fontFamily: 'inherit',
                    }
                }
            },
            yaxis: {
                title: {
                    text: '{% trans "عدد المسؤولين" %}',
                    style: {
                        fontFamily: 'inherit',
                    }
                },
                labels: {
                    formatter: function (value) {
                        return Math.round(value);
                    },
                    style: {
                        fontFamily: 'inherit',
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function(value) {
                        return value;
                    }
                }
            }
        };
        
        var chart = new ApexCharts(document.querySelector("#adminDistributionChart"), options);
        chart.render();
    });
</script>
{% endblock %}