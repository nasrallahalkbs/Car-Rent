{% extends 'superadmin/layout.html' %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load utils_filters %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">{{ title }}</h5>
        </div>
        <div class="card-body">
            <form method="post" id="scheduledJobForm" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <!-- المهام المحددة مسبقًا -->
                        <div class="form-group mb-4">
                            <label for="predefined_task">{% trans "اختر المهمة" %} <span class="text-danger">*</span></label>
                            <select id="predefined_task" name="predefined_task" class="form-select form-control">
                                <option value="">{% trans "-- اختر المهمة المراد جدولتها --" %}</option>
                                {% for task_id, task_name in predefined_tasks %}
                                <option value="{{ task_id }}" data-job-type="{{ task_types|get_item:task_id }}" 
                                        data-description="{{ task_descriptions|get_item:task_id }}"
                                        data-args="{{ task_args|get_item:task_id }}">
                                    {{ task_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted mt-2" id="task-description"></small>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="id_job_type">{% trans "نوع المهمة" %} <span class="text-danger">*</span></label>
                            {{ form.job_type|as_crispy_field }}
                        </div>
                    </div>
                
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="id_interval_type">{% trans "نوع الفاصل الزمني" %} <span class="text-danger">*</span></label>
                            {{ form.interval_type|as_crispy_field }}
                        </div>
                        
                        <div class="form-group mb-3" id="interval_value_group">
                            <label for="id_interval_value">{% trans "قيمة الفاصل الزمني" %} <span class="text-danger">*</span></label>
                            {{ form.interval_value|as_crispy_field }}
                            <small class="form-text text-muted">{% trans "عدد الوحدات الزمنية (ساعات/أيام/أسابيع/شهور)" %}</small>
                        </div>
                        
                        <div class="form-group mb-3" id="cron_expression_group" style="display: none;">
                            <label for="id_cron_expression">{% trans "تعبير Cron" %} <span class="text-danger">*</span></label>
                            {{ form.cron_expression|as_crispy_field }}
                            <small class="form-text text-muted">{% trans "تعبير Cron للجدولة المخصصة (مثال: 0 0 * * * للتنفيذ يومياً عند منتصف الليل)" %}</small>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">{% trans "معاملات الوظيفة" %}</h6>
                            </div>
                            <div class="card-body">
                                <!-- واجهة المستخدم المحسنة للمعاملات -->
                                <div id="parameters-container">
                                    <div class="d-flex justify-content-between mb-3">
                                        <h6>{% trans "المعاملات" %}</h6>
                                        <button type="button" id="add-parameter" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-plus"></i> {% trans "إضافة معامل" %}
                                        </button>
                                    </div>
                                    <div id="parameters-list">
                                        <!-- سيتم إضافة المعاملات هنا بواسطة JavaScript -->
                                    </div>
                                </div>
                                
                                <!-- حقل مخفي لتخزين معاملات JSON -->
                                <input type="hidden" id="args_json" name="args_json" value="{{ args_json|default:'{}' }}">
                                
                                <div class="mt-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="show-json-editor">
                                        <label class="form-check-label" for="show-json-editor">{% trans "عرض محرر JSON المتقدم" %}</label>
                                    </div>
                                </div>
                                
                                <!-- محرر JSON المتقدم (مخفي بشكل افتراضي) -->
                                <div id="advanced-json-editor" class="mt-3" style="display: none;">
                                    <label for="json-editor">{% trans "محرر JSON المتقدم" %}</label>
                                    <textarea id="json-editor" class="form-control" rows="5">{{ args_json|default:'{}' }}</textarea>
                                    <small class="form-text text-muted">{% trans "تحرير المعاملات مباشرة بتنسيق JSON (للمستخدمين المتقدمين)" %}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="form-check form-switch">
                            {{ form.is_active }}
                            <label class="form-check-label" for="id_is_active">{% trans "تفعيل المهمة" %}</label>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12 text-center">
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save {% if LANGUAGE_CODE == 'ar' %}ms-2{% else %}me-2{% endif %}"></i>
                            {% trans "حفظ المهمة" %}
                        </button>
                        <a href="{% url 'superadmin_scheduler' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times {% if LANGUAGE_CODE == 'ar' %}ms-2{% else %}me-2{% endif %}"></i>
                            {% trans "إلغاء" %}
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // التعامل مع تغيير نوع الفاصل الزمني
        $('#id_interval_type').on('change', function() {
            var intervalType = $(this).val();
            
            if (intervalType === 'custom') {
                $('#interval_value_group').hide();
                $('#cron_expression_group').show();
            } else {
                $('#interval_value_group').show();
                $('#cron_expression_group').hide();
            }
        });
        
        // تطبيق الإعدادات الأولية
        $('#id_interval_type').trigger('change');
        
        // التعامل مع اختيار المهمة المحددة مسبقًا
        $('#predefined_task').on('change', function() {
            var selectedOption = $(this).find(':selected');
            var jobType = selectedOption.data('job-type');
            var description = selectedOption.data('description');
            var argsJson = selectedOption.data('args');
            
            // عرض وصف المهمة
            $('#task-description').text(description || '');
            
            // تعيين نوع المهمة
            if (jobType) {
                $('#id_job_type').val(jobType);
            }
            
            // تعيين معاملات المهمة
            if (argsJson) {
                $('#args_json').val(argsJson);
                
                // تحديث واجهة المعاملات
                try {
                    var args = JSON.parse(argsJson);
                    updateParametersUI(args);
                } catch (e) {
                    console.error('خطأ في تحليل المعاملات:', e);
                }
            }
        });
        
        // تهيئة قائمة المعاملات والمحرر المتقدم
        var paramsList = $('#parameters-list');
        var paramCount = 0;
        
        // دالة لتحديث واجهة المعاملات من كائن JSON
        function updateParametersUI(args) {
            // مسح القائمة الحالية
            paramsList.empty();
            paramCount = 0;
            
            // إضافة كل معامل إلى القائمة
            $.each(args, function(key, value) {
                addParameterToUI(key, value);
            });
            
            // تحديث محرر JSON المتقدم أيضًا
            $('#json-editor').val(JSON.stringify(args, null, 2));
        }
        
        // دالة لإضافة معامل إلى واجهة المستخدم
        function addParameterToUI(name, value) {
            var paramId = 'param-' + paramCount;
            var valueType = typeof value;
            var displayValue = value;
            
            if (valueType === 'boolean') {
                displayValue = value ? 'نعم' : 'لا';
            } else if (value === null) {
                valueType = 'null';
                displayValue = 'فارغ';
            } else if (Array.isArray(value)) {
                valueType = 'array';
                displayValue = JSON.stringify(value);
            } else if (valueType === 'object') {
                displayValue = JSON.stringify(value);
            }
            
            var paramHTML = `
                <div class="card mb-2 parameter-item" id="${paramId}">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-md-0">
                                    <label>{% trans "اسم المعامل" %}</label>
                                    <input type="text" class="form-control param-name" value="${name}" data-original="${name}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-md-0">
                                    <label>{% trans "قيمة المعامل" %}</label>
                                    <input type="text" class="form-control param-value" value="${displayValue}" data-type="${valueType}">
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-sm btn-danger remove-param w-100">
                                    <i class="fas fa-trash"></i> {% trans "حذف" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            paramsList.append(paramHTML);
            paramCount++;
        }
        
        // دالة لتحديث كائن JSON من واجهة المستخدم
        function updateJsonFromUI() {
            var jsonObj = {};
            
            $('.parameter-item').each(function() {
                var name = $(this).find('.param-name').val();
                var value = $(this).find('.param-value').val();
                var type = $(this).find('.param-value').data('type');
                
                if (name) {
                    // تحويل القيمة حسب نوع البيانات
                    if (type === 'number') {
                        if (value.indexOf('.') !== -1) {
                            value = parseFloat(value);
                        } else {
                            value = parseInt(value, 10);
                        }
                    } else if (type === 'boolean') {
                        value = (value.toLowerCase() === 'true' || value.toLowerCase() === 'نعم');
                    } else if (type === 'null') {
                        value = null;
                    } else if (type === 'array' || type === 'object') {
                        try {
                            value = JSON.parse(value);
                        } catch (e) {
                            console.error('خطأ في تحليل القيمة:', e);
                        }
                    }
                    
                    jsonObj[name] = value;
                }
            });
            
            return jsonObj;
        }
        // تحميل المعاملات الحالية من الحقل المخفي
        var currentParams = {};
        
        try {
            currentParams = JSON.parse($('#args_json').val() || '{}');
            // عرض المعاملات الحالية في الواجهة
            updateParametersUI(currentParams);
        } catch (e) {
            console.error('خطأ في تحليل المعاملات الحالية', e);
        }
        
        // التعامل مع زر إضافة معامل
        $('#add-parameter').on('click', function() {
            addParameterToUI(`param${paramCount}`, '');
            updateArgsJson();
        });
        
        // التعامل مع زر حذف معامل
        $(document).on('click', '.remove-param', function() {
            $(this).closest('.parameter-item').remove();
            updateArgsJson();
        });
        
        // التعامل مع تغيير اسم أو قيمة المعامل
        $(document).on('change keyup', '.param-name, .param-value', function() {
            updateArgsJson();
        });
        
        // التعامل مع تبديل عرض محرر JSON المتقدم
        $('#show-json-editor').on('change', function() {
            if ($(this).is(':checked')) {
                $('#advanced-json-editor').show();
            } else {
                $('#advanced-json-editor').hide();
            }
        });
        
        // التعامل مع تغييرات محرر JSON المتقدم
        $('#json-editor').on('change keyup', function() {
            try {
                var jsonData = JSON.parse($(this).val());
                $('#args_json').val(JSON.stringify(jsonData));
                updateParametersUI(jsonData);
            } catch (e) {
                console.error('تنسيق JSON غير صالح', e);
            }
        });
        
        // دالة لتحديث حقل JSON المخفي
        function updateArgsJson() {
            var jsonObj = updateJsonFromUI();
            var jsonString = JSON.stringify(jsonObj);
            $('#args_json').val(jsonString);
            $('#json-editor').val(JSON.stringify(jsonObj, null, 2));
        }
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label for="${paramId}-key">{% trans "اسم المعامل" %}</label>
                                <input type="text" id="${paramId}-key" class="form-control param-key" value="${key}" placeholder="{% trans "اسم المعامل" %}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-2">
                                <label for="${paramId}-type">{% trans "نوع القيمة" %}</label>
                                <select id="${paramId}-type" class="form-control param-type">
                                    <option value="string" ${valueType === 'string' ? 'selected' : ''}>{% trans "نص" %}</option>
                                    <option value="number" ${valueType === 'number' ? 'selected' : ''}>{% trans "رقم" %}</option>
                                    <option value="boolean" ${valueType === 'boolean' ? 'selected' : ''}>{% trans "منطقي" %}</option>
                                    <option value="object" ${isObject ? 'selected' : ''}>{% trans "كائن (JSON)" %}</option>
                                    <option value="array" ${isArray ? 'selected' : ''}>{% trans "مصفوفة" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-2 param-value-container">`;
                            
            // تحديد نوع حقل الإدخال بناءً على نوع القيمة
            if (valueType === 'boolean') {
                fieldHtml += `
                    <label for="${paramId}-value">{% trans "القيمة" %}</label>
                    <select id="${paramId}-value" class="form-control param-value">
                        <option value="true" ${value === true ? 'selected' : ''}>{% trans "نعم" %}</option>
                        <option value="false" ${value === false ? 'selected' : ''}>{% trans "لا" %}</option>
                    </select>`;
            } else if (isObject || isArray) {
                fieldHtml += `
                    <label for="${paramId}-value">{% trans "القيمة (JSON)" %}</label>
                    <textarea id="${paramId}-value" class="form-control param-value" rows="1">${JSON.stringify(value)}</textarea>`;
            } else {
                fieldHtml += `
                    <label for="${paramId}-value">{% trans "القيمة" %}</label>
                    <input type="${valueType === 'number' ? 'number' : 'text'}" id="${paramId}-value" class="form-control param-value" value="${value}">`;
            }
            
            fieldHtml += `
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="mt-4 pt-1 text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-param" data-param-id="${paramId}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            paramsList.append(fieldHtml);
            
            // تعيين معالج الأحداث لتغيير نوع القيمة
            $(`#${paramId}-type`).on('change', function() {
                var newType = $(this).val();
                var valueContainer = $(`#${paramId}-container .param-value-container`);
                var currentVal = $(`#${paramId}-value`).val();
                
                // تحويل القيمة الحالية إلى النوع الجديد
                var convertedValue = '';
                try {
                    if (newType === 'string') {
                        convertedValue = String(currentVal);
                    } else if (newType === 'number') {
                        convertedValue = isNaN(Number(currentVal)) ? 0 : Number(currentVal);
                    } else if (newType === 'boolean') {
                        convertedValue = Boolean(currentVal);
                    } else if (newType === 'object') {
                        convertedValue = '{}';
                    } else if (newType === 'array') {
                        convertedValue = '[]';
                    }
                } catch (e) {
                    console.error('خطأ في تحويل القيمة:', e);
                }
                
                // إعادة رسم حقل القيمة وفقاً للنوع
                var newValueHtml = '';
                if (newType === 'boolean') {
                    newValueHtml = `
                        <label for="${paramId}-value">{% trans "القيمة" %}</label>
                        <select id="${paramId}-value" class="form-control param-value">
                            <option value="true">{% trans "نعم" %}</option>
                            <option value="false" selected>{% trans "لا" %}</option>
                        </select>`;
                } else if (newType === 'object' || newType === 'array') {
                    newValueHtml = `
                        <label for="${paramId}-value">{% trans "القيمة (JSON)" %}</label>
                        <textarea id="${paramId}-value" class="form-control param-value" rows="1">${convertedValue}</textarea>`;
                } else {
                    newValueHtml = `
                        <label for="${paramId}-value">{% trans "القيمة" %}</label>
                        <input type="${newType === 'number' ? 'number' : 'text'}" id="${paramId}-value" class="form-control param-value" value="${convertedValue}">`;
                }
                
                valueContainer.html(newValueHtml);
                updateJsonFromFields();
            });
            
            paramCount++;
        }
        
        // عرض المعاملات الموجودة عند تحميل الصفحة
        showExistingParams();
        
        // إضافة معامل جديد عند النقر على الزر
        $('#add-parameter').on('click', function() {
            addParameterField();
            updateJsonFromFields();
        });
        
        // حذف معامل
        $(document).on('click', '.remove-param', function() {
            var paramId = $(this).data('param-id');
            $(`#${paramId}-container`).remove();
            updateJsonFromFields();
        });
        
        // تحديث حقل JSON من الحقول المرئية
        function updateJsonFromFields() {
            var jsonObj = {};
            
            $('.parameter-row').each(function() {
                var keyInput = $(this).find('.param-key');
                var typeSelect = $(this).find('.param-type');
                var valueInput = $(this).find('.param-value');
                
                var key = keyInput.val().trim();
                var type = typeSelect.val();
                var rawValue = valueInput.val();
                
                if (key) {
                    var value;
                    switch (type) {
                        case 'string':
                            value = String(rawValue);
                            break;
                        case 'number':
                            value = isNaN(Number(rawValue)) ? 0 : Number(rawValue);
                            break;
                        case 'boolean':
                            value = rawValue === 'true';
                            break;
                        case 'object':
                        case 'array':
                            try {
                                value = JSON.parse(rawValue);
                            } catch (e) {
                                value = type === 'object' ? {} : [];
                                console.error('خطأ في تحليل JSON:', e);
                            }
                            break;
                        default:
                            value = rawValue;
                    }
                    
                    jsonObj[key] = value;
                }
            });
            
            // تحديث حقل JSON المخفي ومحرر JSON المتقدم
            var jsonStr = JSON.stringify(jsonObj, null, 2);
            $('#args_json').val(jsonStr);
            $('#json-editor').val(jsonStr);
        }
        
        // تحديث JSON عند تغيير أي من حقول المعاملات
        $(document).on('change', '.param-key, .param-type, .param-value', function() {
            updateJsonFromFields();
        });
        
        // التبديل بين عرض محرر JSON المتقدم وإخفائه
        $('#show-json-editor').on('change', function() {
            if ($(this).is(':checked')) {
                $('#advanced-json-editor').show();
            } else {
                $('#advanced-json-editor').hide();
            }
        });
        
        // تحديث حقول المعاملات عند تغيير JSON في المحرر المتقدم
        $('#json-editor').on('change', function() {
            var jsonStr = $(this).val();
            
            try {
                var jsonObj = JSON.parse(jsonStr);
                $('#args_json').val(jsonStr);
                
                // إعادة رسم حقول المعاملات
                $('#parameters-list').empty();
                paramCount = 0;
                currentParams = jsonObj;
                showExistingParams();
            } catch (e) {
                console.error('خطأ في تحليل JSON:', e);
                // عدم تحديث الحقول إذا كان JSON غير صحيح
            }
        });
        
        // التحقق من صحة JSON عند إرسال النموذج
        $('#scheduledJobForm').on('submit', function(e) {
            var argsJson = $('#args_json').val();
            
            try {
                if (argsJson) {
                    JSON.parse(argsJson);
                }
            } catch (error) {
                e.preventDefault();
                alert('{% trans "خطأ في تنسيق JSON. يرجى التحقق من المعاملات." %}');
            }
        });
    });
</script>
{% endblock %}