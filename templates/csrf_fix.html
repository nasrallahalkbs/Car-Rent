{% load static %}
<script>
// هذا السكريبت يضيف تلقائيًا رمز CSRF إلى جميع طلبات AJAX
document.addEventListener('DOMContentLoaded', function() {
    // الحصول على قيمة CSRF token من الصفحة
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // البحث عن رمز CSRF في العناصر الموجودة في الصفحة
    function getCSRFTokenFromPage() {
        // البحث في عناصر meta
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) return metaToken.getAttribute('content');
        
        // البحث في عناصر input
        const inputToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (inputToken) return inputToken.value;
        
        // استخراج من وسوم النماذج أو البيانات
        return null;
    }

    // تخزين قيمة رمز CSRF في المتصفح
    let csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        // نحاول البحث عن رمز CSRF في الصفحة إذا لم يتم العثور عليه في الكوكيز
        csrfToken = getCSRFTokenFromPage();
        console.log('Found CSRF token in page:', csrfToken ? 'Yes' : 'No');
        
        // نتوقف ولا نعيد تحميل الصفحة في حالة عدم وجود رمز CSRF
        if (!csrfToken) {
            console.warn('CSRF token not found. Forms may not work correctly.');
        }
    }
    
    // فقط إذا وجدنا رمز CSRF، نقوم بإضافته إلى الطلبات
    if (csrfToken) {
        // إضافة مستمع للطلبات قبل إرسالها لإضافة رمز CSRF إلى رؤوس الطلبات
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            options = options || {};
            options.headers = options.headers || {};
            options.headers['X-CSRFToken'] = csrfToken;
            return originalFetch(url, options);
        };

        // إضافة مستمع للطلبات XMLHttpRequest لإضافة رمز CSRF
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url) {
            const xhr = this;
            originalOpen.apply(xhr, arguments);
            if (method.toLowerCase() !== 'get') {
                xhr.setRequestHeader('X-CSRFToken', csrfToken);
            }
        };
        
        console.log('CSRF protection initialized');
    }
});
</script>